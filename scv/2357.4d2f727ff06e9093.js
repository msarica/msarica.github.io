"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[2357],{2357:(nt,b,a)=>{a.r(b),a.d(b,{StoryBuilderPageModule:()=>ot});var y=a(9808),c=a(4182),l=a(7590),_=a(5010),t=a(2096),J=a(5485),w=a(2811),M=a(4848),F=a(759),B=a(5672),f=a(4974);const k=["mapElementRef"];let Z=(()=>{class n{constructor(){this.startPoint=[0,0],this.coordinateClick=new t.vpe}ngOnInit(){this.setUpMap()}setUpMap(){const[o,e]=this.startPoint,s=(0,f.xA)([e,o]);this.map=new J.Z({view:new w.ZP({center:s,zoom:18}),layers:[new M.Z({source:new B.Z})],target:"ol-map"});const u=new F.Z({});this.map.addLayer(u),this.map.on("click",d=>{const p=this.map.getCoordinateFromPixel(d.pixel),q=(0,f.FY)(p);this.coordinateClick.emit({coordinate:[q[1],q[0]],event:d})}),setTimeout(()=>{this.map.setTarget(this.mapElementRef.nativeElement)})}goToPoint(o,e=18){const r=(0,f.xA)([o[1],o[0]]),s=this.map.getView();s.setCenter(r),s.setZoom(e)}}return n.\u0275fac=function(o){return new(o||n)},n.\u0275cmp=t.Xpm({type:n,selectors:[["app-coordinate-selection"]],viewQuery:function(o,e){if(1&o&&t.Gf(k,7),2&o){let r;t.iGM(r=t.CRH())&&(e.mapElementRef=r.first)}},inputs:{startPoint:"startPoint"},outputs:{coordinateClick:"coordinateClick"},decls:3,vars:0,consts:[["id","ol-map",1,"map-container"],["mapElementRef",""]],template:function(o,e){1&o&&(t.ynx(0),t._UZ(1,"div",0,1),t.BQk())},styles:["[_nghost-%COMP%]{display:flex;flex-grow:1;flex-direction:column;height:100vh}.map-container[_ngcontent-%COMP%]{flex-grow:1}"]}),n})(),v=(()=>{class n{constructor(){this.coordinateSelected=new t.vpe,this.startPoint=[0,0]}ngOnInit(){}onCoordinateClick(o){console.log(o.coordinate),this.coordinate=o.coordinate}go(){try{const o=this.coord.replace(/\[|\]/g,"").split(",").map(e=>parseFloat(e.trim()));this.coordinate=o,this.coordinateSelect.goToPoint(o)}catch(o){console.log(o.message)}}copy(){navigator.clipboard.writeText(JSON.stringify(this.coordinate))}select(){this.coordinateSelected.emit(this.coordinate)}}return n.\u0275fac=function(o){return new(o||n)},n.\u0275cmp=t.Xpm({type:n,selectors:[["app-coordinate-select-wrapper"]],viewQuery:function(o,e){if(1&o&&t.Gf(Z,7),2&o){let r;t.iGM(r=t.CRH())&&(e.coordinateSelect=r.first)}},inputs:{startPoint:"startPoint"},outputs:{coordinateSelected:"coordinateSelected"},decls:10,vars:4,consts:[["placeholder","Enter coordinates",3,"ngModel","ngModelChange","keyup.enter"],[3,"click"],[3,"startPoint","coordinateClick"]],template:function(o,e){1&o&&(t.TgZ(0,"ion-item")(1,"ion-input",0),t.NdJ("ngModelChange",function(s){return e.coord=s})("keyup.enter",function(){return e.go()}),t.qZA()(),t.TgZ(2,"ion-item")(3,"ion-button",1),t.NdJ("click",function(){return e.go()}),t._uU(4," Go "),t.qZA(),t.TgZ(5,"ion-button",1),t.NdJ("click",function(){return e.copy()}),t._uU(6),t.qZA(),t.TgZ(7,"ion-button",1),t.NdJ("click",function(){return e.select()}),t._uU(8),t.qZA()(),t.TgZ(9,"app-coordinate-selection",2),t.NdJ("coordinateClick",function(s){return e.onCoordinateClick(s)}),t.qZA()),2&o&&(t.xp6(1),t.Q6J("ngModel",e.coord),t.xp6(5),t.hij(" Copy [",e.coordinate,"] "),t.xp6(2),t.hij(" Select [",e.coordinate,"] "),t.xp6(1),t.Q6J("startPoint",e.startPoint))},dependencies:[c.JJ,c.On,l.YG,l.pK,l.Ie,l.j9,Z]}),n})();var m=a(655),S=a(5529),T=a(7224),O=a(7625);function C(){return n=>{const i=n.value;if(!i)return null;try{if((0,f.lJ)(JSON.parse(i.trim())))return null}catch(o){}return{notValid:!0}}}function g(n){if(n)return n.split(",").map(i=>i.trim())}function h(n){if(n)return n.join(",")}function A(n){return JSON.parse(n)}function U(n){return JSON.stringify(n)}function N(n){return n?n.split(",").map(i=>i.trim()).filter(i=>!!i).map(i=>{const o="^"+i.replace("*",".+")+"$";return new RegExp(o,"g")}):null}function x(n){return n?n.split(",").map(i=>i.trim()).filter(i=>!!i):null}var I=a(3629),G=a(9258),j=a(3726),K=a(4725),P=a(5174);function V(n,i){1&n&&(t.ynx(0),t.TgZ(1,"ion-item")(2,"ion-label"),t._uU(3," Choices "),t.qZA(),t._UZ(4,"ion-textarea",24),t.TgZ(5,"span",7),t._uU(6,"Not valid"),t.qZA()(),t.BQk())}function Y(n,i){1&n&&(t.ynx(0),t.TgZ(1,"ion-item")(2,"ion-label"),t._uU(3," Possible Answers "),t.qZA(),t._UZ(4,"ion-textarea",25),t.TgZ(5,"span",7),t._uU(6,"Not valid"),t.qZA()(),t.TgZ(7,"ion-item")(8,"ion-label"),t._uU(9," Message If Correct "),t.qZA(),t._UZ(10,"ion-textarea",26),t.TgZ(11,"span",7),t._uU(12,"Not valid"),t.qZA()(),t.TgZ(13,"ion-item")(14,"ion-label"),t._uU(15," Message If Not Correct "),t.qZA(),t._UZ(16,"ion-textarea",27),t.TgZ(17,"span",7),t._uU(18,"Not valid"),t.qZA()(),t.BQk())}const $=function(){return["multiplechoice","shortanswer"]};function L(n,i){if(1&n){const o=t.EpF();t.TgZ(0,"ion-accordion",15)(1,"ion-item",4)(2,"ion-label"),t._uU(3),t.qZA(),t.TgZ(4,"ion-button",0),t.NdJ("click",function(){const r=t.CHM(o),s=r.$implicit,u=r.index,d=t.oxw();return t.KtG(d.removePoint(s,u))}),t._uU(5," X "),t.qZA()(),t.TgZ(6,"div",5)(7,"ion-item-group",16),t._uU(8),t.TgZ(9,"ion-item")(10,"ion-label"),t._uU(11," Name "),t.qZA(),t._UZ(12,"ion-input",6),t.TgZ(13,"span",7),t._uU(14,"Not valid"),t.qZA()(),t.TgZ(15,"ion-item")(16,"ion-label"),t._uU(17," Title "),t.qZA(),t._UZ(18,"ion-textarea",17),t.TgZ(19,"span",7),t._uU(20,"Not valid"),t.qZA()(),t.TgZ(21,"ion-item")(22,"ion-label"),t._uU(23," Location "),t.qZA(),t._UZ(24,"ion-input",9),t.TgZ(25,"ion-button",0),t.NdJ("click",function(){const s=t.CHM(o).index,u=t.oxw();return t.KtG(u.selectPointLocation(s))}),t._uU(26,"select"),t.qZA(),t.TgZ(27,"span",7),t._uU(28,"Not valid"),t.qZA()(),t.TgZ(29,"ion-item"),t._UZ(30,"ion-checkbox",18),t.TgZ(31,"ion-label"),t._uU(32," Visible "),t.qZA()(),t.ynx(33,19),t.TgZ(34,"ion-item")(35,"ion-label"),t._uU(36," Text "),t.qZA(),t._UZ(37,"ion-textarea",20),t.TgZ(38,"span",7),t._uU(39,"Not valid"),t.qZA()(),t.YNc(40,V,7,0,"ng-container",14),t.YNc(41,Y,19,0,"ng-container",14),t.TgZ(42,"ion-item")(43,"ion-label"),t._uU(44," After Explored "),t.qZA(),t._UZ(45,"ion-textarea",21),t.TgZ(46,"span",7),t._uU(47,"Not valid"),t.qZA()(),t.TgZ(48,"ion-item")(49,"ion-label"),t._uU(50," Enables "),t.qZA(),t._UZ(51,"ion-textarea",22),t.TgZ(52,"span",7),t._uU(53,"Not valid"),t.qZA()(),t.TgZ(54,"ion-item")(55,"ion-label"),t._uU(56," Disables "),t.qZA(),t._UZ(57,"ion-textarea",23),t.TgZ(58,"span",7),t._uU(59,"Not valid"),t.qZA()(),t.BQk(),t.qZA()()()}if(2&n){const o=i.$implicit,e=i.index;t.Q6J("value",e),t.xp6(3),t.hij(" ",o.value.name,""),t.xp6(4),t.Q6J("formGroupName",e),t.xp6(1),t.hij(" ",o.value.type," "),t.xp6(32),t.Q6J("ngIf","multiplechoice"===o.value.type),t.xp6(1),t.Q6J("ngIf",t.DdM(6,$).includes(o.value.type))}}function R(n,i){if(1&n){const o=t.EpF();t.TgZ(0,"div",28)(1,"app-coordinate-select-wrapper",29),t.NdJ("coordinateSelected",function(r){t.CHM(o);const s=t.oxw();return t.KtG(s.coordinateSelected(r))}),t.qZA()()}if(2&n){const o=t.oxw();t.xp6(1),t.Q6J("startPoint",o.lastUsed)}}function W(n,i){1&n&&(t.TgZ(0,"div"),t._uU(1," Point name(s) doesn't exists "),t.qZA())}function D(n,i){if(1&n&&(t.TgZ(0,"div",30),t.YNc(1,W,2,0,"div",14),t.qZA()),2&n){const o=t.oxw();t.xp6(1),t.Q6J("ngIf",o.gameForm.errors.nameNotExist)}}function H(n,i){if(1&n){const o=t.EpF();t.ynx(0),t.TgZ(1,"ion-accordion-group")(2,"ion-accordion",31)(3,"ion-item",4)(4,"ion-label"),t._uU(5,"JSON Story"),t.qZA()(),t.TgZ(6,"div",5)(7,"ion-button",0),t.NdJ("click",function(){t.CHM(o);const r=t.oxw();return t.KtG(r.copy())}),t._uU(8," Copy "),t.qZA(),t._UZ(9,"br"),t.TgZ(10,"code"),t._uU(11),t.qZA()()(),t.TgZ(12,"ion-accordion",32)(13,"ion-item",4)(14,"ion-label"),t._uU(15,"QR"),t.qZA()(),t.TgZ(16,"div",5)(17,"ion-item"),t._UZ(18,"qrcode",33),t.qZA(),t.TgZ(19,"code"),t._uU(20),t.qZA(),t._UZ(21,"br"),t.TgZ(22,"ion-button",0),t.NdJ("click",function(){t.CHM(o);const r=t.oxw();return t.KtG(r.copyUrl())}),t._uU(23," copy url "),t.qZA()()()(),t.BQk()}if(2&n){const o=t.oxw();t.xp6(11),t.hij(" ",o.jsonStory," "),t.xp6(7),t.Q6J("qrdata",o.qrData)("width",512)("errorCorrectionLevel","H"),t.xp6(2),t.hij(" ",o.qrData," ")}}const z=[{path:"",component:(()=>{class n{constructor(o,e,r,s,u,d){this.fb=o,this.gameBuilderService=e,this.gameService=r,this.onlineService=s,this.info=u,this.router=d,this.storyKey="",this.pass="",this.destroy$=new S.xQ,this.coordinateSelected$=new S.xQ,this.pointForms=this.fb.array([]),this.lastUsed=[0,0],this.showMap=!1,this.gameForm=this.fb.group({name:this.fb.control(null,[c.kI.required]),description:this.fb.control(null,[c.kI.required]),location:this.fb.control(null,[c.kI.required,C()]),points:this.pointForms},{validators:[n=>{const i=n.get("points");if(!i)return null;const o=i.value,e=o.map(s=>s.name.trim()).filter(s=>!!s);let r=-1;for(const s of o){r++;let u=N(s.body.enables);if(console.log(u,e),u&&u.some(d=>e.every(p=>!p.match(d))))return i.at(r).get("body").get("enables").setErrors({nameNotExist:!0}),{nameNotExist:!0};if(u=N(s.body.disables),u&&u.some(d=>e.every(p=>!p.match(d))))return i.at(r).get("body").get("disables").setErrors({nameNotExist:!0}),{nameNotExist:!0}}return null},n=>{const i=n.get("points");if(!i)return null;const o=i.value;let e=-1;for(const r of o)if(e++,"multiplechoice"===r.body.type){const s=r.body,u=x(s.choices),d=x(s.possibleAnswers);u&&d?!1===d.every(p=>u.includes(p))&&(i.at(e).get("body").get("choices").setErrors({noChoiceFound:!0}),i.at(e).get("body").get("possibleAnswers").setErrors({noChoiceFound:!0})):(i.at(e).get("body").get("choices").setErrors({noChoiceFound:!0}),i.at(e).get("body").get("possibleAnswers").setErrors({noChoiceFound:!0}))}return null}],updateOn:"blur"})}ngOnInit(){console.log(this.pointForms),this.coordinateSelected$.pipe((0,O.R)(this.destroy$)).subscribe(o=>{this.lastUsed=o})}ngOnDestroy(){this.destroy$.next(),this.destroy$.unsubscribe()}selectLocation(o){return(0,m.mG)(this,void 0,void 0,function*(){this.showMap=!0;const e=yield this.coordinateSelected$.pipe((0,T.P)()).toPromise();this.gameForm.controls.location.patchValue(JSON.stringify(e)),this.showMap=!1})}selectPointLocation(o){return(0,m.mG)(this,void 0,void 0,function*(){this.showMap=!0;const e=yield this.coordinateSelected$.pipe((0,T.P)()).toPromise();this.showMap=!1,this.pointForms.at(o).patchValue({location:JSON.stringify(e)})})}getPoint(o){const e={type:o,text:this.fb.control(null,[c.kI.required]),afterExplored:this.fb.control(null,[c.kI.required]),enables:this.fb.control(null,[]),disables:this.fb.control(null,[])},r={possibleAnswers:this.fb.control(null,[c.kI.required]),messageIfCorrect:this.fb.control(null,[]),messageIfIncorrect:this.fb.control(null,[])};switch(o){case"note":return this.fb.group(Object.assign({},e));case"shortanswer":return this.fb.group(Object.assign(Object.assign({},e),r));case"multiplechoice":return this.fb.group(Object.assign(Object.assign(Object.assign({},e),r),{choices:this.fb.control(null,[c.kI.required])}))}}addPoint(o){const e=this.fb.group({name:this.fb.control(`point${this.pointForms.length+1}`,[]),title:this.fb.control(null,[]),location:this.fb.control(null,[c.kI.required,C()]),visible:this.fb.control(!0,[]),type:o,body:this.getPoint(o)});this.pointForms.push(e)}removePoint(o,e){return(0,m.mG)(this,void 0,void 0,function*(){!(yield this.info.confirm("Remove",`Are you sure to remove ${o.get("name").value}?`))||this.pointForms.removeAt(e)})}coordinateSelected(o){this.coordinateSelected$.next(o)}copy(){navigator.clipboard.writeText(JSON.stringify(this.jsonStory))}generate(){try{this.qrData=null,this.qrData=((0,t.X6Q)()?"https://localhost:8100":"https://msarica.github.io/scv")+"/#/tabs/start?storyKey="+this.storyKey}catch(o){this.info.alert(o.message)}}copyUrl(){navigator.clipboard.writeText(this.qrData),this.info.alert("copied")}onSubmit(){return(0,m.mG)(this,void 0,void 0,function*(){if(console.log(this.gameForm),console.log(this.gameForm.value),!1===this.gameForm.valid)return console.log(this.gameForm.errors),void(this.jsonStory=null);const o=this.getStory(this.gameForm.value);if(o){try{this.validateStoryKey()}catch(e){return void this.info.alert(e.message)}this.jsonStory=JSON.stringify(o),yield this.onlineService.saveStory(this.storyKey.trim().toLowerCase(),this.pass,this.jsonStory).toPromise(),this.generate()}else console.log("not valid")})}validateStoryKey(){var o;if(""===(null===(o=this.storyKey)||void 0===o?void 0:o.trim()))throw new Error("StoryKey is not valid");if(this.storyKey.includes(" "))throw new Error("Key cannot contain spaces");if("MSS"!==this.pass)throw new Error("invalid passcode")}getStory(o){try{o=JSON.parse(JSON.stringify(o));const e=this.correctValues(o);return this.gameService.validateGame(e),e}catch(e){console.log(e.message),this.info.alert(e.message,"Error")}}correctValues(o){o.zoom=17,o.location=A(o.location);for(const e of o.points)e.location=A(e.location),"multiplechoice"===e.body.type?(e.body.choices=g(e.body.choices),e.body.possibleAnswers=g(e.body.possibleAnswers)):"shortanswer"===e.body.type&&(e.body.possibleAnswers=g(e.body.possibleAnswers)),e.body.enables=g(e.body.enables),e.body.disables=g(e.body.disables);return o}correctValuesToForm(o){o.location=U(o.location);for(const e of o.points)e.location=U(e.location),"multiplechoice"===e.body.type?(e.body.choices=h(e.body.choices),e.body.possibleAnswers=h(e.body.possibleAnswers)):"shortanswer"===e.body.type&&(e.body.possibleAnswers=h(e.body.possibleAnswers)),e.body.enables=h(e.body.enables),e.body.disables=h(e.body.disables);return o}parseJson(o){return o=o.replace(/\/\/.*$/g,""),JSON.parse(o)}loadFromJson(){return(0,m.mG)(this,void 0,void 0,function*(){try{const o=yield this.info.input("JSON");let e=this.parseJson(o);this.gameService.validateGame(e),e=this.correctValuesToForm(e),e.points.forEach(r=>{this.addPoint(r.body.type?r.body.type:"note")}),this.gameForm.patchValue(e)}catch(o){this.info.alert(o.message,"Error")}})}}return n.\u0275fac=function(o){return new(o||n)(t.Y36(c.qu),t.Y36(G.y),t.Y36(I.h),t.Y36(j.x),t.Y36(K.C),t.Y36(_.F0))},n.\u0275cmp=t.Xpm({type:n,selectors:[["app-story-builder"]],decls:60,vars:8,consts:[[3,"click"],["type","text",3,"ngModel","ngModelChange"],[3,"formGroup","hidden"],["value","first"],["slot","header","color","light"],["slot","content",1,"ion-padding"],["type","text","formControlName","name"],["slot","error"],["formControlName","description"],["type","text","formControlName","location"],["formArrayName","points"],[3,"value",4,"ngFor","ngForOf"],["style","width: 70%",4,"ngIf"],["style","color: red;",4,"ngIf"],[4,"ngIf"],[3,"value"],[3,"formGroupName"],["formControlName","title"],["slot","start","formControlName","visible"],["formGroupName","body"],["formControlName","text"],["formControlName","afterExplored"],["formControlName","enables"],["formControlName","disables"],["formControlName","choices"],["formControlName","possibleAnswers"],["formControlName","messageIfCorrect"],["formControlName","messageIfIncorrect"],[2,"width","70%"],[3,"startPoint","coordinateSelected"],[2,"color","red"],["value","json"],["value","qr"],[3,"qrdata","width","errorCorrectionLevel"]],template:function(o,e){1&o&&(t.TgZ(0,"ion-header")(1,"ion-toolbar")(2,"ion-title"),t._uU(3,"story-builder"),t.qZA()()(),t.TgZ(4,"ion-content")(5,"ion-button",0),t.NdJ("click",function(){return e.loadFromJson()}),t._uU(6," Load From Json "),t.qZA(),t.TgZ(7,"ion-item")(8,"ion-label"),t._uU(9," Pass "),t.qZA(),t.TgZ(10,"ion-input",1),t.NdJ("ngModelChange",function(s){return e.pass=s}),t.qZA()(),t.TgZ(11,"ion-item")(12,"ion-label"),t._uU(13," StoryKey "),t.qZA(),t.TgZ(14,"ion-input",1),t.NdJ("ngModelChange",function(s){return e.storyKey=s}),t.qZA()(),t.TgZ(15,"ion-item-divider")(16,"ion-label"),t._uU(17," Points "),t.qZA(),t.TgZ(18,"ion-button",0),t.NdJ("click",function(){return e.addPoint("note")}),t._uU(19," Note "),t.qZA(),t.TgZ(20,"ion-button",0),t.NdJ("click",function(){return e.addPoint("shortanswer")}),t._uU(21," Short Answer "),t.qZA(),t.TgZ(22,"ion-button",0),t.NdJ("click",function(){return e.addPoint("multiplechoice")}),t._uU(23," Multiple Choice "),t.qZA()(),t.TgZ(24,"ion-accordion-group",2)(25,"ion-accordion",3)(26,"ion-item",4)(27,"ion-label"),t._uU(28,"Game Details"),t.qZA()(),t.TgZ(29,"div",5)(30,"ion-item-group")(31,"ion-item")(32,"ion-label"),t._uU(33," Name "),t.qZA(),t._UZ(34,"ion-input",6),t.TgZ(35,"span",7),t._uU(36,"Not valid"),t.qZA()(),t.TgZ(37,"ion-item")(38,"ion-label"),t._uU(39," Description "),t.qZA(),t._UZ(40,"ion-textarea",8),t.TgZ(41,"span",7),t._uU(42,"Not valid"),t.qZA()(),t.TgZ(43,"ion-item")(44,"ion-label"),t._uU(45," Location "),t.qZA(),t._UZ(46,"ion-input",9),t.TgZ(47,"ion-button",0),t.NdJ("click",function(){return e.selectLocation("location")}),t._uU(48,"select"),t.qZA(),t.TgZ(49,"span",7),t._uU(50,"Not valid"),t.qZA()()()()(),t.ynx(51,10),t.YNc(52,L,60,7,"ion-accordion",11),t.BQk(),t.qZA(),t.YNc(53,R,2,1,"div",12),t.YNc(54,D,2,1,"div",13),t.TgZ(55,"ion-button",0),t.NdJ("click",function(){return e.onSubmit()}),t._uU(56," Submit "),t.qZA(),t.YNc(57,H,24,5,"ng-container",14),t._UZ(58,"br")(59,"br"),t.qZA()),2&o&&(t.xp6(10),t.Q6J("ngModel",e.pass),t.xp6(4),t.Q6J("ngModel",e.storyKey),t.xp6(10),t.Q6J("formGroup",e.gameForm)("hidden",e.showMap),t.xp6(28),t.Q6J("ngForOf",e.pointForms.controls),t.xp6(1),t.Q6J("ngIf",e.showMap),t.xp6(1),t.Q6J("ngIf",e.gameForm.errors),t.xp6(3),t.Q6J("ngIf",e.jsonStory))},dependencies:[y.sg,y.O5,c.JJ,c.JL,c.On,l.We,l.eh,l.YG,l.nz,l.W2,l.Gu,l.pK,l.Ie,l.rH,l.Ub,l.Q$,l.g2,l.wd,l.sr,l.w,l.j9,c.sg,c.u,c.x0,c.CE,P.V,v],styles:[".pointsDiv[_ngcontent-%COMP%]{padding-left:10px}"]}),n})()},{path:"map",component:v}];let X=(()=>{class n{}return n.\u0275fac=function(o){return new(o||n)},n.\u0275mod=t.oAB({type:n}),n.\u0275inj=t.cJS({imports:[_.Bz.forChild(z),_.Bz]}),n})();var tt=a(520);let ot=(()=>{class n{}return n.\u0275fac=function(o){return new(o||n)},n.\u0275mod=t.oAB({type:n}),n.\u0275inj=t.cJS({imports:[y.ez,c.u5,l.Pc,X,c.UX,P.N,tt.JF]}),n})()}}]);