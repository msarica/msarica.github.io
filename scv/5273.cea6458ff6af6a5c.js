"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[5273],{5273:(lt,F,i)=>{i.r(F),i.d(F,{GamePage:()=>at});var y=i(5861),v=i(6814),b=i(6223),l=i(7027),A=i(4475),E=i(1828),L=i(902),w=i(5311),O=i(2620),N=i(8039),Q=i(9489),C=i(8645),g=i(9773),Y=i(6306),H=i(2096),R=i(8536),D=i(9593),I=i(8182),J=i(6093),j=i(3822),Z=i(7285),z=i(2064),x=i(3911),t=i(2029),k=i(7157),P=i(6546),G=i(8939),B=i(8001);const X=["mapElementRef"];let V=(()=>{var s;class m{constructor(e,o,n,c,r){this.locationService=e,this.gameService=o,this.info=n,this.loading=c,this.menuController=r,this.destroy$=new C.x,this.playerFeature=null,this.markerSource=null,this.features={},this.points=null,this.game$=this.gameService.gameLoaded$.pipe((0,g.R)(this.destroy$)).subscribe(a=>{this.points=null,this.setUpMap(a),this.points={},a.points.forEach(h=>{this.points[h.id]={point:h}})}),this.pointChanges$=this.gameService.pointsSnapshot$.pipe((0,g.R)(this.destroy$)).subscribe(a=>{this.latestUpdate=a,this.updateMarkers()})}updateMarkers(){if(!this.points||!this.latestUpdate)return;const e=this.latestUpdate;Object.keys(e).forEach(o=>{const n=e[o],c=this.points[o];if(!c)return void console.debug(o," not found");const r=c.point,a=r.id,h=r.img||Z.PP.point,u=n.explored?Z.PP.explored:n.selectable?h:Z.PP.notSelectable;var p;if(!n.enabled||this.features[a])if(n.enabled||!this.features[a])if(n.explored&&this.features[a])null===(p=this.features[a])||void 0===p||p.setStyle(this.getStyle(Z.PP.explored));else if(n.selectable&&this.features[a]){var f,S;null===(f=this.features[a])||void 0===f||f.setStyle(this.getStyle(h)),(null===(S=this.features[a])||void 0===S?void 0:S.get("data")).notSelectable=!1}else if(n.selectable||!this.features[a]);else{var T,U;null===(T=this.features[a])||void 0===T||T.setStyle(this.getStyle(Z.PP.notSelectable)),(null===(U=this.features[a])||void 0===U?void 0:U.get("data")).notSelectable=!0}else this.removeMarker(a);else this.addMarker(r.location,{img:u,clickable:!0,pointId:a,location:r.location,notSelectable:!n.selectable})})}ngOnInit(){var e=this;return(0,y.Z)(function*(){e.setupSubscriptions()})()}setupSubscriptions(){var e=this;return(0,y.Z)(function*(){const o=yield e.info.translate("Loading...\nSetting up markers"),n=yield e.loading.present2(o,2e5);e.locationService.watchLocation().pipe((0,g.R)(e.destroy$),(0,Y.K)(r=>(console.log(r),n.dismiss(),(0,H.of)(null)))).subscribe(r=>{r&&(e.lastUserLocation||n.dismiss(),e.lastUserLocation=r,e.playerFeature&&e.updateUserLocation(r))}),e.gameService.gameEnded$.pipe((0,g.R)(e.destroy$)).subscribe(r=>{e.info.alert(r.finishMessage,"END")})})()}setUpMap(e){this.map&&(this.map.dispose(),this.markerSource.dispose(),this.playerFeature.dispose(),this.features={},this.markerSource=null,this.playerFeature=null),(0,z.eL)();const o=e.zoom,n=e.location,c=new N.Z({collapsible:!0});this.map=new A.Z({view:new E.ZP({center:n,zoom:o}),layers:[new O.Z({source:new R.Z})],target:"ol-map",controls:(0,Q.c)({attribution:!1}).extend([c])}),c.setCollapsible(!0),c.setCollapsed(!0);const r=new D.Z({features:[]});this.markerSource=r;const a=new I.Z({source:r});this.map.addLayer(a),this.playerFeature=this.setUpUser(),this.lastUserLocation&&this.updateUserLocation(this.lastUserLocation),this.map.on("moveend",h=>{var u;null===(u=this.map)||void 0===u||u.getView().getZoom()}),this.map.on("click",h=>{var u;const p=null===(u=this.map)||void 0===u?void 0:u.forEachFeatureAtPixel(h.pixel,f=>f);p&&this.onFeatureClicked(h,p)}),setTimeout(()=>{var h,u;null===(h=this.map)||void 0===h||h.setTarget(null===(u=this.mapElementRef)||void 0===u?void 0:u.nativeElement)})}onFeatureClicked(e,o){var n,c;if(!o)throw new Error("feature not found");if(!this.playerFeature)throw new Error("user location not found yet");const r=o.get("data");if(!r.clickable)return;const a=null===(n=o.getGeometry())||void 0===n?void 0:n.getCoordinates(),h=null===(c=this.playerFeature.getGeometry())||void 0===c?void 0:c.getCoordinates();if(!a||!h)throw new Error(`featureCoord ${a} userCoord ${h}`);const f=this.locationService.distance(a[1],h[1],a[0],h[0]),S=this.gameService.isCloseEnough(f);console.log(f,S),this.gameService.pointSelected({pointId:r.pointId,point:this.points[r.pointId].point,distance:f,isClose:S,notSelectable:r.notSelectable})}setUpUser(e){return this.addMarker([0,0],{clickable:!1,img:Z.PP.current})}ngOnDestroy(){console.debug("destroying map component"),this.destroy$.next(),this.destroy$.unsubscribe()}getStyle(e){return new J.ZP({image:new j.Z({anchor:[.5,.5],anchorXUnits:"fraction",anchorYUnits:"fraction",size:[70,70],src:e})})}addMarker(e,o){if(!o)throw new Error("Data not found");const[n,c]=e,a=new L.Z({geometry:new w.Z([n,c]),data:o}),h=this.getStyle(o.img);a.setStyle(h),this.markerSource.addFeature(a);const u=o.pointId;return this.features[u]&&this.markerSource.removeFeature(this.features[u]),this.features[u]=a,a}removeMarker(e){if(!e)throw new Error("pointid cannot be null");const o=this.features[e];if(!o)throw new Error("feature not found");this.markerSource.removeFeature(o),delete this.features[e]}updateUserLocation(e){var o;if(!this.playerFeature)throw new Error("player not present");console.log(e);const n=this.locationService.transformFromGeoLocation(e);null===(o=this.playerFeature.getGeometry())||void 0===o||o.setCoordinates(n)}}return(s=m).\u0275fac=function(e){return new(e||s)(t.Y36(k.a),t.Y36(P.h),t.Y36(G.C),t.Y36(B.b),t.Y36(l._q))},s.\u0275cmp=t.Xpm({type:s,selectors:[["app-map"]],viewQuery:function(e,o){if(1&e&&t.Gf(X,7),2&e){let n;t.iGM(n=t.CRH())&&(o.mapElementRef=n.first)}},standalone:!0,features:[t.jDz],decls:3,vars:0,consts:[["id","ol-map",1,"map-container"],["mapElementRef",""]],template:function(e,o){1&e&&(t.ynx(0),t._UZ(1,"div",0,1),t.BQk())},dependencies:[l.Pc,b.u5,x.aw,v.ez],styles:["[_nghost-%COMP%]{display:flex;flex-grow:1;flex-direction:column;height:86vh}.map-container[_ngcontent-%COMP%]{flex-grow:1}"],changeDetection:0}),m})();var K=i(5619),$=i(8658),W=i(9025);const q=["accordionGroup"];function _(s,m){if(1&s&&(t.TgZ(0,"ion-accordion",8)(1,"ion-item",1)(2,"ion-label"),t._uU(3),t.qZA()(),t.TgZ(4,"div",9),t._UZ(5,"app-story-history-item",10),t.qZA()()),2&s){const d=m.$implicit,e=m.index;t.Q6J("value",e),t.xp6(3),t.Oqu(d.title),t.xp6(2),t.Q6J("item",d)("index",e)("showHeader",!1)}}function tt(s,m){1&s&&(t.TgZ(0,"ion-card")(1,"ion-card-header")(2,"ion-card-title"),t._uU(3),t.ALo(4,"translate"),t.qZA()(),t.TgZ(5,"ion-card-content"),t._uU(6),t.ALo(7,"translate"),t.qZA()()),2&s&&(t.xp6(3),t.Oqu(t.lcZ(4,2,"No History")),t.xp6(3),t.hij(" ",t.lcZ(7,4,"No history found yet")," "))}let et=(()=>{var s;class m{constructor(e){this.gameService=e,this.destroy$=new C.x,this.points={},this.gameName="",this.hist=[],this.game$=this.gameService.gameLoaded$.pipe((0,g.R)(this.destroy$)).subscribe(o=>{this.gameName=o.name,this.gameDescription=o.description,this.points={},o.points.forEach(n=>{this.points[n.id]=n})}),this.gameHistory$=this.gameService.historyChanged$.pipe((0,g.R)(this.destroy$)).subscribe(o=>{this.hist=[],o.history.forEach(n=>{this.hist.push($.H.toHistItem(this.points[n.pointId],n))})})}ngOnInit(){}ngOnDestroy(){console.debug("destroying story-history"),this.destroy$.next(),this.destroy$.unsubscribe()}}return(s=m).\u0275fac=function(e){return new(e||s)(t.Y36(P.h))},s.\u0275cmp=t.Xpm({type:s,selectors:[["app-story-history"]],viewQuery:function(e,o){if(1&e&&t.Gf(q,7),2&e){let n;t.iGM(n=t.CRH())&&(o.accordionGroup=n.first)}},standalone:!0,features:[t.jDz],decls:12,vars:4,consts:[["value","first"],["slot","header","color","light"],["slot","content",1,"ion-padding"],[3,"bodyText"],["multiple","true"],["accordionGroup",""],[3,"value",4,"ngFor","ngForOf"],[4,"ngIf"],[3,"value"],["slot","content"],[3,"item","index","showHeader"]],template:function(e,o){1&e&&(t.TgZ(0,"ion-accordion-group")(1,"ion-accordion",0)(2,"ion-item",1)(3,"ion-label"),t._uU(4),t.qZA()(),t.TgZ(5,"div",2),t._UZ(6,"app-html-show",3),t.qZA()()(),t._UZ(7,"hr"),t.TgZ(8,"ion-accordion-group",4,5),t.YNc(10,_,6,5,"ion-accordion",6),t.qZA(),t.YNc(11,tt,8,6,"ion-card",7)),2&e&&(t.xp6(4),t.Oqu(o.gameName),t.xp6(2),t.Q6J("bodyText",o.gameDescription),t.xp6(4),t.Q6J("ngForOf",o.hist),t.xp6(1),t.Q6J("ngIf",!(null!=o.hist&&o.hist.length)))},dependencies:[l.Pc,l.We,l.eh,l.PM,l.FN,l.Zi,l.Dq,l.Ie,l.Q$,v.ez,v.sg,v.O5,b.u5,x.aw,x.X$,$.H,W.u]}),m})();var ot=i(662),nt=i(3308);function it(s,m){if(1&s&&(t.ynx(0),t._UZ(1,"app-game-point",13),t.BQk()),2&s){const d=t.oxw();t.xp6(1),t.Q6J("selectedPoint",d.selectedPoint)}}function st(s,m){if(1&s){const d=t.EpF();t.TgZ(0,"ion-button",9),t.NdJ("click",function(){t.CHM(d);const o=t.oxw();return t.KtG(o.goBack2Builder())}),t._uU(1),t.ALo(2,"translate"),t.qZA()}2&s&&(t.xp6(1),t.hij(" ",t.lcZ(2,1,"To Builder")," "))}function rt(s,m){1&s&&(t.ynx(0),t._UZ(1,"app-map"),t.BQk())}let at=(()=>{var s;class m{constructor(e,o,n,c){this.gameService=e,this.menuController=o,this.info=n,this.storage=c,this.gameName="",this.destroy$=new C.x,this.title$=new K.X("Menu"),this.isTestingGame=!1,this.askForExit=!0,this.pointSelected$=this.gameService.pointSelected$.pipe((0,g.R)(this.destroy$)).subscribe(r=>{this.selectedPoint=r,this.openPointMenu()})}ngOnInit(){this.gameService.gameLoaded$.pipe((0,g.R)(this.destroy$)).subscribe(e=>{this.gameName=e.name,this.game=e}),this.gameService.closeMenu$.pipe((0,g.R)(this.destroy$)).subscribe(()=>{this.closeMenu()})}ngOnDestroy(){console.debug("destroying gamepage"),this.destroy$.next(),this.destroy$.unsubscribe()}openMenu(e){var o=this;return(0,y.Z)(function*(){const c=["point","story"].map(r=>o.menuController.enable(r===e,r));yield Promise.all(c),o.menuController.open()})()}openStory(){var e=this;return(0,y.Z)(function*(){yield e.closeMenu(),e.openMenu("story")})()}openPointMenu(){var e=this;return(0,y.Z)(function*(){yield e.closeMenu(),e.openMenu("point")})()}ionViewDidEnter(){var e=this;return(0,y.Z)(function*(){e.closeMenu(),e.isTestingGame=e.gameService.isTestingGame,e.askForExit=!0})()}goBack2Builder(){this.askForExit=!1,this.gameService.endTestGame()}closeMenu(){var e=this;return(0,y.Z)(function*(){const o="point";yield e.menuController.enable(!0,o),yield e.menuController.close(o)})()}canLeave(){var e=this;return(0,y.Z)(function*(){return!e.askForExit||!!(yield e.info.confirmYesNo("Leave Game","Are you sure to leave?"))})()}}return(s=m).\u0275fac=function(e){return new(e||s)(t.Y36(P.h),t.Y36(l._q),t.Y36(G.C),t.Y36(nt.V))},s.\u0275cmp=t.Xpm({type:s,selectors:[["app-game"]],standalone:!0,features:[t.jDz],decls:40,vars:20,consts:[["menuId","point","contentId","main-content"],[1,"ion-text-center"],["slot","secondary"],[4,"ngIf"],["menuId","story","contentId","main-content"],[1,"ion-padding"],["id","main-content",3,"translucent"],["slot","primary"],[3,"click",4,"ngIf"],[3,"click"],[3,"fullscreen"],["collapse","condense"],["size","large"],[3,"selectedPoint"]],template:function(e,o){1&e&&(t.TgZ(0,"ion-menu",0)(1,"ion-header",1)(2,"ion-toolbar")(3,"ion-buttons",2)(4,"ion-menu-toggle")(5,"ion-button"),t._uU(6),t.ALo(7,"translate"),t.qZA()()(),t.TgZ(8,"ion-title"),t._uU(9),t.ALo(10,"async"),t.qZA()()(),t.TgZ(11,"ion-content"),t.YNc(12,it,2,1,"ng-container",3),t.qZA()(),t.TgZ(13,"ion-menu",4)(14,"ion-header",1)(15,"ion-toolbar")(16,"ion-buttons",2)(17,"ion-menu-toggle")(18,"ion-button"),t._uU(19),t.ALo(20,"translate"),t.qZA()()(),t.TgZ(21,"ion-title"),t._uU(22),t.qZA()()(),t.TgZ(23,"ion-content",5),t._UZ(24,"app-story-history"),t.qZA()(),t.TgZ(25,"ion-header",6)(26,"ion-toolbar")(27,"ion-title"),t._uU(28),t.qZA(),t.TgZ(29,"ion-buttons",7),t.YNc(30,st,3,3,"ion-button",8),t.TgZ(31,"ion-button",9),t.NdJ("click",function(){return o.openStory()}),t._uU(32),t.ALo(33,"translate"),t.qZA()()()(),t.TgZ(34,"ion-content",10)(35,"ion-header",11)(36,"ion-toolbar")(37,"ion-title",12),t._uU(38),t.qZA()()(),t.YNc(39,rt,2,0,"ng-container",3),t.qZA()),2&e&&(t.xp6(6),t.Oqu(t.lcZ(7,12,"Close")),t.xp6(3),t.Oqu(t.lcZ(10,14,o.title$)),t.xp6(3),t.Q6J("ngIf",o.selectedPoint),t.xp6(7),t.Oqu(t.lcZ(20,16,"Close")),t.xp6(3),t.Oqu(null==o.game?null:o.game.name),t.xp6(3),t.Q6J("translucent",!0),t.xp6(3),t.hij(" ",o.gameName," "),t.xp6(2),t.Q6J("ngIf",o.isTestingGame),t.xp6(2),t.hij(" ",t.lcZ(33,18,"Story")," "),t.xp6(2),t.Q6J("fullscreen",!0),t.xp6(4),t.hij(" ",o.gameName," "),t.xp6(1),t.Q6J("ngIf",o.game))},dependencies:[l.Pc,l.YG,l.Sm,l.W2,l.Gu,l.z0,l.zc,l.wd,l.sr,v.ez,v.O5,v.Ov,b.u5,x.aw,x.X$,V,et,ot.v]}),m})()}}]);