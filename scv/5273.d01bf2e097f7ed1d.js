"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[5273],{5273:(ie,$,i)=>{i.r($),i.d($,{GamePage:()=>ne});var y=i(5861),v=i(6814),C=i(95),l=i(7027),G=i(4475),E=i(1828),L=i(902),A=i(5311),w=i(2620),O=i(8039),N=i(9489),b=i(8645),g=i(9773),Q=i(6306),D=i(2096),H=i(8536),R=i(9593),Y=i(8182),z=i(6093),I=i(3822),S=i(7285),j=i(2064),e=i(6689),J=i(7157),U=i(6546),T=i(8939),k=i(8001);const V=["mapElementRef"];let X=(()=>{var a;class m{constructor(t,o,n,s,u){this.locationService=t,this.gameService=o,this.info=n,this.loading=s,this.menuController=u,this.destroy$=new b.x,this.playerFeature=null,this.markerSource=null,this.features={},this.points=null,this.game$=this.gameService.gameLoaded$.pipe((0,g.R)(this.destroy$)).subscribe(r=>{this.points=null,this.setUpMap(r),this.points={},r.points.forEach(h=>{this.points[h.id]={point:h}}),this.updateMarkers()}),this.pointChanges$=this.gameService.pointsSnapshot$.pipe((0,g.R)(this.destroy$)).subscribe(r=>{this.latestUpdate=r,this.updateMarkers()})}updateMarkers(){if(!this.points||!this.latestUpdate)return;const t=this.latestUpdate;Object.keys(t).forEach(o=>{const n=t[o],s=this.points[o];if(!s)return void console.debug(o," not found");const u=s.point,r=u.id,h=u.img||S.P.point,c=n.explored?S.P.explored:n.selectable?h:S.P.notSelectable;var p;if(!n.enabled||this.features[r])if(n.enabled||!this.features[r])if(n.explored&&this.features[r])null===(p=this.features[r])||void 0===p||p.setStyle(this.getStyle(S.P.explored));else if(n.selectable&&this.features[r]){var f,Z;null===(f=this.features[r])||void 0===f||f.setStyle(this.getStyle(h)),(null===(Z=this.features[r])||void 0===Z?void 0:Z.get("data")).notSelectable=!1}else if(n.selectable||!this.features[r]);else{var M,x;null===(M=this.features[r])||void 0===M||M.setStyle(this.getStyle(S.P.notSelectable)),(null===(x=this.features[r])||void 0===x?void 0:x.get("data")).notSelectable=!0}else this.removeMarker(r);else this.addMarker(u.location,{img:c,clickable:!0,pointId:r,location:u.location,notSelectable:!n.selectable})})}ngOnInit(){var t=this;return(0,y.Z)(function*(){t.setupSubscriptions()})()}setupSubscriptions(){var t=this;return(0,y.Z)(function*(){const o=yield t.loading.present2("Loading...\nSetting up markers",2e5);t.locationService.watchLocation().pipe((0,g.R)(t.destroy$),(0,Q.K)(s=>(console.log(s),o.dismiss(),(0,D.of)(null)))).subscribe(s=>{s&&(t.lastUserLocation||o.dismiss(),t.lastUserLocation=s,t.playerFeature&&t.updateUserLocation(s))}),t.gameService.gameEnded$.pipe((0,g.R)(t.destroy$)).subscribe(s=>{t.info.alert(s.finishMessage,"END")})})()}setUpMap(t){this.map&&(this.map.dispose(),this.features={},this.markerSource=null,this.playerFeature=null),(0,j.eL)();const o=t.zoom,n=t.location,s=new O.Z({collapsible:!0});this.map=new G.Z({view:new E.ZP({center:n,zoom:o}),layers:[new w.Z({source:new H.Z})],target:"ol-map",controls:(0,N.c)({attribution:!1}).extend([s])}),s.setCollapsible(!0),s.setCollapsed(!0);const u=new R.Z({features:[]});this.markerSource=u;const r=new Y.Z({source:u});this.map.addLayer(r),this.playerFeature=this.setUpUser(),this.lastUserLocation&&this.updateUserLocation(this.lastUserLocation),this.map.on("moveend",h=>{var c;null===(c=this.map)||void 0===c||c.getView().getZoom()}),this.map.on("click",h=>{var c;const p=null===(c=this.map)||void 0===c?void 0:c.forEachFeatureAtPixel(h.pixel,f=>f);p&&this.onFeatureClicked(h,p)}),setTimeout(()=>{var h,c;null===(h=this.map)||void 0===h||h.setTarget(null===(c=this.mapElementRef)||void 0===c?void 0:c.nativeElement)})}onFeatureClicked(t,o){var n,s;if(!o)throw new Error("feature not found");if(!this.playerFeature)throw new Error("user location not found yet");const u=o.get("data");if(!u.clickable)return;const r=null===(n=o.getGeometry())||void 0===n?void 0:n.getCoordinates(),h=null===(s=this.playerFeature.getGeometry())||void 0===s?void 0:s.getCoordinates();if(!r||!h)throw new Error(`featureCoord ${r} userCoord ${h}`);const f=this.locationService.distance(r[1],h[1],r[0],h[0]),Z=this.gameService.isCloseEnough(f);console.log(f,Z),this.gameService.pointSelected({pointId:u.pointId,point:this.points[u.pointId].point,distance:f,isClose:Z,notSelectable:u.notSelectable})}setUpUser(t){return this.addMarker([0,0],{clickable:!1,img:S.P.current})}ngOnDestroy(){console.debug("destroying map component"),this.destroy$.next(),this.destroy$.unsubscribe()}getStyle(t){return new z.ZP({image:new I.Z({anchor:[.5,.5],anchorXUnits:"fraction",anchorYUnits:"fraction",size:[70,70],src:t})})}addMarker(t,o){if(!o)throw new Error("Data not found");const[n,s]=t,r=new L.Z({geometry:new A.Z([n,s]),data:o}),h=this.getStyle(o.img);r.setStyle(h),this.markerSource.addFeature(r);const c=o.pointId;return this.features[c]&&this.markerSource.removeFeature(this.features[c]),this.features[c]=r,r}removeMarker(t){if(!t)throw new Error("pointid cannot be null");const o=this.features[t];if(!o)throw new Error("feature not found");this.markerSource.removeFeature(o),delete this.features[t]}updateUserLocation(t){var o;if(!this.playerFeature)throw new Error("player not present");console.log(t);const n=this.locationService.transformFromGeoLocation(t);null===(o=this.playerFeature.getGeometry())||void 0===o||o.setCoordinates(n)}}return(a=m).\u0275fac=function(t){return new(t||a)(e.Y36(J.a),e.Y36(U.h),e.Y36(T.C),e.Y36(k.b),e.Y36(l._q))},a.\u0275cmp=e.Xpm({type:a,selectors:[["app-map"]],viewQuery:function(t,o){if(1&t&&e.Gf(V,7),2&t){let n;e.iGM(n=e.CRH())&&(o.mapElementRef=n.first)}},standalone:!0,features:[e.jDz],decls:3,vars:0,consts:[["id","ol-map",1,"map-container"],["mapElementRef",""]],template:function(t,o){1&t&&(e.ynx(0),e._UZ(1,"div",0,1),e.BQk())},dependencies:[l.Pc,C.u5,v.ez],styles:["[_nghost-%COMP%]{display:flex;flex-grow:1;flex-direction:column;height:86vh}.map-container[_ngcontent-%COMP%]{flex-grow:1}"],changeDetection:0}),m})();var B=i(5619),F=i(8658);const W=["accordionGroup"];function K(a,m){if(1&a&&(e.TgZ(0,"ion-accordion",7)(1,"ion-item",1)(2,"ion-label"),e._uU(3),e.qZA()(),e.TgZ(4,"div",8),e._UZ(5,"app-story-history-item",9),e.qZA()()),2&a){const d=m.$implicit,t=m.index;e.Q6J("value",t),e.xp6(3),e.Oqu(d.title),e.xp6(2),e.Q6J("item",d)("index",t)("showHeader",!1)}}function q(a,m){1&a&&(e.TgZ(0,"ion-card")(1,"ion-card-header")(2,"ion-card-title"),e._uU(3,"No History"),e.qZA()(),e.TgZ(4,"ion-card-content"),e._uU(5," No history found yet "),e.qZA()())}let _=(()=>{var a;class m{constructor(t){this.gameService=t,this.destroy$=new b.x,this.points={},this.gameName="",this.gameDescription="",this.hist=[],this.game$=this.gameService.gameLoaded$.pipe((0,g.R)(this.destroy$)).subscribe(o=>{this.gameName=o.name,this.gameDescription=o.description,this.points={},o.points.forEach(n=>{this.points[n.id]=n})}),this.gameHistory$=this.gameService.historyChanged$.pipe((0,g.R)(this.destroy$)).subscribe(o=>{this.hist=[],o.history.forEach(n=>{this.hist.push(F.H.toHistItem(this.points[n.pointId],n))})})}ngOnInit(){}ngOnDestroy(){console.debug("destroying story-history"),this.destroy$.next(),this.destroy$.unsubscribe()}}return(a=m).\u0275fac=function(t){return new(t||a)(e.Y36(U.h))},a.\u0275cmp=e.Xpm({type:a,selectors:[["app-story-history"]],viewQuery:function(t,o){if(1&t&&e.Gf(W,7),2&t){let n;e.iGM(n=e.CRH())&&(o.accordionGroup=n.first)}},standalone:!0,features:[e.jDz],decls:12,vars:4,consts:[["value","first"],["slot","header","color","light"],["slot","content",1,"ion-padding"],["multiple","true"],["accordionGroup",""],[3,"value",4,"ngFor","ngForOf"],[4,"ngIf"],[3,"value"],["slot","content"],[3,"item","index","showHeader"]],template:function(t,o){1&t&&(e.TgZ(0,"ion-accordion-group")(1,"ion-accordion",0)(2,"ion-item",1)(3,"ion-label"),e._uU(4),e.qZA()(),e.TgZ(5,"div",2),e._uU(6),e.qZA()()(),e._UZ(7,"hr"),e.TgZ(8,"ion-accordion-group",3,4),e.YNc(10,K,6,5,"ion-accordion",5),e.qZA(),e.YNc(11,q,6,0,"ion-card",6)),2&t&&(e.xp6(4),e.Oqu(o.gameName),e.xp6(2),e.hij(" ",o.gameDescription," "),e.xp6(4),e.Q6J("ngForOf",o.hist),e.xp6(1),e.Q6J("ngIf",!(null!=o.hist&&o.hist.length)))},dependencies:[l.Pc,l.We,l.eh,l.PM,l.FN,l.Zi,l.Dq,l.Ie,l.Q$,v.ez,v.sg,v.O5,C.u5,F.H]}),m})();var ee=i(662);function te(a,m){if(1&a&&(e.ynx(0),e._UZ(1,"app-game-point",12),e.BQk()),2&a){const d=e.oxw();e.xp6(1),e.Q6J("selectedPoint",d.selectedPoint)}}function oe(a,m){1&a&&(e.ynx(0),e._UZ(1,"app-map"),e.BQk())}let ne=(()=>{var a;class m{constructor(t,o,n){this.gameService=t,this.menuController=o,this.info=n,this.gameName="",this.destroy$=new b.x,this.title$=new B.X("Menu"),this.pointSelected$=this.gameService.pointSelected$.pipe((0,g.R)(this.destroy$)).subscribe(s=>{this.selectedPoint=s,this.openPointMenu()})}ngOnInit(){this.gameService.gameLoaded$.pipe((0,g.R)(this.destroy$)).subscribe(t=>{this.gameName=t.name,this.game=t}),this.gameService.closeMenu$.pipe((0,g.R)(this.destroy$)).subscribe(()=>{this.closeMenu()})}ngOnDestroy(){console.debug("destroying gamepage"),this.destroy$.next(),this.destroy$.unsubscribe()}openMenu(t){var o=this;return(0,y.Z)(function*(){const s=["point","story"].map(u=>o.menuController.enable(u===t,u));yield Promise.all(s),o.menuController.open()})()}openStory(){var t=this;return(0,y.Z)(function*(){yield t.closeMenu(),t.openMenu("story")})()}openPointMenu(){var t=this;return(0,y.Z)(function*(){yield t.closeMenu(),t.openMenu("point")})()}ionViewDidEnter(){var t=this;return(0,y.Z)(function*(){t.closeMenu()})()}closeMenu(){var t=this;return(0,y.Z)(function*(){const o="point";yield t.menuController.enable(!0,o),yield t.menuController.close(o)})()}canLeave(){var t=this;return(0,y.Z)(function*(){var o;return!!(yield t.info.confirmYesNo("Leave Game",`Are you sure to leave ${null===(o=t.game)||void 0===o?void 0:o.name}`))})()}}return(a=m).\u0275fac=function(t){return new(t||a)(e.Y36(U.h),e.Y36(l._q),e.Y36(T.C))},a.\u0275cmp=e.Xpm({type:a,selectors:[["app-game"]],standalone:!0,features:[e.jDz],decls:36,vars:10,consts:[["menuId","point","contentId","main-content"],[1,"ion-text-center"],["slot","secondary"],[4,"ngIf"],["menuId","story","contentId","main-content"],[1,"ion-padding"],["id","main-content",3,"translucent"],["slot","primary"],[3,"click"],[3,"fullscreen"],["collapse","condense"],["size","large"],[3,"selectedPoint"]],template:function(t,o){1&t&&(e.TgZ(0,"ion-menu",0)(1,"ion-header",1)(2,"ion-toolbar")(3,"ion-buttons",2)(4,"ion-menu-toggle")(5,"ion-button"),e._uU(6,"Close"),e.qZA()()(),e.TgZ(7,"ion-title"),e._uU(8),e.ALo(9,"async"),e.qZA()()(),e.TgZ(10,"ion-content"),e.YNc(11,te,2,1,"ng-container",3),e.qZA()(),e.TgZ(12,"ion-menu",4)(13,"ion-header",1)(14,"ion-toolbar")(15,"ion-buttons",2)(16,"ion-menu-toggle")(17,"ion-button"),e._uU(18,"Close"),e.qZA()()(),e.TgZ(19,"ion-title"),e._uU(20),e.qZA()()(),e.TgZ(21,"ion-content",5),e._UZ(22,"app-story-history"),e.qZA()(),e.TgZ(23,"ion-header",6)(24,"ion-toolbar")(25,"ion-title"),e._uU(26),e.qZA(),e.TgZ(27,"ion-buttons",7)(28,"ion-button",8),e.NdJ("click",function(){return o.openStory()}),e._uU(29," Story "),e.qZA()()()(),e.TgZ(30,"ion-content",9)(31,"ion-header",10)(32,"ion-toolbar")(33,"ion-title",11),e._uU(34),e.qZA()()(),e.YNc(35,oe,2,0,"ng-container",3),e.qZA()),2&t&&(e.xp6(8),e.Oqu(e.lcZ(9,8,o.title$)),e.xp6(3),e.Q6J("ngIf",o.selectedPoint),e.xp6(9),e.Oqu(null==o.game?null:o.game.name),e.xp6(3),e.Q6J("translucent",!0),e.xp6(3),e.hij(" ",o.gameName," "),e.xp6(4),e.Q6J("fullscreen",!0),e.xp6(4),e.hij(" ",o.gameName," "),e.xp6(1),e.Q6J("ngIf",o.game))},dependencies:[l.Pc,l.YG,l.Sm,l.W2,l.Gu,l.z0,l.zc,l.wd,l.sr,v.ez,v.O5,v.Ov,C.u5,X,_,ee.v]}),m})()}}]);