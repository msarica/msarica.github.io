"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[6099],{6099:(jt,A,d)=>{d.r(A),d.d(A,{StoryBuilderPage:()=>kt});var m=d(5861),g=d(6814),t=d(2029),f=d(6223),u=d(7027),Z=d(8645),L=d(9773),Q=d(1374),q=d(4475),I=d(1828),V=d(902),R=d(5311),Y=d(2620),z=d(8182),H=d(8536),X=d(9593),K=d(3822),$=d(6093),W=d(2064),y=d(3911),E=d(7157);const tt=["mapElementRef"];let N=(()=>{var n;class a{constructor(e){this.locationService=e,this.startPoint=(0,t.X6Q)()?[39.25186060990359,-76.83157331721733]:[0,0],this.coordinateClick=new t.vpe,this.features={}}ngOnInit(){this.setUpMap()}setUpMap(){const[e,o]=this.startPoint,s=this.locationService.transformFromLocation2Coordinate([o,e]);(0,W.eL)(),this.map=new q.Z({view:new I.ZP({center:s,zoom:18}),layers:[new Y.Z({source:new H.Z})],target:"ol-map"});const c=new X.Z({features:[]});this.markerSource=c;const l=new z.Z({source:c});this.map.addLayer(l),this.map.on("click",h=>{var p;if(!this.map)return;const v=this.map.getCoordinateFromPixel(h.pixel),_=[v[0],v[1]],C=null===(p=this.map)||void 0===p?void 0:p.forEachFeatureAtPixel(h.pixel,S=>S);this.setSelected(C),this.selectedFeature=C,this.coordinateClick.emit({coordinate:_,event:h,feature:C})}),setTimeout(()=>{!this.map||!this.mapElementRef||this.map.setTarget(this.mapElementRef.nativeElement)})}goToPoint(e,o=18){if(!this.map)return;const i=this.locationService.transformFromLocation2Coordinate([e[0],e[1]]),s=this.map.getView();s.setCenter(i),s.setZoom(o)}addPoint(){}getStyle(e){return new $.ZP({image:new K.Z({anchor:[.5,.5],anchorXUnits:"fraction",anchorYUnits:"fraction",size:[70,70],src:e})})}_setSelectedStatus(e,o){const i=e.getStyle();o?i.getImage().setScale(1.5):i.getImage().setScale(1),e.setStyle(i)}setSelected(e){!this.selectedFeature||e?e&&(this.selectedFeature&&e===this.selectedFeature||(this.selectedFeature&&this.deselect(),this._setSelectedStatus(e,!0),this.selectedFeature=e)):this.deselect()}deselect(){this.selectedFeature&&(this._setSelectedStatus(this.selectedFeature,!1),this.selectedFeature=void 0)}addMarker(e,o){if(!this.markerSource)throw new Error("");const[i,s]=e,c=this.locationService.transformFromLocation2Coordinate([i,s]),l=new V.Z({geometry:new R.Z(c),data:o}),h=this.getStyle(o.img);l.setStyle(h),this.markerSource.addFeature(l);const p=o.pointId;return this.features[p]&&this.markerSource.removeFeature(this.features[p]),this.features[p]=l,this.setSelected(l),l}addCss(e){var o;(null===(o=this.mapElementRef)||void 0===o?void 0:o.nativeElement).classList.add(e)}removeCss(e){var o;(null===(o=this.mapElementRef)||void 0===o?void 0:o.nativeElement).classList.remove(e)}removeMarker(e){if(!this.markerSource)throw new Error("");if(!e)throw new Error("pointid cannot be null");const o=this.features[e];if(!o)throw new Error("feature not found");this.markerSource.removeFeature(o),delete this.features[e]}}return(n=a).\u0275fac=function(e){return new(e||n)(t.Y36(E.a))},n.\u0275cmp=t.Xpm({type:n,selectors:[["app-coordinate-selection"]],viewQuery:function(e,o){if(1&e&&t.Gf(tt,7),2&e){let i;t.iGM(i=t.CRH())&&(o.mapElementRef=i.first)}},inputs:{startPoint:"startPoint"},outputs:{coordinateClick:"coordinateClick"},standalone:!0,features:[t.jDz],decls:3,vars:0,consts:[["id","ol-map",1,"map-container"],["mapElementRef",""]],template:function(e,o){1&e&&(t.ynx(0),t._UZ(1,"div",0,1),t.BQk())},dependencies:[u.Pc,f.u5,y.aw,g.ez],styles:["[_nghost-%COMP%]{display:flex;flex-grow:1;flex-direction:column;height:100vh}.map-container[_ngcontent-%COMP%]{flex-grow:1}.addStory[_ngcontent-%COMP%]{cursor:crosshair}"]}),a})();var F=d(7285),b=d(9964);const et=["editor"];let M=(()=>{var n;class a{set code(e){this.editor&&(this.editor.code=e)}get code(){var e;return(null===(e=this.editor)||void 0===e?void 0:e.code)||""}get location(){var e;const o=(null===(e=this.item)||void 0===e||null===(e=e.feature)||void 0===e||null===(e=e.getGeometry())||void 0===e?void 0:e.getCoordinates())||[0,0];return[o[0],o[1]]}getClean(){return this.code.replace(/"<location>"/g,this.locationStr()).split("\n").map(o=>(0,b.eJ)(o)).join("\n")}validate(){const e=JSON.parse(this.getClean());return e.zoom?(0,b.u2)(e,!0):(0,b.if)(e,""),e}loadFromObj(e){const o={...e};o.location="<location>",this.item&&(this.item.title=o.id),this.code=JSON.stringify(o,null,2)}constructor(){this.destroy$=new Z.x}update(){this.code=this.getJson()}ngOnInit(){this.item&&(this.item.component=this),this.update()}ngOnDestroy(){this.destroy$.next(),this.destroy$.unsubscribe(),console.log("destroying")}getPointObject(e){return{id:"",title:"",location:"<location>",enabled:!1,body:this._getPoint(e)}}getPointJson(e){const o=this.getPointObject(e);return JSON.stringify(o,null,2)}getChoice(){return{type:"choice",text:[""],action:{enables:[],disables:[],gameCompleted:{title:"",finishMessage:""}},options:[{text:"opt1",item:{type:"choice",text:[""],action:{enables:[],disables:[],gameCompleted:{title:"",finishMessage:""}},options:[{text:"opt1",action:{enables:[],disables:[],gameCompleted:{title:"",finishMessage:""}}}]}}]}}_getPoint(e){const o={type:e,text:[""],action:{disables:[],enables:[],gameCompleted:{finishMessage:"",title:""}}},i={...o,type:e,possibleAnswers:[],messageIfIncorrect:"",messageIfCorrect:"",cannotGiveUp:!1,maxTries:3};switch(e){case"note":return{...o};case"shortanswer":return{...i};case"multiplechoice":return{...i,choices:[]};case"choice":return this.getChoice()}throw new Error("error);")}locationStr(){return JSON.stringify(this.location)}}return(n=a).\u0275fac=function(e){return new(e||n)},n.\u0275dir=t.lG2({type:n,viewQuery:function(e,o){if(1&e&&t.Gf(et,7),2&e){let i;t.iGM(i=t.CRH())&&(o.editor=i.first)}},inputs:{item:"item"}}),a})();var ot=d(2181),it=d(8180),nt=d(5619);const rt=["editor"],J="MONACO_PATH";let st=(()=>{class n{constructor(r,e){this.ngZone=r,this.monacoPathConfig=e,this.isMonacoLoaded$=new nt.X(!1),this._monacoPath="assets/monaco-editor/min/vs",window.monacoEditorAlreadyInitialized?r.run(()=>this.isMonacoLoaded$.next(!0)):(window.monacoEditorAlreadyInitialized=!0,this.monacoPathConfig&&(this.monacoPath=this.monacoPathConfig),this.loadMonaco())}set monacoPath(r){r&&(this._monacoPath=r)}loadMonaco(){const r=()=>{let s=this._monacoPath;window.amdRequire=window.require;const c=!!this.nodeRequire,l=s.includes("http");c&&(window.require=this.nodeRequire,l||(s=window.require("path").resolve(window.__dirname,this._monacoPath))),window.amdRequire.config({paths:{vs:s}}),window.amdRequire(["vs/editor/editor.main"],()=>{this.ngZone.run(()=>this.isMonacoLoaded$.next(!0))},h=>console.error("Error loading monaco-editor: ",h))};if(window.amdRequire)return r();window.require&&(this.addElectronFixScripts(),this.nodeRequire=window.require);const i=document.createElement("script");i.type="text/javascript",i.src=`${this._monacoPath}/loader.js`,i.addEventListener("load",r),document.body.appendChild(i)}addElectronFixScripts(){const r=document.createElement("script"),e=document.createTextNode("self.module = undefined;"),o=document.createTextNode("self.process.browser = true;");r.appendChild(e),r.appendChild(o),document.body.appendChild(r)}}return n.\u0275fac=function(r){return new(r||n)(t.LFG(t.R0b),t.LFG(J,8))},n.\u0275prov=t.Yz7({token:n,factory:n.\u0275fac,providedIn:"root"}),n})(),at=(()=>{class n{constructor(r){this.monacoLoader=r,this.init=new t.vpe,this.onTouched=()=>{},this.onErrorStatusChange=()=>{},this.propagateChange=()=>{}}get model(){return this.editor&&this.editor.getModel()}get modelMarkers(){return this.model&&monaco.editor.getModelMarkers({resource:this.model.uri})}ngOnInit(){this.monacoLoader.isMonacoLoaded$.pipe((0,ot.h)(r=>r),(0,it.q)(1)).subscribe(()=>{this.initEditor()})}ngOnChanges(r){if(this.editor&&r.options&&!r.options.firstChange){const{language:e,theme:o,...i}=r.options.currentValue,{language:s,theme:c}=r.options.previousValue;s!==e&&monaco.editor.setModelLanguage(this.editor.getModel(),this.options&&this.options.language?this.options.language:"text"),c!==o&&monaco.editor.setTheme(o),this.editor.updateOptions(i)}if(this.editor&&r.uri){const e=r.uri.currentValue,o=r.uri.previousValue;if(o&&!e||!o&&e||e&&o&&e.path!==o.path){const i=this.editor.getValue();let s;this.modelUriInstance&&this.modelUriInstance.dispose(),e&&(s=monaco.editor.getModels().find(c=>c.uri.path===e.path)),this.modelUriInstance=s||monaco.editor.createModel(i,this.options.language||"text",this.uri),this.editor.setModel(this.modelUriInstance)}}}writeValue(r){this.value=r,this.editor&&r?this.editor.setValue(r):this.editor&&this.editor.setValue("")}registerOnChange(r){this.propagateChange=r}registerOnTouched(r){this.onTouched=r}validate(){return this.parsedError?{monaco:{value:this.parsedError.split("|")}}:null}registerOnValidatorChange(r){this.onErrorStatusChange=r}initEditor(){const r={value:[this.value].join("\n"),language:"text",automaticLayout:!0,scrollBeyondLastLine:!1,theme:"vc"};this.editor=monaco.editor.create(this.editorContent.nativeElement,this.options?{...r,...this.options}:r),this.registerEditorListeners(),this.init.emit(this.editor)}registerEditorListeners(){this.editor.onDidChangeModelContent(()=>{this.propagateChange(this.editor.getValue())}),this.editor.onDidChangeModelDecorations(()=>{const r=this.modelMarkers.map(({message:o})=>o).join("|");this.parsedError!==r&&(this.parsedError=r,this.onErrorStatusChange())}),this.editor.onDidBlurEditorText(()=>{this.onTouched()})}ngOnDestroy(){this.editor&&this.editor.dispose()}}return n.\u0275fac=function(r){return new(r||n)(t.Y36(st))},n.\u0275cmp=t.Xpm({type:n,selectors:[["ngx-monaco-editor"]],viewQuery:function(r,e){if(1&r&&t.Gf(rt,7),2&r){let o;t.iGM(o=t.CRH())&&(e.editorContent=o.first)}},inputs:{options:"options",uri:"uri"},outputs:{init:"init"},features:[t._Bn([{provide:f.JU,useExisting:(0,t.Gpc)(()=>n),multi:!0},{provide:f.Cf,useExisting:(0,t.Gpc)(()=>n),multi:!0}]),t.TTD],decls:4,vars:0,consts:[["fxFlex","",1,"editor-container"],["container",""],[1,"monaco-editor"],["editor",""]],template:function(r,e){1&r&&(t.TgZ(0,"div",0,1),t._UZ(2,"div",2,3),t.qZA())},styles:[".monaco-editor[_ngcontent-%COMP%]{position:absolute;top:0;bottom:0;left:0;right:0}.editor-container[_ngcontent-%COMP%]{overflow:hidden;position:relative;display:table;width:100%;height:100%;min-width:0}"],changeDetection:0}),n})(),ct=(()=>{class n{}return n.\u0275fac=function(r){return new(r||n)},n.\u0275mod=t.oAB({type:n}),n.\u0275inj=t.cJS({imports:[[]]}),n})(),P=(()=>{var n;class a{constructor(){this.code="",this.codeChange=new t.vpe,this.editorOptions={language:"json",theme:"vs-dark",automaticLayout:!0,minimap:{enabled:!1}}}ngOnInit(){}}return(n=a).\u0275fac=function(e){return new(e||n)},n.\u0275cmp=t.Xpm({type:n,selectors:[["app-editor"]],viewQuery:function(e,o){if(1&e&&t.Gf(n,5),2&e){let i;t.iGM(i=t.CRH())&&(o.monacoComponent=i.first)}},inputs:{code:"code"},outputs:{codeChange:"codeChange"},standalone:!0,features:[t._Bn([{provide:J,useValue:"https://unpkg.com/monaco-editor@0.36.1/min/vs"}]),t.jDz],decls:2,vars:2,consts:[[1,"codeArea"],[3,"options","ngModel","ngModelChange"]],template:function(e,o){1&e&&(t.TgZ(0,"div",0)(1,"ngx-monaco-editor",1),t.NdJ("ngModelChange",function(s){return o.code=s}),t.qZA()()),2&e&&(t.xp6(1),t.Q6J("options",o.editorOptions)("ngModel",o.code))},dependencies:[u.Pc,f.u5,f.JJ,f.On,y.aw,g.ez,ct,at],styles:["ngx-monaco-editor[_ngcontent-%COMP%]{height:calc(100% - 60px);width:100%}.codeArea[_ngcontent-%COMP%]{height:50vh;width:100%}"]}),a})(),lt=(()=>{var n;class a extends M{constructor(){super()}getJson(){return JSON.stringify({id:"sample",name:"Sample Game",description:"Hi, welcome to my experiment! :)",location:"<location>",zoom:18},null,2)}}return(n=a).\u0275fac=function(e){return new(e||n)},n.\u0275cmp=t.Xpm({type:n,selectors:[["app-game-details"]],standalone:!0,features:[t.qOj,t.jDz],decls:2,vars:0,consts:[["editor",""]],template:function(e,o){1&e&&t._UZ(0,"app-editor",null,0)},dependencies:[u.Pc,g.ez,f.u5,f.UX,y.aw,P]}),a})(),dt=(()=>{var n;class a extends M{constructor(){super()}getJson(){return this.getPointJson("choice")}}return(n=a).\u0275fac=function(e){return new(e||n)},n.\u0275cmp=t.Xpm({type:n,selectors:[["app-new-choice"]],standalone:!0,features:[t.qOj,t.jDz],decls:2,vars:0,consts:[["editor",""]],template:function(e,o){1&e&&t._UZ(0,"app-editor",null,0)},dependencies:[u.Pc,g.ez,f.u5,y.aw,f.UX,P]}),a})(),ut=(()=>{var n;class a extends M{constructor(){super()}getJson(){return this.getPointJson("multiplechoice")}}return(n=a).\u0275fac=function(e){return new(e||n)},n.\u0275cmp=t.Xpm({type:n,selectors:[["app-new-multiple-choice"]],standalone:!0,features:[t.qOj,t.jDz],decls:2,vars:0,consts:[["editor",""]],template:function(e,o){1&e&&t._UZ(0,"app-editor",null,0)},dependencies:[u.Pc,g.ez,f.u5,f.UX,y.aw,P]}),a})(),pt=(()=>{var n;class a extends M{constructor(){super()}getJson(){return this.getPointJson("note")}}return(n=a).\u0275fac=function(e){return new(e||n)},n.\u0275cmp=t.Xpm({type:n,selectors:[["app-new-note"]],standalone:!0,features:[t.qOj,t.jDz],decls:2,vars:0,consts:[["editor",""]],template:function(e,o){1&e&&t._UZ(0,"app-editor",null,0)},dependencies:[u.Pc,g.ez,f.u5,f.UX,y.aw,P]}),a})(),ht=(()=>{var n;class a extends M{constructor(){super()}getJson(){return this.getPointJson("shortanswer")}}return(n=a).\u0275fac=function(e){return new(e||n)},n.\u0275cmp=t.Xpm({type:n,selectors:[["app-new-short-answer"]],standalone:!0,features:[t.qOj,t.jDz],decls:2,vars:0,consts:[["editor",""]],template:function(e,o){1&e&&t._UZ(0,"app-editor",null,0)},dependencies:[u.Pc,g.ez,f.u5,f.UX,y.aw,P]}),a})();function x(n){if(n)return n.split(",").filter(a=>null==a?void 0:a.trim().length).map(a=>a.trim())}function G(n){return Array.isArray(n)?n:JSON.parse(n)}var ft=d(662),T=d(6546);function vt(n,a){if(1&n&&(t.TgZ(0,"div")(1,"ion-card")(2,"ion-card-header")(3,"ion-card-title"),t._uU(4," Result "),t.qZA()(),t.TgZ(5,"ion-card-content"),t._uU(6),t.ALo(7,"json"),t.qZA()()()),2&n){const r=t.oxw(2);t.xp6(6),t.hij(" ",t.lcZ(7,1,r.whatNext)," ")}}function gt(n,a){if(1&n&&(t.ynx(0),t._UZ(1,"app-game-point",1),t.YNc(2,vt,8,3,"div",0),t.BQk()),2&n){const r=t.oxw();t.xp6(1),t.Q6J("selectedPoint",r.selectedPoint),t.xp6(1),t.Q6J("ngIf",r.whatNext)}}let k=(()=>{var n;class a extends T.h{constructor(){super(...arguments),this.testChanges$=new Z.x}moveNext(e){this.testChanges$.next(e)}saveProgress(){}addHistory(e){}}return(n=a).\u0275fac=function(){let r;return function(o){return(r||(r=t.n5z(n)))(o||n)}}(),n.\u0275prov=t.Yz7({token:n,factory:n.\u0275fac}),a})(),_t=(()=>{var n;class a{constructor(e){this.gameService=e,this.destroy$=new Z.x}ngOnInit(){this.gameService.testChanges$.pipe((0,L.R)(this.destroy$)).subscribe(e=>{this.whatNext=e})}ionViewDidEnter(){}ngOnDestroy(){this.destroy$.next(),this.destroy$.unsubscribe()}}return(n=a).\u0275fac=function(e){return new(e||n)(t.Y36(T.h))},n.\u0275cmp=t.Xpm({type:n,selectors:[["app-test-question"]],inputs:{selectedPoint:"selectedPoint"},standalone:!0,features:[t._Bn([{provide:T.h,useClass:k},{provide:T.h,useClass:k}]),t.jDz],decls:1,vars:1,consts:[[4,"ngIf"],[3,"selectedPoint"]],template:function(e,o){1&e&&t.YNc(0,gt,3,2,"ng-container",0),2&e&&t.Q6J("ngIf",o.selectedPoint)},dependencies:[u.Pc,u.PM,u.FN,u.Zi,u.Dq,g.ez,g.O5,g.Ts,f.u5,y.aw,ft.v]}),a})();var D=d(8939);const yt=["editor"];let Ct=(()=>{var n;class a{set code(e){this.editor&&(this.editor.code=e)}get code(){var e;return(null===(e=this.editor)||void 0===e?void 0:e.code)||""}constructor(e,o){this.gameService=e,this.info=o}ngOnInit(){}validate(){try{const e=JSON.parse(this.code);return this.gameService.validateGame(e),this.info.alert("valid"),e}catch(e){this.info.alert(null==e?void 0:e.message,"Error")}}save(){var e=this;return(0,m.Z)(function*(){const o=yield e.validate();o&&e.saveFn&&(yield e.saveFn(o))})()}}return(n=a).\u0275fac=function(e){return new(e||n)(t.Y36(T.h),t.Y36(D.C))},n.\u0275cmp=t.Xpm({type:n,selectors:[["app-game-editor"]],viewQuery:function(e,o){if(1&e&&t.Gf(yt,7),2&e){let i;t.iGM(i=t.CRH())&&(o.editor=i.first)}},standalone:!0,features:[t.jDz],decls:9,vars:6,consts:[["editor",""],[3,"click"]],template:function(e,o){1&e&&(t.TgZ(0,"div"),t._UZ(1,"app-editor",null,0),t.TgZ(3,"ion-button",1),t.NdJ("click",function(){return o.validate()}),t._uU(4),t.ALo(5,"translate"),t.qZA(),t.TgZ(6,"ion-button",1),t.NdJ("click",function(){return o.save()}),t._uU(7),t.ALo(8,"translate"),t.qZA()()),2&e&&(t.xp6(4),t.Oqu(t.lcZ(5,2,"Validate")),t.xp6(3),t.Oqu(t.lcZ(8,4,"Save Local")))},dependencies:[u.Pc,u.YG,g.ez,f.u5,y.aw,y.X$,f.UX,P]}),a})();var wt=d(4321),xt=d(3308),j=d(4263);const St=["pointAccordion"];function Pt(n,a){if(1&n){const r=t.EpF();t.TgZ(0,"ion-item",2),t.NdJ("click",function(){const i=t.CHM(r).$implicit,s=t.oxw();return t.KtG(s.chooseForLocalSave(i))}),t._uU(1),t.qZA()}if(2&n){const r=a.$implicit;t.xp6(1),t.hij(" ",r," ")}}function Tt(n,a){if(1&n){const r=t.EpF();t.TgZ(0,"ion-accordion",18)(1,"ion-item",6)(2,"ion-label"),t._uU(3,"Url"),t.qZA()(),t.TgZ(4,"div",7)(5,"code"),t._uU(6),t.qZA(),t._UZ(7,"br"),t.TgZ(8,"ion-button",2),t.NdJ("click",function(){t.CHM(r);const o=t.oxw();return t.KtG(o.copyUrl())}),t._uU(9," copy url "),t.qZA()()()}if(2&n){const r=t.oxw();t.xp6(6),t.hij(" ",r.qrData," ")}}function Zt(n,a){if(1&n){const r=t.EpF();t.TgZ(0,"ion-button",2),t.NdJ("click",function(){t.CHM(r);const o=t.oxw();return t.KtG(o.addNewPoint())}),t._uU(1),t.ALo(2,"translate"),t.qZA()}2&n&&(t.xp6(1),t.hij(" ",t.lcZ(2,1,"Add Start Location")," "))}function bt(n,a){if(1&n){const r=t.EpF();t.TgZ(0,"ion-item-divider")(1,"ion-label"),t._uU(2),t.ALo(3,"translate"),t.qZA(),t.TgZ(4,"ion-button",19),t.NdJ("click",function(){t.CHM(r);const o=t.oxw();return t.KtG(o.addPoint("note"))}),t._uU(5),t.ALo(6,"translate"),t.qZA(),t.TgZ(7,"ion-button",19),t.NdJ("click",function(){t.CHM(r);const o=t.oxw();return t.KtG(o.addPoint("shortanswer"))}),t._uU(8),t.ALo(9,"translate"),t.qZA(),t.TgZ(10,"ion-button",19),t.NdJ("click",function(){t.CHM(r);const o=t.oxw();return t.KtG(o.addPoint("multiplechoice"))}),t._uU(11),t.ALo(12,"translate"),t.qZA(),t.TgZ(13,"ion-button",19),t.NdJ("click",function(){t.CHM(r);const o=t.oxw();return t.KtG(o.addPoint("choice"))}),t._uU(14),t.ALo(15,"translate"),t.qZA()()}2&n&&(t.xp6(2),t.hij(" ",t.lcZ(3,5,"Add")," "),t.xp6(3),t.hij(" ",t.lcZ(6,7,"Note")," "),t.xp6(3),t.hij(" ",t.lcZ(9,9,"Short Answer")," "),t.xp6(3),t.hij(" ",t.lcZ(12,11,"Multiple Choice")," "),t.xp6(3),t.hij(" ",t.lcZ(15,13,"Choice")," "))}function Mt(n,a){if(1&n){const r=t.EpF();t.TgZ(0,"ion-button",31),t.NdJ("click",function(o){t.CHM(r);const i=t.oxw().$implicit,s=t.oxw();return t.KtG(s.playPoint(i,o))}),t._UZ(1,"ion-icon",32),t.qZA()}}function Lt(n,a){if(1&n){const r=t.EpF();t.TgZ(0,"ion-button",15),t.NdJ("click",function(){t.CHM(r);const o=t.oxw().$implicit,i=t.oxw();return t.KtG(i.removePoint(o,!0))}),t._uU(1,"x"),t.qZA()}}function At(n,a){if(1&n&&(t.ynx(0),t._UZ(1,"app-game-details",33),t.BQk()),2&n){const r=t.oxw().$implicit;t.xp6(1),t.Q6J("item",r)}}function Et(n,a){if(1&n&&(t.ynx(0),t._UZ(1,"app-new-short-answer",33),t.BQk()),2&n){const r=t.oxw().$implicit;t.xp6(1),t.Q6J("item",r)}}function Nt(n,a){if(1&n&&(t.ynx(0),t._UZ(1,"app-new-multiple-choice",33),t.BQk()),2&n){const r=t.oxw().$implicit;t.xp6(1),t.Q6J("item",r)}}function Ft(n,a){if(1&n&&(t.ynx(0),t._UZ(1,"app-new-note",33),t.BQk()),2&n){const r=t.oxw().$implicit;t.xp6(1),t.Q6J("item",r)}}function Jt(n,a){if(1&n&&(t.ynx(0),t._UZ(1,"app-new-choice",33),t.BQk()),2&n){const r=t.oxw().$implicit;t.xp6(1),t.Q6J("item",r)}}function Gt(n,a){1&n&&t.GkF(0)}function Ot(n,a){if(1&n){const r=t.EpF();t.TgZ(0,"ion-accordion",20)(1,"ion-item",6)(2,"ion-label"),t._uU(3),t.qZA(),t.YNc(4,Mt,2,0,"ion-button",21),t.TgZ(5,"ion-button",22),t.NdJ("click",function(o){const s=t.CHM(r).$implicit,c=t.oxw();return t.KtG(c.relocatePoint(s,o))}),t.ALo(6,"translate"),t._UZ(7,"ion-icon",23),t.qZA(),t.TgZ(8,"ion-button",22),t.NdJ("click",function(o){const s=t.CHM(r).$implicit,c=t.oxw();return t.KtG(c.copyCode(s,o))}),t.ALo(9,"translate"),t._UZ(10,"ion-icon",24),t.qZA(),t.TgZ(11,"ion-button",22),t.NdJ("click",function(o){const s=t.CHM(r).$implicit,c=t.oxw();return t.KtG(c.formatCode(s,o))}),t.ALo(12,"translate"),t._UZ(13,"ion-icon",25),t.qZA(),t.TgZ(14,"ion-button",22),t.NdJ("click",function(o){const s=t.CHM(r).$implicit,c=t.oxw();return t.KtG(c.validatePoint(s,o))}),t.ALo(15,"translate"),t._uU(16,"Validate"),t.qZA(),t.YNc(17,Lt,2,0,"ion-button",26),t.qZA(),t.TgZ(18,"div",27),t.ynx(19,28),t.YNc(20,At,2,1,"ng-container",29),t.YNc(21,Et,2,1,"ng-container",29),t.YNc(22,Nt,2,1,"ng-container",29),t.YNc(23,Ft,2,1,"ng-container",29),t.YNc(24,Jt,2,1,"ng-container",29),t.YNc(25,Gt,1,0,"ng-container",30),t.BQk(),t.qZA()()}if(2&n){const r=a.$implicit;t.Q6J("value",r.index),t.xp6(3),t.Oqu(r.title),t.xp6(1),t.Q6J("ngIf","start"!==r.type),t.xp6(1),t.s9C("title",t.lcZ(6,14,"Change Location")),t.xp6(3),t.s9C("title",t.lcZ(9,16,"Copy Code")),t.xp6(3),t.s9C("title",t.lcZ(12,18,"Format Code")),t.xp6(3),t.s9C("title",t.lcZ(15,20,"Validate")),t.xp6(3),t.Q6J("ngIf","start"!==r.type),t.xp6(2),t.Q6J("ngSwitch",r.type),t.xp6(1),t.Q6J("ngSwitchCase","start"),t.xp6(1),t.Q6J("ngSwitchCase","shortanswer"),t.xp6(1),t.Q6J("ngSwitchCase","multiplechoice"),t.xp6(1),t.Q6J("ngSwitchCase","note"),t.xp6(1),t.Q6J("ngSwitchCase","choice")}}function Ut(n,a){if(1&n){const r=t.EpF();t.TgZ(0,"ion-header")(1,"ion-toolbar")(2,"ion-buttons",34)(3,"ion-button",2),t.NdJ("click",function(){t.CHM(r);const o=t.oxw();return t.KtG(o.closeTest())}),t._uU(4),t.ALo(5,"translate"),t.qZA()(),t.TgZ(6,"ion-title"),t._uU(7),t.ALo(8,"translate"),t.qZA()()(),t.TgZ(9,"ion-content",5),t._UZ(10,"app-test-question",35),t.qZA()}if(2&n){const r=t.oxw();t.xp6(4),t.Oqu(t.lcZ(5,3,"Cancel")),t.xp6(3),t.Oqu(t.lcZ(8,5,"Test")),t.xp6(3),t.Q6J("selectedPoint",r.selectedTestPoint)}}let kt=(()=>{var n;class a{get isModalOpen(){return!!this.selectedTestPoint}set accordionValue(e){this.pointsAccordion&&(this.pointsAccordion.value=e)}constructor(e,o,i,s,c,l,h,p,v){this.fb=e,this.gameService=o,this.onlineService=i,this.locationService=s,this.info=c,this.storage=l,this.router=h,this.activatedRoute=p,this.modalController=v,this.destroy$=new Z.x,this.pointCounter=1,this.newPointLocation=!1,this.pointSelected$=new Z.x,this.pointList=[],this.localSaves=[],this.askForExit=!0}pointsAccordionGroupChange(e){const o=e.detail.value;if(!o)return void this.setPointAsActive();const i=this.pointList.find(s=>s.index==o);i&&this.setPointAsActive(i)}clear(e){var o=this;return(0,m.Z)(function*(){if(!e||(yield o.info.confirmYesNo("clear?","sure to clear?"))){for(const i of[...o.pointList])yield o.removePoint(i,!1);o.pointCounter=1,o.activePoint=void 0}})()}ionViewDidEnter(){this.storage.save("page","builder")}gotoGames(){this.storage.delete("page"),this.router.navigate(["/tabs/game"])}ngOnInit(){var e,o,i;this.loadLocalSaves(),(0,t.X6Q)()&&this.loadLocal("halloweendorsey_TEMP",!1),this.coordinateSelected$=null===(e=this.map)||void 0===e?void 0:e.coordinateClick.pipe((0,L.R)(this.destroy$)),null===(o=this.coordinateSelected$)||void 0===o||o.pipe((0,L.R)(this.destroy$)).subscribe(s=>{var c,l;this.activePoint&&this.newPointLocation&&(null===(c=this.activePoint.getGeometry())||void 0===c||c.setCoordinates(s.coordinate),s.feature=this.activePoint,this.newPointLocation=!1),!s.feature&&this.addingPointType&&(this.addMarkerToMap(s.coordinate,this.addingPointType,this.addingPointType,s),null===(l=this.map)||void 0===l||l.removeCss("addStory")),this.pointSelected$.next(s.feature)}),this.pointSelected$.pipe((0,L.R)(this.destroy$)).subscribe(s=>{if(this.activePoint=s,!s)return void this.setPointAsActive();const c=s.get("data");this.setPointAsActive(this.pointList.find(l=>l.index===c.pointId))}),(0,t.X6Q)()&&(null===(i=this.map)||void 0===i||i.goToPoint([-76.83157331721733,39.25186060990359])),this.locationService.watchLocation().pipe((0,Q.P)()).subscribe(s=>{var c;const l=this.locationService.transformFromGeoLocation(s);null===(c=this.map)||void 0===c||c.goToPoint([l[0],l[1]])})}addMarkerToMap(e,o,i,s){var c;const l=!this.pointList.length,h=this.pointCounter++,p=null===(c=this.map)||void 0===c?void 0:c.addMarker(e,{pointId:h,img:l?F.PP.startLocation:F.PP.pointMarker,start:l});p&&(this.pointList.push({index:h,title:o,type:i,feature:p}),s&&(s.feature=p)),this.addingPointType=void 0}ngOnDestroy(){this.destroy$.next(),this.destroy$.unsubscribe()}addNewPoint(){this._addPoint("start")}_addPoint(e){var o;this.newPointLocation=!1,this.addingPointType=e,null===(o=this.map)||void 0===o||o.addCss("addStory")}addPoint(e){this._addPoint(e)}removePoint(e,o){var i=this;return(0,m.Z)(function*(){var s;if(o){const l=e.title+": "+(yield i.info.translate("Are you sure to remove?"));if(!(yield i.info.confirmYesNo("Remove",l)))return}null===(s=i.map)||void 0===s||s.removeMarker(""+e.index);const c=i.pointList.indexOf(e);i.pointList.splice(c,1)})()}validatePoint(e,o){o.stopPropagation();try{var i;null===(i=e.component)||void 0===i||i.validate(),this.info.alert("valid")}catch(s){this.info.alert(null==s?void 0:s.message,"")}}relocatePoint(e,o){o.stopPropagation(),this.newPointLocation=!0,this.setPointAsActive(e),this.info.showToast("Select a new location on the map")}setPointAsActive(e){var o,i;if(!e)return null===(i=this.map)||void 0===i||i.deselect(),this.activePoint=void 0,void(this.accordionValue=null);this.activePoint=e.feature,this.accordionValue=""+e.index,null===(o=this.map)||void 0===o||o.setSelected(e.feature)}playPoint(e,o){var i=this;return(0,m.Z)(function*(){o.stopPropagation();try{var s;const c=null===(s=e.component)||void 0===s?void 0:s.validate();i.selectedTestPoint={distance:0,isClose:!0,point:c,pointId:"0"}}catch(c){i.info.alert(null==c?void 0:c.message,"")}})()}closeTest(e){this.selectedTestPoint=void 0}copyCode(e,o){var i;o.stopPropagation();const s=null===(i=e.component)||void 0===i?void 0:i.getClean();s&&this.copyText(s),console.log(s),this.info.showToast("Copied to clipboard")}formatCode(e,o){var i;o.stopPropagation();const s=null===(i=e.component)||void 0===i?void 0:i.getClean();var c;if(s)return null===(c=e.component)||void 0===c||c.loadFromObj(JSON.parse(s)),void this.info.showToast("Formatted");this.info.showToast("Code not found")}generateQR(e){try{this.qrData=null,this.qrData=((0,t.X6Q)()?"http://localhost:8100":"https://msarica.github.io/scv")+`/#?storyKey=${e}&start=true`}catch(o){this.info.alert(o.message)}}copyUrl(){this.copyText(this.qrData),this.info.showToast("Copied")}copyText(e){navigator.clipboard.writeText(e)}createGameObj(){try{var e;const i=[...this.pointList],s=i.shift(),c=null==s||null===(e=s.component)||void 0===e?void 0:e.validate(),l=[];for(const p of i)try{var o;const v=null===(o=p.component)||void 0===o?void 0:o.validate();l.push(v)}catch(v){throw console.error(v),new Error(`Error: ${p.index}: ${v.message}`)}return{...c,points:l}}catch(i){throw i}}onSubmit(){var e=this;return(0,m.Z)(function*(){if(0!==e.pointList.length)try{const o=e.createGameObj();console.log(o),e.gameService.validateGame(o),console.log(JSON.stringify(o)),yield e.submitStory(o)}catch(o){e.info.alert(null==o?void 0:o.message,"Error")}else e.info.alert("No points!")})()}submitStory(e){var o=this;return(0,m.Z)(function*(){const i=yield o.info.input("Pass"),s=e.id.replace(/\s/,"_");try{o.validateStoryKey(s,i)}catch(l){o.info.alert(l.message)}const c=JSON.stringify(e);yield o.onlineService.saveStory(s.trim().toLowerCase(),i,c),o.generateQR(s)})()}validateStoryKey(e,o){if(""===(null==e?void 0:e.trim()))throw new Error("StoryKey is not valid");if(e.includes(" "))throw new Error("Key cannot contain spaces")}correctStory(e){try{e=JSON.parse(JSON.stringify(e));const o=this.correctValues(e);return this.gameService.validateGame(o),o}catch(o){throw console.error(o),o}}correctValues(e){e.zoom=18,e.location=G(e.location);for(const o of e.points)o.location=G(o.location),"multiplechoice"===o.body.type?(o.body.choices=x(o.body.choices)||[],o.body.possibleAnswers=x(o.body.possibleAnswers)||[]):"shortanswer"===o.body.type&&(o.body.possibleAnswers=x(o.body.possibleAnswers)||[]),o.body.action&&(o.body.action.enables=x(o.body.action.enables),o.body.action.disables=x(o.body.action.disables));return e}parseJson(e){return e=e.split("\n").map(o=>(0,b.eJ)(o)).join("\n"),JSON.parse(e)}loadFromJson(){var e=this;return(0,m.Z)(function*(){const o=yield e.info.input("JSON");e._loadFromJson(o)})()}_loadFromJson(e){var o=this;return(0,m.Z)(function*(){try{let i=o.parseJson(e);yield o._setUpGameForm(i)}catch(i){o.showBadStory(i,e)}})()}showBadStory(e,o){var i=this;return(0,m.Z)(function*(){console.error(e),yield(yield i.info.alert(e.message,"Error")).onDidDismiss();const c=(0,b.FA)(o);var l;c&&(yield i.modalController.create({component:Ct,componentProps:{code:c,saveFn:function(v){return(l=l||(0,m.Z)(function*(_){yield i._saveGameLocal(_)})).apply(this,arguments)}}})).present()})()}loadFromKey(){var e=this;return(0,m.Z)(function*(){let o;try{const i=yield e.info.input("Key"),s=yield e.gameService.getGameById(i.trim()),c=null==s?void 0:s.game;if(!c)return void e.info.alert("Game not found");o=JSON.stringify(c),yield e._setUpGameForm(c)}catch(i){o?e.showBadStory(i,o):(console.error(i),e.info.alert(i.message,"Error"))}})()}_setUpGameForm(e,o=!0){var i=this;return(0,m.Z)(function*(){console.log(i.pointList),(!o||!i.pointList.length||(yield i.info.confirmYesNo("Load","This will clear current. continue?")))&&(i.gameService.validateGame(e),yield i.clear(),i.addMarkerToMap(e.location,e.id,"start"),i.goToLocation(e.location,e.zoom),e.points.forEach(s=>{s.body.type&&i.addMarkerToMap(s.location,s.id,s.body.type)}),setTimeout(()=>{const s=e.points;i.pointList.forEach((c,l)=>{c.component&&c.component.loadFromObj("start"===c.type?{...e,points:void 0}:s[l-1])})},10))})()}goToLocation(e,o){var i;null===(i=this.map)||void 0===i||i.goToPoint(e,o)}saveLocal(){var e=this;return(0,m.Z)(function*(){if(0!==e.pointList.length)try{const o=yield e.getGame();return yield e._saveGameLocal(o)}catch(o){e.info.alert(null==o?void 0:o.message,"Error")}else e.info.alert("No points!")})()}_saveGameLocal(e){var o=this;return(0,m.Z)(function*(){const s=(e.id?e.id:"unknown")+"_TEMP",c=JSON.stringify(e);return o.storage.save(s,c),o.info.showToast(s+" saved"),o.loadLocalSaves(),s})()}getGame(){var e=this;return(0,m.Z)(function*(){const o=e.createGameObj();return console.log(o),e.gameService.validateGame(o),o})()}saveAndTest(){var e=this;return(0,m.Z)(function*(){const o=yield e.saveLocal();o&&(e.askForExit=!1,e.testLocalGame(o,!1))})()}loadLocalSaves(){var e=this;return(0,m.Z)(function*(){const i=(yield e.storage.getAllKeys()).filter(s=>s.endsWith("_TEMP"));console.log(i),e.localSaves=i})()}chooseForLocalSave(e){var o=this;return(0,m.Z)(function*(){const i=yield o.info.showAction(e,"",["delete","load","test"]);"delete"!==i?"load"!==i?"test"===i&&o.testLocalGame(e):o.loadLocal(e):o.deleteLocalSave(e)})()}deleteLocalSave(e){var o=this;return(0,m.Z)(function*(){(yield o.info.confirmYesNo("",`Delete ${e}?`))&&(o.storage.delete(e),o.loadLocalSaves())})()}loadLocal(e,o=!0){var i=this;return(0,m.Z)(function*(){const s=yield i.storage.get(e);s&&(yield i._loadFromJson(s))})()}testLocalGame(e,o=!0){var i=this;return(0,m.Z)(function*(){if(o&&i.pointList.length&&!(yield i.info.confirmYesNo("",`Test ${e}?`)))return;i.storage.save("page","game");const s=yield i.storage.get(e);if(!s)return;let c=i.parseJson(s);i.gameService.validateGame(c),i.gameService.testGame(c,e)})()}copyGameAsJson(){var e=this;return(0,m.Z)(function*(){const o=yield e.getGame(),i=JSON.stringify(o);console.log(i),e.copyText(i),e.info.showToast("Game copied to clipboard")})()}canLeave(){var e=this;return(0,m.Z)(function*(){return!(e.isModalOpen||e.askForExit&&!(yield e.info.confirmYesNo("Leave Game","Are you sure to leave?")))})()}}return(n=a).\u0275fac=function(e){return new(e||n)(t.Y36(f.qu),t.Y36(T.h),t.Y36(wt.x),t.Y36(E.a),t.Y36(D.C),t.Y36(xt.V),t.Y36(j.F0),t.Y36(j.gz),t.Y36(u.IN))},n.\u0275cmp=t.Xpm({type:n,selectors:[["app-story-builder"]],viewQuery:function(e,o){if(1&e&&(t.Gf(N,7),t.Gf(St,7)),2&e){let i;t.iGM(i=t.CRH())&&(o.map=i.first),t.iGM(i=t.CRH())&&(o.pointsAccordion=i.first)}},standalone:!0,features:[t.jDz],decls:57,vars:39,consts:[["id","main-content"],["slot","primary"],[3,"click"],["when","xs","contentId","main"],["contentId","main",2,"width","60vw"],[1,"ion-padding"],["slot","header","color","light"],["slot","content",1,"ion-padding"],[3,"click",4,"ngFor","ngForOf"],["value","qr",4,"ngIf"],[3,"click",4,"ngIf"],[4,"ngIf"],[3,"ionChange"],["pointAccordion",""],[3,"value",4,"ngFor","ngForOf"],["color","danger",3,"click"],["id","main",1,"ion-page"],[3,"isOpen","willDismiss"],["value","qr"],["size","small",3,"click"],[3,"value"],["title","test component",3,"click",4,"ngIf"],[3,"title","click"],["slot","icon-only","name","pin-outline"],["slot","icon-only","name","copy"],["slot","icon-only","name","help-buoy-outline"],["color","danger",3,"click",4,"ngIf"],["slot","content"],[3,"ngSwitch"],[4,"ngSwitchCase"],[4,"ngSwitchDefault"],["title","test component",3,"click"],["slot","icon-only","name","play-circle-outline"],[3,"item"],["slot","start"],[3,"selectedPoint"]],template:function(e,o){1&e&&(t.TgZ(0,"ion-header",0)(1,"ion-toolbar")(2,"ion-title"),t._uU(3),t.ALo(4,"translate"),t.qZA(),t.TgZ(5,"ion-buttons",1)(6,"ion-button",2),t.NdJ("click",function(){return o.gotoGames()}),t._uU(7),t.ALo(8,"translate"),t.qZA()()()(),t.TgZ(9,"ion-content")(10,"ion-split-pane",3)(11,"div",4)(12,"ion-content",5)(13,"ion-accordion-group")(14,"ion-accordion")(15,"ion-item",6)(16,"ion-label"),t._uU(17),t.ALo(18,"translate"),t.qZA()(),t.TgZ(19,"div",7)(20,"ion-button",2),t.NdJ("click",function(){return o.loadFromJson()}),t._uU(21),t.ALo(22,"translate"),t.qZA(),t.TgZ(23,"ion-button",2),t.NdJ("click",function(){return o.loadFromKey()}),t._uU(24),t.ALo(25,"translate"),t.qZA(),t.TgZ(26,"h5"),t._uU(27),t.ALo(28,"translate"),t.qZA(),t.TgZ(29,"ion-list"),t.YNc(30,Pt,2,1,"ion-item",8),t.qZA()()(),t.YNc(31,Tt,10,1,"ion-accordion",9),t.qZA(),t.YNc(32,Zt,3,3,"ion-button",10),t.YNc(33,bt,16,15,"ion-item-divider",11),t.TgZ(34,"ion-accordion-group",12,13),t.NdJ("ionChange",function(s){return o.pointsAccordionGroupChange(s)}),t.YNc(36,Ot,26,22,"ion-accordion",14),t.qZA(),t.TgZ(37,"ion-button",2),t.NdJ("click",function(){return o.onSubmit()}),t._uU(38),t.ALo(39,"translate"),t.qZA(),t.TgZ(40,"ion-button",2),t.NdJ("click",function(){return o.saveLocal()}),t._uU(41),t.ALo(42,"translate"),t.qZA(),t.TgZ(43,"ion-button",2),t.NdJ("click",function(){return o.saveAndTest()}),t._uU(44),t.ALo(45,"translate"),t.qZA(),t.TgZ(46,"ion-button",15),t.NdJ("click",function(){return o.clear(!0)}),t._uU(47),t.ALo(48,"translate"),t.qZA(),t.TgZ(49,"ion-button",2),t.NdJ("click",function(){return o.copyGameAsJson()}),t._uU(50),t.ALo(51,"translate"),t.qZA()()(),t.TgZ(52,"div",16)(53,"ion-content"),t._UZ(54,"app-coordinate-selection"),t.qZA()()(),t.TgZ(55,"ion-modal",17),t.NdJ("willDismiss",function(s){return o.closeTest(s)}),t.YNc(56,Ut,11,7,"ng-template"),t.qZA()()),2&e&&(t.xp6(3),t.hij(" ",t.lcZ(4,17,"Story Builder"),""),t.xp6(4),t.hij(" ",t.lcZ(8,19,"To Games")," "),t.xp6(10),t.Oqu(t.lcZ(18,21,"Settings")),t.xp6(4),t.hij(" ",t.lcZ(22,23,"Load From Json")," "),t.xp6(3),t.hij(" ",t.lcZ(25,25,"Load From Key")," "),t.xp6(3),t.hij(" ",t.lcZ(28,27,"Saved Games")," "),t.xp6(3),t.Q6J("ngForOf",o.localSaves),t.xp6(1),t.Q6J("ngIf",o.qrData),t.xp6(1),t.Q6J("ngIf",!o.pointList.length),t.xp6(1),t.Q6J("ngIf",o.pointList.length),t.xp6(3),t.Q6J("ngForOf",o.pointList),t.xp6(2),t.hij(" ",t.lcZ(39,29,"Submit")," "),t.xp6(3),t.hij(" ",t.lcZ(42,31,"Save Local")," "),t.xp6(3),t.hij(" ",t.lcZ(45,33,"Save & Test")," "),t.xp6(3),t.hij(" ",t.lcZ(48,35,"Clear")," "),t.xp6(3),t.hij(" ",t.lcZ(51,37,"Copy Game")," "),t.xp6(5),t.Q6J("isOpen",o.isModalOpen))},dependencies:[u.Pc,u.We,u.eh,u.YG,u.Sm,u.W2,u.Gu,u.gu,u.Ie,u.rH,u.Q$,u.q_,u.jI,u.wd,u.sr,u.ki,g.ez,g.sg,g.O5,g.RF,g.n9,g.ED,f.u5,y.aw,y.X$,f.UX,N,lt,dt,ut,pt,ht,_t],styles:["ion-split-pane[_ngcontent-%COMP%]{--side-width: 500px;--side-max-width: 500px;--border: 1px dashed #b3baff}"]}),a})()}}]);