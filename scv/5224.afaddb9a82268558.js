"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[5224],{5224:(Ct,M,d)=>{d.r(M),d.d(M,{StoryBuilderPage:()=>vt});var v=d(5861),t=d(6689),f=d(6814),p=d(95),u=d(7027),g=d(757),S=d(8645),b=d(9773),L=d(1374),Z=d(4475),N=d(1828),A=d(902),F=d(5311),O=d(2620),D=d(8182),J=d(8536),U=d(9593),G=d(3822),I=d(6093),B=d(2064),x=d(7157);const Q=["mapElementRef"];let P=(()=>{var n;class a{constructor(e){this.locationService=e,this.startPoint=[39.25186060990359,-76.83157331721733],this.coordinateClick=new t.vpe,this.features={}}ngOnInit(){this.setUpMap()}setUpMap(){const[e,o]=this.startPoint,s=this.locationService.transformFromLocation2Coordinate([o,e]);(0,B.eL)(),this.map=new Z.Z({view:new N.ZP({center:s,zoom:18}),layers:[new O.Z({source:new J.Z})],target:"ol-map"});const c=new U.Z({features:[]});this.markerSource=c;const l=new D.Z({source:c});this.map.addLayer(l),this.map.on("click",h=>{var m;if(!this.map)return;const y=this.map.getCoordinateFromPixel(h.pixel),yt=[y[0],y[1]],w=null===(m=this.map)||void 0===m?void 0:m.forEachFeatureAtPixel(h.pixel,_t=>_t);this.selectedFeature&&this.setSelectedStatus(this.selectedFeature,!1),w&&this.setSelectedStatus(w,!0),this.selectedFeature=w,this.coordinateClick.emit({coordinate:yt,event:h,feature:w})}),setTimeout(()=>{!this.map||!this.mapElementRef||this.map.setTarget(this.mapElementRef.nativeElement)})}goToPoint(e,o=18){if(!this.map)return;const r=this.locationService.transformFromLocation2Coordinate([e[1],e[0]]),s=this.map.getView();s.setCenter(r),s.setZoom(o)}addPoint(){}getStyle(e){return new I.ZP({image:new G.Z({anchor:[.5,.5],anchorXUnits:"fraction",anchorYUnits:"fraction",size:[70,70],src:e})})}setSelectedStatus(e,o){const r=e.getStyle();o?r.getImage().setScale(1.5):r.getImage().setScale(1),e.setStyle(r)}addMarker(e,o){if(!this.markerSource)throw new Error("");const[r,s]=e,c=this.locationService.transformFromLocation2Coordinate([r,s]),l=new A.Z({geometry:new F.Z(c),data:o}),h=this.getStyle(o.img);l.setStyle(h),this.markerSource.addFeature(l);const m=o.pointId;return this.features[m]&&this.markerSource.removeFeature(this.features[m]),this.features[m]=l,this.selectedFeature&&this.setSelectedStatus(this.selectedFeature,!1),this.selectedFeature=l,l}addCss(e){var o;(null===(o=this.mapElementRef)||void 0===o?void 0:o.nativeElement).classList.add(e)}removeCss(e){var o;(null===(o=this.mapElementRef)||void 0===o?void 0:o.nativeElement).classList.remove(e)}removeMarker(e){if(!this.markerSource)throw new Error("");if(!e)throw new Error("pointid cannot be null");const o=this.features[e];if(!o)throw new Error("feature not found");this.markerSource.removeFeature(o),delete this.features[e]}}return(n=a).\u0275fac=function(e){return new(e||n)(t.Y36(x.a))},n.\u0275cmp=t.Xpm({type:n,selectors:[["app-coordinate-selection"]],viewQuery:function(e,o){if(1&e&&t.Gf(Q,7),2&e){let r;t.iGM(r=t.CRH())&&(o.mapElementRef=r.first)}},inputs:{startPoint:"startPoint"},outputs:{coordinateClick:"coordinateClick"},standalone:!0,features:[t.jDz],decls:3,vars:0,consts:[["id","ol-map",1,"map-container"],["mapElementRef",""]],template:function(e,o){1&e&&(t.ynx(0),t._UZ(1,"div",0,1),t.BQk())},dependencies:[u.Pc,p.u5,f.ez],styles:["[_nghost-%COMP%]{display:flex;flex-grow:1;flex-direction:column;height:100vh}.map-container[_ngcontent-%COMP%]{flex-grow:1}.addStory[_ngcontent-%COMP%]{cursor:crosshair}"]}),a})();var E=d(7285);const j=["editor"];let _=(()=>{var n;class a{set code(e){this.editor&&(this.editor.code=e)}get code(){var e;return(null===(e=this.editor)||void 0===e?void 0:e.code)||""}get location(){var e;const o=(null===(e=this.item)||void 0===e||null===(e=e.feature)||void 0===e||null===(e=e.getGeometry())||void 0===e?void 0:e.getCoordinates())||[0,0];return[o[0],o[1]]}getClean(){return this.code.split("\n").map(o=>o.replace(/\/\/.*/g,"")).join("\n")}validate(){return JSON.parse(this.getClean())}loadFromObj(e){this.code=JSON.stringify(e,null,2)}constructor(){this.destroy$=new S.x}ngOnInit(){this.item&&(this.code=this.getJson(),this.item.component=this)}ngOnDestroy(){this.destroy$.next(),this.destroy$.unsubscribe(),console.log("destroying")}locationStr(){return JSON.stringify(this.location)}shortAnswer(){return`{\n  "id": "",\n  "title": "",\n  "location": ${this.locationStr()},\n  "enabled": true,\n  "body": {\n    "type": "shortanswer",\n    "text": "",\n    "action": {\n      "disables": [],     // optional / pointIds to disable\n      "enables": [],      // optional / pointIds to enable\n      "gameCompleted": {    // optional for game ending\n        "finishMessage": "",\n        "title": ""\n      }\n    },\n    "possibleAnswers": [],\n    "messageIfIncorrect": null // optional or string\n  }\n    }`}note(){return`{\n  "id": "",\n  "title": "",\n  "location": ${this.locationStr()},\n  "enabled": true,\n  "body": {\n    "type": "note",\n    "text": "",\n    "action": {\n      "disables": [],     // optional / pointIds to disable\n      "enables": [],      // optional / pointIds to enable\n      "gameCompleted": {    // optional for game ending\n        "finishMessage": "",\n        "title": ""\n      }\n    }\n  }\n    }`}multipleChoice(){return`{\n  "id": "",\n  "title": "",\n  "location": ${this.locationStr()},\n  "enabled": true,\n  "body": {\n    "type": "multiplechoice",\n    "text": "",\n    "action": {\n      "disables": [],     // optional / pointIds to disable\n      "enables": [],      // optional / pointIds to enable\n      "gameCompleted": {    // optional for game ending\n        "finishMessage": "",\n        "title": ""\n      }\n    },\n    "possibleAnswers": [],\n    "messageIfIncorrect": null,\n    "choices": []\n  }\n    }`}getPointJson(e){if("note"===e)return this.note();if("shortanswer"===e)return this.shortAnswer();if("multiplechoice"===e)return this.multipleChoice();const o={id:"",title:"",location:this.location,enabled:!0,body:this._getPoint(e)},r=JSON.stringify(o,null,2);return console.log(r),r}_getPoint(e){const o={type:e,text:"",action:{disables:[],enables:[],gameCompleted:{finishMessage:"",title:""}}},r={possibleAnswers:[],messageIfIncorrect:null};switch(e){case"note":return{...o};case"shortanswer":return{...o,...r};case"multiplechoice":return{...o,...r,choices:[]}}throw new Error("error);")}}return(n=a).\u0275fac=function(e){return new(e||n)},n.\u0275dir=t.lG2({type:n,viewQuery:function(e,o){if(1&e&&t.Gf(j,7),2&e){let r;t.iGM(r=t.CRH())&&(o.editor=r.first)}},inputs:{item:"item"}}),a})();var k=d(2181),R=d(8180),$=d(5619);const V=["editor"],T="MONACO_PATH";let Y=(()=>{class n{constructor(i,e){this.ngZone=i,this.monacoPathConfig=e,this.isMonacoLoaded$=new $.X(!1),this._monacoPath="assets/monaco-editor/min/vs",window.monacoEditorAlreadyInitialized?i.run(()=>this.isMonacoLoaded$.next(!0)):(window.monacoEditorAlreadyInitialized=!0,this.monacoPathConfig&&(this.monacoPath=this.monacoPathConfig),this.loadMonaco())}set monacoPath(i){i&&(this._monacoPath=i)}loadMonaco(){const i=()=>{let s=this._monacoPath;window.amdRequire=window.require;const c=!!this.nodeRequire,l=s.includes("http");c&&(window.require=this.nodeRequire,l||(s=window.require("path").resolve(window.__dirname,this._monacoPath))),window.amdRequire.config({paths:{vs:s}}),window.amdRequire(["vs/editor/editor.main"],()=>{this.ngZone.run(()=>this.isMonacoLoaded$.next(!0))},h=>console.error("Error loading monaco-editor: ",h))};if(window.amdRequire)return i();window.require&&(this.addElectronFixScripts(),this.nodeRequire=window.require);const r=document.createElement("script");r.type="text/javascript",r.src=`${this._monacoPath}/loader.js`,r.addEventListener("load",i),document.body.appendChild(r)}addElectronFixScripts(){const i=document.createElement("script"),e=document.createTextNode("self.module = undefined;"),o=document.createTextNode("self.process.browser = true;");i.appendChild(e),i.appendChild(o),document.body.appendChild(i)}}return n.\u0275fac=function(i){return new(i||n)(t.LFG(t.R0b),t.LFG(T,8))},n.\u0275prov=t.Yz7({token:n,factory:n.\u0275fac,providedIn:"root"}),n})(),q=(()=>{class n{constructor(i){this.monacoLoader=i,this.init=new t.vpe,this.onTouched=()=>{},this.onErrorStatusChange=()=>{},this.propagateChange=()=>{}}get model(){return this.editor&&this.editor.getModel()}get modelMarkers(){return this.model&&monaco.editor.getModelMarkers({resource:this.model.uri})}ngOnInit(){this.monacoLoader.isMonacoLoaded$.pipe((0,k.h)(i=>i),(0,R.q)(1)).subscribe(()=>{this.initEditor()})}ngOnChanges(i){if(this.editor&&i.options&&!i.options.firstChange){const{language:e,theme:o,...r}=i.options.currentValue,{language:s,theme:c}=i.options.previousValue;s!==e&&monaco.editor.setModelLanguage(this.editor.getModel(),this.options&&this.options.language?this.options.language:"text"),c!==o&&monaco.editor.setTheme(o),this.editor.updateOptions(r)}if(this.editor&&i.uri){const e=i.uri.currentValue,o=i.uri.previousValue;if(o&&!e||!o&&e||e&&o&&e.path!==o.path){const r=this.editor.getValue();let s;this.modelUriInstance&&this.modelUriInstance.dispose(),e&&(s=monaco.editor.getModels().find(c=>c.uri.path===e.path)),this.modelUriInstance=s||monaco.editor.createModel(r,this.options.language||"text",this.uri),this.editor.setModel(this.modelUriInstance)}}}writeValue(i){this.value=i,this.editor&&i?this.editor.setValue(i):this.editor&&this.editor.setValue("")}registerOnChange(i){this.propagateChange=i}registerOnTouched(i){this.onTouched=i}validate(){return this.parsedError?{monaco:{value:this.parsedError.split("|")}}:null}registerOnValidatorChange(i){this.onErrorStatusChange=i}initEditor(){const i={value:[this.value].join("\n"),language:"text",automaticLayout:!0,scrollBeyondLastLine:!1,theme:"vc"};this.editor=monaco.editor.create(this.editorContent.nativeElement,this.options?{...i,...this.options}:i),this.registerEditorListeners(),this.init.emit(this.editor)}registerEditorListeners(){this.editor.onDidChangeModelContent(()=>{this.propagateChange(this.editor.getValue())}),this.editor.onDidChangeModelDecorations(()=>{const i=this.modelMarkers.map(({message:o})=>o).join("|");this.parsedError!==i&&(this.parsedError=i,this.onErrorStatusChange())}),this.editor.onDidBlurEditorText(()=>{this.onTouched()})}ngOnDestroy(){this.editor&&this.editor.dispose()}}return n.\u0275fac=function(i){return new(i||n)(t.Y36(Y))},n.\u0275cmp=t.Xpm({type:n,selectors:[["ngx-monaco-editor"]],viewQuery:function(i,e){if(1&i&&t.Gf(V,7),2&i){let o;t.iGM(o=t.CRH())&&(e.editorContent=o.first)}},inputs:{options:"options",uri:"uri"},outputs:{init:"init"},features:[t._Bn([{provide:p.JU,useExisting:(0,t.Gpc)(()=>n),multi:!0},{provide:p.Cf,useExisting:(0,t.Gpc)(()=>n),multi:!0}]),t.TTD],decls:4,vars:0,consts:[["fxFlex","",1,"editor-container"],["container",""],[1,"monaco-editor"],["editor",""]],template:function(i,e){1&i&&(t.TgZ(0,"div",0,1),t._UZ(2,"div",2,3),t.qZA())},styles:[".monaco-editor[_ngcontent-%COMP%]{position:absolute;top:0;bottom:0;left:0;right:0}.editor-container[_ngcontent-%COMP%]{overflow:hidden;position:relative;display:table;width:100%;height:100%;min-width:0}"],changeDetection:0}),n})(),z=(()=>{class n{}return n.\u0275fac=function(i){return new(i||n)},n.\u0275mod=t.oAB({type:n}),n.\u0275inj=t.cJS({imports:[[]]}),n})(),C=(()=>{var n;class a{constructor(){this.code="",this.codeChange=new t.vpe,this.editorOptions={language:"json",theme:"vs-dark",automaticLayout:!0,minimap:{enabled:!1}}}ngOnInit(){}}return(n=a).\u0275fac=function(e){return new(e||n)},n.\u0275cmp=t.Xpm({type:n,selectors:[["app-editor"]],viewQuery:function(e,o){if(1&e&&t.Gf(n,5),2&e){let r;t.iGM(r=t.CRH())&&(o.monacoComponent=r.first)}},inputs:{code:"code"},outputs:{codeChange:"codeChange"},standalone:!0,features:[t._Bn([{provide:T,useValue:"https://unpkg.com/monaco-editor@0.36.1/min/vs"}]),t.jDz],decls:2,vars:2,consts:[[1,"codeArea"],[3,"options","ngModel","ngModelChange"]],template:function(e,o){1&e&&(t.TgZ(0,"div",0)(1,"ngx-monaco-editor",1),t.NdJ("ngModelChange",function(s){return o.code=s}),t.qZA()()),2&e&&(t.xp6(1),t.Q6J("options",o.editorOptions)("ngModel",o.code))},dependencies:[u.Pc,p.u5,p.JJ,p.On,f.ez,z,q],styles:["ngx-monaco-editor[_ngcontent-%COMP%]{height:calc(100% - 60px);width:100%}.codeArea[_ngcontent-%COMP%]{height:50vh;width:100%}"]}),a})(),H=(()=>{var n;class a extends _{constructor(){super()}getJson(){return JSON.stringify({id:"sample",name:"Sample Game",description:"Hi, welcome to my experiment! :)",location:this.location,zoom:18},null,2)}}return(n=a).\u0275fac=function(e){return new(e||n)},n.\u0275cmp=t.Xpm({type:n,selectors:[["app-game-details"]],standalone:!0,features:[t.qOj,t.jDz],decls:2,vars:0,consts:[["editor",""]],template:function(e,o){1&e&&t._UZ(0,"app-editor",null,0)},dependencies:[u.Pc,f.ez,p.u5,p.UX,C]}),a})(),X=(()=>{var n;class a extends _{constructor(){super()}getJson(){return this.getPointJson("multiplechoice")}}return(n=a).\u0275fac=function(e){return new(e||n)},n.\u0275cmp=t.Xpm({type:n,selectors:[["app-new-multiple-choice"]],standalone:!0,features:[t.qOj,t.jDz],decls:2,vars:0,consts:[["editor",""]],template:function(e,o){1&e&&t._UZ(0,"app-editor",null,0)},dependencies:[u.Pc,f.ez,p.u5,p.UX,C]}),a})(),K=(()=>{var n;class a extends _{constructor(){super()}getJson(){return this.getPointJson("note")}}return(n=a).\u0275fac=function(e){return new(e||n)},n.\u0275cmp=t.Xpm({type:n,selectors:[["app-new-note"]],standalone:!0,features:[t.qOj,t.jDz],decls:2,vars:0,consts:[["editor",""]],template:function(e,o){1&e&&t._UZ(0,"app-editor",null,0)},dependencies:[u.Pc,f.ez,p.u5,p.UX,C]}),a})(),W=(()=>{var n;class a extends _{constructor(){super()}getJson(){return this.getPointJson("shortanswer")}}return(n=a).\u0275fac=function(e){return new(e||n)},n.\u0275cmp=t.Xpm({type:n,selectors:[["app-new-short-answer"]],standalone:!0,features:[t.qOj,t.jDz],decls:2,vars:0,consts:[["editor",""]],template:function(e,o){1&e&&t._UZ(0,"app-editor",null,0)},dependencies:[u.Pc,f.ez,p.u5,p.UX,C]}),a})();var tt=d(6546),et=d(4321),ot=d(8939),it=d(309);const nt=["pointAccordion"];function rt(n,a){if(1&n){const i=t.EpF();t.TgZ(0,"ion-accordion",10)(1,"ion-item",11)(2,"ion-label"),t._uU(3,"Url"),t.qZA()(),t.TgZ(4,"div",12)(5,"code"),t._uU(6),t.qZA(),t._UZ(7,"br"),t.TgZ(8,"ion-button",3),t.NdJ("click",function(){t.CHM(i);const o=t.oxw();return t.KtG(o.copyUrl())}),t._uU(9," copy url "),t.qZA()()()}if(2&n){const i=t.oxw();t.xp6(6),t.hij(" ",i.qrData," ")}}function st(n,a){if(1&n){const i=t.EpF();t.TgZ(0,"ion-button",3),t.NdJ("click",function(){t.CHM(i);const o=t.oxw();return t.KtG(o.addNewPoint())}),t._uU(1," Add Start Location "),t.qZA()}}function at(n,a){if(1&n){const i=t.EpF();t.TgZ(0,"ion-button",3),t.NdJ("click",function(){t.CHM(i);const o=t.oxw();return t.KtG(o.selectNewLocation())}),t._uU(1," Select New Location "),t.qZA()}}function ct(n,a){if(1&n){const i=t.EpF();t.TgZ(0,"ion-item-divider")(1,"ion-label"),t._uU(2," Add "),t.qZA(),t.TgZ(3,"ion-button",13),t.NdJ("click",function(){t.CHM(i);const o=t.oxw();return t.KtG(o.addPoint("note"))}),t._uU(4," Note "),t.qZA(),t.TgZ(5,"ion-button",13),t.NdJ("click",function(){t.CHM(i);const o=t.oxw();return t.KtG(o.addPoint("shortanswer"))}),t._uU(6," Short Answer "),t.qZA(),t.TgZ(7,"ion-button",13),t.NdJ("click",function(){t.CHM(i);const o=t.oxw();return t.KtG(o.addPoint("multiplechoice"))}),t._uU(8," Multiple Choice "),t.qZA(),t.TgZ(9,"ion-button",13),t.NdJ("click",function(){t.CHM(i);const o=t.oxw();return t.KtG(o.addPoint("choice"))}),t._uU(10," Choice "),t.qZA()()}}function dt(n,a){if(1&n){const i=t.EpF();t.TgZ(0,"ion-button",3),t.NdJ("click",function(){t.CHM(i);const o=t.oxw().$implicit,r=t.oxw();return t.KtG(r.removePoint(o,!0))}),t._uU(1,"x"),t.qZA()}}function lt(n,a){if(1&n&&(t.ynx(0),t._UZ(1,"app-game-details",19),t.BQk()),2&n){const i=t.oxw().$implicit;t.xp6(1),t.Q6J("item",i)}}function ut(n,a){if(1&n&&(t.ynx(0),t._UZ(1,"app-new-short-answer",19),t.BQk()),2&n){const i=t.oxw().$implicit;t.xp6(1),t.Q6J("item",i)}}function pt(n,a){if(1&n&&(t.ynx(0),t._UZ(1,"app-new-multiple-choice",19),t.BQk()),2&n){const i=t.oxw().$implicit;t.xp6(1),t.Q6J("item",i)}}function ht(n,a){if(1&n&&(t.ynx(0),t._UZ(1,"app-new-note",19),t.BQk()),2&n){const i=t.oxw().$implicit;t.xp6(1),t.Q6J("item",i)}}function mt(n,a){1&n&&(t.ynx(0),t._uU(1," decision "),t.BQk())}function ft(n,a){1&n&&t.GkF(0)}function gt(n,a){if(1&n&&(t.TgZ(0,"ion-accordion",14)(1,"ion-item",11)(2,"ion-label"),t._uU(3),t.qZA(),t.YNc(4,dt,2,0,"ion-button",5),t.qZA(),t.TgZ(5,"div",15),t.ynx(6,16),t.YNc(7,lt,2,1,"ng-container",17),t.YNc(8,ut,2,1,"ng-container",17),t.YNc(9,pt,2,1,"ng-container",17),t.YNc(10,ht,2,1,"ng-container",17),t.YNc(11,mt,2,0,"ng-container",17),t.YNc(12,ft,1,0,"ng-container",18),t.BQk(),t.qZA()()),2&n){const i=a.$implicit;t.Q6J("value",i.index),t.xp6(3),t.Oqu(i.title),t.xp6(1),t.Q6J("ngIf","start"!==i.type),t.xp6(2),t.Q6J("ngSwitch",i.type),t.xp6(1),t.Q6J("ngSwitchCase","start"),t.xp6(1),t.Q6J("ngSwitchCase","shortanswer"),t.xp6(1),t.Q6J("ngSwitchCase","multiplechoice"),t.xp6(1),t.Q6J("ngSwitchCase","note"),t.xp6(1),t.Q6J("ngSwitchCase","decision")}}let vt=(()=>{var n;class a{constructor(e,o,r,s,c,l){this.fb=e,this.gameService=o,this.onlineService=r,this.locationService=s,this.info=c,this.router=l,this.destroy$=new S.x,this.pointCounter=1,this.newPointLocation=!1,this.pointSelected$=new S.x,this.pointList=[]}clear(e){var o=this;return(0,v.Z)(function*(){if(!e||(yield o.info.confirmYesNo("clear?","sure to clear?"))){for(const r of[...o.pointList])yield o.removePoint(r,!1);o.pointCounter=1,o.activePoint=void 0}})()}ngOnInit(){var e,o,r;this.coordinateSelected$=null===(e=this.map)||void 0===e?void 0:e.coordinateClick.pipe((0,b.R)(this.destroy$)),null===(o=this.coordinateSelected$)||void 0===o||o.pipe((0,b.R)(this.destroy$)).subscribe(s=>{var c,l;this.activePoint&&this.newPointLocation&&(null===(c=this.activePoint.getGeometry())||void 0===c||c.setCoordinates(s.coordinate),s.feature=this.activePoint,this.newPointLocation=!1),!s.feature&&this.addingPointType&&(this.addMarkerToMap(s.coordinate,this.addingPointType,this.addingPointType,s),null===(l=this.map)||void 0===l||l.removeCss("addStory")),this.pointSelected$.next(s.feature)}),this.pointSelected$.pipe((0,b.R)(this.destroy$)).subscribe(s=>{if(this.activePoint=s,!s)return;const c=s.get("data");this.pointsAccordion&&(this.pointsAccordion.value=c.pointId.toString()||"")}),(0,t.X6Q)()&&(null===(r=this.map)||void 0===r||r.goToPoint([39.25186060990359,-76.83157331721733])),this.locationService.watchLocation().pipe((0,L.P)()).subscribe(s=>{var c;const l=this.locationService.transformFromGeoLocation(s);null===(c=this.map)||void 0===c||c.goToPoint([l[1],l[0]])})}addMarkerToMap(e,o,r,s){var c;const l=!this.pointList.length,h=this.pointCounter++,m=null===(c=this.map)||void 0===c?void 0:c.addMarker(e,{pointId:h,img:l?E.P.startLocation:E.P.pointMarker,start:l});m&&(this.pointList.push({index:h,title:o,type:r,feature:m}),s&&(s.feature=m)),this.addingPointType=void 0}ngOnDestroy(){this.destroy$.next(),this.destroy$.unsubscribe()}addNewPoint(){this._addPoint("start")}_addPoint(e){var o;this.addingPointType=e,null===(o=this.map)||void 0===o||o.addCss("addStory")}selectNewLocation(){this.newPointLocation=!0}addPoint(e){this._addPoint(e)}removePoint(e,o){var r=this;return(0,v.Z)(function*(){var s;if(o&&!(yield r.info.confirmYesNo("Remove",`Are you sure to remove ${e.title}?`)))return;null===(s=r.map)||void 0===s||s.removeMarker(""+e.index);const c=r.pointList.indexOf(e);r.pointList.splice(c,1)})()}generateQR(e){try{this.qrData=null,this.qrData=((0,t.X6Q)()?"http://localhost:8100":"https://msarica.github.io/scv")+"/#?storyKey="+e}catch(o){this.info.alert(o.message)}}copyUrl(){navigator.clipboard.writeText(this.qrData),this.info.alert("copied")}createGameObj(){try{var e;const r=[...this.pointList],s=r.shift(),c=null==s||null===(e=s.component)||void 0===e?void 0:e.validate(),l=[];for(const m of r)try{var o;const y=null===(o=m.component)||void 0===o?void 0:o.validate();l.push(y)}catch(y){throw console.error(y),new Error(`Error: ${m.index}: ${y.message}`)}return{...c,points:l}}catch(r){throw this.info.alert(r.message,"Error"),r}}onSubmit(){var e=this;return(0,v.Z)(function*(){if(0!==e.pointList.length)try{const o=e.createGameObj();console.log(o),e.gameService.validateGame(o),console.log(JSON.stringify(o)),yield e.submitStory(o)}catch(o){e.info.alert(null==o?void 0:o.message,"Error")}else e.info.alert("No points!")})()}submitStory(e){var o=this;return(0,v.Z)(function*(){const r=yield o.info.input("Pass"),s=e.id.replace(/\s/,"_");try{o.validateStoryKey(s,r)}catch(l){o.info.alert(l.message)}const c=JSON.stringify(e);yield o.onlineService.saveStory(s.trim().toLowerCase(),r,c),o.generateQR(s)})()}validateStoryKey(e,o){if(""===(null==e?void 0:e.trim()))throw new Error("StoryKey is not valid");if(e.includes(" "))throw new Error("Key cannot contain spaces")}correctStory(e){try{e=JSON.parse(JSON.stringify(e));const o=this.correctValues(e);return this.gameService.validateGame(o),o}catch(o){throw console.error(o),o}}correctValues(e){e.zoom=18,e.location=(0,g.qS)(e.location);for(const o of e.points)o.location=(0,g.qS)(o.location),"multiplechoice"===o.body.type?(o.body.choices=(0,g.W7)(o.body.choices)||[],o.body.possibleAnswers=(0,g.W7)(o.body.possibleAnswers)||[]):"shortanswer"===o.body.type&&(o.body.possibleAnswers=(0,g.W7)(o.body.possibleAnswers)||[]),o.body.action&&(o.body.action.enables=(0,g.W7)(o.body.action.enables),o.body.action.disables=(0,g.W7)(o.body.action.disables));return e}correctValuesToForm(e){return e}parseJson(e){return e=e.replace(/\/\/.*$/g,""),JSON.parse(e)}loadFromJson(){var e=this;return(0,v.Z)(function*(){try{const o=yield e.info.input("JSON");let r=e.parseJson(o);e.gameService.validateGame(r),yield e._setUpGameForm(r)}catch(o){console.error(o),e.info.alert(o.message,"Error")}})()}loadFromKey(){var e=this;return(0,v.Z)(function*(){try{const o=yield e.info.input("Key"),r=yield e.gameService.getGameById(o.trim()),s=null==r?void 0:r.game;if(!s)return void e.info.alert("Game not found");e.gameService.validateGame(s),yield e._setUpGameForm(s)}catch(o){console.error(o),e.info.alert(o.message,"Error")}})()}_setUpGameForm(e){var o=this;return(0,v.Z)(function*(){yield o.clear(),e=o.correctValuesToForm(e),o.addMarkerToMap(e.location,e.id,"start"),e.points.forEach(r=>{r.body.type&&o.addMarkerToMap(r.location,r.id,r.body.type)}),setTimeout(()=>{const r=e.points;o.pointList.forEach((s,c)=>{s.component&&s.component.loadFromObj("start"===s.type?{...e,points:void 0}:r[c-1])})},10)})()}}return(n=a).\u0275fac=function(e){return new(e||n)(t.Y36(p.qu),t.Y36(tt.h),t.Y36(et.x),t.Y36(x.a),t.Y36(ot.C),t.Y36(it.F0))},n.\u0275cmp=t.Xpm({type:n,selectors:[["app-story-builder"]],viewQuery:function(e,o){if(1&e&&(t.Gf(P,7),t.Gf(nt,7)),2&e){let r;t.iGM(r=t.CRH())&&(o.map=r.first),t.iGM(r=t.CRH())&&(o.pointsAccordion=r.first)}},standalone:!0,features:[t.jDz],decls:27,vars:5,consts:[["when","xs","contentId","main"],["contentId","main"],[1,"ion-padding"],[3,"click"],["value","qr",4,"ngIf"],[3,"click",4,"ngIf"],[4,"ngIf"],["pointAccordion",""],[3,"value",4,"ngFor","ngForOf"],["id","main",1,"ion-page"],["value","qr"],["slot","header","color","light"],["slot","content",1,"ion-padding"],["size","small",3,"click"],[3,"value"],["slot","content"],[3,"ngSwitch"],[4,"ngSwitchCase"],[4,"ngSwitchDefault"],[3,"item"]],template:function(e,o){1&e&&(t.TgZ(0,"ion-header")(1,"ion-toolbar")(2,"ion-title"),t._uU(3,"story-builder"),t.qZA()()(),t.TgZ(4,"ion-content")(5,"ion-split-pane",0)(6,"ion-menu",1)(7,"ion-content",2)(8,"ion-button",3),t.NdJ("click",function(){return o.loadFromJson()}),t._uU(9," Load From Json "),t.qZA(),t.TgZ(10,"ion-button",3),t.NdJ("click",function(){return o.loadFromKey()}),t._uU(11," Load From Key "),t.qZA(),t.TgZ(12,"ion-button",3),t.NdJ("click",function(){return o.clear(!0)}),t._uU(13," Clear "),t.qZA(),t.TgZ(14,"ion-accordion-group"),t.YNc(15,rt,10,1,"ion-accordion",4),t.qZA(),t.YNc(16,st,2,0,"ion-button",5),t.YNc(17,at,2,0,"ion-button",5),t.YNc(18,ct,11,0,"ion-item-divider",6),t.TgZ(19,"ion-accordion-group",null,7),t.YNc(21,gt,13,9,"ion-accordion",8),t.qZA(),t.TgZ(22,"ion-button",3),t.NdJ("click",function(){return o.onSubmit()}),t._uU(23," Submit "),t.qZA()()(),t.TgZ(24,"div",9)(25,"ion-content"),t._UZ(26,"app-coordinate-selection"),t.qZA()()()()),2&e&&(t.xp6(15),t.Q6J("ngIf",o.qrData),t.xp6(1),t.Q6J("ngIf",!o.pointList.length),t.xp6(1),t.Q6J("ngIf",o.activePoint),t.xp6(1),t.Q6J("ngIf",o.pointList.length),t.xp6(3),t.Q6J("ngForOf",o.pointList))},dependencies:[u.Pc,u.We,u.eh,u.YG,u.W2,u.Gu,u.Ie,u.rH,u.Q$,u.z0,u.jI,u.wd,u.sr,f.ez,f.sg,f.O5,f.RF,f.n9,f.ED,p.u5,p.UX,P,H,X,K,W],styles:["ion-split-pane[_ngcontent-%COMP%]{--side-width: 500px;--side-max-width: 500px;--border: 1px dashed #b3baff}"]}),a})()}}]);