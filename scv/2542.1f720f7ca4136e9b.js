"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[2542],{2542:(wt,Z,m)=>{m.r(Z),m.d(Z,{StoryBuilderPage:()=>Ct});var x=m(5861),t=m(6689),v=m(6814),l=m(95),u=m(7027);function C(n){if(n)return n.split(",").filter(s=>null==s?void 0:s.trim().length).map(s=>s.trim())}function w(n){return n?n.join(","):null}function A(n){return Array.isArray(n)?n:JSON.parse(n)}function M(n){if(!n)return;const s="^"+n.replace("*",".+")+"$";return new RegExp(s,"g")}function F(n){if(n)return n.split(",").map(s=>null==s?void 0:s.trim()).filter(s=>!!s)}function J(n,s,a,e){let o=s.filter(c=>null==c?void 0:c.trim().length).map(c=>({regex:M(c),mask:c}));for(const c of o)if(!n.some(d=>c.regex&&d.match(c.regex))){var i,r;return null===(i=a.get("body"))||void 0===i||null===(i=i.get("action"))||void 0===i||null===(i=i.get("enables"))||void 0===i||i.setErrors({valid:!1}),{notValid:`${null===(r=a.get("id"))||void 0===r?void 0:r.value}: ${e}: ${c.mask} did not match any of point ids!`}}}var T=m(8645),N=m(9773),V=m(1374),L=m(4475),q=m(1828),O=m(902),D=m(5311),Y=m(2620),j=m(8182),R=m(8536),z=m(9593),K=m(3822),X=m(6093),H=m(2064),I=m(7157);const W=["mapElementRef"];let U=(()=>{var n;class s{constructor(e){this.locationService=e,this.startPoint=[39.25186060990359,-76.83157331721733],this.coordinateClick=new t.vpe,this.features={}}ngOnInit(){this.setUpMap()}setUpMap(){const[e,o]=this.startPoint,r=this.locationService.transformFromLocation2Coordinate([o,e]);(0,H.eL)(),this.map=new L.Z({view:new q.ZP({center:r,zoom:18}),layers:[new Y.Z({source:new R.Z})],target:"ol-map"});const c=new z.Z({features:[]});this.markerSource=c;const d=new j.Z({source:c});this.map.addLayer(d),this.map.on("click",f=>{var p;if(!this.map)return;const h=this.map.getCoordinateFromPixel(f.pixel),b=[h[0],h[1]],y=null===(p=this.map)||void 0===p?void 0:p.forEachFeatureAtPixel(f.pixel,S=>S);this.selectedFeature&&this.setSelectedStatus(this.selectedFeature,!1),y&&this.setSelectedStatus(y,!0),this.selectedFeature=y,this.coordinateClick.emit({coordinate:b,event:f,feature:y})}),setTimeout(()=>{!this.map||!this.mapElementRef||this.map.setTarget(this.mapElementRef.nativeElement)})}goToPoint(e,o=18){if(!this.map)return;const i=this.locationService.transformFromLocation2Coordinate([e[1],e[0]]),r=this.map.getView();r.setCenter(i),r.setZoom(o)}addPoint(){}getStyle(e){return new X.ZP({image:new K.Z({anchor:[.5,.5],anchorXUnits:"fraction",anchorYUnits:"fraction",size:[70,70],src:e})})}setSelectedStatus(e,o){const i=e.getStyle();o?i.getImage().setScale(1.5):i.getImage().setScale(1),e.setStyle(i)}addMarker(e,o){if(!this.markerSource)throw new Error("");const[i,r]=e,c=this.locationService.transformFromLocation2Coordinate([i,r]),d=new O.Z({geometry:new D.Z(c),data:o}),f=this.getStyle(o.img);d.setStyle(f),this.markerSource.addFeature(d);const p=o.pointId;return this.features[p]&&this.markerSource.removeFeature(this.features[p]),this.features[p]=d,this.selectedFeature&&this.setSelectedStatus(this.selectedFeature,!1),this.selectedFeature=d,d}addCss(e){var o;(null===(o=this.mapElementRef)||void 0===o?void 0:o.nativeElement).classList.add(e)}removeCss(e){var o;(null===(o=this.mapElementRef)||void 0===o?void 0:o.nativeElement).classList.remove(e)}removeMarker(e){if(!this.markerSource)throw new Error("");if(!e)throw new Error("pointid cannot be null");const o=this.features[e];if(!o)throw new Error("feature not found");this.markerSource.removeFeature(o),delete this.features[e]}}return(n=s).\u0275fac=function(e){return new(e||n)(t.Y36(I.a))},n.\u0275cmp=t.Xpm({type:n,selectors:[["app-coordinate-selection"]],viewQuery:function(e,o){if(1&e&&t.Gf(W,7),2&e){let i;t.iGM(i=t.CRH())&&(o.mapElementRef=i.first)}},inputs:{startPoint:"startPoint"},outputs:{coordinateClick:"coordinateClick"},standalone:!0,features:[t.jDz],decls:3,vars:0,consts:[["id","ol-map",1,"map-container"],["mapElementRef",""]],template:function(e,o){1&e&&(t.ynx(0),t._UZ(1,"div",0,1),t.BQk())},dependencies:[u.Pc,l.u5,v.ez],styles:["[_nghost-%COMP%]{display:flex;flex-grow:1;flex-direction:column;height:100vh}.map-container[_ngcontent-%COMP%]{flex-grow:1}.addStory[_ngcontent-%COMP%]{cursor:crosshair}"]}),s})();var k=m(7285);let _=(()=>{var n;class s{get location(){var e;const o=(null===(e=this.item)||void 0===e||null===(e=e.feature)||void 0===e||null===(e=e.getGeometry())||void 0===e?void 0:e.getCoordinates())||[0,0];return[o[0],o[1]]}constructor(){this.destroy$=new T.x,this.fb=(0,t.f3M)(l.qu),this.form=this.getForm()}ngOnInit(){var e;this.item&&(this.item.form=this.form,null===(e=this.form.controls.location)||void 0===e||e.setValue(this.location),this.form.valueChanges.pipe((0,N.R)(this.destroy$)).subscribe(o=>{this.item&&(this.item.title=o.id)}))}ngOnDestroy(){this.destroy$.next(),this.destroy$.unsubscribe(),console.log("destroying")}getPoint(e){return this.fb=(0,t.f3M)(l.qu),this.fb.group({id:this.fb.control(null,[l.kI.required]),title:this.fb.control(null,[l.kI.required]),location:this.fb.control(this.location,[l.kI.required]),enabled:this.fb.control(!0,[]),body:this._getPoint(e)})}_getPoint(e){const o={type:e,title:this.fb.control(null,[l.kI.required]),text:this.fb.control(null,[l.kI.required]),action:this.fb.control(null,[])},i={possibleAnswers:this.fb.control(null,[l.kI.required]),messageIfCorrect:this.fb.control(null,[]),messageIfIncorrect:this.fb.control(null,[])};switch(e){case"note":return this.fb.group({...o});case"shortanswer":return this.fb.group({...o,...i});case"multiplechoice":return this.fb.group({...o,...i,choices:this.fb.control(null,[l.kI.required])})}throw new Error("error);")}}return(n=s).\u0275fac=function(e){return new(e||n)},n.\u0275dir=t.lG2({type:n,inputs:{item:"item"}}),s})(),$=(()=>{var n;class s extends _{constructor(){super()}getForm(){return this.fb=(0,t.f3M)(l.qu),this.fb.group({id:this.fb.control(null,[l.kI.required]),zoom:this.fb.control(18),name:this.fb.control(null,[l.kI.required]),description:this.fb.control(null,[l.kI.required]),location:this.fb.control(this.location,[l.kI.required])})}}return(n=s).\u0275fac=function(e){return new(e||n)},n.\u0275cmp=t.Xpm({type:n,selectors:[["app-game-details"]],standalone:!0,features:[t.qOj,t.jDz],decls:5,vars:1,consts:[[3,"formGroup"],["errorText","Not Valid","label","Id","type","text","formControlName","id"],["errorText","Not Valid","label","Name","type","text","formControlName","name"],["errorText","Not Valid","label","Description","formControlName","description"]],template:function(e,o){1&e&&(t.TgZ(0,"div",0)(1,"ion-item-group"),t._UZ(2,"ion-input",1)(3,"ion-input",2)(4,"ion-textarea",3),t.qZA()()),2&e&&t.Q6J("formGroup",o.form)},dependencies:[u.Pc,u.pK,u.Ub,u.g2,u.j9,v.ez,l.u5,l.JJ,l.JL,l.UX,l.sg,l.u]}),s})();function tt(n,s){if(1&n&&(t.ynx(0,1),t._UZ(1,"ion-textarea",2)(2,"ion-textarea",3),t.BQk()),2&n){const a=t.oxw();t.Q6J("formGroup",a.form)}}let P=(()=>{var n;class s{constructor(e){this.fb=e,this.destroy$=new T.x,this._onChange=o=>{},this._onTouched=()=>{},this.form=this.fb.group({enables:this.fb.control(null,[]),disables:this.fb.control(null,[])})}writeValue(e){var o;e&&(null===(o=this.form)||void 0===o||o.setValue(e))}registerOnChange(e){this._onChange=e}registerOnTouched(e){this._onTouched=e}setDisabledState(e){var o,i;e?null===(o=this.form)||void 0===o||o.disable():null===(i=this.form)||void 0===i||i.enable()}ngOnInit(){this.form.valueChanges.pipe((0,N.R)(this.destroy$)).subscribe(e=>{this._onChange(e),this._onTouched()})}ngOnDestroy(){this.destroy$.next(),this.destroy$.unsubscribe()}}return(n=s).\u0275fac=function(e){return new(e||n)(t.Y36(l.qu))},n.\u0275cmp=t.Xpm({type:n,selectors:[["app-enables-disables"]],standalone:!0,features:[t._Bn([{provide:l.JU,useExisting:(0,t.Gpc)(()=>n),multi:!0}]),t.jDz],decls:1,vars:1,consts:[[3,"formGroup",4,"ngIf"],[3,"formGroup"],["errorText","Not Valid","label","Enables","formControlName","enables"],["errorText","Not Valid","label","Disables","formControlName","disables"]],template:function(e,o){1&e&&t.YNc(0,tt,3,1,"ng-container",0),2&e&&t.Q6J("ngIf",o.form)},dependencies:[u.Pc,u.g2,u.j9,v.ez,v.O5,l.u5,l.JJ,l.JL,l.UX,l.sg,l.u]}),s})(),et=(()=>{var n;class s extends _{constructor(){super()}getForm(){return this.getPoint("multiplechoice")}}return(n=s).\u0275fac=function(e){return new(e||n)},n.\u0275cmp=t.Xpm({type:n,selectors:[["app-new-multiple-choice"]],standalone:!0,features:[t.qOj,t.jDz],decls:12,vars:1,consts:[[3,"formGroup"],["errorText","Not Valid","label","Id","type","text","formControlName","id"],["errorText","Not Valid","label","Title","formControlName","title"],["errorText","Not Valid","label","Enabled","slot","start","formControlName","enabled"],["formGroupName","body"],["errorText","Not Valid","label","Text","formControlName","text"],["label","Choices","formControlName","choices"],["errorText","Not Valid","label","Possible Answers","formControlName","possibleAnswers"],["errorText","Not Valid","label","Message If Correct","formControlName","messageIfCorrect"],["errorText","Not Valid","label","Message If Not Correct","formControlName","messageIfIncorrect"],["formControlName","action"]],template:function(e,o){1&e&&(t.TgZ(0,"ion-item-group",0),t._UZ(1,"ion-input",1)(2,"ion-textarea",2),t.TgZ(3,"ion-checkbox",3),t._uU(4,"Enabled"),t.qZA(),t.ynx(5,4),t._UZ(6,"ion-textarea",5)(7,"ion-textarea",6)(8,"ion-textarea",7)(9,"ion-textarea",8)(10,"ion-textarea",9)(11,"app-enables-disables",10),t.BQk(),t.qZA()),2&e&&t.Q6J("formGroup",o.form)},dependencies:[u.Pc,u.nz,u.pK,u.Ub,u.g2,u.w,u.j9,v.ez,l.u5,l.JJ,l.JL,l.UX,l.sg,l.u,l.x0,P]}),s})(),ot=(()=>{var n;class s extends _{constructor(){super()}getForm(){return this.getPoint("note")}}return(n=s).\u0275fac=function(e){return new(e||n)},n.\u0275cmp=t.Xpm({type:n,selectors:[["app-new-note"]],standalone:!0,features:[t.qOj,t.jDz],decls:8,vars:1,consts:[[3,"formGroup"],["errorText","Not Valid","label","Id","type","text","formControlName","id"],["errorText","Not Valid","label","Title","formControlName","title"],["errorText","Not Valid","label","Enabled","slot","start","formControlName","enabled"],["formGroupName","body"],["errorText","Not Valid","label","Text","formControlName","text"],["formControlName","action"]],template:function(e,o){1&e&&(t.TgZ(0,"ion-item-group",0),t._UZ(1,"ion-input",1)(2,"ion-textarea",2),t.TgZ(3,"ion-checkbox",3),t._uU(4,"Enabled"),t.qZA(),t.ynx(5,4),t._UZ(6,"ion-textarea",5)(7,"app-enables-disables",6),t.BQk(),t.qZA()),2&e&&t.Q6J("formGroup",o.form)},dependencies:[u.Pc,u.nz,u.pK,u.Ub,u.g2,u.w,u.j9,v.ez,l.u5,l.JJ,l.JL,l.UX,l.sg,l.u,l.x0,P]}),s})(),nt=(()=>{var n;class s extends _{constructor(){super()}getForm(){return this.getPoint("shortanswer")}}return(n=s).\u0275fac=function(e){return new(e||n)},n.\u0275cmp=t.Xpm({type:n,selectors:[["app-new-short-answer"]],standalone:!0,features:[t.qOj,t.jDz],decls:11,vars:1,consts:[[3,"formGroup"],["errorText","Not Valid","label","Id","type","text","formControlName","id"],["errorText","Not Valid","label","Title","formControlName","title"],["label","Enabled","slot","start","formControlName","enabled"],["formGroupName","body"],["errorText","Not Valid","label","Text","formControlName","text"],["errorText","Not Valid","label","Possible Answers","formControlName","possibleAnswers"],["errorText","Not Valid","label","Message If Correct","formControlName","messageIfCorrect"],["errorText","Not Valid","label","Message If Not Correct","formControlName","messageIfIncorrect"],["formControlName","action"]],template:function(e,o){1&e&&(t.TgZ(0,"ion-item-group",0),t._UZ(1,"ion-input",1)(2,"ion-textarea",2),t.TgZ(3,"ion-checkbox",3),t._uU(4,"Enabled"),t.qZA(),t.ynx(5,4),t._UZ(6,"ion-textarea",5)(7,"ion-textarea",6)(8,"ion-textarea",7)(9,"ion-textarea",8)(10,"app-enables-disables",9),t.BQk(),t.qZA()),2&e&&t.Q6J("formGroup",o.form)},dependencies:[u.Pc,u.nz,u.pK,u.Ub,u.g2,u.w,u.j9,v.ez,l.u5,l.JJ,l.JL,l.UX,l.sg,l.u,l.x0,P]}),s})();var it=m(6546),rt=m(4321),st=m(8939),at=m(309);const lt=["pointAccordion"];function ct(n,s){if(1&n){const a=t.EpF();t.TgZ(0,"ion-accordion",10)(1,"ion-item",11)(2,"ion-label"),t._uU(3,"Url"),t.qZA()(),t.TgZ(4,"div",12)(5,"code"),t._uU(6),t.qZA(),t._UZ(7,"br"),t.TgZ(8,"ion-button",3),t.NdJ("click",function(){t.CHM(a);const o=t.oxw();return t.KtG(o.copyUrl())}),t._uU(9," copy url "),t.qZA()()()}if(2&n){const a=t.oxw();t.xp6(6),t.hij(" ",a.qrData," ")}}function ut(n,s){if(1&n){const a=t.EpF();t.TgZ(0,"ion-button",3),t.NdJ("click",function(){t.CHM(a);const o=t.oxw();return t.KtG(o.addNewPoint())}),t._uU(1," Add Start Location "),t.qZA()}}function dt(n,s){if(1&n){const a=t.EpF();t.TgZ(0,"ion-button",3),t.NdJ("click",function(){t.CHM(a);const o=t.oxw();return t.KtG(o.selectNewLocation())}),t._uU(1," Select New Location "),t.qZA()}}function pt(n,s){if(1&n){const a=t.EpF();t.TgZ(0,"ion-item-divider")(1,"ion-label"),t._uU(2," Add "),t.qZA(),t.TgZ(3,"ion-button",3),t.NdJ("click",function(){t.CHM(a);const o=t.oxw();return t.KtG(o.addPoint("note"))}),t._uU(4," Note "),t.qZA(),t.TgZ(5,"ion-button",3),t.NdJ("click",function(){t.CHM(a);const o=t.oxw();return t.KtG(o.addPoint("shortanswer"))}),t._uU(6," Short Answer "),t.qZA(),t.TgZ(7,"ion-button",3),t.NdJ("click",function(){t.CHM(a);const o=t.oxw();return t.KtG(o.addPoint("multiplechoice"))}),t._uU(8," Multiple Choice "),t.qZA()()}}function mt(n,s){if(1&n){const a=t.EpF();t.TgZ(0,"ion-button",3),t.NdJ("click",function(){t.CHM(a);const o=t.oxw().$implicit,i=t.oxw();return t.KtG(i.removePoint(o))}),t._uU(1,"x"),t.qZA()}}function ft(n,s){if(1&n&&(t.ynx(0),t._UZ(1,"app-game-details",18),t.BQk()),2&n){const a=t.oxw().$implicit;t.xp6(1),t.Q6J("item",a)}}function ht(n,s){if(1&n&&(t.ynx(0),t._UZ(1,"app-new-short-answer",18),t.BQk()),2&n){const a=t.oxw().$implicit;t.xp6(1),t.Q6J("item",a)}}function vt(n,s){if(1&n&&(t.ynx(0),t._UZ(1,"app-new-multiple-choice",18),t.BQk()),2&n){const a=t.oxw().$implicit;t.xp6(1),t.Q6J("item",a)}}function bt(n,s){if(1&n&&(t.ynx(0),t._UZ(1,"app-new-note",18),t.BQk()),2&n){const a=t.oxw().$implicit;t.xp6(1),t.Q6J("item",a)}}function yt(n,s){1&n&&(t.ynx(0),t._uU(1," decision "),t.BQk())}function gt(n,s){1&n&&t.GkF(0)}function xt(n,s){if(1&n&&(t.TgZ(0,"ion-accordion",13)(1,"ion-item",11)(2,"ion-label"),t._uU(3),t.qZA(),t.YNc(4,mt,2,0,"ion-button",5),t.qZA(),t.TgZ(5,"div",14),t.ynx(6,15),t.YNc(7,ft,2,1,"ng-container",16),t.YNc(8,ht,2,1,"ng-container",16),t.YNc(9,vt,2,1,"ng-container",16),t.YNc(10,bt,2,1,"ng-container",16),t.YNc(11,yt,2,0,"ng-container",16),t.YNc(12,gt,1,0,"ng-container",17),t.BQk(),t.qZA()()),2&n){const a=s.$implicit;t.Q6J("value",a.pointId),t.xp6(3),t.Oqu(a.title),t.xp6(1),t.Q6J("ngIf","start"!==a.type),t.xp6(2),t.Q6J("ngSwitch",a.type),t.xp6(1),t.Q6J("ngSwitchCase","start"),t.xp6(1),t.Q6J("ngSwitchCase","shortanswer"),t.xp6(1),t.Q6J("ngSwitchCase","multiplechoice"),t.xp6(1),t.Q6J("ngSwitchCase","note"),t.xp6(1),t.Q6J("ngSwitchCase","decision")}}let Ct=(()=>{var n;class s{constructor(e,o,i,r,c,d){this.fb=e,this.gameService=o,this.onlineService=i,this.locationService=r,this.info=c,this.router=d,this.destroy$=new T.x,this.pointCounter=1,this.points={},this.newPointLocation=!1,this.pointSelected$=new T.x,this.pointList=[]}clear(e){var o=this;return(0,x.Z)(function*(){e&&!(yield o.info.confirmYesNo("clear?","sure to clear?"))||(o.pointList.forEach(i=>{var r;null===(r=o.map)||void 0===r||r.removeMarker(""+i.pointId)}),o.pointList=[],o.pointCounter=1,o.activePoint=void 0)})()}ngOnInit(){var e,o,i;this.coordinateSelected$=null===(e=this.map)||void 0===e?void 0:e.coordinateClick.pipe((0,N.R)(this.destroy$)),null===(o=this.coordinateSelected$)||void 0===o||o.pipe((0,N.R)(this.destroy$)).subscribe(r=>{if(this.activePoint&&this.newPointLocation){var c;const[f,p]=r.coordinate;null===(c=this.activePoint.getGeometry())||void 0===c||c.setCoordinates([p,f]),r.feature=this.activePoint,this.newPointLocation=!1}var d;!r.feature&&this.addingPointType&&(this.addMarkerToMap(r.coordinate,this.addingPointType,this.addingPointType,r),null===(d=this.map)||void 0===d||d.removeCss("addStory")),this.pointSelected$.next(r.feature)}),this.pointSelected$.pipe((0,N.R)(this.destroy$)).subscribe(r=>{if(this.activePoint=r,!r)return;const c=r.get("data");this.pointsAccordion&&(this.pointsAccordion.value=c.pointId.toString()||"")}),(0,t.X6Q)()&&(null===(i=this.map)||void 0===i||i.goToPoint([39.25186060990359,-76.83157331721733])),this.locationService.watchLocation().pipe((0,V.P)()).subscribe(r=>{var c;const d=this.locationService.transformFromGeoLocation(r);null===(c=this.map)||void 0===c||c.goToPoint([d[1],d[0]])})}addMarkerToMap(e,o,i,r){var c;const d=!Object.keys(this.points).length,f=this.pointCounter++,p=null===(c=this.map)||void 0===c?void 0:c.addMarker(e,{pointId:f,img:d?k.P.startLocation:k.P.pointMarker,start:d});p&&(this.points[f]=p,this.pointList.push({pointId:f,title:o,type:i,feature:p}),r&&(r.feature=p)),this.addingPointType=void 0}ngOnDestroy(){this.destroy$.next(),this.destroy$.unsubscribe()}addNewPoint(){this._addPoint("start")}_addPoint(e){var o;this.addingPointType=e,null===(o=this.map)||void 0===o||o.addCss("addStory")}selectNewLocation(){this.newPointLocation=!0}addPoint(e){this._addPoint(e)}removePoint(e){var o=this;return(0,x.Z)(function*(){var i;if(!(yield o.info.confirmYesNo("Remove",`Are you sure to remove ${e.title}?`)))return;null===(i=o.map)||void 0===i||i.removeMarker(""+e.pointId);const c=o.pointList.indexOf(e);o.pointList.splice(c,1)})()}generateQR(e){try{this.qrData=null,this.qrData=((0,t.X6Q)()?"http://localhost:8100":"https://msarica.github.io/scv")+"/#?storyKey="+e}catch(o){this.info.alert(o.message)}}copyUrl(){navigator.clipboard.writeText(this.qrData),this.info.alert("copied")}createForm(){var e;const o=[...this.pointList],i=o.shift(),r=this.fb.array([]);return o.forEach(d=>{r.push(d.form)}),this.fb.group({...null==i||null===(e=i.form)||void 0===e?void 0:e.controls,points:r},{validators:[n=>{const s=n.get("points");if(!s||!s.length)return{noPoints:"No points found"};const a=s.value,e=a.map(p=>{var h;return null===(h=p.id)||void 0===h?void 0:h.trim()}).filter(p=>!!p),o=new Set;let i=-1;for(const p of a){var r,c,d;i++;const h=s.at(i),b=null===(r=h.get("id"))||void 0===r?void 0:r.value;var f;if(o.has(b))return null===(f=h.get("id"))||void 0===f||f.setErrors({idFound:!0}),{uniqueId:`Id: ${b} is not unique`};o.add(b);const y=C(null===(c=p.body.action)||void 0===c?void 0:c.enables);if(y){const g=J(e,y,h,"Enables");if(g)return g}const S=C(null===(d=p.body.action)||void 0===d?void 0:d.disables);if(S){const g=J(e,S,h,"Disables");if(g)return g}}return null},n=>{const s=n.get("points");if(!s||!s.length)return;const a=s.value;let e=-1;for(const h of a){var o;e++;const b=s.at(e),y=null===(o=b.get("id"))||void 0===o?void 0:o.value;if("multiplechoice"===h.body.type){var i,r;const S=h.body,g=F(S.choices),E=F(S.possibleAnswers);var c,d,f,p;if(!g||!E)return null===(c=b.get("body"))||void 0===c||null===(c=c.get("choices"))||void 0===c||c.setErrors({noChoiceFound:!0}),null===(d=b.get("body"))||void 0===d||null===(d=d.get("possibleAnswers"))||void 0===d||d.setErrors({noChoiceFound:!0}),{noChoiceFound:`${y}: choices/answers need to be provided`};if(!1===E.every(St=>g.includes(St)))return null===(f=b.get("body"))||void 0===f||null===(f=f.get("choices"))||void 0===f||f.setErrors({noChoiceFound:!0}),null===(p=b.get("body"))||void 0===p||null===(p=p.get("possibleAnswers"))||void 0===p||p.setErrors({noChoiceFound:!0}),{noChoiceFound:`${y}: some answers not found in choices`};null===(i=b.get("body"))||void 0===i||null===(i=i.get("choices"))||void 0===i||i.setErrors(null),null===(r=b.get("body"))||void 0===r||null===(r=r.get("possibleAnswers"))||void 0===r||r.setErrors(null)}}return null}],updateOn:"blur"})}onSubmit(){var e=this;return(0,x.Z)(function*(){if(0!==e.pointList.length){e.form=e.createForm();try{if(console.log("isvalid",e.form.valid),console.log("errors",e.form.errors),!e.form.valid&&e.form.errors){const r=Object.values(e.form.errors).join("\n");return void e.info.alert(r,"Error")}const i=e.correctStory(e.form.value);console.log(JSON.stringify(i)),yield e.submitStory(i)}catch(o){e.info.alert("Error",null==o?void 0:o.message)}}else e.info.alert("No points!")})()}submitStory(e){var o=this;return(0,x.Z)(function*(){const i=yield o.info.input("Pass"),r=e.id.replace(/\s/,"_");try{o.validateStoryKey(r,i)}catch(d){o.info.alert(d.message)}const c=JSON.stringify(e);yield o.onlineService.saveStory(r.trim().toLowerCase(),i,c),o.generateQR(r)})()}validateStoryKey(e,o){if(""===(null==e?void 0:e.trim()))throw new Error("StoryKey is not valid");if(e.includes(" "))throw new Error("Key cannot contain spaces")}correctStory(e){try{e=JSON.parse(JSON.stringify(e));const o=this.correctValues(e);return this.gameService.validateGame(o),o}catch(o){throw console.error(o),o}}correctValues(e){e.zoom=18,e.location=A(e.location);for(const o of e.points)o.location=A(o.location),"multiplechoice"===o.body.type?(o.body.choices=C(o.body.choices)||[],o.body.possibleAnswers=C(o.body.possibleAnswers)||[]):"shortanswer"===o.body.type&&(o.body.possibleAnswers=C(o.body.possibleAnswers)||[]),o.body.action&&(o.body.action.enables=C(o.body.action.enables),o.body.action.disables=C(o.body.action.disables));return e}correctValuesToForm(e){e.location=e.location;for(const r of e.points){var o,i;r.location=r.location,"multiplechoice"===r.body.type?(r.body.choices=w(r.body.choices),r.body.possibleAnswers=w(r.body.possibleAnswers)):"shortanswer"===r.body.type&&(r.body.possibleAnswers=w(r.body.possibleAnswers));const c=w(null===(o=r.body.action)||void 0===o?void 0:o.enables),d=w(null===(i=r.body.action)||void 0===i?void 0:i.disables);r.body.action={enables:c,disables:d}}return e}parseJson(e){return e=e.replace(/\/\/.*$/g,""),JSON.parse(e)}loadFromJson(){var e=this;return(0,x.Z)(function*(){try{const o=yield e.info.input("JSON");let i=e.parseJson(o);e.gameService.validateGame(i),yield e._setUpGameForm(i)}catch(o){console.error(o),e.info.alert(o.message,"Error")}})()}loadFromKey(){var e=this;return(0,x.Z)(function*(){try{const o=yield e.info.input("Key"),i=yield e.gameService.getGameById(o.trim()),r=null==i?void 0:i.game;if(!r)return void e.info.alert("Game not found");e.gameService.validateGame(r),yield e._setUpGameForm(r)}catch(o){console.error(o),e.info.alert(o.message,"Error")}})()}_setUpGameForm(e){var o=this;return(0,x.Z)(function*(){yield o.clear(),e=o.correctValuesToForm(e),o.addMarkerToMap(e.location,e.id,"start"),e.points.forEach(i=>{i.body.type&&o.addMarkerToMap(i.location,i.title,i.body.type)}),setTimeout(()=>{var i;o.form=o.createForm(),null===(i=o.form)||void 0===i||i.patchValue(e)},10)})()}}return(n=s).\u0275fac=function(e){return new(e||n)(t.Y36(l.qu),t.Y36(it.h),t.Y36(rt.x),t.Y36(I.a),t.Y36(st.C),t.Y36(at.F0))},n.\u0275cmp=t.Xpm({type:n,selectors:[["app-story-builder"]],viewQuery:function(e,o){if(1&e&&(t.Gf(U,7),t.Gf(lt,7)),2&e){let i;t.iGM(i=t.CRH())&&(o.map=i.first),t.iGM(i=t.CRH())&&(o.pointsAccordion=i.first)}},standalone:!0,features:[t.jDz],decls:27,vars:5,consts:[["when","xs","contentId","main"],["contentId","main"],[1,"ion-padding"],[3,"click"],["value","qr",4,"ngIf"],[3,"click",4,"ngIf"],[4,"ngIf"],["pointAccordion",""],[3,"value",4,"ngFor","ngForOf"],["id","main",1,"ion-page"],["value","qr"],["slot","header","color","light"],["slot","content",1,"ion-padding"],[3,"value"],["slot","content"],[3,"ngSwitch"],[4,"ngSwitchCase"],[4,"ngSwitchDefault"],[3,"item"]],template:function(e,o){1&e&&(t.TgZ(0,"ion-header")(1,"ion-toolbar")(2,"ion-title"),t._uU(3,"story-builder"),t.qZA()()(),t.TgZ(4,"ion-content")(5,"ion-split-pane",0)(6,"ion-menu",1)(7,"ion-content",2)(8,"ion-button",3),t.NdJ("click",function(){return o.loadFromJson()}),t._uU(9," Load From Json "),t.qZA(),t.TgZ(10,"ion-button",3),t.NdJ("click",function(){return o.loadFromKey()}),t._uU(11," Load From Key "),t.qZA(),t.TgZ(12,"ion-button",3),t.NdJ("click",function(){return o.clear(!0)}),t._uU(13," Clear "),t.qZA(),t.TgZ(14,"ion-accordion-group"),t.YNc(15,ct,10,1,"ion-accordion",4),t.qZA(),t.YNc(16,ut,2,0,"ion-button",5),t.YNc(17,dt,2,0,"ion-button",5),t.YNc(18,pt,9,0,"ion-item-divider",6),t.TgZ(19,"ion-accordion-group",null,7),t.YNc(21,xt,13,9,"ion-accordion",8),t.qZA(),t.TgZ(22,"ion-button",3),t.NdJ("click",function(){return o.onSubmit()}),t._uU(23," Submit "),t.qZA()()(),t.TgZ(24,"div",9)(25,"ion-content"),t._UZ(26,"app-coordinate-selection"),t.qZA()()()()),2&e&&(t.xp6(15),t.Q6J("ngIf",o.qrData),t.xp6(1),t.Q6J("ngIf",!o.pointList.length),t.xp6(1),t.Q6J("ngIf",o.activePoint),t.xp6(1),t.Q6J("ngIf",o.pointList.length),t.xp6(3),t.Q6J("ngForOf",o.pointList))},dependencies:[u.Pc,u.We,u.eh,u.YG,u.W2,u.Gu,u.Ie,u.rH,u.Q$,u.z0,u.jI,u.wd,u.sr,v.ez,v.sg,v.O5,v.RF,v.n9,v.ED,l.u5,l.UX,U,$,et,ot,nt],styles:["ion-split-pane[_ngcontent-%COMP%]{--side-width: 500px;--side-max-width: 500px;--border: 1px dashed #b3baff}"]}),s})()}}]);