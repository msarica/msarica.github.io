var J=Object.defineProperty;var Q=(c,e,t)=>e in c?J(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t;var y=(c,e,t)=>Q(c,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function t(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(r){if(r.ep)return;r.ep=!0;const i=t(r);fetch(r.href,i)}})();class X{constructor(){}extractMoviesFromHTML(e){const t=[];try{const s=this.extractGridMovieRenderers(e);s.length>0?s.forEach(r=>{const i=this.parseGridMovieRenderer(r);i&&t.push(i)}):t.push(...this.extractMoviesLegacy(e))}catch(s){console.error("Error parsing YouTube content:",s),t.push(...this.extractMoviesLegacy(e))}return t}extractGridMovieRenderers(e){const t=[],s=new Set;try{const r=this.findGridMovieRendererObjects(e);for(const i of r)try{const a=this.parseGridMovieRendererJSON(i);a&&!s.has(a.videoId)&&(t.push(a),s.add(a.videoId))}catch(a){console.error("Error parsing gridMovieRenderer JSON:",a);continue}}catch(r){console.error("Error extracting gridMovieRenderer objects:",r)}return t}findGridMovieRendererObjects(e){const t=[],s='"gridMovieRenderer":';let r=0;for(;;){const i=e.indexOf(s,r);if(i===-1)break;const a=i+s.length;let o=0,n=a,u=!1,h=!1;for(let f=a;f<e.length;f++){const m=e[f];if(h){h=!1;continue}if(m==="\\"){h=!0;continue}if(m==='"'&&!h){u=!u;continue}if(!u){if(m==="{")o++;else if(m==="}"&&(o--,o===0)){n=f+1;break}}}if(o===0){const f=e.substring(a,n).trim();t.push(f)}r=n}return t}parseGridMovieRendererJSON(e){var t,s,r;try{const i=JSON.parse(e);return!i.videoId||!((r=(s=(t=i.title)==null?void 0:t.runs)==null?void 0:s[0])!=null&&r.text)?null:i}catch(i){return console.error("Error parsing JSON:",i),null}}extractMovieDataFromChunk(e){try{const t=e.match(/"videoId":\s*"([^"]+)"/);if(!t)return null;const s=e.match(/"title":\s*{\s*"runs":\s*\[\s*{\s*"text":\s*"([^"]+)"/);if(!s)return null;const r=e.match(/"lengthText":\s*{[^}]*"simpleText":\s*"([^"]+)"/),i=e.match(/"url":\s*"([^"]*ytimg[^"]*movieposter[^"]*)"/)||e.match(/"url":\s*"([^"]*ytimg[^"]*)"/),a=e.match(/"metadata":\s*{\s*"simpleText":\s*"([^"]+)"/),o=e.match(/"metadataBadgeRenderer":\s*{[^}]*"label":\s*"([^"]+)"[^}]*"style":\s*"([^"]+)"/g),n=o?o.map(m=>{const g=m.match(/"label":\s*"([^"]+)"/),b=m.match(/"style":\s*"([^"]+)"/);return{metadataBadgeRenderer:{style:b?b[1]:"BADGE_STYLE_TYPE_SIMPLE",label:g?g[1]:"",trackingParams:""}}}):void 0,u=e.match(/"clickTrackingParams":\s*"([^"]+)"/),h=e.match(/"url":\s*"([^"]*watch[^"]*)"/),f=e.match(/"trackingParams":\s*"([^"]+)"/);return(s[1].includes("John Wick")||s[1].includes("Open Season"))&&console.log(`Debug for ${s[1]}:`,{videoId:t[1],duration:r?r[1]:"NOT FOUND",metadata:a?a[1]:"NOT FOUND",badges:n?n.map(m=>m.metadataBadgeRenderer.label):"NOT FOUND"}),{videoId:t[1],title:{runs:[{text:s[1]}]},lengthText:{simpleText:r?r[1]:"Unknown"},thumbnail:{thumbnails:i?[{url:i[1],width:279,height:402}]:[]},navigationEndpoint:{clickTrackingParams:u?u[1]:"",commandMetadata:{webCommandMetadata:{url:h?h[1]:`/watch?v=${t[1]}`,webPageType:"WEB_PAGE_TYPE_WATCH",rootVe:3832}},watchEndpoint:{videoId:t[1]}},trackingParams:f?f[1]:"",metadata:a?{simpleText:a[1]}:void 0,badges:n}}catch(t){return console.error("Error extracting movie data from chunk:",t),null}}parseGridMovieRenderer(e){var t,s,r,i,a;try{const o=((t=e.title.runs[0])==null?void 0:t.text)||"Unknown Movie",n=((s=e.lengthText)==null?void 0:s.simpleText)||"Unknown",u=((r=e.thumbnail.thumbnails[0])==null?void 0:r.url)||`https://img.youtube.com/vi/${e.videoId}/maxresdefault.jpg`,h=((i=e.metadata)==null?void 0:i.simpleText)||"",f=this.extractYearFromMetadata(h),m=this.extractGenreFromMetadata(h),g=this.extractRatingFromBadges(e.badges);return(o.includes("John Wick")||o.includes("Open Season"))&&console.log(`Parsed ${o}:`,{videoId:e.videoId,duration:n,metadata:h,year:f,genre:m,rating:g,badges:((a=e.badges)==null?void 0:a.map(b=>b.metadataBadgeRenderer.label))||[]}),{videoId:e.videoId,title:this.cleanTitle(o),duration:n,thumbnail:u,url:`https://www.youtube.com/watch?v=${e.videoId}`,year:f,genre:m,rating:g}}catch(o){return console.error("Error parsing gridMovieRenderer:",o),null}}extractMoviesLegacy(e){const t=[],s=/"gridMovieRenderer":\s*{[^}]*"videoId":\s*"([A-Za-z0-9_-]+)"/g;let r;const i=new Set;for(;(r=s.exec(e))!==null;)i.add(r[1]);if(i.size===0){const n=/"videoId":\s*"([A-Za-z0-9_-]+)"/g;for(;(r=n.exec(e))!==null;)i.add(r[1])}const a=Array.from(i),o=this.extractMovieTitles(e);return a.forEach((n,u)=>{let h=o[u]||`Movie ${u+1}`;h=this.cleanTitle(h);const f=this.extractYear(e,n),m=this.extractGenre(e,n),g=this.extractRating(e,n),b=this.extractDuration(e,n);t.push({videoId:n,title:h,duration:b,thumbnail:`https://img.youtube.com/vi/${n}/maxresdefault.jpg`,url:`https://www.youtube.com/watch?v=${n}`,year:f,genre:m,rating:g})}),t}extractMovieTitles(e){const t=[],s=new Set;return[/"gridMovieRenderer":\s*{[^}]*"title":\s*{\s*"runs":\s*\[\s*{\s*"text":\s*"([^"]+)"/g,/"title":\s*{\s*"runs":\s*\[\s*{\s*"text":\s*"([^"]+)"/g,/"title":\s*"([^"]+)"/g].forEach(i=>{let a;for(;(a=i.exec(e))!==null;){const o=a[1];o&&o.length>3&&!s.has(o)&&!o.includes("YouTube")&&!o.includes("Browse")&&!o.includes("Free")&&!o.includes("Movies")&&!o.includes("Watch")&&!o.includes("Play")&&!o.includes("Subscribe")&&(t.push(o),s.add(o))}}),t}cleanTitle(e){return e?e.replace(/^[^\w\s]*/,"").replace(/[^\w\s]*$/,"").replace(/\s+/g," ").trim().substring(0,100):"Unknown Movie"}extractYear(e,t){const s=[/\((\d{4})\)/g,/(\d{4})/g,/"year":\s*"(\d{4})"/g,/"releaseDate":\s*"(\d{4})"/g];for(const r of s){let i;for(;(i=r.exec(e))!==null;){const a=i[1],o=parseInt(a);if(o>=1900&&o<=new Date().getFullYear()+2)return a}}}extractGenre(e,t){const s=["Action","Adventure","Animation","Biography","Comedy","Crime","Documentary","Drama","Family","Fantasy","Film-Noir","History","Horror","Music","Musical","Mystery","Romance","Sci-Fi","Sport","Thriller","War","Western"],r=[new RegExp(`"gridMovieRenderer":\\s*{[^}]*"videoId":\\s*"${t}"[^}]*"metadata":\\s*{\\s*"simpleText":\\s*"([^"]+)"`,"i"),new RegExp(`"videoId":\\s*"${t}"[^}]*"metadata":\\s*{\\s*"simpleText":\\s*"([^"]+)"`,"i"),/"genre":\s*"([^"]+)"/g,/"category":\s*"([^"]+)"/g,/"type":\s*"([^"]+)"/g];for(const a of r){let o;for(;(o=a.exec(e))!==null;){const n=o[1];for(const u of s)if(n.toLowerCase().includes(u.toLowerCase()))return u}}const i=e.match(new RegExp(`"videoId":\\s*"${t}"[^}]*"title":\\s*{\\s*"runs":\\s*\\[\\s*{\\s*"text":\\s*"([^"]+)"`,"i"));if(i){const a=i[1].toLowerCase();for(const o of s)if(a.includes(o.toLowerCase()))return o}}extractRating(e,t){const s=[new RegExp(`"gridMovieRenderer":\\s*{[^}]*"videoId":\\s*"${t}"[^}]*"badges":\\s*\\[[^}]*"metadataBadgeRenderer":\\s*{[^}]*"label":\\s*"([^"]+)"[^}]*"style":\\s*"BADGE_STYLE_TYPE_SIMPLE"`,"i"),new RegExp(`"videoId":\\s*"${t}"[^}]*"badges":\\s*\\[[^}]*"metadataBadgeRenderer":\\s*{[^}]*"label":\\s*"([^"]+)"[^}]*"style":\\s*"BADGE_STYLE_TYPE_SIMPLE"`,"i"),/"metadataBadgeRenderer":\s*{[^}]*"label":\s*"(G|PG|PG-13|R|NC-17|TV-G|TV-PG|TV-14|TV-MA)"[^}]*"style":\s*"BADGE_STYLE_TYPE_SIMPLE"/g,/"rating":\s*"([^"]+)"/g,/"contentRating":\s*"([^"]+)"/g,/"ageRestriction":\s*"([^"]+)"/g];for(const r of s){let i;for(;(i=r.exec(e))!==null;){const a=i[1];if(a&&a.length<=10&&/^(G|PG|PG-13|R|NC-17|TV-G|TV-PG|TV-14|TV-MA)$/.test(a))return a}}}extractDuration(e,t){const s=[new RegExp(`"gridMovieRenderer":\\s*{[^}]*"videoId":\\s*"${t}"[^}]*"lengthText":\\s*{[^}]*"simpleText":\\s*"([^"]+)"`,"i"),new RegExp(`"videoId":\\s*"${t}"[^}]*"lengthText":\\s*{[^}]*"simpleText":\\s*"([^"]+)"`,"i"),new RegExp(`"videoId":\\s*"${t}"[^}]*"accessibilityData":\\s*{[^}]*"label":\\s*"([^"]*\\d+\\s*(?:hours?|minutes?|seconds?)[^"]*)"`,"i"),/"lengthText":\s*{[^}]*"simpleText":\s*"(\d+:\d+:\d+|\d+:\d+)"/g];for(const r of s){let i;for(;(i=r.exec(e))!==null;){const a=i[1];if(a&&a.length>0&&/^\d+:\d+/.test(a))return a}}return"Unknown"}extractYearFromMetadata(e){if(!e)return;const t=e.match(/(\d{4})/);if(t){const s=parseInt(t[1]);if(s>=1900&&s<=new Date().getFullYear()+2)return t[1]}}extractGenreFromMetadata(e){if(!e)return;const t=["Action","Adventure","Animation","Biography","Comedy","Crime","Documentary","Drama","Family","Fantasy","Film-Noir","History","Horror","Music","Musical","Mystery","Romance","Sci-Fi","Sport","Thriller","War","Western"];for(const s of t)if(e.toLowerCase().includes(s.toLowerCase()))return s}extractRatingFromBadges(e){var t;if(!(!e||!Array.isArray(e))){for(const s of e)if((t=s.metadataBadgeRenderer)!=null&&t.label){const r=s.metadataBadgeRenderer.label;if(/^[A-Z]$/.test(r)||/^(G|PG|PG-13|R|NC-17|TV-G|TV-PG|TV-14|TV-MA)$/.test(r))return r}}}}class ee{constructor(e){y(this,"OMDB_BASE_URL","https://www.omdbapi.com/");y(this,"storage");y(this,"API_KEY_STORAGE_KEY","omdb_api_key");this.storage=e}getApiKey(){return localStorage.getItem(this.API_KEY_STORAGE_KEY)}setApiKey(e){localStorage.setItem(this.API_KEY_STORAGE_KEY,e)}clearApiKey(){localStorage.removeItem(this.API_KEY_STORAGE_KEY)}hasApiKey(){const e=this.getApiKey();return e!==null&&e.trim()!==""}async getImdbInfo(e,t){if(!this.hasApiKey())return console.warn("OMDB API key not set. Please set your API key to fetch IMDB responses."),null;try{const s=this.cleanTitle(e);try{const o=await this.storage.loadIMDBResponse(s,t);if(o.success&&o.data)return o.data}catch(o){console.warn("Storage not available for IMDB response, fetching from API:",o)}const r=new URLSearchParams({apikey:this.getApiKey(),t:s,type:"movie",plot:"full"});t&&r.append("y",t);const i=await fetch(`${this.OMDB_BASE_URL}?${r}`);if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);const a=await i.json();if(a.Response==="True"){try{await this.storage.saveIMDBResponse(s,t,a)}catch(o){console.warn("Failed to save IMDB response to storage:",o)}return a}return null}catch(s){return console.error(`Error fetching IMDB response for "${e}":`,s),null}}async getImdbInfoList(e){const t=new Map;if(!this.hasApiKey())return console.warn("OMDB API key not set. Please set your API key to fetch IMDB responses."),t;const s=5;for(let r=0;r<e.length;r+=s){const a=e.slice(r,r+s).map(async o=>{const n=await this.getImdbInfo(o.title,o.year);n&&t.set(o.title,n)});await Promise.all(a),r+s<e.length&&await new Promise(o=>setTimeout(o,1e3))}return t}cleanTitle(e){return e.replace(/\([^)]*\)/g,"").replace(/\[[^\]]*\]/g,"").replace(/\s+/g," ").trim().split(" - ")[0].split(" | ")[0]}async clearIMDBCache(){return(await this.storage.clearIMDBResponses()).success}async getIMDBStorageStats(){const e=await this.storage.getIMDBStorageStats();return e.success&&e.data||null}}class te{constructor(e={dbName:"MoviePickerDB",version:1,storeName:"movieData",imdbStoreName:"imdbResponses"}){y(this,"db",null);y(this,"config");y(this,"APP_VERSION","1.0.0");this.config=e}async initialize(){return new Promise((e,t)=>{if(!("indexedDB"in window)){t(new Error("IndexedDB is not supported in this browser"));return}const s=indexedDB.open(this.config.dbName,this.config.version);s.onerror=()=>{console.error("Failed to open IndexedDB:",s.error),t(s.error)},s.onsuccess=()=>{this.db=s.result,console.log("IndexedDB initialized successfully"),e(!0)},s.onupgradeneeded=r=>{const i=r.target.result;if(!i.objectStoreNames.contains(this.config.storeName)){const a=i.createObjectStore(this.config.storeName,{keyPath:"id"});a.createIndex("videoId","videoId",{unique:!1}),a.createIndex("title","title",{unique:!1}),a.createIndex("dateAdded","dateAdded",{unique:!1}),a.createIndex("imdbScore","imdbScore",{unique:!1}),a.createIndex("genre","genre",{unique:!1}),a.createIndex("year","year",{unique:!1})}if(!i.objectStoreNames.contains(this.config.imdbStoreName)){const a=i.createObjectStore(this.config.imdbStoreName,{keyPath:"id"});a.createIndex("title","title",{unique:!1}),a.createIndex("year","year",{unique:!1}),a.createIndex("dateAdded","dateAdded",{unique:!1}),a.createIndex("titleYear",["title","year"],{unique:!1})}}})}isInitialized(){return this.db!==null}ensureInitialized(){if(!this.isInitialized())throw new Error("Storage not initialized. Call initialize() first.")}async recreateDatabase(){try{this.db&&(this.db.close(),this.db=null);const e=indexedDB.deleteDatabase(this.config.dbName);return new Promise(t=>{let s=!1;const r=i=>{s||(s=!0,t(i))};e.onsuccess=()=>{console.log("Database deleted successfully, recreating..."),this.initialize().then(i=>{r(i)}).catch(i=>{console.error("Failed to reinitialize after deletion:",i),r(!1)})},e.onerror=()=>{console.error("Failed to delete database:",e.error),this.initialize().then(i=>{r(i)}).catch(i=>{console.error("Failed to initialize after delete error:",i),r(!1)})},e.onblocked=()=>{console.warn("Database deletion blocked, trying to recreate anyway..."),this.initialize().then(i=>{r(i)}).catch(i=>{console.error("Failed to initialize after block:",i),r(!1)})},setTimeout(()=>{r(!1)},1e4)})}catch(e){return console.error("Error recreating database:",e),!1}}movieToStoredMovie(e,t){const s=Date.now();return{...e,id:t||this.generateId(),dateAdded:s,lastModified:s}}storedMovieToMovie(e){const{id:t,dateAdded:s,lastModified:r,...i}=e;return i}generateId(){return`movie_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}async saveMovie(e){return this.ensureInitialized(),new Promise(t=>{const r=this.db.transaction([this.config.storeName],"readwrite").objectStore(this.config.storeName),a=r.index("videoId").get(e.videoId);a.onsuccess=()=>{const o=a.result;let n;o?n={...o,...e,lastModified:Date.now()}:n=this.movieToStoredMovie(e);const u=r.put(n);u.onsuccess=()=>{t({success:!0,data:n})},u.onerror=()=>{var h;t({success:!1,error:`Failed to save movie: ${(h=u.error)==null?void 0:h.message}`})}},a.onerror=()=>{var o;t({success:!1,error:`Failed to check existing movie: ${(o=a.error)==null?void 0:o.message}`})}})}async saveMovies(e){this.ensureInitialized();const t=[],s=[];for(const r of e){const i=await this.saveMovie(r);i.success&&i.data?t.push(i.data):s.push(i.error||"Unknown error")}return{success:s.length===0,data:t,error:s.length>0?s.join("; "):void 0}}async loadMovies(){return this.ensureInitialized(),new Promise(e=>{const r=this.db.transaction([this.config.storeName],"readonly").objectStore(this.config.storeName).getAll();r.onsuccess=()=>{const a=r.result.map(o=>this.storedMovieToMovie(o));e({success:!0,data:a})},r.onerror=()=>{var i;e({success:!1,error:`Failed to load movies: ${(i=r.error)==null?void 0:i.message}`})}})}async loadMovieByVideoId(e){return this.ensureInitialized(),new Promise(t=>{const a=this.db.transaction([this.config.storeName],"readonly").objectStore(this.config.storeName).index("videoId").get(e);a.onsuccess=()=>{const o=a.result;t(o?{success:!0,data:this.storedMovieToMovie(o)}:{success:!0,data:null})},a.onerror=()=>{var o;t({success:!1,error:`Failed to load movie: ${(o=a.error)==null?void 0:o.message}`})}})}async deleteMovie(e){return this.ensureInitialized(),new Promise(t=>{const r=this.db.transaction([this.config.storeName],"readwrite").objectStore(this.config.storeName),a=r.index("videoId").get(e);a.onsuccess=()=>{const o=a.result;if(o){const n=r.delete(o.id);n.onsuccess=()=>{t({success:!0,data:!0})},n.onerror=()=>{var u;t({success:!1,error:`Failed to delete movie: ${(u=n.error)==null?void 0:u.message}`})}}else t({success:!0,data:!1})},a.onerror=()=>{var o;t({success:!1,error:`Failed to find movie: ${(o=a.error)==null?void 0:o.message}`})}})}async clearAllMovies(){return this.ensureInitialized(),new Promise(e=>{const r=this.db.transaction([this.config.storeName],"readwrite").objectStore(this.config.storeName).clear();r.onsuccess=()=>{e({success:!0,data:!0})},r.onerror=()=>{var i;e({success:!1,error:`Failed to clear movies: ${(i=r.error)==null?void 0:i.message}`})}})}saveFilters(e){try{return localStorage.setItem("moviePicker_filters",JSON.stringify(e)),!0}catch(t){return console.error("Failed to save filters:",t),!1}}loadFilters(){try{const e=localStorage.getItem("moviePicker_filters");return e?JSON.parse(e):null}catch(e){return console.error("Failed to load filters:",e),null}}saveSearchTerm(e){try{return localStorage.setItem("moviePicker_searchTerm",e),!0}catch(t){return console.error("Failed to save search term:",t),!1}}loadSearchTerm(){try{return localStorage.getItem("moviePicker_searchTerm")}catch(e){return console.error("Failed to load search term:",e),null}}async saveAppState(e,t,s){try{const r=await this.saveMovies(e);if(!r.success)return{success:!1,error:`Failed to save movies: ${r.error}`};const i=this.saveFilters(t),a=this.saveSearchTerm(s);return!i||!a?{success:!1,error:"Failed to save filters or search term"}:{success:!0,data:!0}}catch(r){return{success:!1,error:`Failed to save app state: ${r}`}}}async loadAppState(){try{const e=await this.loadMovies();if(!e.success)return{success:!1,error:`Failed to load movies: ${e.error}`};const t=this.loadFilters(),s=this.loadSearchTerm();return{success:!0,data:{movies:e.data||[],filters:t,searchTerm:s}}}catch(e){return{success:!1,error:`Failed to load app state: ${e}`}}}async getStorageStats(){return this.ensureInitialized(),new Promise(e=>{const r=this.db.transaction([this.config.storeName],"readonly").objectStore(this.config.storeName).count();r.onsuccess=()=>{const i=r.result,a=i*1024;e({success:!0,data:{movieCount:i,dbSize:a}})},r.onerror=()=>{var i;e({success:!1,error:`Failed to get storage stats: ${(i=r.error)==null?void 0:i.message}`})}})}async exportData(){try{const e=await this.loadAppState();if(!e.success)return{success:!1,error:`Failed to load data for export: ${e.error}`};const t={version:this.APP_VERSION,exportDate:new Date().toISOString(),...e.data};return{success:!0,data:JSON.stringify(t,null,2)}}catch(e){return{success:!1,error:`Failed to export data: ${e}`}}}async importData(e){try{const t=JSON.parse(e);if(!t.movies||!Array.isArray(t.movies))return{success:!1,error:"Invalid data format: movies array is required"};await this.clearAllMovies();const s=await this.saveMovies(t.movies);return s.success?(t.filters&&this.saveFilters(t.filters),t.searchTerm&&this.saveSearchTerm(t.searchTerm),{success:!0,data:!0}):{success:!1,error:`Failed to import movies: ${s.error}`}}catch(t){return{success:!1,error:`Failed to import data: ${t}`}}}async saveIMDBResponse(e,t,s){return this.isInitialized()?new Promise(r=>{try{if(!this.db.objectStoreNames.contains(this.config.imdbStoreName)){console.warn(`IMDB object store '${this.config.imdbStoreName}' not found. Attempting to recreate database...`),this.recreateDatabase().then(u=>{u?(console.log("Database recreated successfully, retrying save..."),this.saveIMDBResponse(e,t,s).then(r)):(console.error("Failed to recreate database"),r({success:!1,error:"IMDB object store not found and failed to recreate database."}))}).catch(u=>{console.error("Error during database recreation:",u),r({success:!1,error:"IMDB object store not found and failed to recreate database."})});return}const a=this.db.transaction([this.config.imdbStoreName],"readwrite").objectStore(this.config.imdbStoreName),n=a.index("titleYear").get([e.toLowerCase(),t||""]);n.onsuccess=()=>{const u=n.result,h=Date.now();let f;u?f={...u,response:s,lastModified:h}:f={id:this.generateId(),title:e.toLowerCase(),year:t||"",response:s,dateAdded:h,lastModified:h};const m=a.put(f);m.onsuccess=()=>{r({success:!0,data:f})},m.onerror=()=>{var g;console.error("Error saving IMDB response:",m.error),r({success:!1,error:`Failed to save IMDB response: ${((g=m.error)==null?void 0:g.message)||"Unknown error"}`})}},n.onerror=()=>{var u;console.error("Error checking existing IMDB response:",n.error),r({success:!1,error:`Failed to check existing IMDB response: ${((u=n.error)==null?void 0:u.message)||"Unknown error"}`})}}catch(i){console.error("Error in saveIMDBResponse:",i),r({success:!1,error:`Failed to save IMDB response: ${i instanceof Error?i.message:"Unknown error"}`})}}):(console.warn("Storage not initialized, cannot save IMDB response"),{success:!1,error:"Storage not initialized"})}async loadIMDBResponse(e,t){return this.isInitialized()?new Promise(s=>{try{if(!this.db.objectStoreNames.contains(this.config.imdbStoreName)){console.warn(`IMDB object store '${this.config.imdbStoreName}' not found. Attempting to recreate database...`),this.recreateDatabase().then(n=>{n?(console.log("Database recreated successfully, retrying load..."),this.loadIMDBResponse(e,t).then(s)):(console.error("Failed to recreate database"),s({success:!0,data:null}))}).catch(n=>{console.error("Error during database recreation:",n),s({success:!0,data:null})});return}const o=this.db.transaction([this.config.imdbStoreName],"readonly").objectStore(this.config.imdbStoreName).index("titleYear").get([e.toLowerCase(),t||""]);o.onsuccess=()=>{const n=o.result;s(n?{success:!0,data:n.response}:{success:!0,data:null})},o.onerror=()=>{var n;console.error("Error loading IMDB response:",o.error),s({success:!1,error:`Failed to load IMDB response: ${((n=o.error)==null?void 0:n.message)||"Unknown error"}`})}}catch(r){console.error("Error in loadIMDBResponse:",r),s({success:!1,error:`Failed to load IMDB response: ${r instanceof Error?r.message:"Unknown error"}`})}}):(console.warn("Storage not initialized, cannot load IMDB response"),{success:!0,data:null})}async clearIMDBResponses(){return this.ensureInitialized(),new Promise(e=>{try{if(!this.db.objectStoreNames.contains(this.config.imdbStoreName)){console.warn(`IMDB object store '${this.config.imdbStoreName}' not found. Nothing to clear.`),e({success:!0,data:!0});return}const r=this.db.transaction([this.config.imdbStoreName],"readwrite").objectStore(this.config.imdbStoreName).clear();r.onsuccess=()=>{e({success:!0,data:!0})},r.onerror=()=>{var i;console.error("Error clearing IMDB responses:",r.error),e({success:!1,error:`Failed to clear IMDB responses: ${((i=r.error)==null?void 0:i.message)||"Unknown error"}`})}}catch(t){console.error("Error in clearIMDBResponses:",t),e({success:!1,error:`Failed to clear IMDB responses: ${t instanceof Error?t.message:"Unknown error"}`})}})}async getIMDBStorageStats(){return this.ensureInitialized(),new Promise(e=>{try{if(!this.db.objectStoreNames.contains(this.config.imdbStoreName)){console.warn(`IMDB object store '${this.config.imdbStoreName}' not found. Returning zero count.`),e({success:!0,data:{responseCount:0}});return}const r=this.db.transaction([this.config.imdbStoreName],"readonly").objectStore(this.config.imdbStoreName).count();r.onsuccess=()=>{e({success:!0,data:{responseCount:r.result}})},r.onerror=()=>{var i;console.error("Error getting IMDB storage stats:",r.error),e({success:!1,error:`Failed to get IMDB storage stats: ${((i=r.error)==null?void 0:i.message)||"Unknown error"}`})}}catch(t){console.error("Error in getIMDBStorageStats:",t),e({success:!1,error:`Failed to get IMDB storage stats: ${t instanceof Error?t.message:"Unknown error"}`})}})}close(){this.db&&(this.db.close(),this.db=null)}}function L(c){return c!=null&&c!=="N/A"&&String(c).trim()!==""}function W(c){const e={};if(L(c.imdbRating)){const t=parseFloat(c.imdbRating);isNaN(t)||(e.imdbScore=t)}return L(c.imdbID)&&(e.imdbId=c.imdbID),L(c.Plot)&&(e.plot=c.Plot),L(c.Year)&&(e.year=c.Year),L(c.Genre)&&(e.genre=c.Genre),L(c.Rated)&&(e.rating=c.Rated),e}class se{constructor(){y(this,"movies");y(this,"movieListElement");y(this,"parser");y(this,"imdbService");y(this,"storage");y(this,"searchTerm");y(this,"filters");y(this,"isStorageInitialized",!1);this.movies=[],this.movieListElement=document.getElementById("movie-list"),this.parser=new X,this.storage=new te,this.imdbService=new ee(this.storage),this.searchTerm="",this.filters={selectedGenres:new Set,selectedRatings:new Set,yearFrom:null,yearTo:null,imdbMin:0,imdbMax:10,sortField:"imdbScore",sortDirection:"desc"},this.init()}async init(){try{await this.initializeStorage(),await this.loadMovies(),await this.loadAppState(),this.renderMovies()}catch(e){console.error("Error initializing movie picker:",e),this.showError("Failed to load movies. Please refresh the page.")}}async initializeStorage(){try{await this.storage.initialize()?(this.isStorageInitialized=!0,console.log("Storage initialized successfully")):(console.warn("Storage initialization failed, continuing without persistence"),this.isStorageInitialized=!1)}catch(e){console.error("Error initializing storage:",e),this.isStorageInitialized=!1}}async loadMovies(){try{if(this.isStorageInitialized){const e=await this.storage.loadMovies();e.success&&e.data?(this.movies=e.data,console.log(`Loaded ${this.movies.length} movies from storage`)):(console.warn("Failed to load movies from storage:",e.error),this.movies=[])}else this.movies=[]}catch(e){console.error("Error loading movies:",e),this.movies=[]}await new Promise(e=>setTimeout(e,1e3))}async loadAppState(){if(this.isStorageInitialized)try{const e=await this.storage.loadAppState();if(e.success&&e.data){if(e.data.searchTerm){this.searchTerm=e.data.searchTerm;const t=document.getElementById("search-input");t&&(t.value=this.searchTerm)}e.data.filters&&this.loadFiltersFromStorage(e.data.filters)}}catch(e){console.error("Error loading app state:",e)}}async saveAppState(){if(this.isStorageInitialized)try{const e={selectedGenres:Array.from(this.filters.selectedGenres),selectedRatings:Array.from(this.filters.selectedRatings),yearFrom:this.filters.yearFrom,yearTo:this.filters.yearTo,imdbMin:this.filters.imdbMin,imdbMax:this.filters.imdbMax,sortField:this.filters.sortField,sortDirection:this.filters.sortDirection},t=await this.storage.saveAppState(this.movies,e,this.searchTerm);t.success||console.warn("Failed to save app state:",t.error)}catch(e){console.error("Error saving app state:",e)}}loadFiltersFromStorage(e){this.filters={selectedGenres:new Set(e.selectedGenres),selectedRatings:new Set(e.selectedRatings),yearFrom:e.yearFrom,yearTo:e.yearTo,imdbMin:e.imdbMin,imdbMax:e.imdbMax,sortField:e.sortField||"imdbScore",sortDirection:e.sortDirection||"desc"},this.updateFilterUI()}filterMovies(){let e=this.movies;if(this.searchTerm.trim()){const t=this.searchTerm.toLowerCase();e=e.filter(s=>s.title.toLowerCase().includes(t)||s.genre&&s.genre.toLowerCase().includes(t)||s.year&&s.year.includes(t)||s.rating&&s.rating.toLowerCase().includes(t)||s.imdbScore&&s.imdbScore.toString().includes(t)||s.plot&&s.plot.toLowerCase().includes(t))}return this.filters.selectedGenres.size>0&&(e=e.filter(t=>t.genre?this.filters.selectedGenres.has(t.genre):!1)),this.filters.selectedRatings.size>0&&(e=e.filter(t=>t.rating?this.filters.selectedRatings.has(t.rating):!1)),(this.filters.yearFrom!==null||this.filters.yearTo!==null)&&(e=e.filter(t=>{if(!t.year)return!1;const s=parseInt(t.year);return!(isNaN(s)||this.filters.yearFrom!==null&&s<this.filters.yearFrom||this.filters.yearTo!==null&&s>this.filters.yearTo)})),e=e.filter(t=>t.imdbScore?t.imdbScore>=this.filters.imdbMin&&t.imdbScore<=this.filters.imdbMax:!0),e=this.sortMovies(e),e}sortMovies(e){return e.sort((t,s)=>{let r,i;switch(this.filters.sortField){case"year":r=t.year?parseInt(t.year):0,i=s.year?parseInt(s.year):0;break;case"imdbScore":r=t.imdbScore||0,i=s.imdbScore||0;break;default:r=t.imdbScore||0,i=s.imdbScore||0;break}if(typeof r=="number"&&typeof i=="number")return this.filters.sortDirection==="asc"?r-i:i-r;if(typeof r=="string"&&typeof i=="string")return this.filters.sortDirection==="asc"?r.localeCompare(i):i.localeCompare(r);{const a=String(r).toLowerCase(),o=String(i).toLowerCase();return this.filters.sortDirection==="asc"?a.localeCompare(o):o.localeCompare(a)}})}renderMovies(){if(!this.movieListElement)return;if(this.movies.length===0){this.movieListElement.innerHTML='<div class="loading">No movies found. Click "Paste Content" to add movies from YouTube pages.</div>',this.updateMovieCount(0);return}const e=this.filterMovies();if(e.length===0&&this.searchTerm.trim()){this.movieListElement.innerHTML=`<div class="loading">No movies found matching "${this.searchTerm}". Try a different search term.</div>`,this.updateMovieCount(0);return}const t=e.map(s=>`
      <div class="movie-item" data-movie-id="${s.videoId}" ${s.plot?'data-has-plot="true"':""} onclick="logMovieObject('${s.videoId}')">
        <div class="movie-thumbnail">
          <img src="${s.thumbnail}" alt="${s.title}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjkwIiB2aWV3Qm94PSIwIDAgMTIwIDkwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIxMjAiIGhlaWdodD0iOTAiIGZpbGw9IiNmOGY5ZmEiLz48dGV4dCB4PSI2MCIgeT0iNDUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzZjNzU3ZCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+SW1hZ2U8L3RleHQ+PC9zdmc+'" />
        </div>
        <div class="movie-info">
          <div class="movie-title-row">
            <div class="movie-title">${s.title}</div>
            <div class="imdb-section">
              ${s.imdbScore?`<span class="imdb-rating-display">‚≠ê ${s.imdbScore}/10</span>`:""}
              ${s.imdbId?`<button class="imdb-link-button" onclick="event.stopPropagation(); window.open('https://www.imdb.com/title/${s.imdbId}/', '_blank')" title="View on IMDB">üé¨ IMDB</button>`:""}
              <button class="watch-button" onclick="event.stopPropagation(); window.open('${s.url}', '_blank')">üé¨ Watch</button>
            </div>
          </div>
          <div class="movie-details">
            ${s.year?`<div class="movie-detail-item year">üìÖ ${s.year}</div>`:""}
            ${s.genre?`<div class="movie-detail-item genre">üé≠ ${s.genre}</div>`:""}
            ${s.rating?`<div class="movie-detail-item rating">üé¨ ${s.rating}</div>`:""}
          </div>
          ${s.plot?`<div class="movie-plot collapsed">${s.plot}</div>`:""}
        </div>
      </div>
    `).join("");this.movieListElement.innerHTML=t,this.updateMovieCount(e.length)}updateMovieCount(e){const t=document.getElementById("movie-count");t&&(e===1?t.textContent="1 movie":t.textContent=`${e} movies`)}showError(e){this.movieListElement&&(this.movieListElement.innerHTML=`
      <div class="error">
        <strong>Error:</strong> ${e}
      </div>
    `,this.updateMovieCount(0))}async refreshMovies(){this.movieListElement&&(this.movieListElement.innerHTML='<div class="loading">Refreshing movies...</div>',await this.loadMovies(),this.renderMovies())}parseYouTubeContent(e){console.log("Parsing YouTube content...");try{const t=this.parser.extractMoviesFromHTML(e),s=new Set(this.movies.map(i=>i.videoId)),r=t.filter(i=>!s.has(i.videoId));return console.log(`Found ${r.length} new unique movies`),r}catch(t){throw console.error("Error parsing YouTube content:",t),new Error("Failed to parse the content. Please make sure you pasted valid YouTube page content.")}}async addMoviesToExistingList(e){if(e.length!==0){if(this.movies=[...this.movies,...e],this.isStorageInitialized)try{const t=await this.storage.saveMovies(e);t.success||console.warn("Failed to save new movies to storage:",t.error)}catch(t){console.error("Error saving new movies to storage:",t)}this.updateFilterUI(),this.renderMovies(),this.isStorageInitialized?this.fetchIMDBScoresForMovies(e):console.warn("Storage not initialized, skipping IMDB score fetching"),this.showSuccessMessage(`Successfully added ${e.length} new movies!`)}}async fetchIMDBScoresForMovies(e){try{this.showIMDBLoadingIndicator();const t=e.map(r=>({title:r.title,year:r.year})),s=await this.imdbService.getImdbInfoList(t);if(this.movies=this.movies.map(r=>{const i=s.get(r.title);if(i){const a=W(i);let o={...r};return a.imdbScore!==void 0&&(o.imdbScore=a.imdbScore),a.imdbId!==void 0&&(o.imdbId=a.imdbId),a.plot!==void 0&&(o.plot=a.plot),!o.year&&a.year!==void 0&&(o.year=a.year),!o.genre&&a.genre!==void 0&&(o.genre=a.genre),!o.rating&&a.rating!==void 0&&(o.rating=a.rating),o}return r}),this.isStorageInitialized)try{const r=await this.storage.saveMovies(this.movies);r.success||console.warn("Failed to save updated movies to storage:",r.error)}catch(r){console.error("Error saving updated movies to storage:",r)}this.renderMovies(),this.hideIMDBLoadingIndicator()}catch(t){console.error("Error fetching IMDB scores:",t),this.hideIMDBLoadingIndicator()}}showIMDBLoadingIndicator(){if(!this.movieListElement)return;const e=document.createElement("div");e.id="imdb-loading",e.className="imdb-loading",e.style.cssText=`
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #007bff;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 123, 255, 0.3);
            z-index: 1000;
            font-size: 14px;
        `,e.textContent="Fetching IMDB scores...",document.body.appendChild(e)}hideIMDBLoadingIndicator(){const e=document.getElementById("imdb-loading");e&&e.remove()}async fetchIMDBScoresForAllMovies(){if(this.movies.length===0){alert("No movies available to fetch IMDB scores for.");return}const e=this.movies.filter(t=>!t.imdbScore);if(e.length===0){alert("All movies already have IMDB scores!");return}try{this.showIMDBLoadingIndicator();const t=e.map(i=>({title:i.title,year:i.year})),s=await this.imdbService.getImdbInfoList(t);if(this.movies=this.movies.map(i=>{const a=s.get(i.title);if(a){const o=W(a);let n={...i};return o.imdbScore!==void 0&&(n.imdbScore=o.imdbScore,console.log(`üìä Updated IMDB score for "${i.title}": ${o.imdbScore}`)),o.imdbId!==void 0&&(n.imdbId=o.imdbId,console.log(`üîó Updated IMDB ID for "${i.title}": ${o.imdbId}`)),o.plot!==void 0&&(n.plot=o.plot,console.log(`üìù Updated plot for "${i.title}"`)),!n.year&&o.year!==void 0&&(n.year=o.year,console.log(`üìÖ Updated year for "${i.title}": ${o.year}`)),!n.genre&&o.genre!==void 0&&(n.genre=o.genre,console.log(`üé≠ Updated genre for "${i.title}": ${o.genre}`)),!n.rating&&o.rating!==void 0&&(n.rating=o.rating,console.log(`üé¨ Updated rating for "${i.title}": ${o.rating}`)),n}return i}),this.isStorageInitialized)try{const i=await this.storage.saveMovies(this.movies);i.success||console.warn("Failed to save updated movies to storage:",i.error)}catch(i){console.error("Error saving updated movies to storage:",i)}this.renderMovies(),this.hideIMDBLoadingIndicator();const r=s.size;this.showSuccessMessage(`Successfully fetched ${r} IMDB scores!`)}catch(t){throw console.error("Error fetching IMDB scores for all movies:",t),this.hideIMDBLoadingIndicator(),t}}updateSearchTerm(e){this.searchTerm=e,this.isStorageInitialized&&this.storage.saveSearchTerm(e),this.renderMovies()}getUniqueGenres(){const e=new Set;return this.movies.forEach(t=>{t.genre&&e.add(t.genre)}),Array.from(e).sort()}getUniqueRatings(){const e=new Set;return this.movies.forEach(t=>{t.rating&&e.add(t.rating)}),Array.from(e).sort()}populateGenreCheckboxes(){const e=document.getElementById("genre-checkboxes");if(!e)return;const t=this.getUniqueGenres();e.innerHTML="",t.forEach(s=>{const r=document.createElement("div");r.className="checkbox-item";const i=document.createElement("input");i.type="checkbox",i.id=`genre-${s}`,i.value=s,i.checked=this.filters.selectedGenres.has(s);const a=document.createElement("label");a.htmlFor=`genre-${s}`,a.textContent=s,r.appendChild(i),r.appendChild(a),e.appendChild(r)})}populateRatingCheckboxes(){const e=document.getElementById("rating-checkboxes");if(!e)return;const t=this.getUniqueRatings();e.innerHTML="",t.forEach(s=>{const r=document.createElement("div");r.className="checkbox-item";const i=document.createElement("input");i.type="checkbox",i.id=`rating-${s}`,i.value=s,i.checked=this.filters.selectedRatings.has(s);const a=document.createElement("label");a.htmlFor=`rating-${s}`,a.textContent=s,r.appendChild(i),r.appendChild(a),e.appendChild(r)})}updateFilterLabels(){const e=document.getElementById("genre-selected-count");e&&(this.filters.selectedGenres.size===0?e.textContent="All Genres":this.filters.selectedGenres.size===1?e.textContent=Array.from(this.filters.selectedGenres)[0]:e.textContent=`${this.filters.selectedGenres.size} Genres Selected`);const t=document.getElementById("rating-selected-count");t&&(this.filters.selectedRatings.size===0?t.textContent="All Ratings":this.filters.selectedRatings.size===1?t.textContent=Array.from(this.filters.selectedRatings)[0]:t.textContent=`${this.filters.selectedRatings.size} Ratings Selected`)}updateSelectedFiltersDisplay(){const e=document.getElementById("selected-filters-list");if(!e)return;const t=[];if(this.filters.selectedGenres.size>0&&(this.filters.selectedGenres.size===1?t.push(`<span class="selected-filter-tag"><span class="filter-type">Genre:</span> <span class="filter-value">${Array.from(this.filters.selectedGenres)[0]}</span></span>`):t.push(`<span class="selected-filter-tag"><span class="filter-type">Genres:</span> <span class="filter-value">${this.filters.selectedGenres.size} selected</span></span>`)),this.filters.selectedRatings.size>0&&(this.filters.selectedRatings.size===1?t.push(`<span class="selected-filter-tag"><span class="filter-type">Rating:</span> <span class="filter-value">${Array.from(this.filters.selectedRatings)[0]}</span></span>`):t.push(`<span class="selected-filter-tag"><span class="filter-type">Ratings:</span> <span class="filter-value">${this.filters.selectedRatings.size} selected</span></span>`)),this.filters.yearFrom!==null||this.filters.yearTo!==null){let s="";this.filters.yearFrom!==null&&this.filters.yearTo!==null?s=`${this.filters.yearFrom}-${this.filters.yearTo}`:this.filters.yearFrom!==null?s=`from ${this.filters.yearFrom}`:this.filters.yearTo!==null&&(s=`until ${this.filters.yearTo}`),t.push(`<span class="selected-filter-tag"><span class="filter-type">Year:</span> <span class="filter-value">${s}</span></span>`)}if(this.filters.imdbMin!==0||this.filters.imdbMax!==10){const s=`${this.filters.imdbMin.toFixed(1)}-${this.filters.imdbMax.toFixed(1)}`;t.push(`<span class="selected-filter-tag"><span class="filter-type">IMDB:</span> <span class="filter-value">${s}</span></span>`)}if(this.filters.sortField!=="imdbScore"||this.filters.sortDirection!=="desc"){const s={year:"Year",rating:"Rating",imdbScore:"IMDB Score"},r={asc:"‚Üë",desc:"‚Üì"},i=`${s[this.filters.sortField]||this.filters.sortField} ${r[this.filters.sortDirection]}`;t.push(`<span class="selected-filter-tag"><span class="filter-type">Sort:</span> <span class="filter-value">${i}</span></span>`)}t.length===0?e.innerHTML='<span class="no-filters-message">No filters applied</span>':e.innerHTML=t.join("")}clearAllFilters(){this.filters={selectedGenres:new Set,selectedRatings:new Set,yearFrom:null,yearTo:null,imdbMin:0,imdbMax:10,sortField:"imdbScore",sortDirection:"desc"},this.updateFilterUI(),this.renderMovies()}updateFilterUI(){var o,n;this.populateGenreCheckboxes(),this.populateRatingCheckboxes();const e=document.getElementById("year-from"),t=document.getElementById("year-to");e&&(e.value=((o=this.filters.yearFrom)==null?void 0:o.toString())||""),t&&(t.value=((n=this.filters.yearTo)==null?void 0:n.toString())||"");const s=document.getElementById("imdb-min"),r=document.getElementById("imdb-max"),i=document.getElementById("imdb-min-label"),a=document.getElementById("imdb-max-label");s&&(s.value=this.filters.imdbMin.toString()),r&&(r.value=this.filters.imdbMax.toString()),i&&(i.textContent=this.filters.imdbMin.toFixed(1)),a&&(a.textContent=this.filters.imdbMax.toFixed(1)),this.updateFilterLabels(),this.updateSortingControls(),this.updateSelectedFiltersDisplay()}updateSortingControls(){document.querySelectorAll(".sort-button[data-field]").forEach(e=>{const t=e.getAttribute("data-field"),s=t===this.filters.sortField;if(e.classList.toggle("active",s),s){const r=this.filters.sortDirection==="asc"?"‚Üë":"‚Üì",i={year:"Year",imdbScore:"IMDB Score"};e.textContent=`${i[t]} ${r}`}else{const r={year:"Year",imdbScore:"IMDB Score"};e.textContent=r[t]}})}applyFilters(){const e=document.querySelectorAll('#genre-checkboxes input[type="checkbox"]:checked');this.filters.selectedGenres.clear(),e.forEach(o=>{this.filters.selectedGenres.add(o.value)});const t=document.querySelectorAll('#rating-checkboxes input[type="checkbox"]:checked');this.filters.selectedRatings.clear(),t.forEach(o=>{this.filters.selectedRatings.add(o.value)});const s=document.getElementById("year-from"),r=document.getElementById("year-to");this.filters.yearFrom=s!=null&&s.value?parseInt(s.value):null,this.filters.yearTo=r!=null&&r.value?parseInt(r.value):null;const i=document.getElementById("imdb-min"),a=document.getElementById("imdb-max");if(i&&(this.filters.imdbMin=parseFloat(i.value)),a&&(this.filters.imdbMax=parseFloat(a.value)),this.isStorageInitialized){const o={selectedGenres:Array.from(this.filters.selectedGenres),selectedRatings:Array.from(this.filters.selectedRatings),yearFrom:this.filters.yearFrom,yearTo:this.filters.yearTo,imdbMin:this.filters.imdbMin,imdbMax:this.filters.imdbMax,sortField:this.filters.sortField,sortDirection:this.filters.sortDirection};this.storage.saveFilters(o)}this.updateFilterLabels(),this.updateSelectedFiltersDisplay(),this.renderMovies()}showSuccessMessage(e){const t=document.createElement("div");t.className="success-message",t.style.cssText=`
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
            z-index: 1001;
            animation: slideInRight 0.3s ease-out;
        `,t.textContent=e,document.body.appendChild(t),setTimeout(()=>{t.style.animation="slideOutRight 0.3s ease-in",setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},300)},3e3)}async exportData(){if(!this.isStorageInitialized){alert("Storage not available for export.");return}try{const e=await this.storage.exportData();if(e.success&&e.data){const t=new Blob([e.data],{type:"application/json"}),s=URL.createObjectURL(t),r=document.createElement("a");r.href=s,r.download=`movie-picker-export-${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(s),this.showSuccessMessage("Data exported successfully!")}else alert(`Export failed: ${e.error}`)}catch(e){console.error("Error exporting data:",e),alert("Export failed. Please try again.")}}async importData(e){if(!this.isStorageInitialized){alert("Storage not available for import.");return}try{const t=await e.text(),s=await this.storage.importData(t);s.success?(await this.loadMovies(),await this.loadAppState(),this.renderMovies(),this.showSuccessMessage("Data imported successfully!")):alert(`Import failed: ${s.error}`)}catch(t){console.error("Error importing data:",t),alert("Import failed. Please check the file format and try again.")}}async clearAllData(){if(!this.isStorageInitialized){alert("Storage not available.");return}if(confirm("Are you sure you want to clear all data? This action cannot be undone."))try{const e=await this.storage.clearAllMovies();e.success?(this.movies=[],this.searchTerm="",this.clearAllFilters(),this.renderMovies(),this.showSuccessMessage("All data cleared successfully!")):alert(`Failed to clear data: ${e.error}`)}catch(e){console.error("Error clearing data:",e),alert("Failed to clear data. Please try again.")}}async getStorageStats(){if(!this.isStorageInitialized)return null;try{const e=await this.storage.getStorageStats();if(e.success&&e.data)return e.data}catch(e){console.error("Error getting storage stats:",e)}return null}getMoviesMissingIMDBData(){return this.movies.filter(e=>!e.imdbScore||!e.plot)}getAllMovies(){return this.movies}}document.addEventListener("DOMContentLoaded",()=>{const c=new se;window.moviePickerInstance=c;const e=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"||window.location.hostname==="0.0.0.0"||window.location.port==="5173"||window.location.port==="3000";console.log("Running in local development:",e);const t=document.getElementById("sample-button");t&&e&&(t.style.display="inline-block",t.addEventListener("click",async()=>{try{t.textContent="Loading...",t.disabled=!0;const l=await fetch("/sample1.txt");if(!l.ok)throw new Error(`Failed to load sample file: ${l.status}`);const d=await l.text(),B=c.parseYouTubeContent(d);B.length===0?alert("No movies found in the sample content."):await c.addMoviesToExistingList(B)}catch(l){console.error("Error loading sample:",l),alert(`Error loading sample: ${l.message}`)}finally{t.textContent="üß™ Parse Sample",t.disabled=!1}}));const s=document.getElementById("clear-cache-button"),r=document.getElementById("cache-status");s&&s.addEventListener("click",async()=>{try{if(!confirm("Are you sure you want to clear all data? This will remove all stored movies, IMDB responses, and app settings. This action cannot be undone."))return;s.textContent="Clearing...",s.disabled=!0,await c.clearAllData(),r&&i("‚úÖ All data cleared successfully!","success"),c.showSuccessMessage("All data cleared successfully!")}catch(l){console.error("Error clearing cache data:",l),r?i(`‚ùå Error clearing data: ${l.message}`,"error"):alert(`Error clearing cache data: ${l.message}`)}finally{s.textContent="Clear All Data",s.disabled=!1}});function i(l,d){if(r){switch(r.textContent=l,r.style.display="block",d){case"success":r.style.backgroundColor="#d4edda",r.style.color="#155724",r.style.border="1px solid #c3e6cb";break;case"error":r.style.backgroundColor="#f8d7da",r.style.color="#721c24",r.style.border="1px solid #f5c6cb";break}setTimeout(()=>{r.style.display="none"},3e3)}}const a=document.getElementById("search-input");a&&a.addEventListener("input",l=>{const d=l.target;c.updateSearchTerm(d.value)});const o=document.getElementById("toggle-filters"),n=document.getElementById("filters-content"),u=document.getElementById("clear-all-filters"),h=document.getElementById("apply-filters");o&&n&&o.addEventListener("click",()=>{const l=n.style.display!=="none";n.style.display=l?"none":"block",o.textContent=l?"Show Filters":"Hide Filters";const d=document.getElementById("selected-filters-display");d&&(d.style.display=l?"block":"none",l&&c.updateSelectedFiltersDisplay())}),u&&u.addEventListener("click",()=>{c.clearAllFilters()}),h&&h.addEventListener("click",()=>{c.applyFilters()}),document.querySelectorAll(".sort-button").forEach(l=>{l.addEventListener("click",()=>{const d=l.getAttribute("data-field");d&&(c.filters.sortField===d?c.filters.sortDirection=c.filters.sortDirection==="asc"?"desc":"asc":(c.filters.sortField=d,c.filters.sortDirection="asc"),c.updateSortingControls(),c.applyFilters())})});const m=document.getElementById("genre-dropdown-btn"),g=document.getElementById("genre-dropdown-content"),b=document.getElementById("select-all-genres"),G=document.getElementById("clear-all-genres");m&&g&&(m.addEventListener("click",()=>{g.classList.toggle("show"),m.classList.toggle("active")}),document.addEventListener("click",l=>{const d=l.target;!(m!=null&&m.contains(d))&&!(g!=null&&g.contains(d))&&(g==null||g.classList.remove("show"),m==null||m.classList.remove("active"))})),b&&b.addEventListener("click",()=>{document.querySelectorAll('#genre-checkboxes input[type="checkbox"]').forEach(d=>d.checked=!0)}),G&&G.addEventListener("click",()=>{document.querySelectorAll('#genre-checkboxes input[type="checkbox"]').forEach(d=>d.checked=!1)});const I=document.getElementById("rating-dropdown-btn"),S=document.getElementById("rating-dropdown-content"),O=document.getElementById("select-all-ratings"),j=document.getElementById("clear-all-ratings");I&&S&&(I.addEventListener("click",()=>{S.classList.toggle("show"),I.classList.toggle("active")}),document.addEventListener("click",l=>{const d=l.target;!(I!=null&&I.contains(d))&&!(S!=null&&S.contains(d))&&(S==null||S.classList.remove("show"),I==null||I.classList.remove("active"))})),O&&O.addEventListener("click",()=>{document.querySelectorAll('#rating-checkboxes input[type="checkbox"]').forEach(d=>d.checked=!0)}),j&&j.addEventListener("click",()=>{document.querySelectorAll('#rating-checkboxes input[type="checkbox"]').forEach(d=>d.checked=!1)});const k=document.getElementById("imdb-min"),T=document.getElementById("imdb-max"),P=document.getElementById("imdb-min-label"),C=document.getElementById("imdb-max-label");k&&P&&k.addEventListener("input",()=>{const l=parseFloat(k.value);P.textContent=l.toFixed(1),T&&l>parseFloat(T.value)&&(T.value=l.toString(),C&&(C.textContent=l.toFixed(1)))}),T&&C&&T.addEventListener("input",()=>{const l=parseFloat(T.value);C.textContent=l.toFixed(1),k&&l<parseFloat(k.value)&&(k.value=l.toString(),P&&(P.textContent=l.toFixed(1)))});const R=document.getElementById("paste-modal"),q=document.getElementById("paste-content-button"),_=document.querySelector(".close"),Y=document.getElementById("cancel-button"),F=document.getElementById("parse-button"),D=document.getElementById("content-textarea");q&&R&&D&&q.addEventListener("click",()=>{R.style.display="block",D.focus()});function N(){R&&D&&(R.style.display="none",D.value="")}_&&_.addEventListener("click",N),Y&&Y.addEventListener("click",N),window.addEventListener("click",l=>{l.target===R&&N()}),F&&D&&F.addEventListener("click",async()=>{const l=D.value.trim();if(!l){alert("Please paste some content before parsing.");return}try{F.textContent="Parsing...",F.disabled=!0;const d=c.parseYouTubeContent(l);d.length===0?alert("No new unique movies found in the content. They might already be in your list."):(await c.addMoviesToExistingList(d),N())}catch(d){alert(`Error: ${d.message}`)}finally{F.textContent="Parse & Add Movies",F.disabled=!1}});const x=document.getElementById("api-key-modal"),w=document.getElementById("api-key-button"),U=x==null?void 0:x.querySelector(".close"),K=document.getElementById("api-key-cancel-button"),V=document.getElementById("api-key-clear-button"),H=document.getElementById("api-key-save-button"),A=document.getElementById("api-key-test-button"),v=document.getElementById("api-key-input"),p=document.getElementById("api-key-status");function z(){w&&(c.imdbService.hasApiKey()?(w.textContent="Settings ‚úì",w.style.backgroundColor="#28a745"):(w.textContent="Settings",w.style.backgroundColor="#6c757d"))}z(),w&&x&&v&&w.addEventListener("click",()=>{const l=c.imdbService.getApiKey();l?v.value=l:v.value="",x.style.display="block",v.focus()});function E(){x&&v&&p&&(x.style.display="none",v.value="",p.style.display="none",r&&(r.style.display="none"))}U&&U.addEventListener("click",E),K&&K.addEventListener("click",E),window.addEventListener("click",l=>{l.target===x&&E()}),A&&v&&p&&A.addEventListener("click",async()=>{const l=v.value.trim();if(!l){M("Please enter an API key to test.","error");return}try{A.textContent="Testing...",A.disabled=!0;const B=await(await fetch(`https://www.omdbapi.com/?apikey=${l}&t=The+Matrix&type=movie`)).json();B.Response==="True"?M("‚úÖ API key is valid and working!","success"):B.Error==="Invalid API key!"?M("‚ùå Invalid API key. Please check your key and try again.","error"):M("‚ö†Ô∏è API key test failed. Please check your key.","warning")}catch(d){console.error("Error testing API key:",d),M("‚ùå Error testing API key. Please check your internet connection.","error")}finally{A.textContent="Test Key",A.disabled=!1}}),V&&v&&p&&V.addEventListener("click",()=>{confirm("Are you sure you want to clear the API key? This will remove the stored key and disable IMDB score fetching.")&&(c.imdbService.clearApiKey(),v.value="",M("‚úÖ API key cleared successfully!","success"),z(),setTimeout(()=>{E()},1500))}),H&&v&&p&&H.addEventListener("click",async()=>{const l=v.value.trim();if(!l){M("Please enter an API key to save.","error");return}c.imdbService.setApiKey(l),M("‚úÖ API key saved successfully!","success"),z();const d=c.getMoviesMissingIMDBData();if(d.length>0){const B=d.filter($=>!$.imdbScore).length,Z=d.filter($=>!$.plot).length;if(confirm(`Found ${d.length} movies missing IMDB data:
‚Ä¢ ${B} movies missing IMDB scores
‚Ä¢ ${Z} movies missing plot information

Would you like to fetch this data now? This may take a few minutes.`)){E(),c.showSuccessMessage(`Fetching IMDB data for ${d.length} movies...`);try{await c.fetchIMDBScoresForMovies(d),c.showSuccessMessage(`Successfully fetched IMDB data for ${d.length} movies!`)}catch($){console.error("Error fetching IMDB data:",$),c.showSuccessMessage("Some movies may not have been updated. Check the console for details.")}}else setTimeout(()=>{E()},1500)}else M("‚úÖ All movies already have IMDB data!","success"),setTimeout(()=>{E()},1500)});function M(l,d){if(p)switch(p.textContent=l,p.style.display="block",d){case"success":p.style.backgroundColor="#d4edda",p.style.color="#155724",p.style.border="1px solid #c3e6cb";break;case"error":p.style.backgroundColor="#f8d7da",p.style.color="#721c24",p.style.border="1px solid #f5c6cb";break;case"warning":p.style.backgroundColor="#fff3cd",p.style.color="#856404",p.style.border="1px solid #ffeaa7";break}}});window.toggleMoviePlot=function(c){const e=document.querySelector(`[data-movie-id="${c}"]`);if(!e)return;const t=e.querySelector(".movie-plot");if(!t)return;t.classList.contains("expanded")?(t.classList.remove("expanded"),t.classList.add("collapsed")):(t.classList.remove("collapsed"),t.classList.add("expanded"))};window.logMovieObject=function(c){const e=window.moviePickerInstance;if(!e){console.error("MoviePicker instance not found");return}e.getAllMovies().find(s=>s.videoId===c)||console.error("Movie not found with videoId:",c)};document.addEventListener("DOMContentLoaded",()=>{document.addEventListener("click",c=>{const e=c.target,t=e.closest(".movie-item");if(!t||!t.hasAttribute("data-has-plot")||e.closest(".movie-actions"))return;const s=t.getAttribute("data-movie-id");s&&window.toggleMoviePlot(s)})});
