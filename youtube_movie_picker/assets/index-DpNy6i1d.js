var V=Object.defineProperty;var H=(d,e,t)=>e in d?V(d,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):d[e]=t;var y=(d,e,t)=>H(d,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(r){if(r.ep)return;r.ep=!0;const i=t(r);fetch(r.href,i)}})();class W{constructor(){}extractMoviesFromHTML(e){const t=[];try{const s=this.extractGridMovieRenderers(e);s.length>0?s.forEach(r=>{const i=this.parseGridMovieRenderer(r);i&&t.push(i)}):t.push(...this.extractMoviesLegacy(e))}catch(s){console.error("Error parsing YouTube content:",s),t.push(...this.extractMoviesLegacy(e))}return t}extractGridMovieRenderers(e){const t=[],s=new Set;try{const r=this.findGridMovieRendererObjects(e);for(const i of r)try{const o=this.parseGridMovieRendererJSON(i);o&&!s.has(o.videoId)&&(t.push(o),s.add(o.videoId))}catch(o){console.error("Error parsing gridMovieRenderer JSON:",o);continue}}catch(r){console.error("Error extracting gridMovieRenderer objects:",r)}return t}findGridMovieRendererObjects(e){const t=[],s='"gridMovieRenderer":';let r=0;for(;;){const i=e.indexOf(s,r);if(i===-1)break;const o=i+s.length;let a=0,n=o,u=!1,m=!1;for(let h=o;h<e.length;h++){const f=e[h];if(m){m=!1;continue}if(f==="\\"){m=!0;continue}if(f==='"'&&!m){u=!u;continue}if(!u){if(f==="{")a++;else if(f==="}"&&(a--,a===0)){n=h+1;break}}}if(a===0){const h=e.substring(o,n).trim();t.push(h)}r=n}return t}parseGridMovieRendererJSON(e){var t,s,r;try{const i=JSON.parse(e);return!i.videoId||!((r=(s=(t=i.title)==null?void 0:t.runs)==null?void 0:s[0])!=null&&r.text)?null:i}catch(i){return console.error("Error parsing JSON:",i),null}}extractMovieDataFromChunk(e){try{const t=e.match(/"videoId":\s*"([^"]+)"/);if(!t)return null;const s=e.match(/"title":\s*{\s*"runs":\s*\[\s*{\s*"text":\s*"([^"]+)"/);if(!s)return null;const r=e.match(/"lengthText":\s*{[^}]*"simpleText":\s*"([^"]+)"/),i=e.match(/"url":\s*"([^"]*ytimg[^"]*movieposter[^"]*)"/)||e.match(/"url":\s*"([^"]*ytimg[^"]*)"/),o=e.match(/"metadata":\s*{\s*"simpleText":\s*"([^"]+)"/),a=e.match(/"metadataBadgeRenderer":\s*{[^}]*"label":\s*"([^"]+)"[^}]*"style":\s*"([^"]+)"/g),n=a?a.map(f=>{const v=f.match(/"label":\s*"([^"]+)"/),p=f.match(/"style":\s*"([^"]+)"/);return{metadataBadgeRenderer:{style:p?p[1]:"BADGE_STYLE_TYPE_SIMPLE",label:v?v[1]:"",trackingParams:""}}}):void 0,u=e.match(/"clickTrackingParams":\s*"([^"]+)"/),m=e.match(/"url":\s*"([^"]*watch[^"]*)"/),h=e.match(/"trackingParams":\s*"([^"]+)"/);return(s[1].includes("John Wick")||s[1].includes("Open Season"))&&console.log(`Debug for ${s[1]}:`,{videoId:t[1],duration:r?r[1]:"NOT FOUND",metadata:o?o[1]:"NOT FOUND",badges:n?n.map(f=>f.metadataBadgeRenderer.label):"NOT FOUND"}),{videoId:t[1],title:{runs:[{text:s[1]}]},lengthText:{simpleText:r?r[1]:"Unknown"},thumbnail:{thumbnails:i?[{url:i[1],width:279,height:402}]:[]},navigationEndpoint:{clickTrackingParams:u?u[1]:"",commandMetadata:{webCommandMetadata:{url:m?m[1]:`/watch?v=${t[1]}`,webPageType:"WEB_PAGE_TYPE_WATCH",rootVe:3832}},watchEndpoint:{videoId:t[1]}},trackingParams:h?h[1]:"",metadata:o?{simpleText:o[1]}:void 0,badges:n}}catch(t){return console.error("Error extracting movie data from chunk:",t),null}}parseGridMovieRenderer(e){var t,s,r,i,o;try{const a=((t=e.title.runs[0])==null?void 0:t.text)||"Unknown Movie",n=((s=e.lengthText)==null?void 0:s.simpleText)||"Unknown",u=((r=e.thumbnail.thumbnails[0])==null?void 0:r.url)||`https://img.youtube.com/vi/${e.videoId}/maxresdefault.jpg`,m=((i=e.metadata)==null?void 0:i.simpleText)||"",h=this.extractYearFromMetadata(m),f=this.extractGenreFromMetadata(m),v=this.extractRatingFromBadges(e.badges);return(a.includes("John Wick")||a.includes("Open Season"))&&console.log(`Parsed ${a}:`,{videoId:e.videoId,duration:n,metadata:m,year:h,genre:f,rating:v,badges:((o=e.badges)==null?void 0:o.map(p=>p.metadataBadgeRenderer.label))||[]}),{videoId:e.videoId,title:this.cleanTitle(a),duration:n,thumbnail:u,url:`https://www.youtube.com/watch?v=${e.videoId}`,year:h,genre:f,rating:v}}catch(a){return console.error("Error parsing gridMovieRenderer:",a),null}}extractMoviesLegacy(e){const t=[],s=/"gridMovieRenderer":\s*{[^}]*"videoId":\s*"([A-Za-z0-9_-]+)"/g;let r;const i=new Set;for(;(r=s.exec(e))!==null;)i.add(r[1]);if(i.size===0){const n=/"videoId":\s*"([A-Za-z0-9_-]+)"/g;for(;(r=n.exec(e))!==null;)i.add(r[1])}const o=Array.from(i),a=this.extractMovieTitles(e);return o.forEach((n,u)=>{let m=a[u]||`Movie ${u+1}`;m=this.cleanTitle(m);const h=this.extractYear(e,n),f=this.extractGenre(e,n),v=this.extractRating(e,n),p=this.extractDuration(e,n);t.push({videoId:n,title:m,duration:p,thumbnail:`https://img.youtube.com/vi/${n}/maxresdefault.jpg`,url:`https://www.youtube.com/watch?v=${n}`,year:h,genre:f,rating:v})}),t}extractMovieTitles(e){const t=[],s=new Set;return[/"gridMovieRenderer":\s*{[^}]*"title":\s*{\s*"runs":\s*\[\s*{\s*"text":\s*"([^"]+)"/g,/"title":\s*{\s*"runs":\s*\[\s*{\s*"text":\s*"([^"]+)"/g,/"title":\s*"([^"]+)"/g].forEach(i=>{let o;for(;(o=i.exec(e))!==null;){const a=o[1];a&&a.length>3&&!s.has(a)&&!a.includes("YouTube")&&!a.includes("Browse")&&!a.includes("Free")&&!a.includes("Movies")&&!a.includes("Watch")&&!a.includes("Play")&&!a.includes("Subscribe")&&(t.push(a),s.add(a))}}),t}cleanTitle(e){return e?e.replace(/^[^\w\s]*/,"").replace(/[^\w\s]*$/,"").replace(/\s+/g," ").trim().substring(0,100):"Unknown Movie"}extractYear(e,t){const s=[/\((\d{4})\)/g,/(\d{4})/g,/"year":\s*"(\d{4})"/g,/"releaseDate":\s*"(\d{4})"/g];for(const r of s){let i;for(;(i=r.exec(e))!==null;){const o=i[1],a=parseInt(o);if(a>=1900&&a<=new Date().getFullYear()+2)return o}}}extractGenre(e,t){const s=["Action","Adventure","Animation","Biography","Comedy","Crime","Documentary","Drama","Family","Fantasy","Film-Noir","History","Horror","Music","Musical","Mystery","Romance","Sci-Fi","Sport","Thriller","War","Western"],r=[new RegExp(`"gridMovieRenderer":\\s*{[^}]*"videoId":\\s*"${t}"[^}]*"metadata":\\s*{\\s*"simpleText":\\s*"([^"]+)"`,"i"),new RegExp(`"videoId":\\s*"${t}"[^}]*"metadata":\\s*{\\s*"simpleText":\\s*"([^"]+)"`,"i"),/"genre":\s*"([^"]+)"/g,/"category":\s*"([^"]+)"/g,/"type":\s*"([^"]+)"/g];for(const o of r){let a;for(;(a=o.exec(e))!==null;){const n=a[1];for(const u of s)if(n.toLowerCase().includes(u.toLowerCase()))return u}}const i=e.match(new RegExp(`"videoId":\\s*"${t}"[^}]*"title":\\s*{\\s*"runs":\\s*\\[\\s*{\\s*"text":\\s*"([^"]+)"`,"i"));if(i){const o=i[1].toLowerCase();for(const a of s)if(o.includes(a.toLowerCase()))return a}}extractRating(e,t){const s=[new RegExp(`"gridMovieRenderer":\\s*{[^}]*"videoId":\\s*"${t}"[^}]*"badges":\\s*\\[[^}]*"metadataBadgeRenderer":\\s*{[^}]*"label":\\s*"([^"]+)"[^}]*"style":\\s*"BADGE_STYLE_TYPE_SIMPLE"`,"i"),new RegExp(`"videoId":\\s*"${t}"[^}]*"badges":\\s*\\[[^}]*"metadataBadgeRenderer":\\s*{[^}]*"label":\\s*"([^"]+)"[^}]*"style":\\s*"BADGE_STYLE_TYPE_SIMPLE"`,"i"),/"metadataBadgeRenderer":\s*{[^}]*"label":\s*"(G|PG|PG-13|R|NC-17|TV-G|TV-PG|TV-14|TV-MA)"[^}]*"style":\s*"BADGE_STYLE_TYPE_SIMPLE"/g,/"rating":\s*"([^"]+)"/g,/"contentRating":\s*"([^"]+)"/g,/"ageRestriction":\s*"([^"]+)"/g];for(const r of s){let i;for(;(i=r.exec(e))!==null;){const o=i[1];if(o&&o.length<=10&&/^(G|PG|PG-13|R|NC-17|TV-G|TV-PG|TV-14|TV-MA)$/.test(o))return o}}}extractDuration(e,t){const s=[new RegExp(`"gridMovieRenderer":\\s*{[^}]*"videoId":\\s*"${t}"[^}]*"lengthText":\\s*{[^}]*"simpleText":\\s*"([^"]+)"`,"i"),new RegExp(`"videoId":\\s*"${t}"[^}]*"lengthText":\\s*{[^}]*"simpleText":\\s*"([^"]+)"`,"i"),new RegExp(`"videoId":\\s*"${t}"[^}]*"accessibilityData":\\s*{[^}]*"label":\\s*"([^"]*\\d+\\s*(?:hours?|minutes?|seconds?)[^"]*)"`,"i"),/"lengthText":\s*{[^}]*"simpleText":\s*"(\d+:\d+:\d+|\d+:\d+)"/g];for(const r of s){let i;for(;(i=r.exec(e))!==null;){const o=i[1];if(o&&o.length>0&&/^\d+:\d+/.test(o))return o}}return"Unknown"}extractYearFromMetadata(e){if(!e)return;const t=e.match(/(\d{4})/);if(t){const s=parseInt(t[1]);if(s>=1900&&s<=new Date().getFullYear()+2)return t[1]}}extractGenreFromMetadata(e){if(!e)return;const t=["Action","Adventure","Animation","Biography","Comedy","Crime","Documentary","Drama","Family","Fantasy","Film-Noir","History","Horror","Music","Musical","Mystery","Romance","Sci-Fi","Sport","Thriller","War","Western"];for(const s of t)if(e.toLowerCase().includes(s.toLowerCase()))return s}extractRatingFromBadges(e){var t;if(!(!e||!Array.isArray(e))){for(const s of e)if((t=s.metadataBadgeRenderer)!=null&&t.label){const r=s.metadataBadgeRenderer.label;if(/^[A-Z]$/.test(r)||/^(G|PG|PG-13|R|NC-17|TV-G|TV-PG|TV-14|TV-MA)$/.test(r))return r}}}}class Z{constructor(e){y(this,"OMDB_BASE_URL","https://www.omdbapi.com/");y(this,"storage");y(this,"API_KEY_STORAGE_KEY","omdb_api_key");this.storage=e}getApiKey(){return localStorage.getItem(this.API_KEY_STORAGE_KEY)}setApiKey(e){localStorage.setItem(this.API_KEY_STORAGE_KEY,e)}clearApiKey(){localStorage.removeItem(this.API_KEY_STORAGE_KEY)}hasApiKey(){const e=this.getApiKey();return e!==null&&e.trim()!==""}async getImdbInfo(e,t){if(!this.hasApiKey())return console.warn("OMDB API key not set. Please set your API key to fetch IMDB responses."),null;try{const s=this.cleanTitle(e);try{const a=await this.storage.loadIMDBResponse(s,t);if(a.success&&a.data)return a.data}catch(a){console.warn("Storage not available for IMDB response, fetching from API:",a)}const r=new URLSearchParams({apikey:this.getApiKey(),t:s,type:"movie",plot:"full"});t&&r.append("y",t);const i=await fetch(`${this.OMDB_BASE_URL}?${r}`);if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);const o=await i.json();if(o.Response==="True"){try{await this.storage.saveIMDBResponse(s,t,o)}catch(a){console.warn("Failed to save IMDB response to storage:",a)}return o}return null}catch(s){return console.error(`Error fetching IMDB response for "${e}":`,s),null}}async getImdbInfoList(e){const t=new Map;if(!this.hasApiKey())return console.warn("OMDB API key not set. Please set your API key to fetch IMDB responses."),t;const s=5;for(let r=0;r<e.length;r+=s){const o=e.slice(r,r+s).map(async a=>{const n=await this.getImdbInfo(a.title,a.year);n&&t.set(a.title,n)});await Promise.all(o),r+s<e.length&&await new Promise(a=>setTimeout(a,1e3))}return t}cleanTitle(e){return e.replace(/\([^)]*\)/g,"").replace(/\[[^\]]*\]/g,"").replace(/\s+/g," ").trim().split(" - ")[0].split(" | ")[0]}async clearIMDBCache(){return(await this.storage.clearIMDBResponses()).success}async getIMDBStorageStats(){const e=await this.storage.getIMDBStorageStats();return e.success&&e.data||null}}class J{constructor(e={dbName:"MoviePickerDB",version:1,storeName:"movieData",imdbStoreName:"imdbResponses"}){y(this,"db",null);y(this,"config");y(this,"APP_VERSION","1.0.0");this.config=e}async initialize(){return new Promise((e,t)=>{if(!("indexedDB"in window)){t(new Error("IndexedDB is not supported in this browser"));return}const s=indexedDB.open(this.config.dbName,this.config.version);s.onerror=()=>{console.error("Failed to open IndexedDB:",s.error),t(s.error)},s.onsuccess=()=>{this.db=s.result,console.log("IndexedDB initialized successfully"),e(!0)},s.onupgradeneeded=r=>{const i=r.target.result;if(!i.objectStoreNames.contains(this.config.storeName)){const o=i.createObjectStore(this.config.storeName,{keyPath:"id"});o.createIndex("videoId","videoId",{unique:!1}),o.createIndex("title","title",{unique:!1}),o.createIndex("dateAdded","dateAdded",{unique:!1}),o.createIndex("imdbScore","imdbScore",{unique:!1}),o.createIndex("genre","genre",{unique:!1}),o.createIndex("year","year",{unique:!1})}if(!i.objectStoreNames.contains(this.config.imdbStoreName)){const o=i.createObjectStore(this.config.imdbStoreName,{keyPath:"id"});o.createIndex("title","title",{unique:!1}),o.createIndex("year","year",{unique:!1}),o.createIndex("dateAdded","dateAdded",{unique:!1}),o.createIndex("titleYear",["title","year"],{unique:!1})}}})}isInitialized(){return this.db!==null}ensureInitialized(){if(!this.isInitialized())throw new Error("Storage not initialized. Call initialize() first.")}async recreateDatabase(){try{this.db&&(this.db.close(),this.db=null);const e=indexedDB.deleteDatabase(this.config.dbName);return new Promise(t=>{let s=!1;const r=i=>{s||(s=!0,t(i))};e.onsuccess=()=>{console.log("Database deleted successfully, recreating..."),this.initialize().then(i=>{r(i)}).catch(i=>{console.error("Failed to reinitialize after deletion:",i),r(!1)})},e.onerror=()=>{console.error("Failed to delete database:",e.error),this.initialize().then(i=>{r(i)}).catch(i=>{console.error("Failed to initialize after delete error:",i),r(!1)})},e.onblocked=()=>{console.warn("Database deletion blocked, trying to recreate anyway..."),this.initialize().then(i=>{r(i)}).catch(i=>{console.error("Failed to initialize after block:",i),r(!1)})},setTimeout(()=>{r(!1)},1e4)})}catch(e){return console.error("Error recreating database:",e),!1}}movieToStoredMovie(e,t){const s=Date.now();return{...e,id:t||this.generateId(),dateAdded:s,lastModified:s}}storedMovieToMovie(e){const{id:t,dateAdded:s,lastModified:r,...i}=e;return i}generateId(){return`movie_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}async saveMovie(e){return this.ensureInitialized(),new Promise(t=>{const r=this.db.transaction([this.config.storeName],"readwrite").objectStore(this.config.storeName),o=r.index("videoId").get(e.videoId);o.onsuccess=()=>{const a=o.result;let n;a?n={...a,...e,lastModified:Date.now()}:n=this.movieToStoredMovie(e);const u=r.put(n);u.onsuccess=()=>{t({success:!0,data:n})},u.onerror=()=>{var m;t({success:!1,error:`Failed to save movie: ${(m=u.error)==null?void 0:m.message}`})}},o.onerror=()=>{var a;t({success:!1,error:`Failed to check existing movie: ${(a=o.error)==null?void 0:a.message}`})}})}async saveMovies(e){this.ensureInitialized();const t=[],s=[];for(const r of e){const i=await this.saveMovie(r);i.success&&i.data?t.push(i.data):s.push(i.error||"Unknown error")}return{success:s.length===0,data:t,error:s.length>0?s.join("; "):void 0}}async loadMovies(){return this.ensureInitialized(),new Promise(e=>{const r=this.db.transaction([this.config.storeName],"readonly").objectStore(this.config.storeName).getAll();r.onsuccess=()=>{const o=r.result.map(a=>this.storedMovieToMovie(a));e({success:!0,data:o})},r.onerror=()=>{var i;e({success:!1,error:`Failed to load movies: ${(i=r.error)==null?void 0:i.message}`})}})}async loadMovieByVideoId(e){return this.ensureInitialized(),new Promise(t=>{const o=this.db.transaction([this.config.storeName],"readonly").objectStore(this.config.storeName).index("videoId").get(e);o.onsuccess=()=>{const a=o.result;t(a?{success:!0,data:this.storedMovieToMovie(a)}:{success:!0,data:null})},o.onerror=()=>{var a;t({success:!1,error:`Failed to load movie: ${(a=o.error)==null?void 0:a.message}`})}})}async deleteMovie(e){return this.ensureInitialized(),new Promise(t=>{const r=this.db.transaction([this.config.storeName],"readwrite").objectStore(this.config.storeName),o=r.index("videoId").get(e);o.onsuccess=()=>{const a=o.result;if(a){const n=r.delete(a.id);n.onsuccess=()=>{t({success:!0,data:!0})},n.onerror=()=>{var u;t({success:!1,error:`Failed to delete movie: ${(u=n.error)==null?void 0:u.message}`})}}else t({success:!0,data:!1})},o.onerror=()=>{var a;t({success:!1,error:`Failed to find movie: ${(a=o.error)==null?void 0:a.message}`})}})}async clearAllMovies(){return this.ensureInitialized(),new Promise(e=>{const r=this.db.transaction([this.config.storeName],"readwrite").objectStore(this.config.storeName).clear();r.onsuccess=()=>{e({success:!0,data:!0})},r.onerror=()=>{var i;e({success:!1,error:`Failed to clear movies: ${(i=r.error)==null?void 0:i.message}`})}})}saveFilters(e){try{return localStorage.setItem("moviePicker_filters",JSON.stringify(e)),!0}catch(t){return console.error("Failed to save filters:",t),!1}}loadFilters(){try{const e=localStorage.getItem("moviePicker_filters");return e?JSON.parse(e):null}catch(e){return console.error("Failed to load filters:",e),null}}saveSearchTerm(e){try{return localStorage.setItem("moviePicker_searchTerm",e),!0}catch(t){return console.error("Failed to save search term:",t),!1}}loadSearchTerm(){try{return localStorage.getItem("moviePicker_searchTerm")}catch(e){return console.error("Failed to load search term:",e),null}}async saveAppState(e,t,s){try{const r=await this.saveMovies(e);if(!r.success)return{success:!1,error:`Failed to save movies: ${r.error}`};const i=this.saveFilters(t),o=this.saveSearchTerm(s);return!i||!o?{success:!1,error:"Failed to save filters or search term"}:{success:!0,data:!0}}catch(r){return{success:!1,error:`Failed to save app state: ${r}`}}}async loadAppState(){try{const e=await this.loadMovies();if(!e.success)return{success:!1,error:`Failed to load movies: ${e.error}`};const t=this.loadFilters(),s=this.loadSearchTerm();return{success:!0,data:{movies:e.data||[],filters:t,searchTerm:s}}}catch(e){return{success:!1,error:`Failed to load app state: ${e}`}}}async getStorageStats(){return this.ensureInitialized(),new Promise(e=>{const r=this.db.transaction([this.config.storeName],"readonly").objectStore(this.config.storeName).count();r.onsuccess=()=>{const i=r.result,o=i*1024;e({success:!0,data:{movieCount:i,dbSize:o}})},r.onerror=()=>{var i;e({success:!1,error:`Failed to get storage stats: ${(i=r.error)==null?void 0:i.message}`})}})}async exportData(){try{const e=await this.loadAppState();if(!e.success)return{success:!1,error:`Failed to load data for export: ${e.error}`};const t={version:this.APP_VERSION,exportDate:new Date().toISOString(),...e.data};return{success:!0,data:JSON.stringify(t,null,2)}}catch(e){return{success:!1,error:`Failed to export data: ${e}`}}}async importData(e){try{const t=JSON.parse(e);if(!t.movies||!Array.isArray(t.movies))return{success:!1,error:"Invalid data format: movies array is required"};await this.clearAllMovies();const s=await this.saveMovies(t.movies);return s.success?(t.filters&&this.saveFilters(t.filters),t.searchTerm&&this.saveSearchTerm(t.searchTerm),{success:!0,data:!0}):{success:!1,error:`Failed to import movies: ${s.error}`}}catch(t){return{success:!1,error:`Failed to import data: ${t}`}}}async saveIMDBResponse(e,t,s){return this.isInitialized()?new Promise(r=>{try{if(!this.db.objectStoreNames.contains(this.config.imdbStoreName)){console.warn(`IMDB object store '${this.config.imdbStoreName}' not found. Attempting to recreate database...`),this.recreateDatabase().then(u=>{u?(console.log("Database recreated successfully, retrying save..."),this.saveIMDBResponse(e,t,s).then(r)):(console.error("Failed to recreate database"),r({success:!1,error:"IMDB object store not found and failed to recreate database."}))}).catch(u=>{console.error("Error during database recreation:",u),r({success:!1,error:"IMDB object store not found and failed to recreate database."})});return}const o=this.db.transaction([this.config.imdbStoreName],"readwrite").objectStore(this.config.imdbStoreName),n=o.index("titleYear").get([e.toLowerCase(),t||""]);n.onsuccess=()=>{const u=n.result,m=Date.now();let h;u?h={...u,response:s,lastModified:m}:h={id:this.generateId(),title:e.toLowerCase(),year:t||"",response:s,dateAdded:m,lastModified:m};const f=o.put(h);f.onsuccess=()=>{r({success:!0,data:h})},f.onerror=()=>{var v;console.error("Error saving IMDB response:",f.error),r({success:!1,error:`Failed to save IMDB response: ${((v=f.error)==null?void 0:v.message)||"Unknown error"}`})}},n.onerror=()=>{var u;console.error("Error checking existing IMDB response:",n.error),r({success:!1,error:`Failed to check existing IMDB response: ${((u=n.error)==null?void 0:u.message)||"Unknown error"}`})}}catch(i){console.error("Error in saveIMDBResponse:",i),r({success:!1,error:`Failed to save IMDB response: ${i instanceof Error?i.message:"Unknown error"}`})}}):(console.warn("Storage not initialized, cannot save IMDB response"),{success:!1,error:"Storage not initialized"})}async loadIMDBResponse(e,t){return this.isInitialized()?new Promise(s=>{try{if(!this.db.objectStoreNames.contains(this.config.imdbStoreName)){console.warn(`IMDB object store '${this.config.imdbStoreName}' not found. Attempting to recreate database...`),this.recreateDatabase().then(n=>{n?(console.log("Database recreated successfully, retrying load..."),this.loadIMDBResponse(e,t).then(s)):(console.error("Failed to recreate database"),s({success:!0,data:null}))}).catch(n=>{console.error("Error during database recreation:",n),s({success:!0,data:null})});return}const a=this.db.transaction([this.config.imdbStoreName],"readonly").objectStore(this.config.imdbStoreName).index("titleYear").get([e.toLowerCase(),t||""]);a.onsuccess=()=>{const n=a.result;s(n?{success:!0,data:n.response}:{success:!0,data:null})},a.onerror=()=>{var n;console.error("Error loading IMDB response:",a.error),s({success:!1,error:`Failed to load IMDB response: ${((n=a.error)==null?void 0:n.message)||"Unknown error"}`})}}catch(r){console.error("Error in loadIMDBResponse:",r),s({success:!1,error:`Failed to load IMDB response: ${r instanceof Error?r.message:"Unknown error"}`})}}):(console.warn("Storage not initialized, cannot load IMDB response"),{success:!0,data:null})}async clearIMDBResponses(){return this.ensureInitialized(),new Promise(e=>{try{if(!this.db.objectStoreNames.contains(this.config.imdbStoreName)){console.warn(`IMDB object store '${this.config.imdbStoreName}' not found. Nothing to clear.`),e({success:!0,data:!0});return}const r=this.db.transaction([this.config.imdbStoreName],"readwrite").objectStore(this.config.imdbStoreName).clear();r.onsuccess=()=>{e({success:!0,data:!0})},r.onerror=()=>{var i;console.error("Error clearing IMDB responses:",r.error),e({success:!1,error:`Failed to clear IMDB responses: ${((i=r.error)==null?void 0:i.message)||"Unknown error"}`})}}catch(t){console.error("Error in clearIMDBResponses:",t),e({success:!1,error:`Failed to clear IMDB responses: ${t instanceof Error?t.message:"Unknown error"}`})}})}async getIMDBStorageStats(){return this.ensureInitialized(),new Promise(e=>{try{if(!this.db.objectStoreNames.contains(this.config.imdbStoreName)){console.warn(`IMDB object store '${this.config.imdbStoreName}' not found. Returning zero count.`),e({success:!0,data:{responseCount:0}});return}const r=this.db.transaction([this.config.imdbStoreName],"readonly").objectStore(this.config.imdbStoreName).count();r.onsuccess=()=>{e({success:!0,data:{responseCount:r.result}})},r.onerror=()=>{var i;console.error("Error getting IMDB storage stats:",r.error),e({success:!1,error:`Failed to get IMDB storage stats: ${((i=r.error)==null?void 0:i.message)||"Unknown error"}`})}}catch(t){console.error("Error in getIMDBStorageStats:",t),e({success:!1,error:`Failed to get IMDB storage stats: ${t instanceof Error?t.message:"Unknown error"}`})}})}close(){this.db&&(this.db.close(),this.db=null)}}class Q{constructor(){y(this,"movies");y(this,"movieListElement");y(this,"parser");y(this,"imdbService");y(this,"storage");y(this,"searchTerm");y(this,"filters");y(this,"isStorageInitialized",!1);this.movies=[],this.movieListElement=document.getElementById("movie-list"),this.parser=new W,this.storage=new J,this.imdbService=new Z(this.storage),this.searchTerm="",this.filters={selectedGenres:new Set,selectedRatings:new Set,yearFrom:null,yearTo:null,imdbMin:0,imdbMax:10,sortField:"imdbScore",sortDirection:"desc"},this.init()}async init(){try{await this.initializeStorage(),await this.loadMovies(),await this.loadAppState(),this.renderMovies()}catch(e){console.error("Error initializing movie picker:",e),this.showError("Failed to load movies. Please refresh the page.")}}async initializeStorage(){try{await this.storage.initialize()?(this.isStorageInitialized=!0,console.log("Storage initialized successfully")):(console.warn("Storage initialization failed, continuing without persistence"),this.isStorageInitialized=!1)}catch(e){console.error("Error initializing storage:",e),this.isStorageInitialized=!1}}async loadMovies(){try{if(this.isStorageInitialized){const e=await this.storage.loadMovies();e.success&&e.data?(this.movies=e.data,console.log(`Loaded ${this.movies.length} movies from storage`)):(console.warn("Failed to load movies from storage:",e.error),this.movies=[])}else this.movies=[]}catch(e){console.error("Error loading movies:",e),this.movies=[]}await new Promise(e=>setTimeout(e,1e3))}async loadAppState(){if(this.isStorageInitialized)try{const e=await this.storage.loadAppState();if(e.success&&e.data){if(e.data.searchTerm){this.searchTerm=e.data.searchTerm;const t=document.getElementById("search-input");t&&(t.value=this.searchTerm)}e.data.filters&&this.loadFiltersFromStorage(e.data.filters)}}catch(e){console.error("Error loading app state:",e)}}async saveAppState(){if(this.isStorageInitialized)try{const e={selectedGenres:Array.from(this.filters.selectedGenres),selectedRatings:Array.from(this.filters.selectedRatings),yearFrom:this.filters.yearFrom,yearTo:this.filters.yearTo,imdbMin:this.filters.imdbMin,imdbMax:this.filters.imdbMax,sortField:this.filters.sortField,sortDirection:this.filters.sortDirection},t=await this.storage.saveAppState(this.movies,e,this.searchTerm);t.success||console.warn("Failed to save app state:",t.error)}catch(e){console.error("Error saving app state:",e)}}loadFiltersFromStorage(e){this.filters={selectedGenres:new Set(e.selectedGenres),selectedRatings:new Set(e.selectedRatings),yearFrom:e.yearFrom,yearTo:e.yearTo,imdbMin:e.imdbMin,imdbMax:e.imdbMax,sortField:e.sortField||"imdbScore",sortDirection:e.sortDirection||"desc"},this.updateFilterUI()}filterMovies(){let e=this.movies;if(this.searchTerm.trim()){const t=this.searchTerm.toLowerCase();e=e.filter(s=>s.title.toLowerCase().includes(t)||s.genre&&s.genre.toLowerCase().includes(t)||s.year&&s.year.includes(t)||s.rating&&s.rating.toLowerCase().includes(t)||s.imdbScore&&s.imdbScore.toString().includes(t)||s.plot&&s.plot.toLowerCase().includes(t))}return this.filters.selectedGenres.size>0&&(e=e.filter(t=>t.genre?this.filters.selectedGenres.has(t.genre):!1)),this.filters.selectedRatings.size>0&&(e=e.filter(t=>t.rating?this.filters.selectedRatings.has(t.rating):!1)),(this.filters.yearFrom!==null||this.filters.yearTo!==null)&&(e=e.filter(t=>{if(!t.year)return!1;const s=parseInt(t.year);return!(isNaN(s)||this.filters.yearFrom!==null&&s<this.filters.yearFrom||this.filters.yearTo!==null&&s>this.filters.yearTo)})),e=e.filter(t=>t.imdbScore?t.imdbScore>=this.filters.imdbMin&&t.imdbScore<=this.filters.imdbMax:!0),e=this.sortMovies(e),e}sortMovies(e){return e.sort((t,s)=>{let r,i;switch(this.filters.sortField){case"year":r=t.year?parseInt(t.year):0,i=s.year?parseInt(s.year):0;break;case"imdbScore":r=t.imdbScore||0,i=s.imdbScore||0;break;default:r=t.imdbScore||0,i=s.imdbScore||0;break}if(typeof r=="number"&&typeof i=="number")return this.filters.sortDirection==="asc"?r-i:i-r;if(typeof r=="string"&&typeof i=="string")return this.filters.sortDirection==="asc"?r.localeCompare(i):i.localeCompare(r);{const o=String(r).toLowerCase(),a=String(i).toLowerCase();return this.filters.sortDirection==="asc"?o.localeCompare(a):a.localeCompare(o)}})}renderMovies(){if(!this.movieListElement)return;if(this.movies.length===0){this.movieListElement.innerHTML='<div class="loading">No movies found. Click "Paste Content" to add movies from YouTube pages.</div>',this.updateMovieCount(0);return}const e=this.filterMovies();if(e.length===0&&this.searchTerm.trim()){this.movieListElement.innerHTML=`<div class="loading">No movies found matching "${this.searchTerm}". Try a different search term.</div>`,this.updateMovieCount(0);return}const t=e.map(s=>`
      <div class="movie-item" onclick="window.open('${s.url}', '_blank')">
        <div class="movie-thumbnail">
          <img src="${s.thumbnail}" alt="${s.title}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjkwIiB2aWV3Qm94PSIwIDAgMTIwIDkwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIxMjAiIGhlaWdodD0iOTAiIGZpbGw9IiNmOGY5ZmEiLz48dGV4dCB4PSI2MCIgeT0iNDUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzZjNzU3ZCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+SW1hZ2U8L3RleHQ+PC9zdmc+'" />
        </div>
        <div class="movie-info">
          <div class="movie-title">${s.title}</div>
          <div class="movie-details">
            <div class="movie-duration">Duration: ${s.duration}</div>
            ${s.year?`<div class="movie-year">Year: ${s.year}</div>`:""}
            ${s.genre?`<div class="movie-genre">Genre: ${s.genre}</div>`:""}
            ${s.rating?`<div class="movie-rating">Rating: ${s.rating}</div>`:""}
            ${s.imdbScore?`<div class="movie-imdb-score">IMDB: ${s.imdbScore}/10 ⭐</div>`:""}
          </div>
        </div>
        ${s.plot?`<div class="movie-plot">${s.plot}</div>`:""}
      </div>
    `).join("");this.movieListElement.innerHTML=t,this.updateMovieCount(e.length)}updateMovieCount(e){const t=document.getElementById("movie-count");t&&(e===1?t.textContent="1 movie":t.textContent=`${e} movies`)}showError(e){this.movieListElement&&(this.movieListElement.innerHTML=`
      <div class="error">
        <strong>Error:</strong> ${e}
      </div>
    `,this.updateMovieCount(0))}async refreshMovies(){this.movieListElement&&(this.movieListElement.innerHTML='<div class="loading">Refreshing movies...</div>',await this.loadMovies(),this.renderMovies())}parseYouTubeContent(e){console.log("Parsing YouTube content...");try{const t=this.parser.extractMoviesFromHTML(e),s=new Set(this.movies.map(i=>i.videoId)),r=t.filter(i=>!s.has(i.videoId));return console.log(`Found ${r.length} new unique movies`),r}catch(t){throw console.error("Error parsing YouTube content:",t),new Error("Failed to parse the content. Please make sure you pasted valid YouTube page content.")}}async addMoviesToExistingList(e){if(e.length!==0){if(this.movies=[...this.movies,...e],this.isStorageInitialized)try{const t=await this.storage.saveMovies(e);t.success||console.warn("Failed to save new movies to storage:",t.error)}catch(t){console.error("Error saving new movies to storage:",t)}this.updateFilterUI(),this.renderMovies(),this.isStorageInitialized?this.fetchIMDBScoresForMovies(e):console.warn("Storage not initialized, skipping IMDB score fetching"),this.showSuccessMessage(`Successfully added ${e.length} new movies!`)}}async fetchIMDBScoresForMovies(e){try{this.showIMDBLoadingIndicator();const t=e.map(r=>({title:r.title,year:r.year})),s=await this.imdbService.getImdbInfoList(t);if(this.movies=this.movies.map(r=>{const i=s.get(r.title);if(i){let o={...r};return i.imdbRating&&i.imdbRating!=="N/A"&&(o.imdbScore=parseFloat(i.imdbRating)),i.Plot&&i.Plot!=="N/A"&&(o.plot=i.Plot),o}return r}),this.isStorageInitialized)try{const r=await this.storage.saveMovies(this.movies);r.success||console.warn("Failed to save updated movies to storage:",r.error)}catch(r){console.error("Error saving updated movies to storage:",r)}this.renderMovies(),this.hideIMDBLoadingIndicator()}catch(t){console.error("Error fetching IMDB scores:",t),this.hideIMDBLoadingIndicator()}}showIMDBLoadingIndicator(){if(!this.movieListElement)return;const e=document.createElement("div");e.id="imdb-loading",e.className="imdb-loading",e.style.cssText=`
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #007bff;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 123, 255, 0.3);
            z-index: 1000;
            font-size: 14px;
        `,e.textContent="Fetching IMDB scores...",document.body.appendChild(e)}hideIMDBLoadingIndicator(){const e=document.getElementById("imdb-loading");e&&e.remove()}async fetchIMDBScoresForAllMovies(){if(this.movies.length===0){alert("No movies available to fetch IMDB scores for.");return}const e=this.movies.filter(t=>!t.imdbScore);if(e.length===0){alert("All movies already have IMDB scores!");return}try{this.showIMDBLoadingIndicator();const t=e.map(i=>({title:i.title,year:i.year})),s=await this.imdbService.getImdbInfoList(t);if(this.movies=this.movies.map(i=>{const o=s.get(i.title);if(o){let a={...i};return o.imdbRating&&o.imdbRating!=="N/A"&&(a.imdbScore=parseFloat(o.imdbRating)),o.Plot&&o.Plot!=="N/A"&&(a.plot=o.Plot),a}return i}),this.isStorageInitialized)try{const i=await this.storage.saveMovies(this.movies);i.success||console.warn("Failed to save updated movies to storage:",i.error)}catch(i){console.error("Error saving updated movies to storage:",i)}this.renderMovies(),this.hideIMDBLoadingIndicator();const r=s.size;this.showSuccessMessage(`Successfully fetched ${r} IMDB scores!`)}catch(t){throw console.error("Error fetching IMDB scores for all movies:",t),this.hideIMDBLoadingIndicator(),t}}updateSearchTerm(e){this.searchTerm=e,this.isStorageInitialized&&this.storage.saveSearchTerm(e),this.renderMovies()}getUniqueGenres(){const e=new Set;return this.movies.forEach(t=>{t.genre&&e.add(t.genre)}),Array.from(e).sort()}getUniqueRatings(){const e=new Set;return this.movies.forEach(t=>{t.rating&&e.add(t.rating)}),Array.from(e).sort()}populateGenreCheckboxes(){const e=document.getElementById("genre-checkboxes");if(!e)return;const t=this.getUniqueGenres();e.innerHTML="",t.forEach(s=>{const r=document.createElement("div");r.className="checkbox-item";const i=document.createElement("input");i.type="checkbox",i.id=`genre-${s}`,i.value=s,i.checked=this.filters.selectedGenres.has(s);const o=document.createElement("label");o.htmlFor=`genre-${s}`,o.textContent=s,r.appendChild(i),r.appendChild(o),e.appendChild(r)})}populateRatingCheckboxes(){const e=document.getElementById("rating-checkboxes");if(!e)return;const t=this.getUniqueRatings();e.innerHTML="",t.forEach(s=>{const r=document.createElement("div");r.className="checkbox-item";const i=document.createElement("input");i.type="checkbox",i.id=`rating-${s}`,i.value=s,i.checked=this.filters.selectedRatings.has(s);const o=document.createElement("label");o.htmlFor=`rating-${s}`,o.textContent=s,r.appendChild(i),r.appendChild(o),e.appendChild(r)})}updateFilterLabels(){const e=document.getElementById("genre-selected-count");e&&(this.filters.selectedGenres.size===0?e.textContent="All Genres":this.filters.selectedGenres.size===1?e.textContent=Array.from(this.filters.selectedGenres)[0]:e.textContent=`${this.filters.selectedGenres.size} Genres Selected`);const t=document.getElementById("rating-selected-count");t&&(this.filters.selectedRatings.size===0?t.textContent="All Ratings":this.filters.selectedRatings.size===1?t.textContent=Array.from(this.filters.selectedRatings)[0]:t.textContent=`${this.filters.selectedRatings.size} Ratings Selected`)}updateSelectedFiltersDisplay(){const e=document.getElementById("selected-filters-list");if(!e)return;const t=[];if(this.filters.selectedGenres.size>0&&(this.filters.selectedGenres.size===1?t.push(`<span class="selected-filter-tag"><span class="filter-type">Genre:</span> <span class="filter-value">${Array.from(this.filters.selectedGenres)[0]}</span></span>`):t.push(`<span class="selected-filter-tag"><span class="filter-type">Genres:</span> <span class="filter-value">${this.filters.selectedGenres.size} selected</span></span>`)),this.filters.selectedRatings.size>0&&(this.filters.selectedRatings.size===1?t.push(`<span class="selected-filter-tag"><span class="filter-type">Rating:</span> <span class="filter-value">${Array.from(this.filters.selectedRatings)[0]}</span></span>`):t.push(`<span class="selected-filter-tag"><span class="filter-type">Ratings:</span> <span class="filter-value">${this.filters.selectedRatings.size} selected</span></span>`)),this.filters.yearFrom!==null||this.filters.yearTo!==null){let s="";this.filters.yearFrom!==null&&this.filters.yearTo!==null?s=`${this.filters.yearFrom}-${this.filters.yearTo}`:this.filters.yearFrom!==null?s=`from ${this.filters.yearFrom}`:this.filters.yearTo!==null&&(s=`until ${this.filters.yearTo}`),t.push(`<span class="selected-filter-tag"><span class="filter-type">Year:</span> <span class="filter-value">${s}</span></span>`)}if(this.filters.imdbMin!==0||this.filters.imdbMax!==10){const s=`${this.filters.imdbMin.toFixed(1)}-${this.filters.imdbMax.toFixed(1)}`;t.push(`<span class="selected-filter-tag"><span class="filter-type">IMDB:</span> <span class="filter-value">${s}</span></span>`)}if(this.filters.sortField!=="imdbScore"||this.filters.sortDirection!=="desc"){const s={year:"Year",rating:"Rating",imdbScore:"IMDB Score"},r={asc:"↑",desc:"↓"},i=`${s[this.filters.sortField]||this.filters.sortField} ${r[this.filters.sortDirection]}`;t.push(`<span class="selected-filter-tag"><span class="filter-type">Sort:</span> <span class="filter-value">${i}</span></span>`)}t.length===0?e.innerHTML='<span class="no-filters-message">No filters applied</span>':e.innerHTML=t.join("")}clearAllFilters(){this.filters={selectedGenres:new Set,selectedRatings:new Set,yearFrom:null,yearTo:null,imdbMin:0,imdbMax:10,sortField:"imdbScore",sortDirection:"desc"},this.updateFilterUI(),this.renderMovies()}updateFilterUI(){var a,n;this.populateGenreCheckboxes(),this.populateRatingCheckboxes();const e=document.getElementById("year-from"),t=document.getElementById("year-to");e&&(e.value=((a=this.filters.yearFrom)==null?void 0:a.toString())||""),t&&(t.value=((n=this.filters.yearTo)==null?void 0:n.toString())||"");const s=document.getElementById("imdb-min"),r=document.getElementById("imdb-max"),i=document.getElementById("imdb-min-label"),o=document.getElementById("imdb-max-label");s&&(s.value=this.filters.imdbMin.toString()),r&&(r.value=this.filters.imdbMax.toString()),i&&(i.textContent=this.filters.imdbMin.toFixed(1)),o&&(o.textContent=this.filters.imdbMax.toFixed(1)),this.updateFilterLabels(),this.updateSortingControls(),this.updateSelectedFiltersDisplay()}updateSortingControls(){document.querySelectorAll(".sort-button[data-field]").forEach(e=>{const t=e.getAttribute("data-field"),s=t===this.filters.sortField;if(e.classList.toggle("active",s),s){const r=this.filters.sortDirection==="asc"?"↑":"↓",i={year:"Year",imdbScore:"IMDB Score"};e.textContent=`${i[t]} ${r}`}else{const r={year:"Year",imdbScore:"IMDB Score"};e.textContent=r[t]}})}applyFilters(){const e=document.querySelectorAll('#genre-checkboxes input[type="checkbox"]:checked');this.filters.selectedGenres.clear(),e.forEach(a=>{this.filters.selectedGenres.add(a.value)});const t=document.querySelectorAll('#rating-checkboxes input[type="checkbox"]:checked');this.filters.selectedRatings.clear(),t.forEach(a=>{this.filters.selectedRatings.add(a.value)});const s=document.getElementById("year-from"),r=document.getElementById("year-to");this.filters.yearFrom=s!=null&&s.value?parseInt(s.value):null,this.filters.yearTo=r!=null&&r.value?parseInt(r.value):null;const i=document.getElementById("imdb-min"),o=document.getElementById("imdb-max");if(i&&(this.filters.imdbMin=parseFloat(i.value)),o&&(this.filters.imdbMax=parseFloat(o.value)),this.isStorageInitialized){const a={selectedGenres:Array.from(this.filters.selectedGenres),selectedRatings:Array.from(this.filters.selectedRatings),yearFrom:this.filters.yearFrom,yearTo:this.filters.yearTo,imdbMin:this.filters.imdbMin,imdbMax:this.filters.imdbMax,sortField:this.filters.sortField,sortDirection:this.filters.sortDirection};this.storage.saveFilters(a)}this.updateFilterLabels(),this.updateSelectedFiltersDisplay(),this.renderMovies()}showSuccessMessage(e){const t=document.createElement("div");t.className="success-message",t.style.cssText=`
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
            z-index: 1001;
            animation: slideInRight 0.3s ease-out;
        `,t.textContent=e,document.body.appendChild(t),setTimeout(()=>{t.style.animation="slideOutRight 0.3s ease-in",setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},300)},3e3)}async exportData(){if(!this.isStorageInitialized){alert("Storage not available for export.");return}try{const e=await this.storage.exportData();if(e.success&&e.data){const t=new Blob([e.data],{type:"application/json"}),s=URL.createObjectURL(t),r=document.createElement("a");r.href=s,r.download=`movie-picker-export-${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(s),this.showSuccessMessage("Data exported successfully!")}else alert(`Export failed: ${e.error}`)}catch(e){console.error("Error exporting data:",e),alert("Export failed. Please try again.")}}async importData(e){if(!this.isStorageInitialized){alert("Storage not available for import.");return}try{const t=await e.text(),s=await this.storage.importData(t);s.success?(await this.loadMovies(),await this.loadAppState(),this.renderMovies(),this.showSuccessMessage("Data imported successfully!")):alert(`Import failed: ${s.error}`)}catch(t){console.error("Error importing data:",t),alert("Import failed. Please check the file format and try again.")}}async clearAllData(){if(!this.isStorageInitialized){alert("Storage not available.");return}if(confirm("Are you sure you want to clear all data? This action cannot be undone."))try{const e=await this.storage.clearAllMovies();e.success?(this.movies=[],this.searchTerm="",this.clearAllFilters(),this.renderMovies(),this.showSuccessMessage("All data cleared successfully!")):alert(`Failed to clear data: ${e.error}`)}catch(e){console.error("Error clearing data:",e),alert("Failed to clear data. Please try again.")}}async getStorageStats(){if(!this.isStorageInitialized)return null;try{const e=await this.storage.getStorageStats();if(e.success&&e.data)return e.data}catch(e){console.error("Error getting storage stats:",e)}return null}getMoviesMissingIMDBData(){return this.movies.filter(e=>!e.imdbScore||!e.plot)}}document.addEventListener("DOMContentLoaded",()=>{const d=new Q,e=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"||window.location.hostname==="0.0.0.0"||window.location.port==="5173"||window.location.port==="3000";console.log("Running in local development:",e);const t=document.getElementById("sample-button");t&&(t.style.display="inline-block",t.addEventListener("click",async()=>{try{t.textContent="Loading...",t.disabled=!0;const c=await fetch("/sample1.txt");if(!c.ok)throw new Error(`Failed to load sample file: ${c.status}`);const l=await c.text(),E=d.parseYouTubeContent(l);E.length===0?alert("No movies found in the sample content."):await d.addMoviesToExistingList(E)}catch(c){console.error("Error loading sample:",c),alert(`Error loading sample: ${c.message}`)}finally{t.textContent="🧪 Parse Sample",t.disabled=!1}}));const s=document.getElementById("clear-cache-button");s&&s.addEventListener("click",async()=>{try{if(!confirm("Are you sure you want to clear all cache data? This will remove all stored movies, IMDB responses, and app settings. This action cannot be undone."))return;s.textContent="Clearing...",s.disabled=!0,await d.clearAllData(),d.showSuccessMessage("Cache data cleared successfully!")}catch(c){console.error("Error clearing cache data:",c),alert(`Error clearing cache data: ${c.message}`)}finally{s.textContent="🗑️ Clear Cache",s.disabled=!1}});const r=document.getElementById("search-input");r&&r.addEventListener("input",c=>{const l=c.target;d.updateSearchTerm(l.value)});const i=document.getElementById("toggle-filters"),o=document.getElementById("filters-content"),a=document.getElementById("clear-all-filters"),n=document.getElementById("apply-filters");i&&o&&i.addEventListener("click",()=>{const c=o.style.display!=="none";o.style.display=c?"none":"block",i.textContent=c?"Show Filters":"Hide Filters";const l=document.getElementById("selected-filters-display");l&&(l.style.display=c?"block":"none",c&&d.updateSelectedFiltersDisplay())}),a&&a.addEventListener("click",()=>{d.clearAllFilters()}),n&&n.addEventListener("click",()=>{d.applyFilters()}),document.querySelectorAll(".sort-button").forEach(c=>{c.addEventListener("click",()=>{const l=c.getAttribute("data-field");l&&(d.filters.sortField===l?d.filters.sortDirection=d.filters.sortDirection==="asc"?"desc":"asc":(d.filters.sortField=l,d.filters.sortDirection="asc"),d.updateSortingControls(),d.applyFilters())})});const m=document.getElementById("genre-dropdown-btn"),h=document.getElementById("genre-dropdown-content"),f=document.getElementById("select-all-genres"),v=document.getElementById("clear-all-genres");m&&h&&(m.addEventListener("click",()=>{h.classList.toggle("show"),m.classList.toggle("active")}),document.addEventListener("click",c=>{const l=c.target;!(m!=null&&m.contains(l))&&!(h!=null&&h.contains(l))&&(h==null||h.classList.remove("show"),m==null||m.classList.remove("active"))})),f&&f.addEventListener("click",()=>{document.querySelectorAll('#genre-checkboxes input[type="checkbox"]').forEach(l=>l.checked=!0)}),v&&v.addEventListener("click",()=>{document.querySelectorAll('#genre-checkboxes input[type="checkbox"]').forEach(l=>l.checked=!1)});const p=document.getElementById("rating-dropdown-btn"),M=document.getElementById("rating-dropdown-content"),N=document.getElementById("select-all-ratings"),z=document.getElementById("clear-all-ratings");p&&M&&(p.addEventListener("click",()=>{M.classList.toggle("show"),p.classList.toggle("active")}),document.addEventListener("click",c=>{const l=c.target;!(p!=null&&p.contains(l))&&!(M!=null&&M.contains(l))&&(M==null||M.classList.remove("show"),p==null||p.classList.remove("active"))})),N&&N.addEventListener("click",()=>{document.querySelectorAll('#rating-checkboxes input[type="checkbox"]').forEach(l=>l.checked=!0)}),z&&z.addEventListener("click",()=>{document.querySelectorAll('#rating-checkboxes input[type="checkbox"]').forEach(l=>l.checked=!1)});const B=document.getElementById("imdb-min"),T=document.getElementById("imdb-max"),L=document.getElementById("imdb-min-label"),P=document.getElementById("imdb-max-label");B&&L&&B.addEventListener("input",()=>{const c=parseFloat(B.value);L.textContent=c.toFixed(1),T&&c>parseFloat(T.value)&&(T.value=c.toString(),P&&(P.textContent=c.toFixed(1)))}),T&&P&&T.addEventListener("input",()=>{const c=parseFloat(T.value);P.textContent=c.toFixed(1),B&&c<parseFloat(B.value)&&(B.value=c.toString(),L&&(L.textContent=c.toFixed(1)))});const R=document.getElementById("paste-modal"),G=document.getElementById("paste-content-button"),O=document.querySelector(".close"),j=document.getElementById("cancel-button"),k=document.getElementById("parse-button"),F=document.getElementById("content-textarea");G&&R&&F&&G.addEventListener("click",()=>{R.style.display="block",F.focus()});function $(){R&&F&&(R.style.display="none",F.value="")}O&&O.addEventListener("click",$),j&&j.addEventListener("click",$),window.addEventListener("click",c=>{c.target===R&&$()}),k&&F&&k.addEventListener("click",async()=>{const c=F.value.trim();if(!c){alert("Please paste some content before parsing.");return}try{k.textContent="Parsing...",k.disabled=!0;const l=d.parseYouTubeContent(c);l.length===0?alert("No new unique movies found in the content. They might already be in your list."):(await d.addMoviesToExistingList(l),$())}catch(l){alert(`Error: ${l.message}`)}finally{k.textContent="Parse & Add Movies",k.disabled=!1}});const S=document.getElementById("api-key-modal"),x=document.getElementById("api-key-button"),q=S==null?void 0:S.querySelector(".close"),_=document.getElementById("api-key-cancel-button"),Y=document.getElementById("api-key-clear-button"),K=document.getElementById("api-key-save-button"),D=document.getElementById("api-key-test-button"),b=document.getElementById("api-key-input"),g=document.getElementById("api-key-status");function C(){x&&(d.imdbService.hasApiKey()?(x.textContent="🔑 API Key ✓",x.style.backgroundColor="#28a745"):(x.textContent="🔑 API Key",x.style.backgroundColor="#e74c3c"))}C(),x&&S&&b&&x.addEventListener("click",()=>{const c=d.imdbService.getApiKey();c?b.value=c:b.value="",S.style.display="block",b.focus()});function w(){S&&b&&g&&(S.style.display="none",b.value="",g.style.display="none")}q&&q.addEventListener("click",w),_&&_.addEventListener("click",w),window.addEventListener("click",c=>{c.target===S&&w()}),D&&b&&g&&D.addEventListener("click",async()=>{const c=b.value.trim();if(!c){I("Please enter an API key to test.","error");return}try{D.textContent="Testing...",D.disabled=!0;const E=await(await fetch(`https://www.omdbapi.com/?apikey=${c}&t=The+Matrix&type=movie`)).json();E.Response==="True"?I("✅ API key is valid and working!","success"):E.Error==="Invalid API key!"?I("❌ Invalid API key. Please check your key and try again.","error"):I("⚠️ API key test failed. Please check your key.","warning")}catch(l){console.error("Error testing API key:",l),I("❌ Error testing API key. Please check your internet connection.","error")}finally{D.textContent="Test Key",D.disabled=!1}}),Y&&b&&g&&Y.addEventListener("click",()=>{confirm("Are you sure you want to clear the API key? This will remove the stored key and disable IMDB score fetching.")&&(d.imdbService.clearApiKey(),b.value="",I("✅ API key cleared successfully!","success"),C(),setTimeout(()=>{w()},1500))}),K&&b&&g&&K.addEventListener("click",async()=>{const c=b.value.trim();if(!c){I("Please enter an API key to save.","error");return}d.imdbService.setApiKey(c),I("✅ API key saved successfully!","success"),C();const l=d.getMoviesMissingIMDBData();if(l.length>0){const E=l.filter(A=>!A.imdbScore).length,U=l.filter(A=>!A.plot).length;if(confirm(`Found ${l.length} movies missing IMDB data:
• ${E} movies missing IMDB scores
• ${U} movies missing plot information

Would you like to fetch this data now? This may take a few minutes.`)){w(),d.showSuccessMessage(`Fetching IMDB data for ${l.length} movies...`);try{await d.fetchIMDBScoresForMovies(l),d.showSuccessMessage(`Successfully fetched IMDB data for ${l.length} movies!`)}catch(A){console.error("Error fetching IMDB data:",A),d.showSuccessMessage("Some movies may not have been updated. Check the console for details.")}}else setTimeout(()=>{w()},1500)}else I("✅ All movies already have IMDB data!","success"),setTimeout(()=>{w()},1500)});function I(c,l){if(g)switch(g.textContent=c,g.style.display="block",l){case"success":g.style.backgroundColor="#d4edda",g.style.color="#155724",g.style.border="1px solid #c3e6cb";break;case"error":g.style.backgroundColor="#f8d7da",g.style.color="#721c24",g.style.border="1px solid #f5c6cb";break;case"warning":g.style.backgroundColor="#fff3cd",g.style.color="#856404",g.style.border="1px solid #ffeaa7";break}}});document.addEventListener("DOMContentLoaded",()=>{document.addEventListener("click",d=>{const t=d.target.closest(".movie-item");t&&(t.style.transform="scale(0.98)",setTimeout(()=>{t.style.transform=""},150))})});
