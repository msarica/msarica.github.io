(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))i(t);new MutationObserver(t=>{for(const o of t)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function s(t){const o={};return t.integrity&&(o.integrity=t.integrity),t.referrerPolicy&&(o.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?o.credentials="include":t.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(t){if(t.ep)return;t.ep=!0;const o=s(t);fetch(t.href,o)}})();const n={id:"default",title:"The Great Book",language:"English",pages:[{image:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNk+A8AAQUBAScY42YAAAAASUVORK5CYII=",content:"No content",voice:""}]};class l{constructor(e){if(this.currentPage=0,this.book=n,this.currentAudio=null,console.log("version 1.0.0"),console.log("Initializing BookReader..."),this.book=e,this.pageImage=document.getElementById("page-image"),this.pageContent=document.getElementById("page-content"),this.nextButton=document.getElementById("next-page"),this.prevButton=document.getElementById("prev-page"),this.readButton=document.getElementById("read-page"),this.pageNumber=document.getElementById("page-number"),this.bookTitle=document.getElementById("book-title"),this.savedStoriesToggle=document.getElementById("saved-stories-toggle"),this.savedStoriesModal=document.getElementById("saved-stories-panel"),this.initializeSavedStoriesModal(),console.log("Elements found:",{pageImage:!!this.pageImage,pageContent:!!this.pageContent,nextButton:!!this.nextButton,prevButton:!!this.prevButton,readButton:!!this.readButton,pageNumber:!!this.pageNumber,bookTitle:!!this.bookTitle,savedStoriesToggle:!!this.savedStoriesToggle,savedStoriesModal:!!this.savedStoriesModal}),!this.pageImage||!this.pageContent||!this.nextButton||!this.prevButton||!this.readButton||!this.pageNumber||!this.bookTitle||!this.savedStoriesToggle||!this.savedStoriesModal){console.error("Required elements not found");return}this.bookTitle.textContent=this.book.title,this.nextButton.addEventListener("click",s=>{console.log("Next button clicked"),this.stopAudioPlayback(),this.nextPage()}),this.prevButton.addEventListener("click",s=>{console.log("Previous button clicked"),this.stopAudioPlayback(),this.previousPage()}),this.readButton.addEventListener("click",s=>{console.log("Read button clicked"),this.toggleAudioPlayback()}),this.displayCurrentPage()}get pages(){return this.book.pages}async loadSavedStories(){try{const e=await fetch("/ai_book/assets/story_list.json");if(!e.ok)throw new Error("Failed to load saved stories");const s=await e.json(),i=this.savedStoriesModal.querySelector("#stories-list");if(!i){console.error("Stories list element not found");return}i.innerHTML="",s.stories.forEach(t=>{const o=document.createElement("li");o.textContent=t.title,o.dataset.storyId=t.id,o.dataset.storyFile=t.file,i.appendChild(o)})}catch(e){console.error("Error loading saved stories:",e)}}initializeSavedStoriesModal(){this.savedStoriesToggle.addEventListener("click",()=>{this.savedStoriesModal.classList.toggle("active"),this.loadSavedStories()});const e=this.savedStoriesModal.querySelector(".close-panel-button");e&&e.addEventListener("click",()=>{this.savedStoriesModal.classList.remove("active")}),window.addEventListener("click",i=>{!this.savedStoriesModal.contains(i.target)&&!this.savedStoriesToggle.contains(i.target)&&this.savedStoriesModal.classList.contains("active")&&this.savedStoriesModal.classList.remove("active")});const s=this.savedStoriesModal.querySelector("#stories-list");s&&s.addEventListener("click",async i=>{const t=i.target;if(t.tagName==="LI"){const o=t.dataset.storyId;if(!o)return;try{const a=await fetch(`/ai_book/assets/${o}/${o}.json`);if(!a.ok)throw new Error("Failed to load selected story");const d=await a.json();this.book=d,this.currentPage=0,this.displayCurrentPage(),this.savedStoriesModal.classList.remove("active")}catch(a){console.error("Error loading selected story:",a),alert("Failed to load the selected story. Please try again.")}}})}playPageAudio(){const e=this.book.pages[this.currentPage];let s="";e.voice&&(e.voice.startsWith("data:")||e.voice.startsWith("http"))?s=e.voice:e.voice?s=`/ai_book/assets/${this.book.id}/${e.voice}`:s=`/ai_book/assets/${this.book.id}/${this.currentPage+1}.mp3`,console.log("Playing audio from:",s),this.currentAudio&&(this.currentAudio.pause(),this.currentAudio.currentTime=0),this.currentAudio=new Audio(s),this.readButton.textContent="Pause",this.readButton.classList.add("playing"),this.currentAudio.addEventListener("ended",()=>{this.readButton.textContent="Read",this.readButton.classList.remove("playing"),this.currentAudio=null}),this.currentAudio.addEventListener("pause",()=>{this.readButton.textContent="Resume",this.readButton.classList.remove("playing")}),this.currentAudio.addEventListener("play",()=>{this.readButton.textContent="Pause",this.readButton.classList.add("playing")}),this.currentAudio.play().catch(i=>{console.error("Error playing audio:",i),this.readButton.textContent="Read",this.readButton.classList.remove("playing"),this.currentAudio=null})}toggleAudioPlayback(){if(!this.currentAudio){this.playPageAudio();return}this.currentAudio.paused?this.currentAudio.play():this.currentAudio.pause()}stopAudioPlayback(){this.currentAudio&&(this.currentAudio.pause(),this.currentAudio.currentTime=0,this.currentAudio=null,this.readButton.textContent="Read",this.readButton.classList.remove("playing"))}displayCurrentPage(){console.log("Displaying page:",this.currentPage);const e=this.book.pages[this.currentPage];e.image&&(e.image.startsWith("data:")||e.image.startsWith("http"))?this.pageImage.src=e.image:e.image?this.pageImage.src=`/ai_book/assets/${this.book.id}/${e.image}`:this.pageImage.src=`/ai_book/assets/${this.book.id}/${this.currentPage+1}.png`,this.pageContent.textContent=e.content,this.bookTitle.textContent=this.book.title,this.pageNumber.textContent=`${this.currentPage+1}`;const s=this.currentPage>=this.pages.length-1,i=this.currentPage<=0;this.nextButton.disabled=s,this.prevButton.disabled=i}nextPage(){console.log("Attempting to go to next page"),this.currentPage<this.pages.length-1?(this.currentPage++,console.log("Moving to next page:",this.currentPage),this.displayCurrentPage()):console.log("Already on last page")}previousPage(){console.log("Attempting to go to previous page"),this.currentPage>0?(this.currentPage--,console.log("Moving to previous page:",this.currentPage),this.displayCurrentPage()):console.log("Already on first page")}}document.addEventListener("DOMContentLoaded",async()=>{console.log("DOM loaded, creating BookReader instance"),new URLSearchParams(window.location.search).get("book");let e=n;new l(e)});
