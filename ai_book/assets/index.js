(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const t of o)if(t.type==="childList")for(const r of t.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function i(o){const t={};return o.integrity&&(t.integrity=o.integrity),o.referrerPolicy&&(t.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?t.credentials="include":o.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function s(o){if(o.ep)return;o.ep=!0;const t=i(o);fetch(o.href,t)}})();const l={id:"default",title:"The Great Book",language:"English",pages:[{image:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNk+A8AAQUBAScY42YAAAAASUVORK5CYII=",content:"No content",voice:""}]};class n{constructor(e){if(this.currentPage=0,this.book=l,this.currentAudio=null,console.log("version 1.0.0"),console.log("Initializing BookReader..."),this.book=e,this.pageImage=document.getElementById("page-image"),this.pageContent=document.getElementById("page-content"),this.nextButton=document.getElementById("next-page"),this.prevButton=document.getElementById("prev-page"),this.readButton=document.getElementById("read-page"),this.pageNumber=document.getElementById("page-number"),this.bookTitle=document.getElementById("book-title"),this.savedStoriesToggle=document.getElementById("saved-stories-toggle"),this.savedStoriesModal=document.getElementById("saved-stories-panel"),this.initializeSavedStoriesModal(),!this.pageImage||!this.pageContent||!this.nextButton||!this.prevButton||!this.readButton||!this.pageNumber||!this.bookTitle||!this.savedStoriesToggle||!this.savedStoriesModal){console.error("Required elements not found");return}this.bookTitle.textContent=this.book.title,this.nextButton.addEventListener("click",i=>{console.log("Next button clicked"),this.stopAudioPlayback(),this.nextPage()}),this.prevButton.addEventListener("click",i=>{console.log("Previous button clicked"),this.stopAudioPlayback(),this.previousPage()}),this.readButton.addEventListener("click",i=>{console.log("Read button clicked"),this.toggleAudioPlayback()}),this.displayCurrentPage()}get pages(){return this.book.pages}async loadSavedStories(){try{const e=await fetch("/ai_book/assets/story_list.json");if(!e.ok)throw new Error("Failed to load saved stories");const i=await e.json(),s=this.savedStoriesModal.querySelector("#stories-list");if(!s){console.error("Stories list element not found");return}s.innerHTML="",i.stories.forEach(o=>{const t=document.createElement("li");t.textContent=o.title,t.dataset.storyId=o.id,t.dataset.storyFile=o.file,s.appendChild(t)})}catch(e){console.error("Error loading saved stories:",e)}}initializeSavedStoriesModal(){this.savedStoriesToggle.addEventListener("click",()=>{this.savedStoriesModal.classList.toggle("active"),this.loadSavedStories()});const e=this.savedStoriesModal.querySelector(".close-panel-button");e&&e.addEventListener("click",()=>{this.savedStoriesModal.classList.remove("active")}),window.addEventListener("click",s=>{!this.savedStoriesModal.contains(s.target)&&!this.savedStoriesToggle.contains(s.target)&&this.savedStoriesModal.classList.contains("active")&&this.savedStoriesModal.classList.remove("active")});const i=this.savedStoriesModal.querySelector("#stories-list");i&&i.addEventListener("click",async s=>{const o=s.target;if(o.tagName==="LI"){const t=o.dataset.storyId;if(!t)return;try{const r=await fetch(`/ai_book/assets/${t}/${t}.json`);if(!r.ok)throw new Error("Failed to load selected story");const c=await r.json();this.book=c,this.currentPage=0,this.displayCurrentPage(),this.savedStoriesModal.classList.remove("active");const d=new URL(window.location.href);d.searchParams.set("story",t),d.searchParams.set("page","1"),window.history.pushState({},"",d)}catch(r){console.error("Error loading selected story:",r),alert("Failed to load the selected story. Please try again.")}}})}playPageAudio(){const e=this.book.pages[this.currentPage];let i="";e.voice&&(e.voice.startsWith("data:")||e.voice.startsWith("http"))?i=e.voice:e.voice?i=`/ai_book/assets/${this.book.id}/${e.voice}`:i=`/ai_book/assets/${this.book.id}/${this.currentPage+1}.mp3`,console.log("Playing audio from:",i),this.currentAudio&&(this.currentAudio.pause(),this.currentAudio.currentTime=0),this.currentAudio=new Audio(i),this.readButton.textContent="Pause",this.readButton.classList.add("playing"),this.currentAudio.addEventListener("ended",()=>{this.readButton.textContent="Read",this.readButton.classList.remove("playing"),this.currentAudio=null}),this.currentAudio.addEventListener("pause",()=>{this.readButton.textContent="Resume",this.readButton.classList.remove("playing")}),this.currentAudio.addEventListener("play",()=>{this.readButton.textContent="Pause",this.readButton.classList.add("playing")}),this.currentAudio.play().catch(s=>{console.error("Error playing audio:",s),this.readButton.textContent="Read",this.readButton.classList.remove("playing"),this.currentAudio=null})}toggleAudioPlayback(){if(!this.currentAudio){this.playPageAudio();return}this.currentAudio.paused?this.currentAudio.play():this.currentAudio.pause()}stopAudioPlayback(){this.currentAudio&&(this.currentAudio.pause(),this.currentAudio.currentTime=0,this.currentAudio=null,this.readButton.textContent="Read",this.readButton.classList.remove("playing"))}displayCurrentPage(){console.log("Displaying page:",this.currentPage);const e=this.book.pages[this.currentPage];e.image&&(e.image.startsWith("data:")||e.image.startsWith("http"))?this.pageImage.src=e.image:e.image?this.pageImage.src=`/ai_book/assets/${this.book.id}/${e.image}`:this.pageImage.src=`/ai_book/assets/${this.book.id}/${this.currentPage+1}.png`,this.pageContent.textContent=e.content,this.bookTitle.textContent=this.book.title,this.pageNumber.textContent=`${this.currentPage+1}`;const i=this.currentPage>=this.pages.length-1,s=this.currentPage<=0;this.nextButton.disabled=i,this.prevButton.disabled=s}nextPage(){console.log("Attempting to go to next page"),this.currentPage<this.pages.length-1?(this.currentPage++,console.log("Moving to next page:",this.currentPage),this.displayCurrentPage(),this.updateUrl()):console.log("Already on last page")}previousPage(){console.log("Attempting to go to previous page"),this.currentPage>0?(this.currentPage--,console.log("Moving to previous page:",this.currentPage),this.displayCurrentPage(),this.updateUrl()):console.log("Already on first page")}updateUrl(){const e=new URL(window.location.href);e.searchParams.set("page",(this.currentPage+1).toString()),window.history.pushState({},"",e)}}document.addEventListener("DOMContentLoaded",async()=>{console.log("DOM loaded, creating BookReader instance");const a=new URLSearchParams(window.location.search);a.get("book");const e=a.get("story"),i=a.get("page");let s=l,o=0;if(i){const t=parseInt(i);!isNaN(t)&&t>0&&(o=t-1)}if(!e){new n(s);return}try{fetch(`/ai_book/assets/${e}/${e}.json`).then(t=>{if(!t.ok)throw new Error("Failed to load story from URL");return t.json()}).then(t=>{s=t;const r=new n(s);o>0&&(r.currentPage=o,r.displayCurrentPage())}).catch(t=>{console.error("Error loading story from URL:",t),new n(s)})}catch(t){console.error("Error parsing story parameter:",t),new n(s)}});
