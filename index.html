<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
  </head>
  <body>
    <button id="counter" type="button" onclick="connect()">Connect</button> <br>
    <button id="counter" type="button" onclick="listModels()">Find Model</button> <br>

    <button id="counter" type="button" onclick="loadModel()">LoadModel</button> <br>
    <button id="counter" type="button" onclick="summarize()">Summarize</button> <br>


    <textarea name="content" id="content"></textarea> <br>
    <textarea name="summary" id="summary"></textarea> <br>



    <pre id="logs"></pre>
    <script>
        const fileId = "9b8c2778cb5a3303c7a8e16f6e1c8647c403ca131f87a739e85b7b500f79b6c5"; // tinyllama 4
        const port = 3000;
        const endpoint = `http://localhost:${port}/agent`;

        function addLog(text) {
            text = typeof text == 'string' ? text: JSON.stringify(text);
            document.getElementById('logs').append(text + '\n')

        }

        function connect() {
            fetch(endpoint, {
            method: 'POST',
            body: JSON.stringify({
                action: 'CONNECT',
                appId: 'test',
                accessList: ['MODEL_DOWNLOAD', 'MODEL_LOAD', 'INFERENCE'],
            }),
            headers: {
                'Content-Type': 'application/json',
                Accept: '*/*',
            },
            })
            .then((response) => response.json())
            .then((response) => {
                console.log(response);
                addLog(response);
            })
            .catch((error) => console.error('Error:', error));
        }

        async function listModels() {
            const models = await fetch(endpoint, {
            method: 'POST',
            body: JSON.stringify({
                action: 'LIST_LOCAL_MODELS',
                appId: 'test',
            }),
            headers: {
                'Content-Type': 'application/json',
                Accept: '*/*',
            },
            })
            .then((response) => response.json());
           
            const exists = models.find(i=>i.fileId=== fileId);
            if(exists) {
                console.log('exists');
            } else {
                console.log('does NOT exist... download');
            }
        }

        async function loadModel() {
            const result = fetch(endpoint, {
            method: 'POST',
            body: JSON.stringify({
                action: 'LOAD_MODEL',
                appId: 'test',
                fileId
            }),
            headers: {
                'Content-Type': 'application/json',
                Accept: '*/*',
            },
            })
            .then((response) => response.json())
            .then((response) => {
                console.log(response);
                addLog(response);
            })
            .catch((error) => console.error('Error:', error));
        }

        async function inference(prompt) {
            return fetch(endpoint, {
            method: 'POST',
            body: JSON.stringify({
                action: 'INFERENCE',
                appId: 'test',
                prompt
            }),
            headers: {
                'Content-Type': 'application/json',
                Accept: '*/*',
            },
            })
            .then((response) => response.json())
            .then((response) => {
                console.log(response);
                addLog(response);
                return response;
            })
            .catch((error) => console.error('Error:', error));
        }

        async function summarize() {
            const content = document.getElementById('content').value;
            // console.log(content)

            const response = (await inference(`
            ${content}

            summarize the text above
            `)).content;

            document.getElementById('summary').value = response;

            const utterThis = new SpeechSynthesisUtterance(response);
            window.speechSynthesis.speak(utterThis);
        }
    </script>
  </body>
</html>
