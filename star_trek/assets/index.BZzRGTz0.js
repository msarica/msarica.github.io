!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const s of e)if("childList"===s.type)for(const e of s.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();class e{constructor(e){this.currentChallenge=null,this.panelOpen=!1,this.assetManager=e,this.initializeEventListeners()}initializeEventListeners(){const e=document.getElementById("cancelMathBtn"),t=document.getElementById("optionA"),s=document.getElementById("optionB"),i=document.getElementById("optionC"),a=document.getElementById("optionD");null==e||e.addEventListener("click",()=>{this.assetManager.playUIClickSound(),this.closePanel()}),null==t||t.addEventListener("click",()=>{this.assetManager.playUIClickSound(),this.selectOption("A")}),null==s||s.addEventListener("click",()=>{this.assetManager.playUIClickSound(),this.selectOption("B")}),null==i||i.addEventListener("click",()=>{this.assetManager.playUIClickSound(),this.selectOption("C")}),null==a||a.addEventListener("click",()=>{this.assetManager.playUIClickSound(),this.selectOption("D")}),document.addEventListener("keydown",e=>{"Escape"===e.key&&this.panelOpen&&this.closePanel()})}showChallenge(e,t,s,i){if(this.panelOpen)return!1;this.panelOpen=!0;const a=Math.floor(9*Math.random())+2,n=Math.floor(9*Math.random())+2,o=a*n,l=this.generateOptions(o);return this.currentChallenge={num1:a,num2:n,correctAnswer:o,repairType:e,options:l,correctOptionLetter:l.correctLetter,onSuccess:t,onFailure:s,onCancel:i},this.updatePanelContent(),this.showPanel(),console.log(`Math challenge: ${a} × ${n} = ${o} (for ${e})`),console.log(`Options: A=${l.A}, B=${l.B}, C=${l.C}, D=${l.D}, Correct=${l.correctLetter}`),!0}generateOptions(e){const t=[];for(;t.length<3;){let s;switch(Math.floor(4*Math.random())){case 0:s=e+Math.floor(10*Math.random())+1;break;case 1:s=e-Math.floor(10*Math.random())-1;break;case 2:s=Math.floor(e*(.8+.4*Math.random()));break;case 3:s=10*Math.floor(e/10)+Math.floor(10*Math.random());break;default:s=e+1}s>0&&s!==e&&!t.includes(s)&&t.push(s)}const s=[e,...t];for(let n=s.length-1;n>0;n--){const e=Math.floor(Math.random()*(n+1));[s[n],s[e]]=[s[e],s[n]]}const i={A:s[0],B:s[1],C:s[2],D:s[3]},a=["A","B","C","D"].find(t=>i[t]===e);if(!a)throw new Error("Could not find correct answer in options");return i.correctLetter=a,i}updatePanelContent(){var e,t,s,i;if(!this.currentChallenge)return;const{num1:a,num2:n,repairType:o,options:l}=this.currentChallenge,r=document.getElementById("mathQuestion"),h=document.getElementById("mathDescription"),c=document.getElementById("mathFeedback");r&&(r.textContent=`${a} × ${n} = ?`),h&&(h.textContent="Complete this calculation to repair your "+("hull"===o?"hull integrity":"energy reserves")),c&&(c.textContent="",c.className="math-feedback");const d=null==(e=document.getElementById("optionA"))?void 0:e.querySelector(".option-value"),p=null==(t=document.getElementById("optionB"))?void 0:t.querySelector(".option-value"),u=null==(s=document.getElementById("optionC"))?void 0:s.querySelector(".option-value"),g=null==(i=document.getElementById("optionD"))?void 0:i.querySelector(".option-value");d&&(d.textContent=String(l.A)),p&&(p.textContent=String(l.B)),u&&(u.textContent=String(l.C)),g&&(g.textContent=String(l.D)),["optionA","optionB","optionC","optionD"].forEach(e=>{const t=document.getElementById(e);null==t||t.classList.remove("correct","incorrect")})}selectOption(e){if(!this.currentChallenge)return;const t=document.getElementById("mathFeedback"),s=document.getElementById(`option${e}`);if(["optionA","optionB","optionC","optionD"].forEach(e=>{const t=document.getElementById(e);null==t||t.classList.remove("correct","incorrect")}),e===this.currentChallenge.correctOptionLetter)null==s||s.classList.add("correct"),t&&(t.textContent="CORRECT! Repair applied.",t.className="math-feedback success"),this.currentChallenge.onSuccess&&this.currentChallenge.onSuccess(this.currentChallenge.repairType),this.closePanel();else{null==s||s.classList.add("incorrect"),t&&(t.textContent="INCORRECT! Penalty applied. Try again.",t.className="math-feedback error"),this.currentChallenge.onFailure&&this.currentChallenge.onFailure(this.currentChallenge.repairType);const e=document.getElementById(`option${this.currentChallenge.correctOptionLetter}`);null==e||e.classList.add("correct"),setTimeout(()=>{null==s||s.classList.remove("incorrect"),null==e||e.classList.remove("correct"),t&&(t.textContent="",t.className="math-feedback")},2e3)}}showPanel(){const e=document.querySelector(".weapons-panel"),t=document.getElementById("mathChallengePanel");e&&(e.style.display="none"),t&&(t.style.display="block")}closePanel(){const e=document.getElementById("mathChallengePanel"),t=document.querySelector(".weapons-panel");e&&(e.style.display="none"),t&&(t.style.display="block"),this.currentChallenge&&this.currentChallenge.onCancel&&this.currentChallenge.onCancel(),this.panelOpen=!1,this.currentChallenge=null,console.log("Math challenge closed")}isPanelOpen(){return this.panelOpen}getCurrentChallenge(){return this.currentChallenge}}class t{constructor(e){this.images={},this.sounds={},this.loadingComplete=!1,this.loadPromises=[],this.gameSettings=e,this.initializeAssets()}initializeAssets(){const e="/star_trek/";this.loadShipImages(e),this.loadWeaponSounds(e),this.loadExplosionSounds(e),this.loadUISounds(e),this.waitForAssets().then(()=>{this.loadingComplete=!0,console.log("All assets loaded successfully!")}).catch(e=>{console.error("Error loading assets:",e)})}loadShipImages(e){this.gameSettings.getAllShips().forEach(t=>{t.image&&(this.images[t.id]=this.loadImage(`${e}assets/images/${t.image}`),this.images[t.image]=this.images[t.id])})}loadWeaponSounds(e){const t=this.gameSettings.getAllWeapons(),s=new Set;t.forEach(e=>{e.soundFile&&s.add(e.soundFile)}),s.forEach(t=>{const s=t.replace(".mp3","");this.sounds[s]=this.loadSound(`${e}assets/sounds/${t}`)})}loadExplosionSounds(e){this.gameSettings.getExplosionSounds().forEach(t=>{this.sounds[t.id]=this.loadSound(`${e}assets/sounds/${t.soundFile}`)})}loadUISounds(e){this.sounds.computerbeep=this.loadSound(`${e}assets/sounds/computerbeep_9.mp3`)}loadImage(e){const t=new Image,s=new Promise((s,i)=>{t.onload=()=>s(t),t.onerror=t=>{console.error(`Image load error for ${e}:`,t),i(t)}});return this.loadPromises.push(s),t.src=e,t}loadSound(e){const t=new Audio(e);t.volume=.3;const s=new Promise((s,i)=>{t.addEventListener("canplaythrough",()=>s(t)),t.addEventListener("error",t=>{console.error(`Sound load error for ${e}:`,t),i(t)})});return this.loadPromises.push(s),t.load(),t}checkAssetsLoaded(){const e=Object.values(this.images).every(e=>e.complete);return e&&!this.loadingComplete?(this.loadingComplete=!0,console.log("All assets loaded successfully!"),!0):e?this.loadingComplete:(setTimeout(()=>this.checkAssetsLoaded(),100),!1)}async waitForAssets(){try{return await Promise.all(this.loadPromises),this.loadingComplete=!0,console.log("All assets loaded via promises!"),!0}catch(e){return console.error("Error loading assets:",e),!1}}getImage(e){return this.images[e]}getSound(e){return this.sounds[e]}playSound(e){const t=this.sounds[e];t?(t.currentTime=0,t.play().catch(t=>{console.error(`Sound play failed for ${e}:`,t)})):console.error(`Sound not found: ${e}`)}playWeaponSound(e){const t=this.gameSettings.getWeaponSoundFile(e);if(t){const e=t.replace(".mp3","");this.playSound(e)}else console.error(`Sound file not found for weapon type: ${e}`)}playExplosionSound(){const e=this.gameSettings.getExplosionSounds();if(e.length>0){const t=e[Math.floor(Math.random()*e.length)];this.playSound(t.id)}else console.error("No explosion sounds available")}playUIClickSound(){this.playSound("computerbeep")}isLoaded(){return this.loadingComplete}getAssets(){return{images:this.images,sounds:this.sounds}}}class s{constructor(e){this.config=e,this.shipData=e.shipData,this.x=e.x??0,this.y=e.y??0,this.width=e.width,this.height=e.height,this.health=e.health||this.shipData.maxHealth,this.maxHealth=e.maxHealth||this.shipData.maxHealth,this.energy=e.energy||this.shipData.maxEnergy,this.maxEnergy=e.maxEnergy||this.shipData.maxEnergy,this.velocityX=e.velocityX||.8,this.direction=e.direction||1,this.minX=e.minX||60,this.maxX=e.maxX||740,this.isPlayer=e.isPlayer||!1,this.isEnemy=e.isEnemy||!1,this.image=this.shipData.image}update(){this.x+=this.velocityX*this.direction,this.x<=this.minX?(this.x=this.minX,this.direction=1):this.x>=this.maxX&&(this.x=this.maxX,this.direction=-1)}takeDamage(e){return this.health-=e,this.health=Math.max(0,this.health),console.log(`${this.isPlayer?"Player":"Enemy"} took ${e} damage! Health: ${this.health}`),this.health<=0}repairHull(e=100){this.health=Math.min(this.maxHealth,this.health+e),console.log(`Hull repaired! Health: ${this.health}`)}rechargeEnergy(e=100){this.isPlayer&&(this.energy=Math.min(this.maxEnergy,this.energy+e),console.log(`Energy recharged! Energy: ${this.energy}`))}consumeEnergy(e){return!this.isPlayer||(this.energy-=e,this.energy=Math.max(0,this.energy),this.energy>=0)}getBounds(){return{left:this.x-this.width/2,right:this.x+this.width/2,top:this.y-this.height/2,bottom:this.y+this.height/2}}contains(e,t){const s=this.getBounds();return e>=s.left&&e<=s.right&&t>=s.top&&t<=s.bottom}reset(e){this.x=e.x??this.x,this.y=e.y??this.y,this.health=e.health??this.maxHealth,this.energy=e.energy??this.maxEnergy,this.direction=e.direction??1,e.shipData&&(this.shipData=e.shipData,this.image=this.shipData.image)}levelUp(e){this.isEnemy&&(this.maxHealth=100+25*(e-1),this.health=this.maxHealth,console.log(`Enemy leveled up! Level ${e}, Health: ${this.maxHealth}`))}getHealthPercent(){return this.health/this.maxHealth*100}getEnergyPercent(){return this.energy/this.maxEnergy*100}isDestroyed(){return this.health<=0}isAlive(){return this.health>0}getWeapons(){return this.shipData.weapons}getWeapon(e){return this.shipData.weapons.find(t=>t.id===e)}addWeapon(e){return!(this.shipData.weapons.length>=this.shipData.weaponSlots)&&(e.id&&!this.getWeapon(e.id)||(e.id=`${e.templateId}_${Date.now()}_${Math.random()}`),this.shipData.weapons.push(e),this.shipData.lastModified=Date.now(),!0)}removeWeapon(e){const t=this.shipData.weapons.findIndex(t=>t.id===e);return t>=0&&(this.shipData.weapons.splice(t,1),this.shipData.lastModified=Date.now(),!0)}upgradeWeapon(e,t){const s=this.getWeapon(e);if(!s||!s.upgrades)return!1;const i=s.upgrades.find(e=>e.id===t);return!!i&&(Object.keys(i.effects).forEach(e=>{const t=i.effects[e];void 0!==t&&e in s&&(s[e]+=t)}),s.upgrades=s.upgrades.filter(e=>e.id!==t),s.level++,this.shipData.lastModified=Date.now(),console.log(`Upgraded weapon ${s.name} with ${i.name}`),!0)}}function i(e,t,s){const i=t.map(e=>function(e,t=1){return{id:`${e.id}_${Date.now()}_${Math.random()}`,templateId:e.id,name:e.name,description:e.description,damage:e.damage,energyCost:e.energyCost,projectileSpeed:e.projectileSpeed,projectileLifetime:e.projectileLifetime,isInstantHit:e.isInstantHit,hasParticles:e.hasParticles,useCircularArc:e.useCircularArc,maxEnergy:e.maxEnergy,currentEnergy:e.currentEnergy,loadingTime:e.loadingTime,soundFile:e.soundFile,projectileColor:e.projectileColor,projectileSize:e.projectileSize,faction:e.faction,cost:e.cost||0,level:t,upgrades:[]}}(e));return{id:`ship_${Date.now()}_${Math.random()}`,templateId:e.id,name:s||e.name,value:e.cost||1e3,maxHealth:e.maxHealth,maxEnergy:e.maxEnergy,speed:e.speed,weapons:i,weaponSlots:e.weaponSlots,image:e.image,faction:e.faction,level:1,experience:0,upgrades:[],createdAt:Date.now(),lastModified:Date.now()}}class a{constructor(e,t,s){this.lastUpdateTime=0,this.assetManager=e,this.collisionManager=t,this.particleSystem=s,this.projectiles=[],this.missMessages=[],this.lastUpdateTime=Date.now()}updateWeaponConfigs(e){e.getWeapons().forEach(e=>{void 0===e.currentEnergy&&(e.currentEnergy=0)})}updateWeaponLoading(e,t){t.getWeapons().forEach(t=>{if(t.currentEnergy<t.maxEnergy){const s=t.maxEnergy/(t.loadingTime/1e3)*e/1e3;t.currentEnergy=Math.min(t.maxEnergy,t.currentEnergy+s)}})}fireWeapon(e,t,s){if(t.isPlayer&&!this.haveEnoughEnergyFor(t,e.id))return void console.log(`Insufficient weapon energy for ${e.name}! Need ${e.energyCost}, have ${e.currentEnergy}`);if(t.isPlayer&&(e.currentEnergy=Math.max(0,e.currentEnergy-e.energyCost),console.log(`Weapon ${e.name} fired! Energy: ${e.currentEnergy}/${e.maxEnergy}`)),e.isInstantHit){this.createPhaserBeam(t,s,e),this.assetManager.playWeaponSound(e.templateId);return void(s.takeDamage(e.damage)&&this.particleSystem.createShipExplosion(s))}const i=this.createProjectile(e.templateId,t,s,e);this.projectiles.push(i),this.assetManager.playWeaponSound(e.templateId)}createProjectile(e,t,s,i){const a=t.isEnemy,n=a?t.y+t.height/2+10:t.y-t.height/2-10,o=i.useCircularArc?80+120*Math.random():100,l={x:t.x,y:n,startX:t.x,startY:n,targetX:s.x,targetY:s.y,progress:0,arcHeight:o,arcDirection:Math.random()<.5?-1:1,speed:i.projectileSpeed/1e3,width:i.projectileSize.width,height:i.projectileSize.height,damage:i.damage,color:i.projectileColor,type:e,trail:[],useCircularArc:i.useCircularArc,isEnemyProjectile:a};return i.hasParticles&&(l.particles=[]),l}createPhaserBeam(e,t,s){const i={shooterShip:e,targetShip:t,duration:s.projectileLifetime,startTime:Date.now(),type:"phaser",damage:s.damage,color:s.projectileColor};this.projectiles.push(i)}update(e,t){const s=Date.now(),i=s-this.lastUpdateTime;this.lastUpdateTime=s,this.updateWeaponLoading(i,e),this.updateProjectiles(e,t),this.updateMissMessages(),this.particleSystem.update()}updateProjectiles(e,t){this.projectiles=this.projectiles.filter(s=>{if("phaser"===s.type||"enemy_phaser"===s.type){const e=s;return Date.now()-e.startTime<e.duration}if("explosion"===s.type){const e=s;return e.x+=e.vx,e.y+=e.vy,e.life--,e.life>0}if("progress"in s){const i=s;if(this.updateProjectileArc(i),i.trail){i.trail.push({x:i.x,y:i.y});const e=i.useCircularArc?30:8;i.trail.length>e&&i.trail.shift()}this.particleSystem.updateQuantumParticles(i);if(this.checkCollisions(i,e,t))return!1;if(this.collisionManager.checkProjectileMiss(i))return this.createMissMessage(i,e,t),!1}return!0})}updateProjectileArc(e){e.progress+=e.speed;const t=e.x,s=e.y,i=e.progress;if(e.useCircularArc){if(!e.cached){const t=e.targetX-e.startX,s=e.targetY-e.startY,i=Math.sqrt(t*t+s*s);e.cached={deltaX:t,deltaY:s,perpX:-s/i,perpY:t/i}}const t=e.startX+e.cached.deltaX*i,s=e.startY+e.cached.deltaY*i,a=Math.sin(Math.PI*i)*e.arcHeight*e.arcDirection;e.x=t+e.cached.perpX*a,e.y=s+e.cached.perpY*a}else{const t=e.targetX-e.startX,s=e.targetY-e.startY;e.x=e.startX+t*i,e.y=e.startY+s*i}if(void 0!==t&&void 0!==s){const i=e.x-t,a=e.y-s;e.rotation=Math.atan2(a,i)}}checkCollisions(e,t,s){const i=this.collisionManager.checkProjectileCollision(e,t,s);return!(!i.hit||!i.impactPoint)&&(this.particleSystem.createExplosion(i.impactPoint.x,i.impactPoint.y),i.wasDestroyed&&i.targetShip&&this.particleSystem.createShipExplosion(i.targetShip),!0)}createMissMessage(e,t,s){const i=e.isEnemyProjectile?t:s,a=i.x+i.width/2+20,n=i.y;this.missMessages.push({x:a,y:n,text:"MISSED",life:120,maxLife:120,color:"#ff0000",fontSize:16,startTime:Date.now()}),console.log((e.isEnemyProjectile?"Enemy":"Player")+" torpedo missed!")}updateMissMessages(){this.missMessages=this.missMessages.filter(e=>(e.life--,e.life>0))}clear(){this.projectiles=[],this.missMessages=[],this.particleSystem.clear()}getProjectiles(){return[...this.projectiles,...this.particleSystem.getExplosionParticles()]}getMissMessages(){return this.missMessages}getShipExplosions(){return this.particleSystem.getShipExplosions()}getWeaponLoadingProgress(e,t){const s=e.getWeapon(t);return s?s.currentEnergy/s.maxEnergy:0}haveEnoughEnergyFor(e,t){const s=e.getWeapon(t);if(!s)return!1;return s.currentEnergy>=s.energyCost}}class n{constructor(){}checkProjectileCollision(e,t,s){const i=e.isEnemyProjectile?t:s;if(i.contains(e.x,e.y)){const t=i.takeDamage(e.damage);return{hit:!0,targetShip:i,wasDestroyed:t,impactPoint:{x:e.x,y:e.y}}}return{hit:!1}}checkShipCollision(e,t){const s=e.getBounds(),i=t.getBounds();return!(s.right<i.left||s.left>i.right||s.bottom<i.top||s.top>i.bottom)}checkPointInShip(e,t,s){return s.contains(e,t)}checkProjectileMiss(e){return e.progress>=1.5}}class o{constructor(e){this.assetManager=e,this.explosionParticles=[],this.shipExplosions=[]}createExplosion(e,t){this.assetManager.playExplosionSound();const s=[];for(let i=0;i<20;i++){const i={x:e+20*(Math.random()-.5),y:t+20*(Math.random()-.5),vx:4*(Math.random()-.5),vy:4*(Math.random()-.5),life:30,maxLife:30,size:3*Math.random()+1,type:"explosion"};this.explosionParticles.push(i),s.push(i)}return s}createShipExplosion(e){this.assetManager.playExplosionSound();const t={x:e.x,y:e.y,width:e.width,height:e.height,particles:[],startTime:Date.now(),duration:3e3,isPlayer:e.isPlayer};for(let s=0;s<80;s++){const s={x:e.x+(Math.random()-.5)*e.width,y:e.y+(Math.random()-.5)*e.height,vx:8*(Math.random()-.5),vy:8*(Math.random()-.5),life:60+120*Math.random(),maxLife:60+120*Math.random(),size:6*Math.random()+2,color:Math.random()<.5?"#ff6600":"#ffff00",type:"shipExplosion"};t.particles.push(s)}for(let s=0;s<3;s++)setTimeout(()=>{for(let i=0;i<30;i++){const i={x:e.x+(Math.random()-.5)*e.width*(1+.5*s),y:e.y+(Math.random()-.5)*e.height*(1+.5*s),vx:(Math.random()-.5)*(6-s),vy:(Math.random()-.5)*(6-s),life:40+80*Math.random(),maxLife:40+80*Math.random(),size:4*Math.random()+1,color:0===s?"#ff0000":1===s?"#ff6600":"#ffff00",type:"shipExplosion"};t.particles.push(i)}s<2&&this.assetManager.playExplosionSound()},500*s);this.shipExplosions.push(t),console.log((e.isPlayer?"Player":"Enemy")+" ship explosion created!")}update(){this.updateExplosionParticles(),this.updateShipExplosions()}updateExplosionParticles(){this.explosionParticles=this.explosionParticles.filter(e=>(e.x+=e.vx,e.y+=e.vy,e.life--,e.life>0))}updateShipExplosions(){this.shipExplosions.forEach(e=>{e.particles=e.particles.filter(e=>(e.x+=e.vx,e.y+=e.vy,e.life--,e.vx*=.999,e.vy*=.999,e.life>0))}),this.shipExplosions=this.shipExplosions.filter(e=>Date.now()-e.startTime<e.duration&&e.particles.length>0)}updateQuantumParticles(e){if("quantum"===e.type&&e.particles){for(let t=0;t<3;t++)e.particles.push({x:e.x+10*(Math.random()-.5),y:e.y+10*(Math.random()-.5),vx:2*(Math.random()-.5),vy:2*(Math.random()-.5),life:30,maxLife:30});e.particles=e.particles.filter(e=>(e.x+=e.vx,e.y+=e.vy,e.life--,e.life>0))}}getExplosionParticles(){return this.explosionParticles}getShipExplosions(){return this.shipExplosions}clear(){this.explosionParticles=[],this.shipExplosions=[]}}class l{constructor(e,t){this.weaponSystem=e,this.lastShotTime=Date.now(),this.baseShootInterval=(null==t?void 0:t.baseShootInterval)||6e3,this.shootInterval=this.baseShootInterval,this.level=1}update(e,t,s){if(!s||!e.isAlive())return;const i=Date.now();i-this.lastShotTime>this.shootInterval&&(this.fireAtPlayer(e,t),this.lastShotTime=i)}fireAtPlayer(e,t){const s=e.getWeapons();if(0===s.length)return void console.log("Enemy ship has no weapons assigned");const i=s[Math.floor(Math.random()*s.length)];if(!i)return void console.error("No weapon available for enemy ship");const a={...i,damage:i.damage+this.level*(i.isInstantHit?2:3)};this.weaponSystem.fireWeapon(a,e,t),console.log(`Enemy fired ${i.name}!`)}setLevel(e){this.level=e,this.shootInterval=Math.max(800,this.baseShootInterval-300*(e-1)),console.log(`Enemy AI updated to Level ${e}! Firing rate: ${this.shootInterval}ms`)}getShootInterval(){return this.shootInterval}getLevel(){return this.level}reset(){this.lastShotTime=Date.now(),this.shootInterval=this.baseShootInterval,this.level=1}forceShot(e,t){this.fireAtPlayer(e,t),this.lastShotTime=Date.now()}setDifficulty(e){this.shootInterval=Math.max(500,this.baseShootInterval/e),console.log(`Enemy AI difficulty set to ${e}x! New firing rate: ${this.shootInterval}ms`)}}class r{constructor(e){this.level=1,this.gameOver=!1,this.gameOverMessage="",this.levelCompleted=!1,this.gameStarted=!1,this.gamePaused=!1,this.currentCredits=4e3,this.callbacks=[],this.settingsManager=e}onStateChange(e){this.callbacks.push(e)}notifyStateChange(){const e=this.getCurrentState();this.callbacks.forEach(t=>t(e))}startGame(){this.gameStarted=!0,this.gameOver=!1,this.gamePaused=!1,this.levelCompleted=!1,console.log("Game started!"),this.notifyStateChange()}pauseGame(){this.gameStarted&&!this.gameOver&&(this.gamePaused=!0,console.log("Game paused"),this.notifyStateChange())}resumeGame(){this.gameStarted&&!this.gameOver&&(this.gamePaused=!1,console.log("Game resumed"),this.notifyStateChange())}endGame(e){this.gameOver=!0,this.gameOverMessage=e,console.log(`Game Over: ${e}`),this.notifyStateChange()}completeLevel(){!this.gameOver&&this.gameStarted&&(this.levelCompleted=!0,console.log("Battle completed!"),this.notifyStateChange())}advanceToNextLevel(e,t,s,i,a){this.level++,this.levelCompleted=!1,e.reset({x:i/2,y:a-120,health:100,energy:100,direction:1}),t.levelUp(this.level),t.reset({x:i/2,y:90,health:t.maxHealth,direction:-1}),s.setLevel(this.level),console.log(`Advanced to Level ${this.level}! Enemy Health: ${t.maxHealth}`),this.notifyStateChange()}restartGame(){var e;this.currentCredits=4e3,this.gameOver=!1,this.gameOverMessage="",this.level=1,this.levelCompleted=!1,this.gameStarted=!1,this.gamePaused=!1,this.settingsManager&&this.settingsManager.resetAllData(),null==(e=this.creditUpdateCallback)||e.call(this,this.currentCredits),console.log("Game restarted!"),this.notifyStateChange()}checkVictoryCondition(e){return!(this.levelCompleted||!e.isDestroyed())&&(this.completeLevel(),!0)}checkDefeatCondition(e){return!(!e.isDestroyed()||this.gameOver)&&(this.endGame("MISSION FAILED"),!0)}getCurrentState(){return{level:this.level,gameOver:this.gameOver,gameOverMessage:this.gameOverMessage,levelCompleted:this.levelCompleted,gameStarted:this.gameStarted,gamePaused:this.gamePaused,canUpdate:this.gameStarted&&!this.gamePaused&&!this.gameOver,canUpdateProjectiles:this.gameStarted&&!this.gamePaused&&!this.gameOver}}getLevel(){return this.level}isGameActive(){return this.gameStarted&&!this.gameOver&&!this.gamePaused}isLevelCompleted(){return this.levelCompleted}isGameOver(){return this.gameOver}isGameStarted(){return this.gameStarted}isGamePaused(){return this.gamePaused}setCreditUpdateCallback(e){this.creditUpdateCallback=e}updateCredits(e){var t;this.currentCredits=Math.max(0,e),null==(t=this.creditUpdateCallback)||t.call(this,this.currentCredits)}addCredits(e){var t;this.currentCredits+=e,null==(t=this.creditUpdateCallback)||t.call(this,this.currentCredits)}spendCredits(e){var t;return this.currentCredits>=e&&(this.currentCredits-=e,null==(t=this.creditUpdateCallback)||t.call(this,this.currentCredits),!0)}getCredits(){return this.currentCredits}}class h{constructor(e,t){this.canvas=e;const s=e.getContext("2d");if(!s)throw new Error("Could not get 2D context from canvas");this.ctx=s,this.width=e.width,this.height=e.height,this.assetManager=t,this.stars=[],this.initializeStars()}initializeStars(){for(let e=0;e<200;e++)this.stars.push({x:Math.random()*this.width,y:Math.random()*this.height,size:2*Math.random()+.5,speed:.5*Math.random()+.1,brightness:.8*Math.random()+.2})}updateStars(){this.stars.forEach(e=>{e.y+=e.speed,e.y>this.height&&(e.y=0,e.x=Math.random()*this.width)})}render(e){this.ctx.fillStyle="#000",this.ctx.fillRect(0,0,this.width,this.height),this.drawStars(),this.assetManager.isLoaded()?(this.drawShips(e.playerShip,e.enemyShip),this.drawProjectiles(e.weaponSystem.getProjectiles()),this.drawMissMessages(e.weaponSystem.getMissMessages()),this.drawShipExplosions(e.weaponSystem.getShipExplosions()),e.gameOver&&this.drawGameOverScreen(e)):this.drawLoadingScreen()}renderBackground(){this.ctx.fillStyle="#000",this.ctx.fillRect(0,0,this.width,this.height),this.drawStars(),this.assetManager.isLoaded()||this.drawLoadingScreen()}drawLoadingScreen(){this.ctx.fillStyle="#00ff00",this.ctx.font="24px Courier New",this.ctx.textAlign="center",this.ctx.fillText("Loading Assets...",this.width/2,this.height/2),this.ctx.textAlign="left"}drawStars(){this.ctx.fillStyle="#ffffff",this.stars.forEach(e=>{this.ctx.globalAlpha=e.brightness,this.ctx.fillRect(e.x,e.y,e.size,e.size)}),this.ctx.globalAlpha=1}drawShips(e,t){if(e.isAlive()){const t=this.assetManager.getImage(e.image);t&&t.complete?this.drawShipWithTransparency(t,e.x-e.width/2,e.y-e.height/2,e.width,e.height,"#00ffff"):(this.ctx.fillStyle="#00ff00",this.ctx.fillRect(e.x-e.width/2,e.y-e.height/2,e.width,e.height))}if(t.isAlive()){const e=this.assetManager.getImage(t.image);e&&e.complete?this.drawShipWithTransparency(e,t.x-t.width/2,t.y-t.height/2,t.width,t.height,"#ff6600"):(this.ctx.fillStyle="#ff0000",this.ctx.fillRect(t.x-t.width/2,t.y-t.height/2,t.width,t.height))}}drawShipWithTransparency(e,t,s,i,a,n){const o=`${e.src}_${i}_${a}`;this.processedImageCache||(this.processedImageCache=new Map);let l=this.processedImageCache.get(o);if(!l){l=document.createElement("canvas");const t=l.getContext("2d");l.width=i,l.height=a,t.drawImage(e,0,0,i,a);const s=t.getImageData(0,0,i,a),n=s.data;for(let e=0;e<n.length;e+=4){const t=n[e],s=n[e+1],i=n[e+2];(t+s+i)/3>200&&Math.abs(t-s)<30&&Math.abs(s-i)<30&&Math.abs(t-i)<30&&(n[e+3]=0)}t.putImageData(s,0,0),this.processedImageCache.set(o,l)}this.ctx.drawImage(l,t,s)}drawProjectiles(e){e.forEach(e=>{"phaser"===e.type||"enemy_phaser"===e.type?this.drawPhaserBeam(e):"explosion"===e.type?this.drawExplosionParticle(e):this.drawTorpedo(e)})}drawPhaserBeam(e){const t=1-(Date.now()-e.startTime)/e.duration,s=e.shooterShip.isEnemy,i=e.shooterShip.x,a=s?e.shooterShip.y+e.shooterShip.height/2:e.shooterShip.y-e.shooterShip.height/2,n=e.targetShip.x,o=e.targetShip.y,l=e.color||"#ff0000";this.ctx.globalAlpha=t,this.ctx.strokeStyle=l,this.ctx.lineWidth=4,this.ctx.shadowColor=l,this.ctx.shadowBlur=10,this.ctx.beginPath(),this.ctx.moveTo(i,a),this.ctx.lineTo(n,o),this.ctx.stroke(),this.ctx.shadowBlur=0,this.ctx.globalAlpha=1}drawExplosionParticle(e){const t=e.life/e.maxLife;this.ctx.globalAlpha=t,this.ctx.fillStyle=`hsl(${30+30*Math.random()}, 100%, 50%)`,this.ctx.fillRect(e.x,e.y,e.size,e.size),this.ctx.globalAlpha=1}drawTorpedo(e){e.trail&&(e.trail.forEach((t,s)=>{const i=s/e.trail.length*.5;this.ctx.globalAlpha=i,this.ctx.fillStyle=e.color,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,1.5,0,2*Math.PI),this.ctx.fill()}),this.ctx.globalAlpha=1),e.particles&&(e.particles.forEach(t=>{const s=t.life/t.maxLife;this.ctx.globalAlpha=s,this.ctx.fillStyle=e.color,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,1,0,2*Math.PI),this.ctx.fill()}),this.ctx.globalAlpha=1),this.ctx.fillStyle=e.color,this.ctx.shadowColor=e.color,this.ctx.shadowBlur=10;const t=Math.max(e.width,e.height)/2;this.ctx.beginPath(),this.ctx.arc(e.x,e.y,t,0,2*Math.PI),this.ctx.fill(),this.ctx.shadowBlur=5,this.ctx.fillStyle="rgba(255, 255, 255, 0.8)",this.ctx.beginPath(),this.ctx.arc(e.x,e.y,.4*t,0,2*Math.PI),this.ctx.fill(),this.ctx.shadowBlur=0}drawMissMessages(e){e.forEach(e=>{const t=e.life/e.maxLife;this.ctx.globalAlpha=t,this.ctx.fillStyle=e.color,this.ctx.font=`bold ${e.fontSize}px Courier New`,this.ctx.textAlign="left",this.ctx.shadowColor=e.color,this.ctx.shadowBlur=8,this.ctx.fillText(e.text,e.x,e.y),this.ctx.globalAlpha=1,this.ctx.shadowBlur=0,this.ctx.textAlign="left"})}drawShipExplosions(e){e.forEach(e=>{e.particles.forEach(e=>{const t=e.life/e.maxLife;this.ctx.globalAlpha=t,this.ctx.fillStyle=e.color||"#000000",this.ctx.shadowColor=e.color||"#000000",this.ctx.shadowBlur=8,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,e.size||0,0,2*Math.PI),this.ctx.fill(),t>.5&&(this.ctx.fillStyle="#ffffff",this.ctx.globalAlpha=.8*t,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,e.size||0,0,2*Math.PI),this.ctx.fill())})}),this.ctx.globalAlpha=1,this.ctx.shadowBlur=0}drawGameOverScreen(e){this.ctx.fillStyle="rgba(0, 0, 0, 0.8)",this.ctx.fillRect(0,0,this.width,this.height),this.ctx.fillStyle="#ff0000",this.ctx.font="bold 48px Courier New",this.ctx.textAlign="center",this.ctx.shadowColor="#ff0000",this.ctx.shadowBlur=15,this.ctx.fillText(e.gameOverMessage,this.width/2,this.height/2-40),this.ctx.fillStyle="#ffffff",this.ctx.font="24px Courier New",this.ctx.shadowColor="#ffffff",this.ctx.shadowBlur=8,this.ctx.fillText(`Hull Integrity: ${e.playerShip.health}%`,this.width/2,this.height/2+20),this.ctx.fillText(`Final Level Reached: ${e.level}`,this.width/2,this.height/2+60),this.ctx.fillStyle="#00ff00",this.ctx.font="20px Courier New",this.ctx.shadowColor="#00ff00",this.ctx.shadowBlur=10,this.ctx.fillText("Click RESTART to begin new mission",this.width/2,this.height/2+120),this.ctx.textAlign="left",this.ctx.shadowBlur=0}update(){this.updateStars()}}class c{constructor(e,t){this.weaponCallbacks={},this.repairCallbacks={},this.gameCallbacks={},this.weaponListenersAdded=!1,this.repairListenersAdded=!1,this.gameListenersAdded=!1,this.pauseListenerAdded=!1,this.playerShip=null,this.assetManager=e,this.initializeEventListeners(),this.weaponSystem=t}initializeEventListeners(){this.weaponCallbacks={},this.repairCallbacks={},this.gameCallbacks={}}updateWeaponConfigs(e){this.playerShip=e,this.updateWeaponUI(e.getWeapons())}updateWeaponUI(e){const t=document.querySelector(".weapons-panel .weapon-section");t&&(t.innerHTML="",e.forEach(e=>{const s=document.createElement("button");s.id=e.id+"Btn",s.className="weapon-btn",s.innerHTML=`\n                <span class="weapon-name">${e.name}</span>\n                <span class="weapon-status">Ready</span>\n            `,s.addEventListener("click",()=>{var t,s;this.assetManager.playUIClickSound(),null==(s=(t=this.weaponCallbacks).fire)||s.call(t,e.templateId)}),t.appendChild(s)}))}updateCreditDisplay(e){document.querySelectorAll("#creditAmount").forEach(t=>{t.textContent=e.toString()})}hideMainCreditDisplay(){const e=document.getElementById("creditDisplay");e&&e.classList.add("hidden"),document.body.classList.add("credit-display-hidden")}showMainCreditDisplay(){const e=document.getElementById("creditDisplay");e&&e.classList.remove("hidden"),document.body.classList.remove("credit-display-hidden")}setWeaponCallbacks(e){if(this.weaponCallbacks=e,!this.weaponListenersAdded){const e=document.getElementById("photonBtn"),t=document.getElementById("phaserBtn"),s=document.getElementById("quantumBtn");null==e||e.addEventListener("click",()=>{this.assetManager.playUIClickSound(),this.fireWeapon("photon")}),null==t||t.addEventListener("click",()=>{this.assetManager.playUIClickSound(),this.fireWeapon("phaser")}),null==s||s.addEventListener("click",()=>{this.assetManager.playUIClickSound(),this.fireWeapon("quantum")}),this.weaponListenersAdded=!0}}setRepairCallbacks(e){if(this.repairCallbacks=e,!this.repairListenersAdded){const e=document.getElementById("repairHullBtn"),t=document.getElementById("repairEnergyBtn");null==e||e.addEventListener("click",()=>{this.assetManager.playUIClickSound(),this.showMathChallenge("hull")}),null==t||t.addEventListener("click",()=>{this.assetManager.playUIClickSound(),this.showMathChallenge("energy")}),this.repairListenersAdded=!0}}setGameCallbacks(e){if(this.gameCallbacks=e,!this.gameListenersAdded){const e=document.getElementById("restartBtn"),t=document.getElementById("continueBtn");null==e||e.addEventListener("click",()=>{var e,t;this.assetManager.playUIClickSound(),null==(t=(e=this.gameCallbacks).restart)||t.call(e),this.hideRestartButton()}),null==t||t.addEventListener("click",()=>{var e,t;this.assetManager.playUIClickSound(),null==(t=(e=this.gameCallbacks).continue)||t.call(e),this.hideContinueButton()}),this.gameListenersAdded=!0}if(!this.pauseListenerAdded){const e=document.getElementById("pauseBtn");null==e||e.addEventListener("click",()=>{var e,t;this.assetManager.playUIClickSound(),null==(t=(e=this.gameCallbacks).pause)||t.call(e)}),this.pauseListenerAdded=!0}}fireWeapon(e){var t,s;null==(s=(t=this.weaponCallbacks).fire)||s.call(t,e);const i=document.getElementById(e+"Btn");null==i||i.classList.add("firing"),setTimeout(()=>null==i?void 0:i.classList.remove("firing"),500)}showMathChallenge(e){var t,s;null==(s=(t=this.repairCallbacks).show)||s.call(t,e)}updateUI(e){this.updateHealthBars(e),this.updateWeaponStatus(e.playerShip),this.updateLevelDisplay(e.level),this.updateEnemyLabel(e.level)}updateHealthBars(e){const t=document.querySelector(".hull-integrity");t&&(t.style.width=e.playerShip.health+"%");const s=document.querySelector(".energy-reserves");if(s){const t=e.playerShip.getEnergyPercent();s.style.width=t+"%"}const i=document.querySelector(".enemy-health");if(i){const t=e.enemyShip.getHealthPercent();i.style.width=t+"%"}}updateWeaponStatus(e){this.playerShip&&this.playerShip.getWeapons().forEach(t=>{const s=document.getElementById(t.id+"Btn"),i=null==s?void 0:s.querySelector(".weapon-status"),a=null==s?void 0:s.querySelector(".weapon-loading-bar"),n=this.weaponSystem.haveEnoughEnergyFor(e,t.id),o=this.weaponSystem.getWeaponLoadingProgress(e,t.id);if(n&&i&&s)i.textContent="Ready",i.style.color="#00FF00",i.style.borderColor="#00FF00",i.style.backgroundColor="rgba(0, 255, 0, 0.1)",s.style.opacity="1",s.style.cursor="pointer";else if(i&&s){const e=Math.round(100*o);i.textContent=`Loading ${e}%`,i.style.color="#FFAA00",i.style.borderColor="#FFAA00",i.style.backgroundColor="rgba(255, 170, 0, 0.1)",s.style.opacity="0.8",s.style.cursor="not-allowed"}a&&(a.style.width=100*o+"%",a.style.backgroundColor=n?"#00FF00":"#FFAA00")})}updateLevelDisplay(e){const t=document.querySelector(".level-number");t&&(t.textContent="1")}updateEnemyLabel(e){const t=document.querySelector(".enemy-label");t&&(t.textContent="Enemy:")}showStartupScreen(){const e=document.getElementById("startupScreen"),t=document.getElementById("gameContainer");e&&(e.style.display="flex"),t&&(t.style.display="none"),this.hideMainCreditDisplay()}showGameScreen(){const e=document.getElementById("startupScreen"),t=document.getElementById("gameContainer");e&&(e.style.display="none"),t&&(t.style.display="flex"),this.hideMainCreditDisplay()}showRestartButton(){const e=document.getElementById("restartContainer");e&&(e.style.display="block")}hideRestartButton(){const e=document.getElementById("restartContainer");e&&(e.style.display="none")}showContinueButton(){const e=document.getElementById("continueContainer");e&&(e.style.display="block")}hideContinueButton(){const e=document.getElementById("continueContainer");e&&(e.style.display="none")}updatePauseButton(e){const t=document.getElementById("pauseBtn"),s=null==t?void 0:t.querySelector(".pause-text");t&&s&&(e?(t.classList.add("paused"),s.textContent="RESUME"):(t.classList.remove("paused"),s.textContent="PAUSE"))}showWeaponsPanel(){const e=document.querySelector(".weapons-panel");e&&(e.style.display="block")}showGameControlsPanel(){const e=document.querySelector(".game-controls-panel");e&&(e.style.display="block")}reset(){this.hideRestartButton(),this.hideContinueButton(),this.showWeaponsPanel(),this.showGameControlsPanel(),this.updateLevelDisplay(1),this.updateEnemyLabel(1);const e=document.querySelector(".hull-integrity"),t=document.querySelector(".energy-reserves"),s=document.querySelector(".enemy-health");e&&(e.style.width="100%"),t&&(t.style.width="100%"),s&&(s.style.width="100%")}}class d{constructor(){this.currentRoute="startup",this.routes=new Map,this.routeHistory=["startup"],this.initializeRoutes()}initializeRoutes(){this.routes.set("startup",{}),this.routes.set("game",{}),this.routes.set("settings",{}),this.routes.set("about",{}),this.routes.set("map",{}),this.routes.set("ship-selection",{}),this.routes.set("weapon-selection",{})}registerRoute(e,t){this.routes.set(e,t)}navigate(e){var t,s;if(e===this.currentRoute)return;const i=this.routes.get(this.currentRoute);null==(t=null==i?void 0:i.onExit)||t.call(i),this.routeHistory.push(e),this.routeHistory.length>10&&this.routeHistory.shift(),this.currentRoute=e;const a=this.routes.get(e);null==(s=null==a?void 0:a.onEnter)||s.call(a),window.location.hash=e,console.log(`Navigated to: ${e}`)}goBack(){if(this.routeHistory.length>1){this.routeHistory.pop();const e=this.routeHistory[this.routeHistory.length-1];e&&this.navigate(e)}}getCurrentRoute(){return this.currentRoute}isOnRoute(e){return this.currentRoute===e}update(){var e;const t=this.routes.get(this.currentRoute);null==(e=null==t?void 0:t.onUpdate)||e.call(t)}initializeFromHash(){const e=window.location.hash.slice(1);e&&"startup"!==e&&this.routes.has(e)?(console.log(`Page refreshed on ${e} route, redirecting to startup`),this.navigate("startup")):e&&this.routes.has(e)?this.navigate(e):this.navigate("startup")}getHistory(){return[...this.routeHistory]}}class p{constructor(){this.selectedShip=null,this.selectedWeapons=[],this.currentLocation=null,this.unlockedShips=new Set(["federation-cruiser"]),this.unlockedWeapons=new Set(["phaser","photon","quantum"]),this.unlockedLocations=new Set(["earth-orbit"]),this.__cachedWeapons=[],this.settings=this.getDefaultSettings(),this.loadSettings(),this.initializeDefaultSelections()}getDefaultSettings(){return{masterVolume:.8,musicVolume:.7,sfxVolume:.9,particleEffects:!0,screenShake:!0,fullscreen:!1,difficulty:"normal",autoSave:!0,showFPS:!1,keyBindings:{"move-left":"ArrowLeft","move-right":"ArrowRight","fire-phaser":"Space","fire-photon":"KeyP","fire-quantum":"KeyQ","repair-hull":"KeyH","repair-energy":"KeyE"},uiScale:1,theme:"classic",selectedFaction:"federation"}}initializeDefaultSelections(){var e;if(!this.selectedShip){const e=this.getAvailableShips();this.selectedShip=e.length>0?e[0]:null}if(0===this.selectedWeapons.length){const t=(null==(e=this.selectedShip)?void 0:e.weaponSlots)||3;this.selectedWeapons=this.getAvailableWeapons().slice(0,t)}if(!this.currentLocation){const e=this.getAvailableLocations();this.currentLocation=e.length>0?e[0]:null}}getSettings(){return{...this.settings}}updateSettings(e){this.settings={...this.settings,...e},this.saveSettings()}resetSettings(){this.settings=this.getDefaultSettings(),this.saveSettings()}resetAllData(){this.unlockedShips=new Set(["federation-cruiser"]),this.unlockedWeapons=new Set(["phaser","photon","quantum"]),this.unlockedLocations=new Set(["earth-orbit"]),this.selectedShip=null,this.selectedWeapons=[],this.currentLocation=null,this.settings=this.getDefaultSettings(),this.saveSettings(),console.log("Reset all data to defaults"),this.initializeDefaultSelections()}getSelectedFaction(){return this.settings.selectedFaction}setSelectedFaction(e){this.settings.selectedFaction=e,this.saveSettings()}getEnemyShipType(){const e=this.getAllShips().filter(e=>"romulan"===e.faction);return e.length>0?e[0]:null}getAvailableShips(){return this.getAllShips().filter(e=>e.unlocked&&e.faction===this.getSelectedFaction())}getAllShips(){return[{id:"federation-cruiser",name:"Federation Cruiser",description:"Standard Starfleet vessel with balanced stats",maxHealth:100,maxEnergy:100,speed:1,image:"player-ship.png",unlocked:!0,weaponSlots:3,faction:"federation"},{id:"defiant-class",name:"Defiant Class",description:"Heavily armed warship with high damage output",maxHealth:80,maxEnergy:120,speed:1.2,image:"defiant-ship.png",unlocked:!1,cost:1e3,weaponSlots:4,faction:"federation"},{id:"sovereign-class",name:"Sovereign Class",description:"Large exploration vessel with high health",maxHealth:150,maxEnergy:90,speed:.8,image:"sovereign-ship.png",unlocked:!1,cost:1500,weaponSlots:5,faction:"federation"},{id:"romulan-warbird",name:"Romulan Warbird",description:"Stealthy Romulan vessel with advanced technology",maxHealth:90,maxEnergy:110,speed:1.1,image:"romulan-warbird.png",unlocked:!1,cost:1200,weaponSlots:4,faction:"romulan"},{id:"klingon-bird-of-prey",name:"Klingon Bird of Prey",description:"Fast and agile Klingon vessel with high damage output",maxHealth:100,maxEnergy:120,speed:1.3,image:"klingon-bird-of-prey.png",unlocked:!1,cost:1200,weaponSlots:4,faction:"klingon"}].map(e=>({...e,unlocked:this.unlockedShips.has(e.id)}))}getShipById(e){return this.getAllShips().find(t=>t.id===e)||null}getEnemyShips(){return this.getAllShips().filter(e=>e.faction!==this.getSelectedFaction())}getEnemyWeapons(e){return this.getAllWeapons().filter(t=>t.faction===e).slice(0,2)}selectShip(e){const t=this.getAllShips().find(t=>t.id===e);return!(!t||!this.unlockedShips.has(e))&&(this.selectedShip=t,this.saveSettings(),!0)}getSelectedShip(){return this.selectedShip}unlockShip(e){this.unlockedShips.add(e),console.log("Unlocked ship:",e),console.log("Current unlocked ships:",Array.from(this.unlockedShips))}clearSelectedShip(){this.selectedShip=null,this.saveSettings()}getAvailableWeapons(){return this.getAllWeapons().filter(e=>this.unlockedWeapons.has(e.id)&&e.faction===this.getSelectedFaction())}getAllWeapons(){if(this.__cachedWeapons.length>0)return this.__cachedWeapons;const e=[{id:"phaser",name:"Phaser Array",description:"Standard energy weapon with moderate damage",damage:15,energyCost:10,unlocked:!0,soundFile:"phasers.mp3",projectileColor:"#ff0000",projectileSize:{width:4,height:15},projectileSpeed:8,projectileLifetime:200,isInstantHit:!0,hasParticles:!1,useCircularArc:!1,faction:"federation",maxEnergy:20,currentEnergy:0,loadingTime:2e3},{id:"photon",name:"Photon Torpedo",description:"High damage projectile weapon",damage:25,energyCost:25,unlocked:!0,soundFile:"photon_torpedo.mp3",projectileColor:"#ff0000",projectileSize:{width:4,height:15},projectileSpeed:6,projectileLifetime:1e3,isInstantHit:!1,hasParticles:!1,useCircularArc:!0,faction:"federation",maxEnergy:25,currentEnergy:0,loadingTime:2e3},{id:"quantum",name:"Quantum Torpedo",description:"Advanced torpedo with highest damage",damage:35,energyCost:50,unlocked:!0,soundFile:"quantum_torpedo.mp3",projectileColor:"#ffffff",projectileSize:{width:6,height:20},projectileSpeed:5,projectileLifetime:1200,isInstantHit:!1,hasParticles:!0,useCircularArc:!0,faction:"federation",maxEnergy:50,currentEnergy:0,loadingTime:2e3},{id:"pulse-phaser",name:"Pulse Phaser",description:"Rapid-fire phaser with lower damage",damage:8,energyCost:5,unlocked:!1,cost:500,soundFile:"phasers.mp3",projectileColor:"#ff8800",projectileSize:{width:3,height:12},projectileSpeed:10,projectileLifetime:150,isInstantHit:!1,hasParticles:!1,useCircularArc:!1,faction:"federation",maxEnergy:5,currentEnergy:0,loadingTime:2e3},{id:"plasma-torpedo",name:"Plasma Torpedo",description:"Alien technology with unique properties",damage:30,energyCost:40,unlocked:!1,cost:800,soundFile:"romulan_torpedo.mp3",projectileColor:"#ff00ff",projectileSize:{width:5,height:18},projectileSpeed:4,projectileLifetime:1500,isInstantHit:!1,hasParticles:!0,useCircularArc:!0,faction:"federation",maxEnergy:40,currentEnergy:0,loadingTime:2e3},{id:"romulan-disruptor",name:"Romulan Disruptor",description:"Romulan energy weapon with green energy bolts",damage:18,energyCost:12,unlocked:!1,cost:600,soundFile:"romulan_disruptor.mp3",projectileColor:"#00ff00",projectileSize:{width:4,height:15},projectileSpeed:7,projectileLifetime:180,isInstantHit:!0,hasParticles:!1,useCircularArc:!1,faction:"romulan",maxEnergy:12,currentEnergy:0,loadingTime:2e3},{id:"romulan-torpedo",name:"Romulan Torpedo",description:"Romulan projectile weapon with high damage",damage:28,energyCost:30,unlocked:!1,cost:700,soundFile:"romulan_torpedo.mp3",projectileColor:"#00ff00",projectileSize:{width:5,height:18},projectileSpeed:5,projectileLifetime:1100,isInstantHit:!1,hasParticles:!0,useCircularArc:!0,faction:"romulan",maxEnergy:30,currentEnergy:0,loadingTime:2e3},{id:"klingon-disruptor",name:"Klingon Disruptor",description:"Klingon energy weapon with green energy bolts",damage:18,energyCost:12,unlocked:!1,cost:600,soundFile:"klingon_disruptor4.mp3",projectileColor:"#ffee00",projectileSize:{width:4,height:15},projectileSpeed:7,projectileLifetime:180,isInstantHit:!0,hasParticles:!1,useCircularArc:!1,faction:"klingon",maxEnergy:12,currentEnergy:0,loadingTime:2e3},{id:"klingon-torpedo",name:"Klingon Torpedo",description:"Klingon projectile weapon with high damage",damage:28,energyCost:30,unlocked:!1,cost:700,soundFile:"klingon_torpedo.mp3",projectileColor:"#ff4000",projectileSize:{width:5,height:18},projectileSpeed:5,projectileLifetime:1100,isInstantHit:!1,hasParticles:!0,useCircularArc:!0,faction:"klingon",maxEnergy:30,currentEnergy:0,loadingTime:2e3}];return e.forEach(e=>{e.unlocked=this.unlockedWeapons.has(e.id)}),this.__cachedWeapons=e,e}getWeaponTemplatesByIds(e){const t=this.getAvailableWeapons();return e.map(e=>t.find(t=>t.id===e)).filter(e=>void 0!==e)}selectWeapons(e){var t;const s=this.getAvailableWeapons(),i=e.map(e=>s.find(t=>t.id===e)).filter(e=>void 0!==e),a=(null==(t=this.selectedShip)?void 0:t.weaponSlots)||3;return i.length===e.length&&i.length<=a&&(this.selectedWeapons=i,this.saveSettings(),!0)}getSelectedWeapons(){return this.selectedWeapons}unlockWeapon(e){this.unlockedWeapons.add(e),this.__cachedWeapons=[],console.log("Unlocked weapon:",e),console.log("Current unlocked weapons:",Array.from(this.unlockedWeapons))}clearSelectedWeapons(){this.selectedWeapons=[],this.saveSettings()}getAvailableLocations(){return this.getAllLocations().filter(e=>this.unlockedLocations.has(e.id))}getAllLocations(){return[{id:"earth-orbit",name:"Earth Orbit",description:"Home base of Starfleet operations",x:400,y:300,unlocked:!0,hasEncounter:!1},{id:"klingon-border",name:"Klingon Border",description:"Dangerous territory with hostile encounters",x:200,y:150,unlocked:!1,hasEncounter:!0,encounterType:"battle"},{id:"romulan-neutral-zone",name:"Romulan Neutral Zone",description:"Forbidden space with mysterious encounters",x:600,y:200,unlocked:!1,hasEncounter:!0,encounterType:"battle"},{id:"ferengi-trading-post",name:"Ferengi Trading Post",description:"Commercial hub for ship upgrades",x:300,y:450,unlocked:!1,hasEncounter:!0,encounterType:"trade"},{id:"unknown-sector",name:"Unknown Sector",description:"Unexplored space with potential discoveries",x:500,y:100,unlocked:!1,hasEncounter:!0,encounterType:"exploration"}]}selectLocation(e){const t=this.getAllLocations().find(t=>t.id===e);return!(!t||!this.unlockedLocations.has(e))&&(this.currentLocation=t,this.saveSettings(),!0)}getCurrentLocation(){return this.currentLocation}unlockLocation(e){this.unlockedLocations.add(e),this.saveSettings()}getExplosionSounds(){return[{id:"explosion1",soundFile:"smallexplosion1.mp3",volume:.3},{id:"explosion2",soundFile:"smallexplosion2.mp3",volume:.3}]}getWeaponSoundFile(e){const t=this.getAllWeapons().find(t=>t.id===e);return t?t.soundFile:null}getWeaponProperties(e){const t=this.getAllWeapons().find(t=>t.id===e);return t?{projectileColor:t.projectileColor,projectileSize:t.projectileSize,projectileSpeed:t.projectileSpeed,projectileLifetime:t.projectileLifetime,isInstantHit:t.isInstantHit,hasParticles:t.hasParticles,useCircularArc:t.useCircularArc}:null}getWeaponTemplateById(e){return this.getAllWeapons().find(t=>t.id===e)||null}saveSettings(){var e,t;const s={settings:this.settings,selectedShip:null==(e=this.selectedShip)?void 0:e.id,selectedWeapons:this.selectedWeapons.map(e=>e.id),currentLocation:null==(t=this.currentLocation)?void 0:t.id,unlockedLocations:Array.from(this.unlockedLocations)};try{localStorage.setItem("starTrekGameSettings",JSON.stringify(s))}catch(i){console.warn("Failed to save settings:",i)}}loadSettings(){try{const e=localStorage.getItem("starTrekGameSettings");if(e){const t=JSON.parse(e);if(t.settings&&(this.settings={...this.getDefaultSettings(),...t.settings}),t.selectedShip){const e=this.getShipById(t.selectedShip);e&&e.unlocked&&e.faction===this.settings.selectedFaction&&(this.selectedShip=e)}if(t.selectedWeapons&&Array.isArray(t.selectedWeapons)){const e=t.selectedWeapons.map(e=>this.getAllWeapons().find(t=>t.id===e)).filter(e=>void 0!==e&&e.unlocked&&e.faction===this.settings.selectedFaction);this.selectedWeapons=e}if(t.currentLocation){const e=this.getAllLocations().find(e=>e.id===t.currentLocation);e&&this.unlockedLocations.has(e.id)&&(this.currentLocation=e)}t.unlockedLocations&&(this.unlockedLocations=new Set(t.unlockedLocations))}}catch(e){console.warn("Failed to load settings:",e)}}}class u{constructor(e){this.modalContainer=null,this.currentModal=null,this.assetManager=e,this.initializeModalContainer()}initializeModalContainer(){this.modalContainer=document.getElementById("modal-container"),this.modalContainer||(this.modalContainer=document.createElement("div"),this.modalContainer.id="modal-container",this.modalContainer.className="modal-container",document.body.appendChild(this.modalContainer))}async showModal(e){return new Promise(t=>{this.createModal(e,[{text:"OK",action:()=>{this.closeModal(),t()},primary:!0}])})}async showConfirmation(e){return new Promise(t=>{this.createModal(e,[{text:"No",action:()=>{this.closeModal(),t(!1)},primary:!1},{text:"Yes",action:()=>{this.closeModal(),t(!0)},primary:!0}])})}createModal(e,t){this.closeModal();const s=document.createElement("div");s.className="modal-overlay";const i=document.createElement("div");i.className="modal-dialog";const a=document.createElement("div");a.className="modal-message",a.textContent=e;const n=document.createElement("div");n.className="modal-buttons",t.forEach(e=>{const t=document.createElement("button");t.className="modal-button "+(e.primary?"primary":"secondary"),t.textContent=e.text,t.addEventListener("click",()=>{this.assetManager.playUIClickSound(),e.action()}),n.appendChild(t)}),i.appendChild(a),i.appendChild(n),s.appendChild(i),this.modalContainer.appendChild(s),this.currentModal=s;const o=e=>{var s,i;"Escape"===e.key&&(2===t.length?null==(s=t[0])||s.action():null==(i=t[0])||i.action(),document.removeEventListener("keydown",o))};document.addEventListener("keydown",o);const l=i.querySelector(".modal-button.primary");l&&l.focus()}closeModal(){this.currentModal&&(this.currentModal.remove(),this.currentModal=null)}}class g{constructor(e,t,s=!0){this.isVisible=!1;const i=document.getElementById(t);if(!i)throw new Error(`Element with id '${t}' not found`);this.element=i,this.assetManager=e,s&&this.initialize()}show(){this.element.style.display="block",this.isVisible=!0,this.onShow()}hide(){this.element.style.display="none",this.isVisible=!1,this.onHide()}toggle(){this.isVisible?this.hide():this.show()}isComponentVisible(){return this.isVisible}onShow(){}onHide(){}createElement(e,t,s){const i=document.createElement(e);return t&&(i.className=t),s&&(i.textContent=s),i}addClickHandler(e,t){const s=this.element.querySelector(e);s&&s.addEventListener("click",()=>{this.assetManager.playUIClickSound(),t()})}updateElement(e,t){const s=this.element.querySelector(e);s&&(s.textContent=t)}updateElementHTML(e,t){const s=this.element.querySelector(e);s&&(s.innerHTML=t)}}class m extends g{constructor(e,t,s){super(t,"settingsPage",!1),this.modalService=s,this.settingsManager=e,this.initialize()}initialize(){this.setupEventListeners(),this.renderSettings()}setupEventListeners(){this.addClickHandler("#settingsBackBtn",()=>{var e;null==(e=this.onBackCallback)||e.call(this)}),this.addClickHandler("#masterVolumeSlider",()=>this.updateMasterVolume()),this.addClickHandler("#musicVolumeSlider",()=>this.updateMusicVolume()),this.addClickHandler("#sfxVolumeSlider",()=>this.updateSFXVolume()),this.addClickHandler("#particleEffectsToggle",()=>this.toggleParticleEffects()),this.addClickHandler("#screenShakeToggle",()=>this.toggleScreenShake()),this.addClickHandler("#fullscreenToggle",()=>this.toggleFullscreen()),this.addClickHandler("#difficultySelect",()=>this.updateDifficulty()),this.addClickHandler("#autoSaveToggle",()=>this.toggleAutoSave()),this.addClickHandler("#showFPSToggle",()=>this.toggleShowFPS()),this.addClickHandler("#uiScaleSlider",()=>this.updateUIScale()),this.addClickHandler("#themeSelect",()=>this.updateTheme()),this.addClickHandler("#resetSettingsBtn",async()=>await this.resetSettings())}renderSettings(){const e=this.settingsManager.getSettings();this.updateSliderValue("#masterVolumeSlider",e.masterVolume),this.updateSliderValue("#musicVolumeSlider",e.musicVolume),this.updateSliderValue("#sfxVolumeSlider",e.sfxVolume),this.updateToggleState("#particleEffectsToggle",e.particleEffects),this.updateToggleState("#screenShakeToggle",e.screenShake),this.updateToggleState("#fullscreenToggle",e.fullscreen),this.updateToggleState("#autoSaveToggle",e.autoSave),this.updateToggleState("#showFPSToggle",e.showFPS),this.updateSelectValue("#difficultySelect",e.difficulty),this.updateSelectValue("#themeSelect",e.theme),this.updateSliderValue("#uiScaleSlider",e.uiScale)}updateSliderValue(e,t){const s=this.element.querySelector(e);if(s){s.value=t.toString();const i=this.element.querySelector(e+"Display");i&&(i.textContent=Math.round(100*t)+"%")}}updateToggleState(e,t){const s=this.element.querySelector(e);s&&(s.checked=t)}updateSelectValue(e,t){const s=this.element.querySelector(e);s&&(s.value=t)}updateMasterVolume(){const e=this.element.querySelector("#masterVolumeSlider");if(e){const t=parseFloat(e.value);this.settingsManager.updateSettings({masterVolume:t}),this.updateSliderValue("#masterVolumeSlider",t)}}updateMusicVolume(){const e=this.element.querySelector("#musicVolumeSlider");if(e){const t=parseFloat(e.value);this.settingsManager.updateSettings({musicVolume:t}),this.updateSliderValue("#musicVolumeSlider",t)}}updateSFXVolume(){const e=this.element.querySelector("#sfxVolumeSlider");if(e){const t=parseFloat(e.value);this.settingsManager.updateSettings({sfxVolume:t}),this.updateSliderValue("#sfxVolumeSlider",t)}}toggleParticleEffects(){const e=this.element.querySelector("#particleEffectsToggle");e&&this.settingsManager.updateSettings({particleEffects:e.checked})}toggleScreenShake(){const e=this.element.querySelector("#screenShakeToggle");e&&this.settingsManager.updateSettings({screenShake:e.checked})}toggleFullscreen(){var e,t,s;const i=this.element.querySelector("#fullscreenToggle");i&&(this.settingsManager.updateSettings({fullscreen:i.checked}),i.checked?null==(t=(e=document.documentElement).requestFullscreen)||t.call(e):null==(s=document.exitFullscreen)||s.call(document))}updateDifficulty(){const e=this.element.querySelector("#difficultySelect");e&&this.settingsManager.updateSettings({difficulty:e.value})}toggleAutoSave(){const e=this.element.querySelector("#autoSaveToggle");e&&this.settingsManager.updateSettings({autoSave:e.checked})}toggleShowFPS(){const e=this.element.querySelector("#showFPSToggle");e&&this.settingsManager.updateSettings({showFPS:e.checked})}updateUIScale(){const e=this.element.querySelector("#uiScaleSlider");if(e){const t=parseFloat(e.value);this.settingsManager.updateSettings({uiScale:t}),this.updateSliderValue("#uiScaleSlider",t),document.documentElement.style.setProperty("--ui-scale",t.toString())}}updateTheme(){const e=this.element.querySelector("#themeSelect");e&&(this.settingsManager.updateSettings({theme:e.value}),document.body.className=`theme-${e.value}`)}async resetSettings(){await this.modalService.showConfirmation("Are you sure you want to reset all settings to default?")&&(this.settingsManager.resetSettings(),this.renderSettings())}setOnBackCallback(e){this.onBackCallback=e}onShow(){this.renderSettings()}}class y extends g{constructor(e){super(e,"aboutPage",!0)}initialize(){this.setupEventListeners(),this.renderContent()}setupEventListeners(){this.addClickHandler("#aboutBackBtn",()=>{var e;null==(e=this.onBackCallback)||e.call(this)}),this.addClickHandler("#versionInfoBtn",()=>{this.showVersionInfo()}),this.addClickHandler("#creditsBtn",()=>{this.showCredits()})}renderContent(){this.updateElementHTML("#gameDescription","\n      <h3>Star Trek Battle Simulator</h3>\n      <p>Experience the thrill of space combat in this Star Trek-themed battle game. \n      Command your starship through challenging encounters with enemy vessels, \n      manage your ship's systems, and prove your tactical skills.</p>\n      \n      <h4>Features:</h4>\n      <ul>\n        <li>Real-time space combat with multiple weapon systems</li>\n        <li>Ship customization and upgrades</li>\n        <li>Multiple ship classes and weapon types</li>\n        <li>Strategic repair system with math challenges</li>\n        <li>Progressive difficulty levels</li>\n        <li>Immersive Star Trek universe</li>\n      </ul>\n    "),this.updateElementHTML("#gameControls",'\n      <h4>Controls:</h4>\n      <div class="controls-grid">\n        <div class="control-item">\n          <span class="key">← →</span>\n          <span class="action">Move Ship</span>\n        </div>\n        <div class="control-item">\n          <span class="key">SPACE</span>\n          <span class="action">Fire Phasers</span>\n        </div>\n        <div class="control-item">\n          <span class="key">P</span>\n          <span class="action">Fire Photon Torpedoes</span>\n        </div>\n        <div class="control-item">\n          <span class="key">Q</span>\n          <span class="action">Fire Quantum Torpedoes</span>\n        </div>\n        <div class="control-item">\n          <span class="key">H</span>\n          <span class="action">Repair Hull</span>\n        </div>\n        <div class="control-item">\n          <span class="key">E</span>\n          <span class="action">Recharge Energy</span>\n        </div>\n      </div>\n    '),this.updateElement("#versionNumber","1.0.0"),this.updateElement("#buildDate",(new Date).toLocaleDateString())}showVersionInfo(){const e=`\n      <div class="version-details">\n        <h4>Version Information</h4>\n        <p><strong>Version:</strong> 1.0.0</p>\n        <p><strong>Build Date:</strong> ${(new Date).toLocaleDateString()}</p>\n        <p><strong>Engine:</strong> HTML5 Canvas + TypeScript</p>\n        <p><strong>Framework:</strong> Vanilla JavaScript</p>\n        <p><strong>Build Tool:</strong> Vite</p>\n        <p><strong>License:</strong> MIT</p>\n      </div>\n    `;this.updateElementHTML("#versionDetails",e),this.showSection("#versionDetails")}showCredits(){this.updateElementHTML("#creditsDetails",'\n      <div class="credits-details">\n        <h4>Credits</h4>\n        <div class="credits-section">\n          <h5>Development</h5>\n          <p>Game developed with passion for the Star Trek universe</p>\n        </div>\n        \n        <div class="credits-section">\n          <h5>Inspiration</h5>\n          <p>Based on the Star Trek universe created by Gene Roddenberry</p>\n        </div>\n        \n        <div class="credits-section">\n          <h5>Assets</h5>\n          <p>Game assets created specifically for this project</p>\n        </div>\n        \n        <div class="credits-section">\n          <h5>Technology</h5>\n          <p>Built with modern web technologies: TypeScript, HTML5 Canvas, CSS3</p>\n        </div>\n        \n        <div class="credits-section">\n          <h5>Special Thanks</h5>\n          <p>To the Star Trek community for inspiration and feedback</p>\n        </div>\n      </div>\n    '),this.showSection("#creditsDetails")}showSection(e){this.element.querySelectorAll(".detail-section").forEach(e=>{e.style.display="none"});const t=this.element.querySelector(e);t&&(t.style.display="block")}setOnBackCallback(e){this.onBackCallback=e}onShow(){this.renderContent();this.element.querySelectorAll(".detail-section").forEach(e=>{e.style.display="none"})}}class S{constructor(e){this.cells=new Map,this.playerPosition={q:0,r:0},this.mapSize=10,this.hexSize=40,this.canvasWidth=800,this.canvasHeight=600,this.settingsManager=e,this.generateMap(),this.placeStarbases(),this.placeEnemies()}generateMap(){for(let e=-this.mapSize;e<=this.mapSize;e++){const t=Math.max(-this.mapSize,-e-this.mapSize),s=Math.min(this.mapSize,-e+this.mapSize);for(let i=t;i<=s;i++){const t={q:e,r:i},s={coordinate:t,hasShip:!1,hasEnemy:!1,isAccessible:!0,isStarbase:!1,name:`Sector ${e},${i}`,description:"Uncharted space"};this.isBorderCell(e,i)&&(s.isAccessible=!1,s.name="Void",s.description="Impassable space"),this.cells.set(this.coordinateToKey(t),s)}}this.setPlayerPosition({q:0,r:0})}placeStarbases(){[{q:0,r:0},{q:-3,r:2},{q:3,r:-2}].forEach((e,t)=>{const s=this.getCell(e);s&&s.isAccessible&&(s.isStarbase=!0,s.name=`Starbase ${String.fromCharCode(65+t)}`,s.description="Federation starbase - ship services available",s.encounterType="trade",s.ship="starbase")})}isBorderCell(e,t){return Math.abs(e)+Math.abs(t)+Math.abs(e+t)>=this.mapSize||0===e&&Math.abs(t)>this.mapSize-3||0===t&&Math.abs(e)>this.mapSize-3}placeEnemies(){const e=Array.from(this.cells.values()).filter(e=>e.isAccessible&&!e.hasShip&&!e.isStarbase),t=Math.min(8,Math.floor(.15*e.length)),s=this.settingsManager.getEnemyShips();for(let i=0;i<t;i++){const t=Math.floor(Math.random()*e.length),a=e[t];if(a&&s.length>0){const n=s[Math.floor(Math.random()*s.length)];n&&(a.hasEnemy=!0,a.encounterType="battle",a.name=n.name+" "+(i+1),a.description=n.description,a.ship=n.id,e.splice(t,1))}}}getCell(e){return this.cells.get(this.coordinateToKey(e))}getPlayerPosition(){return{...this.playerPosition}}getPlayerShip(){const e=this.getCell(this.playerPosition);return null==e?void 0:e.ship}setPlayerPosition(e,t){const s=this.getCell(e);if(s&&s.isAccessible){const i=this.getCell(this.playerPosition);return i&&(i.hasShip=!1,i.ship===t&&delete i.ship),this.playerPosition={...e},s.hasShip=!0,t&&(s.ship=t),!0}return!1}getAdjacentCells(e){return[{q:1,r:0},{q:1,r:-1},{q:0,r:-1},{q:-1,r:0},{q:-1,r:1},{q:0,r:1}].map(t=>({q:e.q+t.q,r:e.r+t.r}))}getAccessibleAdjacentCells(e){return this.getAdjacentCells(e).filter(e=>{const t=this.getCell(e);return t&&t.isAccessible})}canMoveTo(e){const t=this.getCell(e);if(!t||!t.isAccessible)return!1;return this.getAccessibleAdjacentCells(this.playerPosition).some(t=>t.q===e.q&&t.r===e.r)}moveTo(e){return!!this.canMoveTo(e)&&this.setPlayerPosition(e)}getCellAtPixel(e,t){const s=e-this.canvasWidth/2,i=t-this.canvasHeight/2,a={q:Math.round((Math.sqrt(3)/3*s-1/3*i)/this.hexSize),r:Math.round(2/3*i/this.hexSize)};return this.getCell(a)?a:null}getPixelFromCoordinate(e){return{x:this.hexSize*(Math.sqrt(3)*e.q+Math.sqrt(3)/2*e.r)+this.canvasWidth/2,y:this.hexSize*(1.5*e.r)+this.canvasHeight/2}}getAllCells(){return Array.from(this.cells.values())}getCellsInRange(e,t){const s=[];for(let i=-t;i<=t;i++){const a=Math.max(-t,-i-t),n=Math.min(t,-i+t);for(let t=a;t<=n;t++){const a={q:e.q+i,r:e.r+t},n=this.getCell(a);n&&s.push(n)}}return s}coordinateToKey(e){return`${e.q},${e.r}`}getMapSize(){return this.mapSize}getHexSize(){return this.hexSize}clearEnemyFromCell(e){const t=this.getCell(e);t&&(t.hasEnemy=!1,delete t.encounterType,delete t.ship,t.name=`Sector ${e.q},${e.r}`,t.description="Uncharted space")}resetPlayerPosition(){const e=this.getCell(this.playerPosition);e&&(e.hasShip=!1,delete e.ship),this.playerPosition={q:0,r:0};const t=this.getCell(this.playerPosition);t&&(t.hasShip=!0)}regenerateMap(){this.cells.forEach(e=>{e.hasEnemy&&(e.hasEnemy=!1,delete e.encounterType,delete e.ship,e.name=`Sector ${e.coordinate.q},${e.coordinate.r}`,e.description="Uncharted space")}),this.placeEnemies()}}class f extends g{constructor(e,t,s){super(t,"mapPage",!1),this.modalService=s,this.hoveredCell=null,this.selectedCell=null,this.hasMovedToStarbase=!1,this.hexagonalMap=new S(e),this.settingsManager=e,this.initialize()}initialize(){this.setupMapCanvas(),this.setupEventListeners();const e=this.hexagonalMap.getPlayerPosition(),t=this.hexagonalMap.getCell(e);t&&t.isStarbase&&(this.hasMovedToStarbase=!0),this.renderMap()}setupMapCanvas(){if(this.mapCanvas=this.element.querySelector("#mapCanvas"),!this.mapCanvas)throw new Error("Map canvas not found");this.mapCtx=this.mapCanvas.getContext("2d"),this.mapCanvas.width=800,this.mapCanvas.height=600}setupEventListeners(){this.addClickHandler("#mapBackBtn",async()=>{var e;await this.modalService.showConfirmation("Are you sure you want to go back? Any progress on the map will be lost.")&&(null==(e=this.onBackCallback)||e.call(this))}),this.mapCanvas.addEventListener("click",e=>this.handleMapClick(e)),this.mapCanvas.addEventListener("mousemove",e=>this.handleMapHover(e)),this.mapCanvas.addEventListener("mouseleave",()=>this.handleMapLeave()),this.addClickHandler("#jumpBtn",()=>{this.selectedCell&&this.moveToCell(this.selectedCell)}),this.addClickHandler("#shipSelectionBtn",()=>{var e;null==(e=this.onShipServicesCallback)||e.call(this)}),this.addClickHandler("#shipServicesBtn",()=>{var e;null==(e=this.onWeaponServicesCallback)||e.call(this)})}renderMap(){this.mapCtx.clearRect(0,0,this.mapCanvas.width,this.mapCanvas.height),this.drawStarfield(),this.drawHexagonalGrid(),this.hoveredCell&&this.drawCellInfo(this.hoveredCell)}drawStarfield(){this.mapCtx.fillStyle="#000011",this.mapCtx.fillRect(0,0,this.mapCanvas.width,this.mapCanvas.height),this.mapCtx.fillStyle="#FFFFFF";for(let e=0;e<200;e++){const e=Math.random()*this.mapCanvas.width,t=Math.random()*this.mapCanvas.height,s=2*Math.random();this.mapCtx.beginPath(),this.mapCtx.arc(e,t,s,0,2*Math.PI),this.mapCtx.fill()}}drawHexagonalGrid(){const e=this.hexagonalMap.getAllCells(),t=this.hexagonalMap.getPlayerPosition();e.forEach(e=>{const s=this.hexagonalMap.getPixelFromCoordinate(e.coordinate);this.drawHexagon(s.x,s.y,e,t)})}drawHexagon(e,t,s,i){const a=this.hexagonalMap.getHexSize(),n=s.coordinate.q===i.q&&s.coordinate.r===i.r,o=this.hoveredCell&&s.coordinate.q===this.hoveredCell.q&&s.coordinate.r===this.hoveredCell.r,l=this.selectedCell&&s.coordinate.q===this.selectedCell.q&&s.coordinate.r===this.selectedCell.r;let r="#001122",h="#333366";s.isAccessible?n?(r="#00FF00",h="#00FF00"):l?(r="#FF9900",h="#FF9900"):o?(r="#0066CC",h="#0066CC"):s.isStarbase?(r="#001166",h="#00FFFF"):s.hasEnemy&&(r="#CC0000",h="#FF0000"):(r="#000000",h="#111111"),this.mapCtx.beginPath();for(let c=0;c<6;c++){const s=Math.PI/3*c-Math.PI/6,i=e+a*Math.cos(s),n=t+a*Math.sin(s);0===c?this.mapCtx.moveTo(i,n):this.mapCtx.lineTo(i,n)}this.mapCtx.closePath(),this.mapCtx.fillStyle=r,this.mapCtx.fill(),this.mapCtx.strokeStyle=h,this.mapCtx.lineWidth=1,this.mapCtx.stroke(),s.isStarbase&&s.isAccessible?(this.mapCtx.fillStyle="#00FFFF",this.mapCtx.font="bold 16px Arial",this.mapCtx.textAlign="center",this.mapCtx.fillText("B",e,t+5)):s.hasEnemy&&s.isAccessible&&(this.mapCtx.fillStyle="#FFFFFF",this.mapCtx.font="bold 12px Arial",this.mapCtx.textAlign="center",this.mapCtx.fillText("⚔",e,t+4))}drawCellInfo(e){const t=this.hexagonalMap.getCell(e);if(!t||!t.isAccessible)return;const s=this.hexagonalMap.getPixelFromCoordinate(e),i=Math.min(s.x+40,this.mapCanvas.width-200),a=Math.max(s.y-80,20);this.mapCtx.fillStyle="rgba(0, 0, 0, 0.8)",this.mapCtx.fillRect(i,a,180,100),this.mapCtx.strokeStyle="#FF9900",this.mapCtx.lineWidth=2,this.mapCtx.strokeRect(i,a,180,100),this.mapCtx.fillStyle="#FFFFFF",this.mapCtx.font="bold 14px Courier New",this.mapCtx.textAlign="left",this.mapCtx.fillText(t.name||`Sector ${e.q},${e.r}`,i+10,a+20),this.mapCtx.font="12px Courier New",this.mapCtx.fillStyle="#CCCCCC",this.mapCtx.fillText(t.description||"Uncharted space",i+10,a+40),t.isStarbase?(this.mapCtx.fillStyle="#00FFFF",this.mapCtx.fillText("Starbase - Ship Services Available",i+10,a+60)):t.hasEnemy&&(this.mapCtx.fillStyle="#FF4444",this.mapCtx.fillText("Enemy Territory",i+10,a+60));const n=this.hexagonalMap.getPlayerPosition(),o=this.hexagonalMap.canMoveTo(e),l=e.q===n.q&&e.r===n.r,r=this.hexagonalMap.getAccessibleAdjacentCells(n).some(t=>t.q===e.q&&t.r===e.r);t.isStarbase&&(o||l)?(this.mapCtx.fillStyle="#00FFFF",this.mapCtx.fillText("Click for ship services",i+10,a+80)):o?(this.mapCtx.fillStyle="#00FF00",this.mapCtx.fillText("Click to move here",i+10,a+80)):r?(this.mapCtx.fillStyle="#FFAA00",this.mapCtx.fillText("Adjacent - can move",i+10,a+80)):(this.mapCtx.fillStyle="#FF6666",this.mapCtx.fillText("Too far to move",i+10,a+80))}handleMapClick(e){const t=this.mapCanvas.getBoundingClientRect(),s=e.clientX-t.left,i=e.clientY-t.top,a=this.hexagonalMap.getCellAtPixel(s,i);if(a){const e=this.hexagonalMap.getCell(a);e&&e.isAccessible&&(this.selectedCell=a,this.updateCellInfo(a),this.renderMap()),this.assetManager.playUIClickSound()}}handleMapHover(e){const t=this.mapCanvas.getBoundingClientRect(),s=e.clientX-t.left,i=e.clientY-t.top,a=this.hexagonalMap.getCellAtPixel(s,i);a!==this.hoveredCell&&(this.hoveredCell=a,this.renderMap())}handleMapLeave(){this.hoveredCell=null,this.renderMap()}updateCellInfo(e){const t=this.hexagonalMap.getCell(e);if(!t)return;this.updateElement("#selectedLocationName",t.name||`Sector ${e.q},${e.r}`),this.updateElement("#selectedLocationDescription",t.description||"Uncharted space");const s=t.hasEnemy?`Encounter Type: ${t.encounterType||"battle"}`:"No encounters";this.updateElement("#selectedLocationEncounter",s),this.updateCellImageDisplay(t.ship);const i=this.element.querySelector("#jumpBtn"),a=this.element.querySelector("#shipSelectionBtn"),n=this.element.querySelector("#shipServicesBtn");if(i&&a&&n){const s=this.hexagonalMap.canMoveTo(e),o=this.hexagonalMap.getPlayerPosition(),l=e.q===o.q&&e.r===o.r;t.isStarbase&&l&&this.hasMovedToStarbase?(i.style.display="none",a.disabled=!1,a.style.display="block",n.disabled=!1,n.style.display="block"):t.isStarbase&&l||t.isStarbase&&s?(i.disabled=!1,i.textContent="Move Here",i.style.display="block",a.style.display="none",n.style.display="none"):(i.disabled=!s,i.textContent=s?"Move Here":"Cannot Move Here",i.style.display="block",a.style.display="none",n.style.display="none")}}updateCellImageDisplay(e){const t=this.element.querySelector("#cellImageContainer"),s=this.element.querySelector("#cellImage");if(t&&s)if(e){const i=this.getShipImagePath(e);s.src=i,t.style.display="block"}else t.style.display="none"}getShipImagePath(e){if("starbase"===e)return"assets/images/starbase.png";const t=this.settingsManager.getShipById(e);if(t)return`assets/images/${t.image}`;throw new Error(`Ship image not found for ship: ${e}`)}moveToCell(e){var t;const s=this.hexagonalMap.getCell(e);if(!s)return;const i=this.hexagonalMap.getPlayerPosition(),a=e.q===i.q&&e.r===i.r;if(s.isStarbase){if(a&&!this.hasMovedToStarbase)return this.hasMovedToStarbase=!0,void this.updateCellInfo(e);if(this.hexagonalMap.canMoveTo(e)){return void(this.hexagonalMap.moveTo(e)&&(this.hasMovedToStarbase=!0,this.selectedCell=null,this.renderMap(),this.updateCellInfo(e)))}}if(!this.hexagonalMap.canMoveTo(e))return;this.hexagonalMap.moveTo(e)&&(this.selectedCell=null,this.renderMap(),s.hasEnemy&&"battle"===s.encounterType&&(null==(t=this.onJumpCallback)||t.call(this,{id:`battle-${e.q}-${e.r}`,name:s.name||"Battle",description:s.description||"Enemy encounter",x:0,y:0,unlocked:!0,hasEncounter:!0,encounterType:"battle"})))}setOnBackCallback(e){this.onBackCallback=e}setOnJumpCallback(e){this.onJumpCallback=e}setCreditCallbacks(e,t){this.getCreditsCallback=e}setOnShipServicesCallback(e){this.onShipServicesCallback=e}setOnWeaponServicesCallback(e){this.onWeaponServicesCallback=e}updateCreditDisplay(){var e;const t=(null==(e=this.getCreditsCallback)?void 0:e.call(this))||0,s=document.getElementById("creditAmount");s&&(s.textContent=t.toString())}hideMainCreditDisplay(){const e=document.getElementById("creditDisplay");e&&e.classList.add("hidden"),document.body.classList.add("credit-display-hidden")}showMainCreditDisplay(){const e=document.getElementById("creditDisplay");e&&e.classList.remove("hidden"),document.body.classList.remove("credit-display-hidden")}onShow(){this.renderMap(),this.hoveredCell=null;const e=this.hexagonalMap.getPlayerPosition();this.selectedCell=e,this.updateCellInfo(e),this.updateCreditDisplay(),this.hideMainCreditDisplay()}onHide(){this.showMainCreditDisplay()}clearEnemyFromCell(e){this.hexagonalMap.clearEnemyFromCell(e),this.renderMap()}getHexCell(e){const t={q:e.q,r:e.r};return this.hexagonalMap.getCell(t)}restartMap(){this.hexagonalMap.resetPlayerPosition(),this.hexagonalMap.regenerateMap(),this.selectedCell=null,this.hoveredCell=null,this.renderMap();const e=this.hexagonalMap.getPlayerPosition();this.selectedCell=e,this.updateCellInfo(e),this.assetManager.playUIClickSound()}}class C extends g{constructor(e,t,s){super(t,"shipSelectionPage",!1),this.modalService=s,this.availableShips=[],this.selectedShip=null,this.settingsManager=e,this.initialize()}initialize(){this.setupEventListeners(),this.loadShips(),this.renderShips()}setupEventListeners(){this.addClickHandler("#shipSelectionBackBtn",()=>{var e;null==(e=this.onBackCallback)||e.call(this)})}loadShips(){const e=this.settingsManager.getAllShips(),t=this.settingsManager.getSelectedFaction();this.availableShips=e.filter(e=>e.faction===t),this.selectedShip=this.settingsManager.getSelectedShip()}renderShips(){const e=this.element.querySelector("#shipsContainer");e&&(this.loadShips(),e.innerHTML="",this.availableShips.forEach(t=>{const s=this.createShipCard(t);e.appendChild(s)}))}createShipCard(e){var t;const s=this.createElement("div","ship-card");e.id===(null==(t=this.selectedShip)?void 0:t.id)&&s.classList.add("selected"),e.unlocked||s.classList.add("locked");const i=e.unlocked?"Select Ship":`Purchase (${e.cost||0} Credits)`;s.innerHTML=`\n      <div class="ship-image">\n        <img src="./public/assets/images/${e.image}" alt="${e.name}" \n             onerror="this.src='./public/assets/images/player-ship.png'">\n        ${e.unlocked?"":'<div class="lock-overlay">🔒</div>'}\n      </div>\n      <div class="ship-info">\n        <h3>${e.name}</h3>\n        <p class="ship-description">${e.description}</p>\n        <div class="ship-stats">\n          <div class="stat">\n            <span class="stat-label">Health:</span>\n            <span class="stat-value">${e.maxHealth}</span>\n          </div>\n          <div class="stat">\n            <span class="stat-label">Energy:</span>\n            <span class="stat-value">${e.maxEnergy}</span>\n          </div>\n          <div class="stat">\n            <span class="stat-label">Speed:</span>\n            <span class="stat-value">${e.speed}x</span>\n          </div>\n          <div class="stat">\n            <span class="stat-label">Faction:</span>\n            <span class="stat-value">${e.faction.charAt(0).toUpperCase()+e.faction.slice(1)}</span>\n          </div>\n        </div>\n        <button class="ship-action-btn" \n                data-ship-id="${e.id}">\n          ${i}\n        </button>\n      </div>\n    `;const a=s.querySelector(".ship-action-btn");return a&&a.addEventListener("click",async t=>{t.stopPropagation(),this.assetManager.playUIClickSound(),await this.handleShipAction(e)}),s}async handleShipAction(e){e.unlocked?this.selectShip(e):await this.unlockShip(e)}selectShip(e){var t;this.settingsManager.selectShip(e.id),this.selectedShip=e,this.renderShips(),null==(t=this.onSelectCallback)||t.call(this,e)}async unlockShip(e){var t,s;const i=e.cost||0,a=(null==(t=this.getCreditsCallback)?void 0:t.call(this))||0;if(a<i)return void(await this.modalService.showModal(`Insufficient credits! You need ${i} credits but only have ${a}.`));await this.modalService.showConfirmation(`Purchase ${e.name} for ${i} credits?`)&&((null==(s=this.spendCreditsCallback)?void 0:s.call(this,i))?(this.settingsManager.unlockShip(e.id),this.renderShips(),this.updateCreditDisplay()):await this.modalService.showModal("Failed to complete purchase. Please try again."))}setOnBackCallback(e){this.onBackCallback=e}setOnSelectCallback(e){this.onSelectCallback=e}setCreditCallbacks(e,t){this.getCreditsCallback=e,this.spendCreditsCallback=t}onShow(){this.loadShips(),this.renderShips(),this.updateCreditDisplay(),this.hideMainCreditDisplay()}onHide(){this.showMainCreditDisplay()}updateCreditDisplay(){var e;const t=(null==(e=this.getCreditsCallback)?void 0:e.call(this))||0,s=document.getElementById("creditAmount");s&&(s.textContent=t.toString())}hideMainCreditDisplay(){const e=document.getElementById("creditDisplay");e&&e.classList.add("hidden"),document.body.classList.add("credit-display-hidden")}showMainCreditDisplay(){const e=document.getElementById("creditDisplay");e&&e.classList.remove("hidden"),document.body.classList.remove("credit-display-hidden")}}class v extends g{constructor(e,t,s){super(t,"weaponSelectionPage",!1),this.modalService=s,this.availableWeapons=[],this.selectedWeapons=[],this.settingsManager=e,this.initialize()}initialize(){this.setupEventListeners(),this.loadWeapons(),this.renderWeapons()}setupEventListeners(){this.addClickHandler("#weaponSelectionBackBtn",()=>{var e;null==(e=this.onBackCallback)||e.call(this)}),this.addClickHandler("#applyLoadoutBtn",()=>{var e;null==(e=this.onSelectCallback)||e.call(this,this.selectedWeapons)})}loadWeapons(){this.availableWeapons=this.settingsManager.getAllWeapons().filter(e=>e.faction===this.settingsManager.getSelectedFaction()),this.selectedWeapons=[...this.settingsManager.getSelectedWeapons()]}getMaxWeapons(){const e=this.settingsManager.getSelectedShip();return(null==e?void 0:e.weaponSlots)||3}renderWeapons(){this.loadWeapons(),this.renderAvailableWeapons(),this.renderSelectedLoadout(),this.updateLoadoutInfo()}renderAvailableWeapons(){const e=this.element.querySelector("#availableWeaponsContainer");e&&(e.innerHTML="",this.availableWeapons.forEach(t=>{const s=this.createWeaponCard(t);e.appendChild(s)}))}createWeaponCard(e){const t=this.createElement("div","weapon-card");e.unlocked||t.classList.add("locked");const s=this.selectedWeapons.some(t=>t.id===e.id);s&&t.classList.add("selected"),t.innerHTML=`\n      <div class="weapon-header">\n        <h3>${e.name}</h3>\n        ${e.unlocked?"":'<div class="lock-icon">🔒</div>'}\n      </div>\n      <div class="weapon-description">\n        <p>${e.description}</p>\n      </div>\n      <div class="weapon-stats">\n        <div class="stat">\n          <span class="stat-label">Damage:</span>\n          <span class="stat-value">${e.damage}</span>\n        </div>\n        <div class="stat">\n          <span class="stat-label">Energy Cost:</span>\n          <span class="stat-value">${e.energyCost}</span>\n        </div>\n        <div class="stat">\n          <span class="stat-label">Efficiency:</span>\n          <span class="stat-value">${(e.damage/e.energyCost).toFixed(1)}</span>\n        </div>\n      </div>\n      ${!e.unlocked&&e.cost?`<div class="weapon-cost">Cost: ${e.cost} Credits</div>`:""}\n      <div class="weapon-actions">\n        ${e.unlocked?s?'<button class="remove-weapon-btn">Remove</button>':this.selectedWeapons.length<this.getMaxWeapons()?'<button class="add-weapon-btn">Add to Loadout</button>':'<span class="loadout-full">Loadout Full</span>':`<button class="unlock-weapon-btn" data-weapon-id="${e.id}">Unlock for ${e.cost||0} Credits</button>`}\n      </div>\n    `;const i=t.querySelector(".add-weapon-btn"),a=t.querySelector(".remove-weapon-btn"),n=t.querySelector(".unlock-weapon-btn");return i&&i.addEventListener("click",async t=>{t.stopPropagation(),this.assetManager.playUIClickSound(),await this.addWeaponToLoadout(e)}),a&&a.addEventListener("click",t=>{t.stopPropagation(),this.assetManager.playUIClickSound(),this.removeWeaponFromLoadout(e)}),n&&n.addEventListener("click",async t=>{t.stopPropagation(),this.assetManager.playUIClickSound(),await this.unlockWeapon(e)}),t}renderSelectedLoadout(){const e=this.element.querySelector("#selectedLoadoutContainer");if(e){e.innerHTML="";for(let t=0;t<this.getMaxWeapons();t++){const s=this.createElement("div","loadout-slot");if(t<this.selectedWeapons.length){const e=this.selectedWeapons[t];if(e){s.innerHTML=`\n          <div class="slot-content">\n            <h4>${e.name}</h4>\n            <p>Damage: ${e.damage}</p>\n            <p>Energy: ${e.energyCost}</p>\n            <button class="remove-slot-btn" data-weapon-id="${e.id}">Remove</button>\n          </div>\n        `;const t=s.querySelector(".remove-slot-btn");t&&t.addEventListener("click",()=>{this.assetManager.playUIClickSound(),this.removeWeaponFromLoadout(e)})}}else s.innerHTML='\n          <div class="slot-content empty">\n            <span>Empty Slot</span>\n          </div>\n        ';e.appendChild(s)}}}async addWeaponToLoadout(e){this.selectedWeapons.length>=this.getMaxWeapons()?await this.modalService.showModal("Loadout is full! Remove a weapon first."):this.selectedWeapons.some(t=>t.id===e.id)?await this.modalService.showModal("Weapon already in loadout!"):(this.selectedWeapons.push(e),this.settingsManager.selectWeapons(this.selectedWeapons.map(e=>e.id)),this.renderWeapons())}removeWeaponFromLoadout(e){this.selectedWeapons=this.selectedWeapons.filter(t=>t.id!==e.id),this.settingsManager.selectWeapons(this.selectedWeapons.map(e=>e.id)),this.renderWeapons()}async unlockWeapon(e){var t,s;const i=e.cost||0,a=(null==(t=this.getCreditsCallback)?void 0:t.call(this))||0;if(a<i)return void(await this.modalService.showModal(`Insufficient credits! You need ${i} credits but only have ${a}.`));await this.modalService.showConfirmation(`Unlock ${e.name} for ${i} credits?`)&&((null==(s=this.spendCreditsCallback)?void 0:s.call(this,i))?(this.settingsManager.unlockWeapon(e.id),this.renderWeapons(),this.updateCreditDisplay()):await this.modalService.showModal("Failed to complete purchase. Please try again."))}updateLoadoutInfo(){const e=this.selectedWeapons.reduce((e,t)=>e+t.damage,0),t=this.selectedWeapons.reduce((e,t)=>e+t.energyCost,0),s=this.selectedWeapons.length>0?(e/t).toFixed(1):"0";this.updateElement("#loadoutTotalDamage",e.toString()),this.updateElement("#loadoutTotalEnergy",t.toString()),this.updateElement("#loadoutEfficiency",s),this.updateElement("#loadoutWeaponCount",`${this.selectedWeapons.length}/${this.getMaxWeapons()}`);const i=this.element.querySelector("#applyLoadoutBtn");i&&(i.disabled=0===this.selectedWeapons.length)}setOnBackCallback(e){this.onBackCallback=e}setOnSelectCallback(e){this.onSelectCallback=e}setCreditCallbacks(e,t){this.getCreditsCallback=e,this.spendCreditsCallback=t}onShow(){this.loadWeapons(),this.renderWeapons(),this.updateCreditDisplay(),this.hideMainCreditDisplay()}onHide(){this.showMainCreditDisplay()}updateCreditDisplay(){var e;const t=(null==(e=this.getCreditsCallback)?void 0:e.call(this))||0,s=document.getElementById("creditAmount");s&&(s.textContent=t.toString())}hideMainCreditDisplay(){const e=document.getElementById("creditDisplay");e&&e.classList.add("hidden"),document.body.classList.add("credit-display-hidden")}showMainCreditDisplay(){const e=document.getElementById("creditDisplay");e&&e.classList.remove("hidden"),document.body.classList.remove("credit-display-hidden")}}class x{constructor(){this.currentBattleCell=null;try{const s=document.getElementById("gameCanvas");if(!s)throw new Error("Game canvas element not found");this.canvas=s,this.width=this.canvas.width,this.height=this.canvas.height,this.settingsManager=new p,this.assetManager=new t(this.settingsManager),this.collisionManager=new n,this.particleSystem=new o(this.assetManager),this.mathChallenge=new e(this.assetManager),this.weaponSystem=new a(this.assetManager,this.collisionManager,this.particleSystem),this.enemyAI=new l(this.weaponSystem),this.gameStateManager=new r(this.settingsManager),this.renderer=new h(this.canvas,this.assetManager),this.ui=new c(this.assetManager,this.weaponSystem),this.router=new d,this.modalService=new u(this.assetManager),this.settingsPage=new m(this.settingsManager,this.assetManager,this.modalService),this.aboutPage=new y(this.assetManager),this.mapPage=new f(this.settingsManager,this.assetManager,this.modalService),this.shipSelectionPage=new C(this.settingsManager,this.assetManager,this.modalService),this.weaponSelectionPage=new v(this.settingsManager,this.assetManager,this.modalService),this.initializeControls(),this.initializeRouter(),this.initializeStartupMenu(),this.renderLoop()}catch(s){throw console.error("Error in StarTrekGame constructor:",s),s}}initializeShips(e){const t=this.settingsManager.getSelectedShip();if(!t)throw new Error("No ship selected. Please select a ship before starting battle.");const a=this.mapPage.getHexCell(e);if(!a||!a.hasEnemy)throw new Error("Invalid battle cell or no enemy present.");const n=this.settingsManager.getSelectedWeapons();this.playerShip=function(e,t,a,n){const o=i(e,n||[],`Player ${e.name}`);return new s({x:t/2,y:a-120,width:120,height:90,velocityX:.8,direction:1,minX:60,maxX:t-60,isPlayer:!0,shipData:o})}(t,this.width,this.height,n);const o=a.ship;if(!o)throw new Error("No enemy ship type found.");console.log("Enemy ship type:",o);const l=this.settingsManager.getShipById(o);if(console.log("Enemy ship:",l),!l)throw new Error("No enemy ship found.");const r=this.settingsManager.getEnemyWeapons(l.faction);console.log("Enemy weapons assigned:",r),this.enemyShip=function(e,t,a,n=1,o=[]){const l=e.maxHealth+25*(n-1),r=i(e,o,`Enemy ${e.name}`);return r.maxHealth=l,r.level=n,new s({x:t/2,y:90,width:120,height:90,health:l,maxHealth:l,energy:e.maxEnergy,maxEnergy:e.maxEnergy,velocityX:.6,direction:-1,minX:60,maxX:t-60,isEnemy:!0,shipData:r})}(l,this.width,this.height,1,r),console.log("Enemy ship created with weapons:",this.enemyShip.getWeapons())}initializeControls(){this.ui.setWeaponCallbacks({fire:e=>this.fireWeapon(e)}),this.ui.setRepairCallbacks({show:e=>this.showMathChallenge(e)}),this.ui.setGameCallbacks({start:()=>this.startGame(),continue:()=>this.goToMap(),restart:()=>this.restartGame(),pause:()=>this.togglePause()})}initializeRouter(){this.router.registerRoute("startup",{onEnter:()=>this.showStartupScreen()}),this.router.registerRoute("game",{onEnter:()=>this.showGameScreen()}),this.router.registerRoute("settings",{onEnter:()=>this.showSettingsPage()}),this.router.registerRoute("about",{onEnter:()=>this.showAboutPage()}),this.router.registerRoute("map",{onEnter:()=>this.showMapPage()}),this.router.registerRoute("ship-selection",{onEnter:()=>this.showShipSelectionPage()}),this.router.registerRoute("weapon-selection",{onEnter:()=>this.showWeaponSelectionPage()}),this.router.initializeFromHash()}initializeStartupMenu(){const e=document.getElementById("startGameBtn");null==e||e.addEventListener("click",()=>{this.assetManager.playUIClickSound(),this.startMissionFlow()}),this.shipSelectionPage.setOnBackCallback(()=>this.router.navigate("map")),this.weaponSelectionPage.setOnBackCallback(()=>this.router.navigate("map")),this.mapPage.setOnBackCallback(()=>this.router.navigate("startup")),this.mapPage.setOnJumpCallback(e=>this.jumpToLocation(e)),this.mapPage.setOnShipServicesCallback(()=>this.router.navigate("ship-selection")),this.mapPage.setOnWeaponServicesCallback(()=>this.router.navigate("weapon-selection")),this.shipSelectionPage.setOnSelectCallback(e=>this.selectShipAndContinue(e)),this.weaponSelectionPage.setOnSelectCallback(e=>this.selectWeaponsAndContinue(e)),this.shipSelectionPage.setCreditCallbacks(()=>this.gameStateManager.getCredits(),e=>this.gameStateManager.spendCredits(e)),this.weaponSelectionPage.setCreditCallbacks(()=>this.gameStateManager.getCredits(),e=>this.gameStateManager.spendCredits(e)),this.mapPage.setCreditCallbacks(()=>this.gameStateManager.getCredits(),e=>this.gameStateManager.spendCredits(e)),this.gameStateManager.setCreditUpdateCallback(e=>{this.ui.updateCreditDisplay(e)}),this.ui.updateCreditDisplay(this.gameStateManager.getCredits()),window.resetGameData=()=>{this.settingsManager.resetAllData(),console.log("Game data reset to defaults")}}startMissionFlow(){this.router.navigate("map"),this.restartGame()}restartGame(){this.gameStateManager.restartGame(),this.router.navigate("map"),this.currentBattleCell=null,this.mapPage.restartMap(),console.log("Game restarted from UI")}startGame(){if(!this.currentBattleCell)throw new Error("No battle cell set. Cannot start game.");this.initializeShips(this.currentBattleCell),this.weaponSystem.updateWeaponConfigs(this.playerShip),this.ui.updateWeaponConfigs(this.playerShip),this.ui.showGameScreen(),this.gameStateManager.startGame(),this.ui.updatePauseButton(!1)}showStartupScreen(){this.hideAllPages(),this.ui.showStartupScreen()}showGameScreen(){this.hideAllPages();const e=document.getElementById("gameContainer");e&&(e.style.display="flex")}showSettingsPage(){this.hideAllPages(),this.settingsPage.show()}showAboutPage(){this.hideAllPages(),this.aboutPage.show()}showMapPage(){this.hideAllPages(),this.mapPage.show()}showShipSelectionPage(){this.hideAllPages(),this.shipSelectionPage.show()}showWeaponSelectionPage(){this.hideAllPages(),this.weaponSelectionPage.show()}hideAllPages(){const e=document.getElementById("startupScreen"),t=document.getElementById("gameContainer");e&&(e.style.display="none"),t&&(t.style.display="none"),this.settingsPage.hide(),this.aboutPage.hide(),this.mapPage.hide(),this.shipSelectionPage.hide(),this.weaponSelectionPage.hide()}jumpToLocation(e){if(this.settingsManager.selectLocation(e.id),e.hasEncounter&&"battle"===e.encounterType){const t=e.id.match(/battle-(-?\d+)-(-?\d+)/);t&&(this.currentBattleCell={q:parseInt(t[1]),r:parseInt(t[2])}),this.router.navigate("game"),this.startGame()}else this.mapPage.show()}selectShipAndContinue(e){this.settingsManager.selectShip(e.id),this.router.navigate("map")}selectWeaponsAndContinue(e){const t=e.map(e=>e.id);this.settingsManager.selectWeapons(t),this.router.navigate("map")}showMathChallenge(e){this.gameStateManager.isGameActive()&&!this.mathChallenge.isPanelOpen()&&(this.gameStateManager.pauseGame(),this.mathChallenge.showChallenge(e,e=>this.applyRepair(e),e=>this.applyPenalty(e),()=>this.closeMathPanel()))}applyRepair(e){this.gameStateManager.spendCredits(50)?"hull"===e?(this.playerShip.repairHull(),console.log("Hull repaired! Cost: 50 credits")):"energy"===e&&(this.playerShip.rechargeEnergy(),console.log("Energy recharged! Cost: 50 credits")):console.log(`Insufficient credits for repair! Need: 50, Have: ${this.gameStateManager.getCredits()}`)}applyPenalty(e){if("hull"===e){this.playerShip.takeDamage(1)&&(this.gameStateManager.endGame("MISSION FAILED"),this.ui.showRestartButton(),this.mathChallenge.closePanel(),console.log("Game Over due to penalty!"))}else"energy"===e&&(this.playerShip.consumeEnergy(1),console.log(`Penalty applied to energy! Energy: ${this.playerShip.energy}`))}closeMathPanel(){this.gameStateManager.resumeGame(),console.log("Math challenge closed, game resumed")}togglePause(){this.gameStateManager.isGamePaused()?(this.gameStateManager.resumeGame(),this.ui.updatePauseButton(!1),console.log("Game resumed")):(this.gameStateManager.pauseGame(),this.ui.updatePauseButton(!0),console.log("Game paused"))}fireWeapon(e){if(!this.gameStateManager.isGameActive()||this.gameStateManager.isLevelCompleted())return;const t=this.playerShip.getWeapons().find(t=>t.templateId===e);t?(this.weaponSystem.fireWeapon(t,this.playerShip,this.enemyShip),console.log(`Fired ${t.name}!`)):console.error(`Player doesn't have weapon type: ${e}`)}updateShips(){this.gameStateManager.isGameActive()&&(this.playerShip.update(),this.enemyShip.update())}updateProjectiles(){if(!this.gameStateManager.isGameActive())return;const e=!this.gameStateManager.isLevelCompleted();if(this.enemyAI.update(this.enemyShip,this.playerShip,e),this.gameStateManager.checkDefeatCondition(this.playerShip)&&setTimeout(()=>{this.ui.showRestartButton()},1e3),this.weaponSystem.update(this.playerShip,this.enemyShip),this.gameStateManager.checkVictoryCondition(this.enemyShip)){const e=100;this.gameStateManager.addCredits(e),console.log(`Battle won! Awarded ${e} credits`),this.currentBattleCell&&(this.mapPage.clearEnemyFromCell(this.currentBattleCell),console.log(`Cleared enemy from cell (${this.currentBattleCell.q}, ${this.currentBattleCell.r})`),this.currentBattleCell=null),setTimeout(()=>{this.showGoToMapButton()},1e3)}}render(){const e=this.gameStateManager.getCurrentState(),t={level:e.level,gameOver:e.gameOver,gameOverMessage:e.gameOverMessage,playerShip:this.playerShip,enemyShip:this.enemyShip,weaponSystem:this.weaponSystem};this.playerShip&&this.enemyShip?this.renderer.render(t):this.renderer.renderBackground(),this.playerShip&&this.enemyShip&&this.ui.updateUI(t)}goToMap(){this.playerShip.reset({x:this.width/2,y:this.height-120,health:this.playerShip.maxHealth,energy:this.playerShip.maxEnergy,direction:1}),this.enemyShip.reset({x:this.width/2,y:90,health:this.enemyShip.maxHealth,direction:-1}),this.weaponSystem.clear(),this.router.navigate("map")}showGoToMapButton(){this.ui.hideContinueButton();const e=document.getElementById("continueContainer");if(e){const t=e.querySelector("#continueBtn");t&&(t.textContent="Go to Map",t.onclick=()=>this.goToMap(),e.style.display="block")}}renderLoop(){this.router.update(),this.renderer.update(),this.gameStateManager.isGameActive()&&"game"===this.router.getCurrentRoute()&&(this.updateShips(),this.updateProjectiles()),this.render(),requestAnimationFrame(()=>this.renderLoop())}}window.addEventListener("load",()=>{try{console.log("Window loaded, initializing game..."),new x,console.log("Game initialized successfully")}catch(e){console.error("Error initializing game:",e)}});
//# sourceMappingURL=index.BZzRGTz0.js.map
